const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-CJ3gq17o.js","assets/vendor-DyAC-rNV.js","assets/vendor-dexie-DObWwHmA.js","assets/vendor-zxing-CVcUwAn5.js"])))=>i.map(i=>d[i]);
import{r as f,u as T,b as Y,j as e,N as F,O as Z,d as ee,e as se,R as te,f as ae}from"./vendor-DyAC-rNV.js";import{u as q,d as n,e as ne,a as oe,S as re,D as ie,L as ce,A as le,P as de,w as me,p as V}from"./survey-CJ3gq17o.js";import"./vendor-dexie-DObWwHmA.js";import"./vendor-zxing-CVcUwAn5.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&m(c)}).observe(document,{childList:!0,subtree:!0});function i(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function m(o){if(o.ep)return;o.ep=!0;const r=i(o);fetch(o.href,r)}})();function J(){const[l,t]=f.useState(navigator.onLine);return f.useEffect(()=>{const i=()=>t(!0),m=()=>t(!1);return window.addEventListener("online",i),window.addEventListener("offline",m),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",m)}},[]),l}function ue(){const[l,t]=f.useState(0),[i,m]=f.useState(0);return f.useEffect(()=>{let o=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const r=await navigator.storage.estimate();t((r.usage||0)/1048576),m((r.quota||0)/1048576)}},1500);return()=>clearInterval(o)},[]),{usedMB:l,quotaMB:i}}function Q(l,t){if(typeof window>"u")return t;const i=sessionStorage.getItem(l);return i&&i.trim().length>0?i:t}function he(){const l=T(),t=Y();if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return e.jsx(F,{to:"/",replace:!0});const m=Q("mockHospitalName",""),o=t.pathname.startsWith("/survey")&&t.pathname!=="/survey/home",r=Q("mockUserEmail","survey.operator@example.com"),c=J(),{usedMB:u,quotaMB:v}=ue(),p=q(g=>g.completedCount),x=m.trim().length>0;return e.jsxs("div",{className:"app survey-app",children:[e.jsxs("header",{className:"survey-header",children:[e.jsxs("div",{className:"survey-header__left",children:[o&&e.jsxs("button",{type:"button",className:"survey-header__back",onClick:()=>l("/survey/home"),children:[e.jsx("span",{className:"survey-header__back-icon",children:"←"}),e.jsx("span",{children:"戻る"})]}),e.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),x&&e.jsx("h1",{className:"survey-header__title",children:m}),e.jsx("p",{className:"survey-header__user",children:r})]}),e.jsxs("div",{className:"survey-header__stats",children:[e.jsxs("div",{className:`survey-badge${c?" is-online":" is-offline"}`,children:[e.jsx("span",{className:"survey-badge__label",children:"通信状態"}),e.jsx("span",{className:"survey-badge__value",children:c?"オンライン":"オフライン"})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),e.jsxs("span",{className:"survey-badge__value",children:[u.toFixed(1)," / ",v.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"作業済み"}),e.jsxs("span",{className:"survey-badge__value",children:[p," 件"]})]})]})]}),e.jsx("main",{className:"survey-main",children:e.jsx("div",{className:"survey-main__inner",children:e.jsx(Z,{})})})]})}const pe="modulepreload",ge=function(l){return"/"+l},z={},P=function(t,i,m){let o=Promise.resolve();if(i&&i.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),u=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(i.map(v=>{if(v=ge(v),v in z)return;z[v]=!0;const p=v.endsWith(".css"),x=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${v}"]${x}`))return;const g=document.createElement("link");if(g.rel=p?"stylesheet":pe,p||(g.as="script"),g.crossOrigin="",g.href=v,u&&g.setAttribute("nonce",u),document.head.appendChild(g),p)return new Promise((y,j)=>{g.addEventListener("load",y),g.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${v}`)))})}))}function r(c){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=c,window.dispatchEvent(u),!u.defaultPrevented)throw c}return o.then(c=>{for(const u of c||[])u.status==="rejected"&&r(u.reason);return t().catch(r)})};function G(l){const t=[];let i="",m=!1;for(let o=0;o<l.length;o+=1){const r=l[o];if(r==='"'){m&&l[o+1]==='"'?(i+='"',o+=1):m=!m;continue}if(r===","&&!m){t.push(i),i="";continue}i+=r}return t.push(i),t.map(o=>o.trim())}function K(l){if(!l)return"";const t=l.trim();return t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1).replace(/""/g,'"').trim():t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1).trim():t}function ve(l){const t=l.split(/\r?\n/).filter(m=>m.trim().length>0);if(t.length===0)return[];const i=G(t.shift()).map(K);return t.map(m=>{const o=G(m).map(K),r={};return i.forEach((c,u)=>{r[c]=o[u]??""}),r})}async function S(l){const t=await fetch(l,{cache:"no-store"});if(!t.ok)throw new Error(`Failed to download ${l}`);const i=await t.text();return ve(i)}async function fe(){const[l,t,i,m,o,r,c,u,v,p]=await Promise.all([S("/masters/locations_buildings.csv"),S("/masters/locations_floors.csv"),S("/masters/locations_departments.csv"),S("/masters/locations_divisions.csv"),S("/masters/locations_rooms.csv"),S("/masters/product_categories.csv"),S("/masters/product_subcategories.csv"),S("/masters/product_items.csv"),S("/masters/product_makers.csv"),S("/masters/product_models.csv")]),x=l.map(s=>({id:s.id,name:s.name})),g=t.map(s=>({id:s.id,buildingId:s.buildingId,name:s.name})),y=i.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,name:s.name})),j=m.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,name:s.name})),N=o.map(s=>({id:s.roomId??s.id,name:s.name,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,divisionId:s.divisionId})),w=r.map(s=>({id:s.id,name:s.name})),k=c.map(s=>({id:s.id,categoryId:s.categoryId,name:s.name})),h=u.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,name:s.name})),I=v.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,name:s.name})),_=p.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,name:s.name}));await n.transaction("rw",n.location_buildings,n.location_floors,n.location_departments,n.location_divisions,n.location_rooms,n.product_categories,n.product_subcategories,n.product_items,n.product_makers,n.product_models,n.settings,async()=>{await Promise.all([n.location_buildings.clear(),n.location_floors.clear(),n.location_departments.clear(),n.location_divisions.clear(),n.location_rooms.clear(),n.product_categories.clear(),n.product_subcategories.clear(),n.product_items.clear(),n.product_makers.clear(),n.product_models.clear()]),await n.location_buildings.bulkPut(x),await n.location_floors.bulkPut(g),await n.location_departments.bulkPut(y),await n.location_divisions.bulkPut(j),await n.location_rooms.bulkPut(N),await n.product_categories.bulkPut(w),await n.product_subcategories.bulkPut(k),await n.product_items.bulkPut(h),await n.product_makers.bulkPut(I),await n.product_models.bulkPut(_),await n.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function ye(){const l=T(),t=J(),i=q(d=>d.completedCount),m=q(d=>d.purgeCompleted),[o,r]=f.useState(!1),[c,u]=f.useState(null),[v,p]=f.useState([]),[x,g]=f.useState(null),[y,j]=f.useState("unknown"),[N,w]=f.useState(!1),[k,h]=f.useState(!1),[I,_]=f.useState(!1),s=async()=>{const d=[n.location_buildings,n.location_floors,n.location_departments,n.location_divisions,n.location_rooms,n.product_categories,n.product_subcategories,n.product_items,n.product_makers,n.product_models,n.survey_masters,n.indices];await n.transaction("rw",...d,n.settings,async()=>{await Promise.all(d.map(a=>a.clear())),await n.settings.delete("mastersDownloadedAt")})};f.useEffect(()=>{const d=sessionStorage.getItem("cameraPermission");if(d==="granted"||d==="denied"){const a=d==="granted";j(a?"granted":"denied"),w(a)}},[]),f.useEffect(()=>{let d=!1;return h(!1),u(null),(async()=>{try{await s(),d||p(b=>[...b,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(b){const O=b instanceof Error?b.message:String(b);d||p(M=>[...M,"マスタデータの初期化に失敗しました: "+O])}})(),()=>{d=!0}},[]);const E=async()=>{if(!o){r(!0),g(null),h(!1),w(!1),_(!1),u(null),p(d=>[...d,"マスタCSVの読み込みを開始しました"]);try{p(a=>[...a,"既存のマスタデータをクリアしています…"]),await s(),p(a=>[...a,"既存のマスタデータをクリアしました。"]),await Promise.all([P(()=>import("./survey-CJ3gq17o.js").then(a=>a.b),__vite__mapDeps([0,1,2,3])),P(()=>import("./survey-CJ3gq17o.js").then(a=>a.c),__vite__mapDeps([0,1,2,3])),P(()=>import("./survey-CJ3gq17o.js").then(a=>a.f),__vite__mapDeps([0,1,2,3])),P(()=>import("./survey-CJ3gq17o.js").then(a=>a.g),__vite__mapDeps([0,1,2,3])),P(()=>import("./survey-CJ3gq17o.js").then(a=>a.q),__vite__mapDeps([0,1,2,3]))]),await fe();const d=new Date().toISOString();u(d),h(!0),p(a=>[...a,"マスタCSVをローカルDBへ保存しました"]),p(a=>[...a,"カメラアクセスをリクエストします"]);try{await ne(),j("granted"),w(!0),p(a=>[...a,"カメラアクセスを取得しました"])}catch(a){const b=a instanceof Error?a.message:String(a),M=sessionStorage.getItem("cameraPermission")==="denied";j(M?"denied":"unknown"),w(!1),p(X=>[...X,`カメラアクセスに失敗しました: ${b}`])}p(a=>[...a,"Tesseract OCRの準備を行っています…"]);try{await oe(),_(!0),p(a=>[...a,"Tesseract OCRの準備が完了しました"])}catch(a){const b=a instanceof Error?a.message:String(a);_(!1),p(O=>[...O,`Tesseract OCRの準備に失敗しました: ${b}`])}}catch(d){const a=d instanceof Error?d.message:String(d);g(a),h(!1),w(!1),_(!1),p(b=>[...b,`エラー: ${a}`])}finally{r(!1)}}},W=()=>{sessionStorage.setItem("surveyActive","1"),l("/survey/department")},$=async()=>{if(t){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),p(d=>[...d,"送信処理（ダミー）: Phase2で実装予定です"]);try{const d=await m();d>0?p(a=>[...a,`ローカルに保存されていた作業済みデータを削除しました（${d}件）`]):p(a=>[...a,"削除対象の作業済みデータはありませんでした"])}catch(d){const a=d instanceof Error?d.message:String(d);p(b=>[...b,`作業済みデータ削除時にエラーが発生しました: ${a}`])}}},C=k&&y!=="denied"&&I,A=sessionStorage.getItem("visitedDepartment")==="1"&&i>0,L=c?new Date(c).toLocaleString():"未ダウンロード",D=t?"オンライン":"オフライン",B=y==="granted"?"利用可能":y==="denied"?"拒否されています":"未確認";return e.jsx("div",{className:"page survey-home-page",children:e.jsxs("div",{className:"survey-home",children:[e.jsxs("section",{className:"survey-home__hero",children:[e.jsxs("div",{className:"survey-home__hero-top",children:[e.jsx("span",{className:"survey-home__label",children:"現地登録モード"}),e.jsx("h1",{className:"survey-home__title",children:"現有資産登録"}),e.jsx("p",{className:"survey-home__description",children:"オフライン環境での現地登録を行う前に、マスタデータのダウンロードとカメラアクセスの事前確認を完了してください。 調査開始後は /survey/ 配下の画面のみオフライン遷移が許可されます。"})]}),e.jsxs("div",{className:"survey-home__hero-actions",children:[e.jsx("button",{type:"button",onClick:E,disabled:o,children:"事前ダウンロードを実行"}),k&&e.jsxs("span",{className:"survey-home__badge",children:["最終更新: ",L]}),y==="granted"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可済み"}),y==="denied"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可なし"})]}),x&&e.jsxs("div",{className:"survey-home__badge",style:{background:"rgba(239, 68, 68, 0.2)",color:"#b91c1c"},children:["エラー: ",x]})]}),e.jsxs("section",{className:"survey-home__status-grid",children:[e.jsxs("div",{className:`survey-home__status-card${k?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"事前ダウンロード"}),e.jsx("strong",{children:k?"完了":"未実行"}),e.jsx("span",{children:L})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"通信状態"}),e.jsx("strong",{children:D}),e.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"作業済み件数"}),e.jsxs("strong",{children:[i,"件"]}),e.jsx("span",{children:"調査完了後にサーバー送信予定（Phase2）"})]}),e.jsxs("div",{className:`survey-home__status-card${N?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"カメラステータス"}),e.jsx("strong",{children:B}),e.jsx("span",{children:"QRコード読取と撮影に使用します"})]})]}),e.jsxs("section",{className:"survey-home__actions",children:[e.jsxs("div",{className:"survey-home__actions-text",children:[e.jsx("h3",{children:"現地登録を開始する"}),e.jsx("p",{children:"部署入力 → QRコード読取 → 写真撮影 → 商品登録の順に進みます。"})]}),e.jsxs("div",{className:"survey-home__actions-buttons",children:[e.jsx("button",{type:"button",onClick:W,disabled:!C,children:"調査を開始"}),A&&e.jsx("button",{type:"button",className:"ghost",onClick:$,disabled:!t,children:"調査完了（送信想定）"})]})]}),e.jsxs("section",{className:"survey-home__log",children:[e.jsxs("div",{className:"survey-home__log-header",children:[e.jsx("h2",{children:"アクティビティログ"}),e.jsxs("span",{children:[v.length," 件"]})]}),e.jsxs("div",{className:"survey-home__log-body",children:[v.length===0&&e.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),v.map((d,a)=>{const b=d.startsWith("エラー")||d.includes("失敗")||d.includes("エラーが発生");return e.jsx("div",{className:`survey-home__log-line${b?" is-error":""}`,children:d},a)})]})]})]})})}function _e(){const l=T(),[t,i]=f.useState("user@example.com"),[m,o]=f.useState("password"),r=typeof window<"u"?sessionStorage.getItem("mockToken"):null;f.useEffect(()=>{r&&l("/survey/home",{replace:!0})},[r,l]);const c=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",t.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),l("/survey/home",{replace:!0})};return e.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[e.jsx("h2",{children:"ログイン"}),e.jsxs("form",{className:"grid",onSubmit:c,children:[e.jsxs("label",{children:["メールアドレス",e.jsx("input",{value:t,onChange:u=>i(u.target.value),autoComplete:"username"})]}),e.jsxs("label",{children:["パスワード",e.jsx("input",{value:m,onChange:u=>o(u.target.value),type:"password",autoComplete:"current-password"})]}),e.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function R(l){var c;const i=l.document.getElementById("login-id"),m=((c=i==null?void 0:i.value)==null?void 0:c.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",o=l.selectedHospitalName,r=typeof o=="string"&&o.trim().length>0?o.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",m),r?window.sessionStorage.setItem("mockHospitalName",r):window.sessionStorage.removeItem("mockHospitalName")}function U({mode:l="login"}){const t=f.useRef(null),i=T();return f.useEffect(()=>{const m=t.current;if(!m)return;const o=()=>{const r=m.contentWindow;if(!r)return;const c=r.document,u=r,v=h=>{window.location.pathname!==h&&i(h,{replace:!0})},p=()=>{try{typeof u.hideLocationInputScreen=="function"&&u.hideLocationInputScreen()}catch{}R(r),i("/survey/home")},x=(h,I)=>{const _=u[h];u[h]=I(typeof _=="function"?_:void 0)};x("handleLogin",h=>function(_){var E;h&&h.call(this,_),R(r),(((E=c.getElementById("login-id"))==null?void 0:E.value)??"").includes("@hospital")?k():w()}),x("selectHospital",h=>function(..._){h&&h.apply(this,_),R(r)}),x("showAssetListScreen",h=>function(..._){h&&h.apply(this,_),R(r),v("/mock/assets")}),x("hideAssetListScreen",h=>function(..._){h&&h.apply(this,_),w()}),x("showLocationInputScreen",()=>function(){p()}),x("handleNext",()=>function(){var C,H,A,L,D,B;const I=((C=c.getElementById("surveyDate"))==null?void 0:C.textContent)??"",_=((H=c.getElementById("categoryInput"))==null?void 0:H.value)??"",s=((A=c.getElementById("buildingSelect"))==null?void 0:A.value)??"",E=((L=c.getElementById("floorSelect"))==null?void 0:L.value)??"",W=((D=c.getElementById("departmentSelect"))==null?void 0:D.value)??"",$=((B=c.getElementById("sectionSelect"))==null?void 0:B.value)??"";console.log("調査場所データ:",{surveyDate:I,category:_,building:s,floor:E,department:W,section:$}),p()}),l!=="login"&&R(r);const g=c.getElementById("loginPage"),y=c.getElementById("mainLayout"),j=c.getElementById("assetListScreen"),N=()=>{g&&(g.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.remove("active"),window.location.pathname.startsWith("/mock")||i("/mock/login",{replace:!0}),v("/mock/login")},w=()=>{g&&(g.style.display="none"),j&&j.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),window.location.pathname.startsWith("/mock")||i("/mock/dashboard",{replace:!0}),v("/mock/dashboard")},k=()=>{const h=c.getElementById("login-id");h&&!h.value.includes("@hospital")&&(h.value="demo@hospital.example"),typeof u.showAssetListScreen=="function"?u.showAssetListScreen():(g&&(g.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.add("active")),window.location.pathname.startsWith("/mock")||i("/mock/assets",{replace:!0}),v("/mock/assets")};l==="login"?N():l==="dashboard"?w():l==="assets"&&k()};return m.addEventListener("load",o),()=>{m.removeEventListener("load",o)}},[l,i]),e.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:e.jsx("iframe",{ref:t,title:"医療コンサル管理システム モック",src:"/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const xe=ee([{path:"/",children:[{index:!0,element:e.jsx(F,{to:"/login",replace:!0})},{path:"mock/login",element:e.jsx(U,{mode:"login"})},{path:"mock/dashboard",element:e.jsx(U,{mode:"dashboard"})},{path:"mock/assets",element:e.jsx(U,{mode:"assets"})},{path:"login",element:e.jsx(_e,{})},{element:e.jsx(he,{}),children:[{path:"home",element:e.jsx(F,{to:"/survey/home",replace:!0})},{path:"survey/home",element:e.jsx(ye,{})},{path:"survey/all",element:e.jsx(re,{})},{path:"survey/department",element:e.jsx(ie,{})},{path:"survey/label",element:e.jsx(ce,{})},{path:"survey/asset",element:e.jsx(le,{})},{path:"survey/product",element:e.jsx(de,{})}]}]}]);if("serviceWorker"in navigator)navigator.serviceWorker.register("/sw.js").then(()=>navigator.serviceWorker.ready).then(()=>{me(),V()}).catch(()=>{try{V()}catch{}});else try{V()}catch{}se.createRoot(document.getElementById("root")).render(e.jsx(te.StrictMode,{children:e.jsx(ae,{router:xe})}));
