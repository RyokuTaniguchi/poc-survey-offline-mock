const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-ChHo4KGa.js","assets/vendor-Cpb81dVA.js","assets/vendor-dexie-BWsXn92a.js","assets/vendor-zxing-6Q_caI5h.js"])))=>i.map(i=>d[i]);
import{r as v,u as $,b as Y,j as e,N as U,O as Z,d as ee,e as se,R as te,f as ne}from"./vendor-Cpb81dVA.js";import{u as F,d as a,e as oe,a as ae,S as re,D as ie,L as ce,A as le,P as de,w as ue,p as M}from"./survey-ChHo4KGa.js";import"./vendor-dexie-BWsXn92a.js";import"./vendor-zxing-6Q_caI5h.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&m(l)}).observe(document,{childList:!0,subtree:!0});function i(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function m(o){if(o.ep)return;o.ep=!0;const c=i(o);fetch(o.href,c)}})();function J(){const[r,n]=v.useState(navigator.onLine);return v.useEffect(()=>{const i=()=>n(!0),m=()=>n(!1);return window.addEventListener("online",i),window.addEventListener("offline",m),()=>{window.removeEventListener("online",i),window.removeEventListener("offline",m)}},[]),r}function me(){const[r,n]=v.useState(0),[i,m]=v.useState(0);return v.useEffect(()=>{let o=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const c=await navigator.storage.estimate();n((c.usage||0)/1048576),m((c.quota||0)/1048576)}},1500);return()=>clearInterval(o)},[]),{usedMB:r,quotaMB:i}}function Q(r,n){if(typeof window>"u")return n;const i=sessionStorage.getItem(r);return i&&i.trim().length>0?i:n}function he(){const r=$(),n=Y();if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return e.jsx(U,{to:"/",replace:!0});const m=Q("mockHospitalName",""),o=n.pathname.startsWith("/survey")&&n.pathname!=="/survey/home",c=Q("mockUserEmail","survey.operator@example.com"),l=J(),{usedMB:u,quotaMB:p}=me(),h=F(g=>g.completedCount),b=m.trim().length>0;return e.jsxs("div",{className:"app survey-app",children:[e.jsxs("header",{className:"survey-header",children:[e.jsxs("div",{className:"survey-header__left",children:[o&&e.jsxs("button",{type:"button",className:"survey-header__back",onClick:()=>r("/survey/home"),children:[e.jsx("span",{className:"survey-header__back-icon",children:"←"}),e.jsx("span",{children:"戻る"})]}),e.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),b&&e.jsx("h1",{className:"survey-header__title",children:m}),e.jsx("p",{className:"survey-header__user",children:c})]}),e.jsxs("div",{className:"survey-header__stats",children:[e.jsxs("div",{className:`survey-badge${l?" is-online":" is-offline"}`,children:[e.jsx("span",{className:"survey-badge__label",children:"通信状態"}),e.jsx("span",{className:"survey-badge__value",children:l?"オンライン":"オフライン"})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),e.jsxs("span",{className:"survey-badge__value",children:[u.toFixed(1)," / ",p.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"作業済み"}),e.jsxs("span",{className:"survey-badge__value",children:[h," 件"]})]})]})]}),e.jsx("main",{className:"survey-main",children:e.jsx("div",{className:"survey-main__inner",children:e.jsx(Z,{})})})]})}const pe="modulepreload",ge=function(r){return"/poc-survey-offline-mock/"+r},z={},A=function(n,i,m){let o=Promise.resolve();if(i&&i.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));o=Promise.allSettled(i.map(p=>{if(p=ge(p),p in z)return;z[p]=!0;const h=p.endsWith(".css"),b=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${b}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":pe,h||(g.as="script"),g.crossOrigin="",g.href=p,u&&g.setAttribute("nonce",u),document.head.appendChild(g),h)return new Promise((_,y)=>{g.addEventListener("load",_),g.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${p}`)))})}))}function c(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return o.then(l=>{for(const u of l||[])u.status==="rejected"&&c(u.reason);return n().catch(c)})};function G(r){const n=[];let i="",m=!1;for(let o=0;o<r.length;o+=1){const c=r[o];if(c==='"'){m&&r[o+1]==='"'?(i+='"',o+=1):m=!m;continue}if(c===","&&!m){n.push(i),i="";continue}i+=c}return n.push(i),n.map(o=>o.trim())}function K(r){if(!r)return"";const n=r.trim();return n.startsWith('"')&&n.endsWith('"')?n.slice(1,-1).replace(/""/g,'"').trim():n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1).trim():n}function ve(r){const n=r.split(/\r?\n/).filter(m=>m.trim().length>0);if(n.length===0)return[];const i=G(n.shift()).map(K);return n.map(m=>{const o=G(m).map(K),c={};return i.forEach((l,u)=>{c[l]=o[u]??""}),c})}const fe="/poc-survey-offline-mock/";function ye(r){const n=r.startsWith("/")?r.slice(1):r;return`${fe}${n}`}async function I(r){const n=ye(r),i=await fetch(n,{cache:"no-store"});if(!i.ok)throw new Error(`Failed to download ${r}`);const m=await i.text();return ve(m)}async function _e(){const[r,n,i,m,o,c,l,u,p,h]=await Promise.all([I("/masters/locations_buildings.csv"),I("/masters/locations_floors.csv"),I("/masters/locations_departments.csv"),I("/masters/locations_divisions.csv"),I("/masters/locations_rooms.csv"),I("/masters/product_categories.csv"),I("/masters/product_subcategories.csv"),I("/masters/product_items.csv"),I("/masters/product_makers.csv"),I("/masters/product_models.csv")]),b=r.map(s=>({id:s.id,name:s.name})),g=n.map(s=>({id:s.id,buildingId:s.buildingId,name:s.name})),_=i.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,name:s.name})),y=m.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,name:s.name})),j=o.map(s=>({id:s.roomId??s.id,name:s.name,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,divisionId:s.divisionId})),w=c.map(s=>({id:s.id,name:s.name})),S=l.map(s=>({id:s.id,categoryId:s.categoryId,name:s.name})),N=u.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,name:s.name})),P=p.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,name:s.name})),k=h.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,name:s.name}));await a.transaction("rw",a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.settings,async()=>{await Promise.all([a.location_buildings.clear(),a.location_floors.clear(),a.location_departments.clear(),a.location_divisions.clear(),a.location_rooms.clear(),a.product_categories.clear(),a.product_subcategories.clear(),a.product_items.clear(),a.product_makers.clear(),a.product_models.clear()]),await a.location_buildings.bulkPut(b),await a.location_floors.bulkPut(g),await a.location_departments.bulkPut(_),await a.location_divisions.bulkPut(y),await a.location_rooms.bulkPut(j),await a.product_categories.bulkPut(w),await a.product_subcategories.bulkPut(S),await a.product_items.bulkPut(N),await a.product_makers.bulkPut(P),await a.product_models.bulkPut(k),await a.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function xe(){const r=$(),n=J(),i=F(d=>d.completedCount),m=F(d=>d.purgeCompleted),[o,c]=v.useState(!1),[l,u]=v.useState(null),[p,h]=v.useState([]),[b,g]=v.useState(null),[_,y]=v.useState("unknown"),[j,w]=v.useState(!1),[S,N]=v.useState(!1),[P,k]=v.useState(!1),s=async()=>{const d=[a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.survey_masters,a.indices];await a.transaction("rw",...d,a.settings,async()=>{await Promise.all(d.map(t=>t.clear())),await a.settings.delete("mastersDownloadedAt")})};v.useEffect(()=>{const d=sessionStorage.getItem("cameraPermission");if(d==="granted"||d==="denied"){const t=d==="granted";y(t?"granted":"denied"),w(t)}},[]),v.useEffect(()=>{let d=!1;return N(!1),u(null),(async()=>{try{await s(),d||h(f=>[...f,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(f){const T=f instanceof Error?f.message:String(f);d||h(H=>[...H,"マスタデータの初期化に失敗しました: "+T])}})(),()=>{d=!0}},[]);const E=async()=>{if(!o){c(!0),g(null),N(!1),w(!1),k(!1),u(null),h(d=>[...d,"マスタCSVの読み込みを開始しました"]);try{h(t=>[...t,"既存のマスタデータをクリアしています…"]),await s(),h(t=>[...t,"既存のマスタデータをクリアしました。"]),await Promise.all([A(()=>import("./survey-ChHo4KGa.js").then(t=>t.b),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.c),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.f),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.g),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.q),__vite__mapDeps([0,1,2,3]))]),await _e();const d=new Date().toISOString();u(d),N(!0),h(t=>[...t,"マスタCSVをローカルDBへ保存しました"]),h(t=>[...t,"カメラアクセスをリクエストします"]);try{await oe(),y("granted"),w(!0),h(t=>[...t,"カメラアクセスを取得しました"])}catch(t){const f=t instanceof Error?t.message:String(t),H=sessionStorage.getItem("cameraPermission")==="denied";y(H?"denied":"unknown"),w(!1),h(X=>[...X,`カメラアクセスに失敗しました: ${f}`])}h(t=>[...t,"Tesseract OCRの準備を行っています…"]);try{await ae(),k(!0),h(t=>[...t,"Tesseract OCRの準備が完了しました"])}catch(t){const f=t instanceof Error?t.message:String(t);k(!1),h(T=>[...T,`Tesseract OCRの準備に失敗しました: ${f}`])}}catch(d){const t=d instanceof Error?d.message:String(d);g(t),N(!1),w(!1),k(!1),h(f=>[...f,`エラー: ${t}`])}finally{c(!1)}}},x=()=>{sessionStorage.setItem("surveyActive","1"),r("/survey/department")},B=async()=>{if(n){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),h(d=>[...d,"送信処理（ダミー）: Phase2で実装予定です"]);try{const d=await m();d>0?h(t=>[...t,`ローカルに保存されていた作業済みデータを削除しました（${d}件）`]):h(t=>[...t,"削除対象の作業済みデータはありませんでした"])}catch(d){const t=d instanceof Error?d.message:String(d);h(f=>[...f,`作業済みデータ削除時にエラーが発生しました: ${t}`])}}},L=S&&_!=="denied"&&P,W=sessionStorage.getItem("visitedDepartment")==="1"&&i>0,R=l?new Date(l).toLocaleString():"未ダウンロード",D=n?"オンライン":"オフライン",O=_==="granted"?"利用可能":_==="denied"?"拒否されています":"未確認";return e.jsx("div",{className:"page survey-home-page",children:e.jsxs("div",{className:"survey-home",children:[e.jsxs("section",{className:"survey-home__hero",children:[e.jsxs("div",{className:"survey-home__hero-top",children:[e.jsx("span",{className:"survey-home__label",children:"現地登録モード"}),e.jsx("h1",{className:"survey-home__title",children:"現有資産登録"}),e.jsx("p",{className:"survey-home__description",children:"オフライン環境での現地登録を行う前に、マスタデータのダウンロードとカメラアクセスの事前確認を完了してください。 調査開始後は /survey/ 配下の画面のみオフライン遷移が許可されます。"})]}),e.jsxs("div",{className:"survey-home__hero-actions",children:[e.jsx("button",{type:"button",onClick:E,disabled:o,children:"事前ダウンロードを実行"}),S&&e.jsxs("span",{className:"survey-home__badge",children:["最終更新: ",R]}),_==="granted"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可済み"}),_==="denied"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可なし"})]}),b&&e.jsxs("div",{className:"survey-home__badge",style:{background:"rgba(239, 68, 68, 0.2)",color:"#b91c1c"},children:["エラー: ",b]})]}),e.jsxs("section",{className:"survey-home__status-grid",children:[e.jsxs("div",{className:`survey-home__status-card${S?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"事前ダウンロード"}),e.jsx("strong",{children:S?"完了":"未実行"}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"通信状態"}),e.jsx("strong",{children:D}),e.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"作業済み件数"}),e.jsxs("strong",{children:[i,"件"]}),e.jsx("span",{children:"調査完了後にサーバー送信予定（Phase2）"})]}),e.jsxs("div",{className:`survey-home__status-card${j?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"カメラステータス"}),e.jsx("strong",{children:O}),e.jsx("span",{children:"QRコード読取と撮影に使用します"})]})]}),e.jsxs("section",{className:"survey-home__actions",children:[e.jsxs("div",{className:"survey-home__actions-text",children:[e.jsx("h3",{children:"現地登録を開始する"}),e.jsx("p",{children:"部署入力 → QRコード読取 → 写真撮影 → 商品登録の順に進みます。"})]}),e.jsxs("div",{className:"survey-home__actions-buttons",children:[e.jsx("button",{type:"button",onClick:x,disabled:!L,children:"調査を開始"}),W&&e.jsx("button",{type:"button",className:"ghost",onClick:B,disabled:!n,children:"調査完了（送信想定）"})]})]}),e.jsxs("section",{className:"survey-home__log",children:[e.jsxs("div",{className:"survey-home__log-header",children:[e.jsx("h2",{children:"アクティビティログ"}),e.jsxs("span",{children:[p.length," 件"]})]}),e.jsxs("div",{className:"survey-home__log-body",children:[p.length===0&&e.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),p.map((d,t)=>{const f=d.startsWith("エラー")||d.includes("失敗")||d.includes("エラーが発生");return e.jsx("div",{className:`survey-home__log-line${f?" is-error":""}`,children:d},t)})]})]})]})})}function be(){const r=$(),[n,i]=v.useState("user@example.com"),[m,o]=v.useState("password"),c=typeof window<"u"?sessionStorage.getItem("mockToken"):null;v.useEffect(()=>{c&&r("/survey/home",{replace:!0})},[c,r]);const l=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",n.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),r("/survey/home",{replace:!0})};return e.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[e.jsx("h2",{children:"ログイン"}),e.jsxs("form",{className:"grid",onSubmit:l,children:[e.jsxs("label",{children:["メールアドレス",e.jsx("input",{value:n,onChange:u=>i(u.target.value),autoComplete:"username"})]}),e.jsxs("label",{children:["パスワード",e.jsx("input",{value:m,onChange:u=>o(u.target.value),type:"password",autoComplete:"current-password"})]}),e.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function C(r){var l;const i=r.document.getElementById("login-id"),m=((l=i==null?void 0:i.value)==null?void 0:l.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",o=r.selectedHospitalName,c=typeof o=="string"&&o.trim().length>0?o.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",m),c?window.sessionStorage.setItem("mockHospitalName",c):window.sessionStorage.removeItem("mockHospitalName")}function V({mode:r="login"}){const n=v.useRef(null),i=$();return v.useEffect(()=>{const o=n.current;if(!o)return;const c=()=>{const l=o.contentWindow;if(!l)return;const u=l.document,p=l,h=s=>{window.location.pathname!==s&&i(s,{replace:!0})},b=()=>{try{typeof p.hideLocationInputScreen=="function"&&p.hideLocationInputScreen()}catch{}C(l),i("/survey/home")},g=(s,E)=>{const x=p[s];p[s]=E(typeof x=="function"?x:void 0)};g("handleLogin",s=>function(x){var L;s&&s.call(this,x),C(l),(((L=u.getElementById("login-id"))==null?void 0:L.value)??"").includes("@hospital")?k():P()}),g("selectHospital",s=>function(...x){s&&s.apply(this,x),C(l)}),g("showAssetListScreen",s=>function(...x){s&&s.apply(this,x),C(l),h("/mock/assets")}),g("hideAssetListScreen",s=>function(...x){s&&s.apply(this,x),P()}),g("showLocationInputScreen",()=>function(){b()}),g("handleNext",()=>function(){var R,D,O,d,t,f;const E=((R=u.getElementById("surveyDate"))==null?void 0:R.textContent)??"",x=((D=u.getElementById("categoryInput"))==null?void 0:D.value)??"",B=((O=u.getElementById("buildingSelect"))==null?void 0:O.value)??"",L=((d=u.getElementById("floorSelect"))==null?void 0:d.value)??"",q=((t=u.getElementById("departmentSelect"))==null?void 0:t.value)??"",W=((f=u.getElementById("sectionSelect"))==null?void 0:f.value)??"";console.log("調査場所データ:",{surveyDate:E,category:x,building:B,floor:L,department:q,section:W}),b()}),r!=="login"&&C(l);const _=u.getElementById("loginPage"),y=u.getElementById("mainLayout"),j=u.getElementById("assetListScreen"),w="/poc-survey-offline-mock/",S=()=>window.location.pathname.startsWith(`${w}mock`),N=()=>{_&&(_.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.remove("active"),S()||i("/mock/login",{replace:!0}),h("/mock/login")},P=()=>{_&&(_.style.display="none"),j&&j.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),S()||i("/mock/dashboard",{replace:!0}),h("/mock/dashboard")},k=()=>{const s=u.getElementById("login-id");s&&!s.value.includes("@hospital")&&(s.value="demo@hospital.example"),typeof p.showAssetListScreen=="function"?p.showAssetListScreen():(_&&(_.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.add("active")),S()||i("/mock/assets",{replace:!0}),h("/mock/assets")};r==="login"?N():r==="dashboard"?P():r==="assets"&&k()};return o.addEventListener("load",c),()=>{o.removeEventListener("load",c)}},[r,i]),e.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:e.jsx("iframe",{ref:n,title:"医療コンサル管理システム モック",src:"/poc-survey-offline-mock/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const je=[{path:"/",children:[{index:!0,element:e.jsx(U,{to:"/login",replace:!0})},{path:"mock/login",element:e.jsx(V,{mode:"login"})},{path:"mock/dashboard",element:e.jsx(V,{mode:"dashboard"})},{path:"mock/assets",element:e.jsx(V,{mode:"assets"})},{path:"login",element:e.jsx(be,{})},{element:e.jsx(he,{}),children:[{path:"home",element:e.jsx(U,{to:"/survey/home",replace:!0})},{path:"survey/home",element:e.jsx(xe,{})},{path:"survey/all",element:e.jsx(re,{})},{path:"survey/department",element:e.jsx(ie,{})},{path:"survey/label",element:e.jsx(ce,{})},{path:"survey/asset",element:e.jsx(le,{})},{path:"survey/product",element:e.jsx(de,{})}]}]}],Se=ee(je,{basename:"/poc-survey-offline-mock/"}),Ie="/poc-survey-offline-mock/";if("serviceWorker"in navigator)navigator.serviceWorker.register(`${Ie}sw.js`).then(()=>navigator.serviceWorker.ready).then(()=>{ue(),M()}).catch(()=>{try{M()}catch{}});else try{M()}catch{}se.createRoot(document.getElementById("root")).render(e.jsx(te.StrictMode,{children:e.jsx(ne,{router:Se})}));
