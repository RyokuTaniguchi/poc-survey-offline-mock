const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-ChHo4KGa.js","assets/vendor-Cpb81dVA.js","assets/vendor-dexie-BWsXn92a.js","assets/vendor-zxing-6Q_caI5h.js"])))=>i.map(i=>d[i]);
import{r as v,u as $,b as Y,j as e,N as U,O as Z,d as ee,e as se,R as te,f as ne}from"./vendor-Cpb81dVA.js";import{u as F,d as o,e as ae,a as oe,S as re,D as ie,L as ce,A as le,P as de,w as ue,p as M}from"./survey-ChHo4KGa.js";import"./vendor-dexie-BWsXn92a.js";import"./vendor-zxing-6Q_caI5h.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))h(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&h(l)}).observe(document,{childList:!0,subtree:!0});function r(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function h(a){if(a.ep)return;a.ep=!0;const c=r(a);fetch(a.href,c)}})();function J(){const[i,n]=v.useState(navigator.onLine);return v.useEffect(()=>{const r=()=>n(!0),h=()=>n(!1);return window.addEventListener("online",r),window.addEventListener("offline",h),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",h)}},[]),i}function me(){const[i,n]=v.useState(0),[r,h]=v.useState(0);return v.useEffect(()=>{let a=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const c=await navigator.storage.estimate();n((c.usage||0)/1048576),h((c.quota||0)/1048576)}},1500);return()=>clearInterval(a)},[]),{usedMB:i,quotaMB:r}}function Q(i,n){if(typeof window>"u")return n;const r=sessionStorage.getItem(i);return r&&r.trim().length>0?r:n}function he(){const i=$(),n=Y();if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return e.jsx(U,{to:"/",replace:!0});const h=Q("mockHospitalName",""),a=n.pathname.startsWith("/survey")&&n.pathname!=="/survey/home",c=Q("mockUserEmail","survey.operator@example.com"),l=J(),{usedMB:u,quotaMB:p}=me(),m=F(g=>g.completedCount),b=h.trim().length>0;return e.jsxs("div",{className:"app survey-app",children:[e.jsxs("header",{className:"survey-header",children:[e.jsxs("div",{className:"survey-header__left",children:[a&&e.jsxs("button",{type:"button",className:"survey-header__back",onClick:()=>i("/survey/home"),children:[e.jsx("span",{className:"survey-header__back-icon",children:"←"}),e.jsx("span",{children:"戻る"})]}),e.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),b&&e.jsx("h1",{className:"survey-header__title",children:h}),e.jsx("p",{className:"survey-header__user",children:c})]}),e.jsxs("div",{className:"survey-header__stats",children:[e.jsxs("div",{className:`survey-badge${l?" is-online":" is-offline"}`,children:[e.jsx("span",{className:"survey-badge__label",children:"通信状態"}),e.jsx("span",{className:"survey-badge__value",children:l?"オンライン":"オフライン"})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),e.jsxs("span",{className:"survey-badge__value",children:[u.toFixed(1)," / ",p.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"作業済み"}),e.jsxs("span",{className:"survey-badge__value",children:[m," 件"]})]})]})]}),e.jsx("main",{className:"survey-main",children:e.jsx("div",{className:"survey-main__inner",children:e.jsx(Z,{})})})]})}const pe="modulepreload",ge=function(i){return"/poc-survey-offline-mock/"+i},z={},A=function(n,r,h){let a=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));a=Promise.allSettled(r.map(p=>{if(p=ge(p),p in z)return;z[p]=!0;const m=p.endsWith(".css"),b=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${b}`))return;const g=document.createElement("link");if(g.rel=m?"stylesheet":pe,m||(g.as="script"),g.crossOrigin="",g.href=p,u&&g.setAttribute("nonce",u),document.head.appendChild(g),m)return new Promise((_,y)=>{g.addEventListener("load",_),g.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${p}`)))})}))}function c(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return a.then(l=>{for(const u of l||[])u.status==="rejected"&&c(u.reason);return n().catch(c)})};function G(i){const n=[];let r="",h=!1;for(let a=0;a<i.length;a+=1){const c=i[a];if(c==='"'){h&&i[a+1]==='"'?(r+='"',a+=1):h=!h;continue}if(c===","&&!h){n.push(r),r="";continue}r+=c}return n.push(r),n.map(a=>a.trim())}function K(i){if(!i)return"";const n=i.trim();return n.startsWith('"')&&n.endsWith('"')?n.slice(1,-1).replace(/""/g,'"').trim():n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1).trim():n}function ve(i){const n=i.split(/\r?\n/).filter(h=>h.trim().length>0);if(n.length===0)return[];const r=G(n.shift()).map(K);return n.map(h=>{const a=G(h).map(K),c={};return r.forEach((l,u)=>{c[l]=a[u]??""}),c})}async function S(i){const n=await fetch(i,{cache:"no-store"});if(!n.ok)throw new Error(`Failed to download ${i}`);const r=await n.text();return ve(r)}async function fe(){const[i,n,r,h,a,c,l,u,p,m]=await Promise.all([S("/masters/locations_buildings.csv"),S("/masters/locations_floors.csv"),S("/masters/locations_departments.csv"),S("/masters/locations_divisions.csv"),S("/masters/locations_rooms.csv"),S("/masters/product_categories.csv"),S("/masters/product_subcategories.csv"),S("/masters/product_items.csv"),S("/masters/product_makers.csv"),S("/masters/product_models.csv")]),b=i.map(s=>({id:s.id,name:s.name})),g=n.map(s=>({id:s.id,buildingId:s.buildingId,name:s.name})),_=r.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,name:s.name})),y=h.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,name:s.name})),j=a.map(s=>({id:s.roomId??s.id,name:s.name,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,divisionId:s.divisionId})),w=c.map(s=>({id:s.id,name:s.name})),I=l.map(s=>({id:s.id,categoryId:s.categoryId,name:s.name})),N=u.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,name:s.name})),P=p.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,name:s.name})),k=m.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,name:s.name}));await o.transaction("rw",o.location_buildings,o.location_floors,o.location_departments,o.location_divisions,o.location_rooms,o.product_categories,o.product_subcategories,o.product_items,o.product_makers,o.product_models,o.settings,async()=>{await Promise.all([o.location_buildings.clear(),o.location_floors.clear(),o.location_departments.clear(),o.location_divisions.clear(),o.location_rooms.clear(),o.product_categories.clear(),o.product_subcategories.clear(),o.product_items.clear(),o.product_makers.clear(),o.product_models.clear()]),await o.location_buildings.bulkPut(b),await o.location_floors.bulkPut(g),await o.location_departments.bulkPut(_),await o.location_divisions.bulkPut(y),await o.location_rooms.bulkPut(j),await o.product_categories.bulkPut(w),await o.product_subcategories.bulkPut(I),await o.product_items.bulkPut(N),await o.product_makers.bulkPut(P),await o.product_models.bulkPut(k),await o.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function ye(){const i=$(),n=J(),r=F(d=>d.completedCount),h=F(d=>d.purgeCompleted),[a,c]=v.useState(!1),[l,u]=v.useState(null),[p,m]=v.useState([]),[b,g]=v.useState(null),[_,y]=v.useState("unknown"),[j,w]=v.useState(!1),[I,N]=v.useState(!1),[P,k]=v.useState(!1),s=async()=>{const d=[o.location_buildings,o.location_floors,o.location_departments,o.location_divisions,o.location_rooms,o.product_categories,o.product_subcategories,o.product_items,o.product_makers,o.product_models,o.survey_masters,o.indices];await o.transaction("rw",...d,o.settings,async()=>{await Promise.all(d.map(t=>t.clear())),await o.settings.delete("mastersDownloadedAt")})};v.useEffect(()=>{const d=sessionStorage.getItem("cameraPermission");if(d==="granted"||d==="denied"){const t=d==="granted";y(t?"granted":"denied"),w(t)}},[]),v.useEffect(()=>{let d=!1;return N(!1),u(null),(async()=>{try{await s(),d||m(f=>[...f,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(f){const T=f instanceof Error?f.message:String(f);d||m(H=>[...H,"マスタデータの初期化に失敗しました: "+T])}})(),()=>{d=!0}},[]);const E=async()=>{if(!a){c(!0),g(null),N(!1),w(!1),k(!1),u(null),m(d=>[...d,"マスタCSVの読み込みを開始しました"]);try{m(t=>[...t,"既存のマスタデータをクリアしています…"]),await s(),m(t=>[...t,"既存のマスタデータをクリアしました。"]),await Promise.all([A(()=>import("./survey-ChHo4KGa.js").then(t=>t.b),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.c),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.f),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.g),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(t=>t.q),__vite__mapDeps([0,1,2,3]))]),await fe();const d=new Date().toISOString();u(d),N(!0),m(t=>[...t,"マスタCSVをローカルDBへ保存しました"]),m(t=>[...t,"カメラアクセスをリクエストします"]);try{await ae(),y("granted"),w(!0),m(t=>[...t,"カメラアクセスを取得しました"])}catch(t){const f=t instanceof Error?t.message:String(t),H=sessionStorage.getItem("cameraPermission")==="denied";y(H?"denied":"unknown"),w(!1),m(X=>[...X,`カメラアクセスに失敗しました: ${f}`])}m(t=>[...t,"Tesseract OCRの準備を行っています…"]);try{await oe(),k(!0),m(t=>[...t,"Tesseract OCRの準備が完了しました"])}catch(t){const f=t instanceof Error?t.message:String(t);k(!1),m(T=>[...T,`Tesseract OCRの準備に失敗しました: ${f}`])}}catch(d){const t=d instanceof Error?d.message:String(d);g(t),N(!1),w(!1),k(!1),m(f=>[...f,`エラー: ${t}`])}finally{c(!1)}}},x=()=>{sessionStorage.setItem("surveyActive","1"),i("/survey/department")},D=async()=>{if(n){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),m(d=>[...d,"送信処理（ダミー）: Phase2で実装予定です"]);try{const d=await h();d>0?m(t=>[...t,`ローカルに保存されていた作業済みデータを削除しました（${d}件）`]):m(t=>[...t,"削除対象の作業済みデータはありませんでした"])}catch(d){const t=d instanceof Error?d.message:String(d);m(f=>[...f,`作業済みデータ削除時にエラーが発生しました: ${t}`])}}},L=I&&_!=="denied"&&P,W=sessionStorage.getItem("visitedDepartment")==="1"&&r>0,R=l?new Date(l).toLocaleString():"未ダウンロード",B=n?"オンライン":"オフライン",O=_==="granted"?"利用可能":_==="denied"?"拒否されています":"未確認";return e.jsx("div",{className:"page survey-home-page",children:e.jsxs("div",{className:"survey-home",children:[e.jsxs("section",{className:"survey-home__hero",children:[e.jsxs("div",{className:"survey-home__hero-top",children:[e.jsx("span",{className:"survey-home__label",children:"現地登録モード"}),e.jsx("h1",{className:"survey-home__title",children:"現有資産登録"}),e.jsx("p",{className:"survey-home__description",children:"オフライン環境での現地登録を行う前に、マスタデータのダウンロードとカメラアクセスの事前確認を完了してください。 調査開始後は /survey/ 配下の画面のみオフライン遷移が許可されます。"})]}),e.jsxs("div",{className:"survey-home__hero-actions",children:[e.jsx("button",{type:"button",onClick:E,disabled:a,children:"事前ダウンロードを実行"}),I&&e.jsxs("span",{className:"survey-home__badge",children:["最終更新: ",R]}),_==="granted"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可済み"}),_==="denied"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可なし"})]}),b&&e.jsxs("div",{className:"survey-home__badge",style:{background:"rgba(239, 68, 68, 0.2)",color:"#b91c1c"},children:["エラー: ",b]})]}),e.jsxs("section",{className:"survey-home__status-grid",children:[e.jsxs("div",{className:`survey-home__status-card${I?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"事前ダウンロード"}),e.jsx("strong",{children:I?"完了":"未実行"}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"通信状態"}),e.jsx("strong",{children:B}),e.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"作業済み件数"}),e.jsxs("strong",{children:[r,"件"]}),e.jsx("span",{children:"調査完了後にサーバー送信予定（Phase2）"})]}),e.jsxs("div",{className:`survey-home__status-card${j?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"カメラステータス"}),e.jsx("strong",{children:O}),e.jsx("span",{children:"QRコード読取と撮影に使用します"})]})]}),e.jsxs("section",{className:"survey-home__actions",children:[e.jsxs("div",{className:"survey-home__actions-text",children:[e.jsx("h3",{children:"現地登録を開始する"}),e.jsx("p",{children:"部署入力 → QRコード読取 → 写真撮影 → 商品登録の順に進みます。"})]}),e.jsxs("div",{className:"survey-home__actions-buttons",children:[e.jsx("button",{type:"button",onClick:x,disabled:!L,children:"調査を開始"}),W&&e.jsx("button",{type:"button",className:"ghost",onClick:D,disabled:!n,children:"調査完了（送信想定）"})]})]}),e.jsxs("section",{className:"survey-home__log",children:[e.jsxs("div",{className:"survey-home__log-header",children:[e.jsx("h2",{children:"アクティビティログ"}),e.jsxs("span",{children:[p.length," 件"]})]}),e.jsxs("div",{className:"survey-home__log-body",children:[p.length===0&&e.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),p.map((d,t)=>{const f=d.startsWith("エラー")||d.includes("失敗")||d.includes("エラーが発生");return e.jsx("div",{className:`survey-home__log-line${f?" is-error":""}`,children:d},t)})]})]})]})})}function _e(){const i=$(),[n,r]=v.useState("user@example.com"),[h,a]=v.useState("password"),c=typeof window<"u"?sessionStorage.getItem("mockToken"):null;v.useEffect(()=>{c&&i("/survey/home",{replace:!0})},[c,i]);const l=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",n.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),i("/survey/home",{replace:!0})};return e.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[e.jsx("h2",{children:"ログイン"}),e.jsxs("form",{className:"grid",onSubmit:l,children:[e.jsxs("label",{children:["メールアドレス",e.jsx("input",{value:n,onChange:u=>r(u.target.value),autoComplete:"username"})]}),e.jsxs("label",{children:["パスワード",e.jsx("input",{value:h,onChange:u=>a(u.target.value),type:"password",autoComplete:"current-password"})]}),e.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function C(i){var l;const r=i.document.getElementById("login-id"),h=((l=r==null?void 0:r.value)==null?void 0:l.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",a=i.selectedHospitalName,c=typeof a=="string"&&a.trim().length>0?a.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",h),c?window.sessionStorage.setItem("mockHospitalName",c):window.sessionStorage.removeItem("mockHospitalName")}function V({mode:i="login"}){const n=v.useRef(null),r=$();return v.useEffect(()=>{const a=n.current;if(!a)return;const c=()=>{const l=a.contentWindow;if(!l)return;const u=l.document,p=l,m=s=>{window.location.pathname!==s&&r(s,{replace:!0})},b=()=>{try{typeof p.hideLocationInputScreen=="function"&&p.hideLocationInputScreen()}catch{}C(l),r("/survey/home")},g=(s,E)=>{const x=p[s];p[s]=E(typeof x=="function"?x:void 0)};g("handleLogin",s=>function(x){var L;s&&s.call(this,x),C(l),(((L=u.getElementById("login-id"))==null?void 0:L.value)??"").includes("@hospital")?k():P()}),g("selectHospital",s=>function(...x){s&&s.apply(this,x),C(l)}),g("showAssetListScreen",s=>function(...x){s&&s.apply(this,x),C(l),m("/mock/assets")}),g("hideAssetListScreen",s=>function(...x){s&&s.apply(this,x),P()}),g("showLocationInputScreen",()=>function(){b()}),g("handleNext",()=>function(){var R,B,O,d,t,f;const E=((R=u.getElementById("surveyDate"))==null?void 0:R.textContent)??"",x=((B=u.getElementById("categoryInput"))==null?void 0:B.value)??"",D=((O=u.getElementById("buildingSelect"))==null?void 0:O.value)??"",L=((d=u.getElementById("floorSelect"))==null?void 0:d.value)??"",q=((t=u.getElementById("departmentSelect"))==null?void 0:t.value)??"",W=((f=u.getElementById("sectionSelect"))==null?void 0:f.value)??"";console.log("調査場所データ:",{surveyDate:E,category:x,building:D,floor:L,department:q,section:W}),b()}),i!=="login"&&C(l);const _=u.getElementById("loginPage"),y=u.getElementById("mainLayout"),j=u.getElementById("assetListScreen"),w="/poc-survey-offline-mock/",I=()=>window.location.pathname.startsWith(`${w}mock`),N=()=>{_&&(_.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.remove("active"),I()||r("/mock/login",{replace:!0}),m("/mock/login")},P=()=>{_&&(_.style.display="none"),j&&j.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),I()||r("/mock/dashboard",{replace:!0}),m("/mock/dashboard")},k=()=>{const s=u.getElementById("login-id");s&&!s.value.includes("@hospital")&&(s.value="demo@hospital.example"),typeof p.showAssetListScreen=="function"?p.showAssetListScreen():(_&&(_.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.add("active")),I()||r("/mock/assets",{replace:!0}),m("/mock/assets")};i==="login"?N():i==="dashboard"?P():i==="assets"&&k()};return a.addEventListener("load",c),()=>{a.removeEventListener("load",c)}},[i,r]),e.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:e.jsx("iframe",{ref:n,title:"医療コンサル管理システム モック",src:"/poc-survey-offline-mock/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const xe=[{path:"/",children:[{index:!0,element:e.jsx(U,{to:"/login",replace:!0})},{path:"mock/login",element:e.jsx(V,{mode:"login"})},{path:"mock/dashboard",element:e.jsx(V,{mode:"dashboard"})},{path:"mock/assets",element:e.jsx(V,{mode:"assets"})},{path:"login",element:e.jsx(_e,{})},{element:e.jsx(he,{}),children:[{path:"home",element:e.jsx(U,{to:"/survey/home",replace:!0})},{path:"survey/home",element:e.jsx(ye,{})},{path:"survey/all",element:e.jsx(re,{})},{path:"survey/department",element:e.jsx(ie,{})},{path:"survey/label",element:e.jsx(ce,{})},{path:"survey/asset",element:e.jsx(le,{})},{path:"survey/product",element:e.jsx(de,{})}]}]}],be=ee(xe,{basename:"/poc-survey-offline-mock/"}),je="/poc-survey-offline-mock/";if("serviceWorker"in navigator)navigator.serviceWorker.register(`${je}sw.js`).then(()=>navigator.serviceWorker.ready).then(()=>{ue(),M()}).catch(()=>{try{M()}catch{}});else try{M()}catch{}se.createRoot(document.getElementById("root")).render(e.jsx(te.StrictMode,{children:e.jsx(ne,{router:be})}));
