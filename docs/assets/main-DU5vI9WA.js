const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-CPRs5s4G.js","assets/vendor-5jQwBCrV.js","assets/vendor-dexie-DWlydIdn.js","assets/vendor-zxing-DcYOnkv9.js"])))=>i.map(i=>d[i]);
import{r as g,j as t,N as V,O as Z,u as q,b as ee,d as te,R as se,e as ne}from"./vendor-5jQwBCrV.js";import{u as F,d as a,e as oe,a as ae,S as re,D as ie,L as ce,A as le,P as de,w as ue,p as H}from"./survey-CPRs5s4G.js";import"./vendor-dexie-DWlydIdn.js";import"./vendor-zxing-DcYOnkv9.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&m(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function m(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();function X(){const[i,s]=g.useState(navigator.onLine);return g.useEffect(()=>{const r=()=>s(!0),m=()=>s(!1);return window.addEventListener("online",r),window.addEventListener("offline",m),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",m)}},[]),i}function me(){const[i,s]=g.useState(0),[r,m]=g.useState(0);return g.useEffect(()=>{let o=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const c=await navigator.storage.estimate();s((c.usage||0)/1048576),m((c.quota||0)/1048576)}},1500);return()=>clearInterval(o)},[]),{usedMB:i,quotaMB:r}}function z(i,s){if(typeof window>"u")return s;const r=sessionStorage.getItem(i);return r&&r.trim().length>0?r:s}function he(){if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return t.jsx(V,{to:"/",replace:!0});const s=z("mockHospitalName",""),r=z("mockUserEmail","survey.operator@example.com"),m=X(),{usedMB:o,quotaMB:c}=me(),d=F(p=>p.completedCount),u=s.trim().length>0;return t.jsxs("div",{className:"app survey-app",children:[t.jsxs("header",{className:"survey-header",children:[t.jsxs("div",{className:"survey-header__top",children:[t.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),t.jsx("p",{className:"survey-header__user",children:r})]}),u&&t.jsx("h1",{className:"survey-header__title",children:s}),t.jsxs("div",{className:"survey-header__stats",children:[t.jsxs("div",{className:`survey-badge${m?" is-online":" is-offline"}`,children:[t.jsx("span",{className:"survey-badge__label",children:"通信状態"}),t.jsx("span",{className:"survey-badge__value",children:m?"オンライン":"オフライン"})]}),t.jsxs("div",{className:"survey-badge",children:[t.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),t.jsxs("span",{className:"survey-badge__value",children:[o.toFixed(1)," / ",c.toFixed(1)," MB"]})]}),t.jsxs("div",{className:"survey-badge",children:[t.jsx("span",{className:"survey-badge__label",children:"作業済み"}),t.jsxs("span",{className:"survey-badge__value",children:[d," 件"]})]})]})]}),t.jsx("main",{className:"survey-main",children:t.jsx("div",{className:"survey-main__inner",children:t.jsx(Z,{})})})]})}const pe="modulepreload",fe=function(i){return"/poc-survey-offline-mock/"+i},G={},R=function(s,r,m){let o=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),u=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));o=Promise.allSettled(r.map(p=>{if(p=fe(p),p in G)return;G[p]=!0;const h=p.endsWith(".css"),S=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${S}`))return;const f=document.createElement("link");if(f.rel=h?"stylesheet":pe,h||(f.as="script"),f.crossOrigin="",f.href=p,u&&f.setAttribute("nonce",u),document.head.appendChild(f),h)return new Promise((_,y)=>{f.addEventListener("load",_),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${p}`)))})}))}function c(d){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=d,window.dispatchEvent(u),!u.defaultPrevented)throw d}return o.then(d=>{for(const u of d||[])u.status==="rejected"&&c(u.reason);return s().catch(c)})};function K(i){const s=[];let r="",m=!1;for(let o=0;o<i.length;o+=1){const c=i[o];if(c==='"'){m&&i[o+1]==='"'?(r+='"',o+=1):m=!m;continue}if(c===","&&!m){s.push(r),r="";continue}r+=c}return s.push(r),s.map(o=>o.trim())}function J(i){if(!i)return"";const s=i.trim();return s.startsWith('"')&&s.endsWith('"')?s.slice(1,-1).replace(/""/g,'"').trim():s.startsWith("'")&&s.endsWith("'")?s.slice(1,-1).trim():s}function ge(i){const s=i.split(/\r?\n/).filter(m=>m.trim().length>0);if(s.length===0)return[];const r=K(s.shift()).map(J);return s.map(m=>{const o=K(m).map(J),c={};return r.forEach((d,u)=>{c[d]=o[u]??""}),c})}const U="/poc-survey-offline-mock/";function ve(i){const s=i.startsWith("/")?i.slice(1):i;if(typeof window>"u"||typeof window.location>"u")return`${U}${s}`;try{const r=new URL(U,window.location.origin);return new URL(s,r).toString()}catch{return`${U}${s}`}}async function b(i){const s=ve(i),r=await fetch(s,{cache:"no-store"});if(!r.ok)throw new Error(`Failed to download ${i}`);const m=await r.text();return ge(m)}async function ye(){const[i,s,r,m,o,c,d,u,p,h]=await Promise.all([b("/masters/locations_buildings.csv"),b("/masters/locations_floors.csv"),b("/masters/locations_departments.csv"),b("/masters/locations_divisions.csv"),b("/masters/locations_rooms.csv"),b("/masters/product_categories.csv"),b("/masters/product_subcategories.csv"),b("/masters/product_items.csv"),b("/masters/product_makers.csv"),b("/masters/product_models.csv")]),S=i.map(e=>({id:e.id,name:e.name})),f=s.map(e=>({id:e.id,buildingId:e.buildingId,name:e.name})),_=r.map(e=>({id:e.id,buildingId:e.buildingId,floorId:e.floorId,name:e.name})),y=m.map(e=>({id:e.id,buildingId:e.buildingId,floorId:e.floorId,departmentId:e.departmentId,name:e.name})),w=o.map(e=>({id:e.roomId??e.id,name:e.name,buildingId:e.buildingId,floorId:e.floorId,departmentId:e.departmentId,divisionId:e.divisionId})),I=c.map(e=>({id:e.id,name:e.name})),j=d.map(e=>({id:e.id,categoryId:e.categoryId,name:e.name})),P=u.map(e=>({id:e.id,categoryId:e.categoryId,subcategoryId:e.subcategoryId,name:e.name})),L=p.map(e=>({id:e.id,categoryId:e.categoryId,subcategoryId:e.subcategoryId,itemId:e.itemId,name:e.name})),k=h.map(e=>({id:e.id,categoryId:e.categoryId,subcategoryId:e.subcategoryId,itemId:e.itemId,makerId:e.makerId,name:e.name}));await a.transaction("rw",a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.settings,async()=>{await Promise.all([a.location_buildings.clear(),a.location_floors.clear(),a.location_departments.clear(),a.location_divisions.clear(),a.location_rooms.clear(),a.product_categories.clear(),a.product_subcategories.clear(),a.product_items.clear(),a.product_makers.clear(),a.product_models.clear()]),await a.location_buildings.bulkPut(S),await a.location_floors.bulkPut(f),await a.location_departments.bulkPut(_),await a.location_divisions.bulkPut(y),await a.location_rooms.bulkPut(w),await a.product_categories.bulkPut(I),await a.product_subcategories.bulkPut(j),await a.product_items.bulkPut(P),await a.product_makers.bulkPut(L),await a.product_models.bulkPut(k),await a.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function _e(){const i=q(),s=X(),r=F(l=>l.completedCount),m=F(l=>l.purgeCompleted),[o,c]=g.useState(!1),[d,u]=g.useState(null),[p,h]=g.useState([]),[S,f]=g.useState(null),[_,y]=g.useState("unknown"),[w,I]=g.useState(!1),[j,P]=g.useState(!1),[L,k]=g.useState(!1),e=async()=>{const l=[a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.survey_masters,a.indices];await a.transaction("rw",...l,a.settings,async()=>{await Promise.all(l.map(n=>n.clear())),await a.settings.delete("mastersDownloadedAt")})};g.useEffect(()=>{const l=sessionStorage.getItem("cameraPermission");if(l==="granted"||l==="denied"){const n=l==="granted";y(n?"granted":"denied"),I(n)}},[]),g.useEffect(()=>{let l=!1;return P(!1),u(null),(async()=>{try{await e(),l||h(v=>[...v,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(v){const $=v instanceof Error?v.message:String(v);l||h(W=>[...W,"マスタデータの初期化に失敗しました: "+$])}})(),()=>{l=!0}},[]);const E=async()=>{if(!o){c(!0),f(null),P(!1),I(!1),k(!1),u(null),h(l=>[...l,"マスタCSVの読み込みを開始しました"]);try{h(n=>[...n,"既存のマスタデータをクリアしています…"]),await e(),h(n=>[...n,"既存のマスタデータをクリアしました。"]),await Promise.all([R(()=>import("./survey-CPRs5s4G.js").then(n=>n.b),__vite__mapDeps([0,1,2,3])),R(()=>import("./survey-CPRs5s4G.js").then(n=>n.c),__vite__mapDeps([0,1,2,3])),R(()=>import("./survey-CPRs5s4G.js").then(n=>n.f),__vite__mapDeps([0,1,2,3])),R(()=>import("./survey-CPRs5s4G.js").then(n=>n.g),__vite__mapDeps([0,1,2,3])),R(()=>import("./survey-CPRs5s4G.js").then(n=>n.q),__vite__mapDeps([0,1,2,3]))]),await ye();const l=new Date().toISOString();u(l),P(!0),h(n=>[...n,"マスタCSVをローカルDBへ保存しました"]),h(n=>[...n,"カメラアクセスをリクエストします"]);try{await oe(),y("granted"),I(!0),h(n=>[...n,"カメラアクセスを取得しました"])}catch(n){const v=n instanceof Error?n.message:String(n),W=sessionStorage.getItem("cameraPermission")==="denied";y(W?"denied":"unknown"),I(!1),h(Y=>[...Y,`カメラアクセスに失敗しました: ${v}`])}h(n=>[...n,"Tesseract OCRの準備を行っています…"]);try{await ae(),k(!0),h(n=>[...n,"Tesseract OCRの準備が完了しました"])}catch(n){const v=n instanceof Error?n.message:String(n);k(!1),h($=>[...$,`Tesseract OCRの準備に失敗しました: ${v}`])}}catch(l){const n=l instanceof Error?l.message:String(l);f(n),P(!1),I(!1),k(!1),h(v=>[...v,`エラー: ${n}`])}finally{c(!1)}}},x=()=>{sessionStorage.setItem("surveyActive","1"),i("/survey/department")},C=async()=>{if(s){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),h(l=>[...l,"送信処理（ダミー）: Phase2で実装予定です"]);try{const l=await m();l>0?h(n=>[...n,`ローカルに保存されていた作業済みデータを削除しました（${l}件）`]):h(n=>[...n,"削除対象の作業済みデータはありませんでした"])}catch(l){const n=l instanceof Error?l.message:String(l);h(v=>[...v,`作業済みデータ削除時にエラーが発生しました: ${n}`])}}},N=j&&_!=="denied"&&L,T=sessionStorage.getItem("visitedDepartment")==="1"&&r>0,D=d?new Date(d).toLocaleString():"未ダウンロード",B=s?"オンライン":"オフライン",O=_==="granted"?"利用可能":_==="denied"?"拒否されています":"未確認";return t.jsxs("div",{className:"page survey-home-page",children:[t.jsxs("div",{className:"survey-home",children:[t.jsxs("section",{className:"survey-home__status-grid",children:[t.jsxs("div",{className:`survey-home__status-card${j?"":" status-card--warn"}`,children:[t.jsx("h3",{children:"事前ダウンロード"}),t.jsx("strong",{children:j?"完了":"未実行"}),t.jsx("span",{children:D})]}),t.jsxs("div",{className:"survey-home__status-card",children:[t.jsx("h3",{children:"通信状態"}),t.jsx("strong",{children:B}),t.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),t.jsxs("div",{className:`survey-home__status-card${w?"":" status-card--warn"}`,children:[t.jsx("h3",{children:"カメラステータス"}),t.jsx("strong",{children:O}),t.jsx("span",{children:"QRコード読取と撮影に使用します"})]}),S&&t.jsxs("div",{className:"survey-home__status-card status-card--warn",children:[t.jsx("h3",{children:"エラー"}),t.jsx("strong",{children:"発生中"}),t.jsx("span",{children:S})]})]}),t.jsxs("section",{className:"survey-home__log",children:[t.jsxs("div",{className:"survey-home__log-header",children:[t.jsx("h2",{children:"アクティビティログ"}),t.jsxs("span",{children:[p.length," 件"]})]}),t.jsxs("div",{className:"survey-home__log-body",children:[p.length===0&&t.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),p.map((l,n)=>{const v=l.startsWith("エラー")||l.includes("失敗")||l.includes("エラーが発生");return t.jsx("div",{className:`survey-home__log-line${v?" is-error":""}`,children:l},n)})]})]})]}),t.jsxs("footer",{className:"page-footer",children:[t.jsx("button",{type:"button",className:"ghost",onClick:E,disabled:o,children:"事前ダウンロード"}),t.jsx("button",{type:"button",onClick:x,disabled:!N,children:"調査開始"}),t.jsx("button",{type:"button",onClick:C,disabled:!s||!T,children:"調査完了"})]})]})}function xe(){const i=q(),[s,r]=g.useState("user@example.com"),[m,o]=g.useState("password"),c=typeof window<"u"?sessionStorage.getItem("mockToken"):null;g.useEffect(()=>{c&&i("/survey/home",{replace:!0})},[c,i]);const d=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",s.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),i("/survey/home",{replace:!0})};return t.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:t.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[t.jsx("h2",{children:"ログイン"}),t.jsxs("form",{className:"grid",onSubmit:d,children:[t.jsxs("label",{children:["メールアドレス",t.jsx("input",{value:s,onChange:u=>r(u.target.value),autoComplete:"username"})]}),t.jsxs("label",{children:["パスワード",t.jsx("input",{value:m,onChange:u=>o(u.target.value),type:"password",autoComplete:"current-password"})]}),t.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function A(i){var d;const r=i.document.getElementById("login-id"),m=((d=r==null?void 0:r.value)==null?void 0:d.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",o=i.selectedHospitalName,c=typeof o=="string"&&o.trim().length>0?o.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",m),c?window.sessionStorage.setItem("mockHospitalName",c):window.sessionStorage.removeItem("mockHospitalName")}function M({mode:i="login"}){const s=g.useRef(null),r=q();return g.useEffect(()=>{const o=s.current;if(!o)return;const c=()=>{const d=o.contentWindow;if(!d)return;const u=d.document,p=d,h=e=>{window.location.pathname!==e&&r(e,{replace:!0})},S=()=>{try{typeof p.hideLocationInputScreen=="function"&&p.hideLocationInputScreen()}catch{}A(d),r("/survey/home")},f=(e,E)=>{const x=p[e];p[e]=E(typeof x=="function"?x:void 0)};f("handleLogin",e=>function(x){var N;e&&e.call(this,x),A(d),(((N=u.getElementById("login-id"))==null?void 0:N.value)??"").includes("@hospital")?k():L()}),f("selectHospital",e=>function(...x){e&&e.apply(this,x),A(d)}),f("showAssetListScreen",e=>function(...x){e&&e.apply(this,x),A(d),h("/mock/assets")}),f("hideAssetListScreen",e=>function(...x){e&&e.apply(this,x),L()}),f("showLocationInputScreen",()=>function(){S()}),f("handleNext",()=>function(){var D,B,O,l,n,v;const E=((D=u.getElementById("surveyDate"))==null?void 0:D.textContent)??"",x=((B=u.getElementById("categoryInput"))==null?void 0:B.value)??"",C=((O=u.getElementById("buildingSelect"))==null?void 0:O.value)??"",N=((l=u.getElementById("floorSelect"))==null?void 0:l.value)??"",Q=((n=u.getElementById("departmentSelect"))==null?void 0:n.value)??"",T=((v=u.getElementById("sectionSelect"))==null?void 0:v.value)??"";console.log("調査場所データ:",{surveyDate:E,category:x,building:C,floor:N,department:Q,section:T}),S()}),i!=="login"&&A(d);const _=u.getElementById("loginPage"),y=u.getElementById("mainLayout"),w=u.getElementById("assetListScreen"),I="/poc-survey-offline-mock/",j=()=>window.location.pathname.startsWith(`${I}mock`),P=()=>{_&&(_.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),w&&w.classList.remove("active"),j()||r("/mock/login",{replace:!0}),h("/mock/login")},L=()=>{_&&(_.style.display="none"),w&&w.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),j()||r("/mock/dashboard",{replace:!0}),h("/mock/dashboard")},k=()=>{const e=u.getElementById("login-id");e&&!e.value.includes("@hospital")&&(e.value="demo@hospital.example"),typeof p.showAssetListScreen=="function"?p.showAssetListScreen():(_&&(_.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),w&&w.classList.add("active")),j()||r("/mock/assets",{replace:!0}),h("/mock/assets")};i==="login"?P():i==="dashboard"?L():i==="assets"&&k()};return o.addEventListener("load",c),()=>{o.removeEventListener("load",c)}},[i,r]),t.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:t.jsx("iframe",{ref:s,title:"医療コンサル管理システム モック",src:"/poc-survey-offline-mock/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const we=[{path:"/",children:[{index:!0,element:t.jsx(V,{to:"/login",replace:!0})},{path:"mock/login",element:t.jsx(M,{mode:"login"})},{path:"mock/dashboard",element:t.jsx(M,{mode:"dashboard"})},{path:"mock/assets",element:t.jsx(M,{mode:"assets"})},{path:"login",element:t.jsx(xe,{})},{element:t.jsx(he,{}),children:[{path:"home",element:t.jsx(V,{to:"/survey/home",replace:!0})},{path:"survey/home",element:t.jsx(_e,{})},{path:"survey/all",element:t.jsx(re,{})},{path:"survey/department",element:t.jsx(ie,{})},{path:"survey/label",element:t.jsx(ce,{})},{path:"survey/asset",element:t.jsx(le,{})},{path:"survey/product",element:t.jsx(de,{})}]}]}],be=ee(we,{basename:"/poc-survey-offline-mock/"}),Se="/poc-survey-offline-mock/";if("serviceWorker"in navigator)navigator.serviceWorker.register(`${Se}sw.js`).then(()=>navigator.serviceWorker.ready).then(()=>{ue(),H()}).catch(()=>{try{H()}catch{}});else try{H()}catch{}te.createRoot(document.getElementById("root")).render(t.jsx(se.StrictMode,{children:t.jsx(ne,{router:be})}));
