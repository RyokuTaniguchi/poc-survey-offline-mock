const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-CUtG2NUX.js","assets/vendor-5jQwBCrV.js","assets/vendor-dexie-DWlydIdn.js","assets/vendor-zxing-DcYOnkv9.js"])))=>i.map(i=>d[i]);
import{r as f,j as e,N as V,O as Z,u as q,b as ee,d as se,R as te,e as ne}from"./vendor-5jQwBCrV.js";import{u as F,d as a,e as oe,a as ae,S as re,D as ie,L as ce,A as le,P as de,w as ue,p as H}from"./survey-CUtG2NUX.js";import"./vendor-dexie-DWlydIdn.js";import"./vendor-zxing-DcYOnkv9.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&m(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function m(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();function X(){const[i,t]=f.useState(navigator.onLine);return f.useEffect(()=>{const r=()=>t(!0),m=()=>t(!1);return window.addEventListener("online",r),window.addEventListener("offline",m),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",m)}},[]),i}function me(){const[i,t]=f.useState(0),[r,m]=f.useState(0);return f.useEffect(()=>{let o=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const c=await navigator.storage.estimate();t((c.usage||0)/1048576),m((c.quota||0)/1048576)}},1500);return()=>clearInterval(o)},[]),{usedMB:i,quotaMB:r}}function z(i,t){if(typeof window>"u")return t;const r=sessionStorage.getItem(i);return r&&r.trim().length>0?r:t}function he(){if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return e.jsx(V,{to:"/",replace:!0});const t=z("mockHospitalName",""),r=z("mockUserEmail","survey.operator@example.com"),m=X(),{usedMB:o,quotaMB:c}=me(),d=F(p=>p.completedCount),u=t.trim().length>0;return e.jsxs("div",{className:"app survey-app",children:[e.jsxs("header",{className:"survey-header",children:[e.jsxs("div",{className:"survey-header__left",children:[e.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),u&&e.jsx("h1",{className:"survey-header__title",children:t}),e.jsx("p",{className:"survey-header__user",children:r})]}),e.jsxs("div",{className:"survey-header__stats",children:[e.jsxs("div",{className:`survey-badge${m?" is-online":" is-offline"}`,children:[e.jsx("span",{className:"survey-badge__label",children:"通信状態"}),e.jsx("span",{className:"survey-badge__value",children:m?"オンライン":"オフライン"})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),e.jsxs("span",{className:"survey-badge__value",children:[o.toFixed(1)," / ",c.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"作業済み"}),e.jsxs("span",{className:"survey-badge__value",children:[d," 件"]})]})]})]}),e.jsx("main",{className:"survey-main",children:e.jsx("div",{className:"survey-main__inner",children:e.jsx(Z,{})})})]})}const pe="modulepreload",ge=function(i){return"/poc-survey-offline-mock/"+i},G={},A=function(t,r,m){let o=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),u=(d==null?void 0:d.nonce)||(d==null?void 0:d.getAttribute("nonce"));o=Promise.allSettled(r.map(p=>{if(p=ge(p),p in G)return;G[p]=!0;const h=p.endsWith(".css"),S=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${S}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":pe,h||(g.as="script"),g.crossOrigin="",g.href=p,u&&g.setAttribute("nonce",u),document.head.appendChild(g),h)return new Promise((_,y)=>{g.addEventListener("load",_),g.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${p}`)))})}))}function c(d){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=d,window.dispatchEvent(u),!u.defaultPrevented)throw d}return o.then(d=>{for(const u of d||[])u.status==="rejected"&&c(u.reason);return t().catch(c)})};function K(i){const t=[];let r="",m=!1;for(let o=0;o<i.length;o+=1){const c=i[o];if(c==='"'){m&&i[o+1]==='"'?(r+='"',o+=1):m=!m;continue}if(c===","&&!m){t.push(r),r="";continue}r+=c}return t.push(r),t.map(o=>o.trim())}function J(i){if(!i)return"";const t=i.trim();return t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1).replace(/""/g,'"').trim():t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1).trim():t}function fe(i){const t=i.split(/\r?\n/).filter(m=>m.trim().length>0);if(t.length===0)return[];const r=K(t.shift()).map(J);return t.map(m=>{const o=K(m).map(J),c={};return r.forEach((d,u)=>{c[d]=o[u]??""}),c})}const U="/poc-survey-offline-mock/";function ve(i){const t=i.startsWith("/")?i.slice(1):i;if(typeof window>"u"||typeof window.location>"u")return`${U}${t}`;try{const r=new URL(U,window.location.origin);return new URL(t,r).toString()}catch{return`${U}${t}`}}async function w(i){const t=ve(i),r=await fetch(t,{cache:"no-store"});if(!r.ok)throw new Error(`Failed to download ${i}`);const m=await r.text();return fe(m)}async function ye(){const[i,t,r,m,o,c,d,u,p,h]=await Promise.all([w("/masters/locations_buildings.csv"),w("/masters/locations_floors.csv"),w("/masters/locations_departments.csv"),w("/masters/locations_divisions.csv"),w("/masters/locations_rooms.csv"),w("/masters/product_categories.csv"),w("/masters/product_subcategories.csv"),w("/masters/product_items.csv"),w("/masters/product_makers.csv"),w("/masters/product_models.csv")]),S=i.map(s=>({id:s.id,name:s.name})),g=t.map(s=>({id:s.id,buildingId:s.buildingId,name:s.name})),_=r.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,name:s.name})),y=m.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,name:s.name})),b=o.map(s=>({id:s.roomId??s.id,name:s.name,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,divisionId:s.divisionId})),I=c.map(s=>({id:s.id,name:s.name})),j=d.map(s=>({id:s.id,categoryId:s.categoryId,name:s.name})),N=u.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,name:s.name})),P=p.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,name:s.name})),k=h.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,name:s.name}));await a.transaction("rw",a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.settings,async()=>{await Promise.all([a.location_buildings.clear(),a.location_floors.clear(),a.location_departments.clear(),a.location_divisions.clear(),a.location_rooms.clear(),a.product_categories.clear(),a.product_subcategories.clear(),a.product_items.clear(),a.product_makers.clear(),a.product_models.clear()]),await a.location_buildings.bulkPut(S),await a.location_floors.bulkPut(g),await a.location_departments.bulkPut(_),await a.location_divisions.bulkPut(y),await a.location_rooms.bulkPut(b),await a.product_categories.bulkPut(I),await a.product_subcategories.bulkPut(j),await a.product_items.bulkPut(N),await a.product_makers.bulkPut(P),await a.product_models.bulkPut(k),await a.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function _e(){const i=q(),t=X(),r=F(l=>l.completedCount),m=F(l=>l.purgeCompleted),[o,c]=f.useState(!1),[d,u]=f.useState(null),[p,h]=f.useState([]),[S,g]=f.useState(null),[_,y]=f.useState("unknown"),[b,I]=f.useState(!1),[j,N]=f.useState(!1),[P,k]=f.useState(!1),s=async()=>{const l=[a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.survey_masters,a.indices];await a.transaction("rw",...l,a.settings,async()=>{await Promise.all(l.map(n=>n.clear())),await a.settings.delete("mastersDownloadedAt")})};f.useEffect(()=>{const l=sessionStorage.getItem("cameraPermission");if(l==="granted"||l==="denied"){const n=l==="granted";y(n?"granted":"denied"),I(n)}},[]),f.useEffect(()=>{let l=!1;return N(!1),u(null),(async()=>{try{await s(),l||h(v=>[...v,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(v){const $=v instanceof Error?v.message:String(v);l||h(W=>[...W,"マスタデータの初期化に失敗しました: "+$])}})(),()=>{l=!0}},[]);const E=async()=>{if(!o){c(!0),g(null),N(!1),I(!1),k(!1),u(null),h(l=>[...l,"マスタCSVの読み込みを開始しました"]);try{h(n=>[...n,"既存のマスタデータをクリアしています…"]),await s(),h(n=>[...n,"既存のマスタデータをクリアしました。"]),await Promise.all([A(()=>import("./survey-CUtG2NUX.js").then(n=>n.b),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-CUtG2NUX.js").then(n=>n.c),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-CUtG2NUX.js").then(n=>n.f),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-CUtG2NUX.js").then(n=>n.g),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-CUtG2NUX.js").then(n=>n.q),__vite__mapDeps([0,1,2,3]))]),await ye();const l=new Date().toISOString();u(l),N(!0),h(n=>[...n,"マスタCSVをローカルDBへ保存しました"]),h(n=>[...n,"カメラアクセスをリクエストします"]);try{await oe(),y("granted"),I(!0),h(n=>[...n,"カメラアクセスを取得しました"])}catch(n){const v=n instanceof Error?n.message:String(n),W=sessionStorage.getItem("cameraPermission")==="denied";y(W?"denied":"unknown"),I(!1),h(Y=>[...Y,`カメラアクセスに失敗しました: ${v}`])}h(n=>[...n,"Tesseract OCRの準備を行っています…"]);try{await ae(),k(!0),h(n=>[...n,"Tesseract OCRの準備が完了しました"])}catch(n){const v=n instanceof Error?n.message:String(n);k(!1),h($=>[...$,`Tesseract OCRの準備に失敗しました: ${v}`])}}catch(l){const n=l instanceof Error?l.message:String(l);g(n),N(!1),I(!1),k(!1),h(v=>[...v,`エラー: ${n}`])}finally{c(!1)}}},x=()=>{sessionStorage.setItem("surveyActive","1"),i("/survey/department")},D=async()=>{if(t){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),h(l=>[...l,"送信処理（ダミー）: Phase2で実装予定です"]);try{const l=await m();l>0?h(n=>[...n,`ローカルに保存されていた作業済みデータを削除しました（${l}件）`]):h(n=>[...n,"削除対象の作業済みデータはありませんでした"])}catch(l){const n=l instanceof Error?l.message:String(l);h(v=>[...v,`作業済みデータ削除時にエラーが発生しました: ${n}`])}}},L=j&&_!=="denied"&&P,T=sessionStorage.getItem("visitedDepartment")==="1"&&r>0,R=d?new Date(d).toLocaleString():"未ダウンロード",B=t?"オンライン":"オフライン",O=_==="granted"?"利用可能":_==="denied"?"拒否されています":"未確認";return e.jsx("div",{className:"page survey-home-page",children:e.jsxs("div",{className:"survey-home",children:[e.jsxs("section",{className:"survey-home__hero",children:[e.jsxs("div",{className:"survey-home__hero-top",children:[e.jsx("span",{className:"survey-home__label",children:"現地登録モード"}),e.jsx("h1",{className:"survey-home__title",children:"現有資産登録"}),e.jsx("p",{className:"survey-home__description",children:"オフライン環境での現地登録を行う前に、マスタデータのダウンロードとカメラアクセスの事前確認を完了してください。 調査開始後は /survey/ 配下の画面のみオフライン遷移が許可されます。"})]}),e.jsxs("div",{className:"survey-home__hero-actions",children:[e.jsx("button",{type:"button",onClick:E,disabled:o,children:"事前ダウンロードを実行"}),j&&e.jsxs("span",{className:"survey-home__badge",children:["最終更新: ",R]}),_==="granted"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可済み"}),_==="denied"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可なし"})]}),S&&e.jsxs("div",{className:"survey-home__badge",style:{background:"rgba(239, 68, 68, 0.2)",color:"#b91c1c"},children:["エラー: ",S]})]}),e.jsxs("section",{className:"survey-home__status-grid",children:[e.jsxs("div",{className:`survey-home__status-card${j?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"事前ダウンロード"}),e.jsx("strong",{children:j?"完了":"未実行"}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"通信状態"}),e.jsx("strong",{children:B}),e.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"作業済み件数"}),e.jsxs("strong",{children:[r,"件"]}),e.jsx("span",{children:"調査完了後にサーバー送信予定（Phase2）"})]}),e.jsxs("div",{className:`survey-home__status-card${b?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"カメラステータス"}),e.jsx("strong",{children:O}),e.jsx("span",{children:"QRコード読取と撮影に使用します"})]})]}),e.jsxs("section",{className:"survey-home__actions",children:[e.jsxs("div",{className:"survey-home__actions-text",children:[e.jsx("h3",{children:"現地登録を開始する"}),e.jsx("p",{children:"部署入力 → QRコード読取 → 写真撮影 → 商品登録の順に進みます。"})]}),e.jsxs("div",{className:"survey-home__actions-buttons",children:[e.jsx("button",{type:"button",onClick:x,disabled:!L,children:"調査を開始"}),T&&e.jsx("button",{type:"button",className:"ghost",onClick:D,disabled:!t,children:"調査完了（送信想定）"})]})]}),e.jsxs("section",{className:"survey-home__log",children:[e.jsxs("div",{className:"survey-home__log-header",children:[e.jsx("h2",{children:"アクティビティログ"}),e.jsxs("span",{children:[p.length," 件"]})]}),e.jsxs("div",{className:"survey-home__log-body",children:[p.length===0&&e.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),p.map((l,n)=>{const v=l.startsWith("エラー")||l.includes("失敗")||l.includes("エラーが発生");return e.jsx("div",{className:`survey-home__log-line${v?" is-error":""}`,children:l},n)})]})]})]})})}function xe(){const i=q(),[t,r]=f.useState("user@example.com"),[m,o]=f.useState("password"),c=typeof window<"u"?sessionStorage.getItem("mockToken"):null;f.useEffect(()=>{c&&i("/survey/home",{replace:!0})},[c,i]);const d=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",t.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),i("/survey/home",{replace:!0})};return e.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[e.jsx("h2",{children:"ログイン"}),e.jsxs("form",{className:"grid",onSubmit:d,children:[e.jsxs("label",{children:["メールアドレス",e.jsx("input",{value:t,onChange:u=>r(u.target.value),autoComplete:"username"})]}),e.jsxs("label",{children:["パスワード",e.jsx("input",{value:m,onChange:u=>o(u.target.value),type:"password",autoComplete:"current-password"})]}),e.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function C(i){var d;const r=i.document.getElementById("login-id"),m=((d=r==null?void 0:r.value)==null?void 0:d.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",o=i.selectedHospitalName,c=typeof o=="string"&&o.trim().length>0?o.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",m),c?window.sessionStorage.setItem("mockHospitalName",c):window.sessionStorage.removeItem("mockHospitalName")}function M({mode:i="login"}){const t=f.useRef(null),r=q();return f.useEffect(()=>{const o=t.current;if(!o)return;const c=()=>{const d=o.contentWindow;if(!d)return;const u=d.document,p=d,h=s=>{window.location.pathname!==s&&r(s,{replace:!0})},S=()=>{try{typeof p.hideLocationInputScreen=="function"&&p.hideLocationInputScreen()}catch{}C(d),r("/survey/home")},g=(s,E)=>{const x=p[s];p[s]=E(typeof x=="function"?x:void 0)};g("handleLogin",s=>function(x){var L;s&&s.call(this,x),C(d),(((L=u.getElementById("login-id"))==null?void 0:L.value)??"").includes("@hospital")?k():P()}),g("selectHospital",s=>function(...x){s&&s.apply(this,x),C(d)}),g("showAssetListScreen",s=>function(...x){s&&s.apply(this,x),C(d),h("/mock/assets")}),g("hideAssetListScreen",s=>function(...x){s&&s.apply(this,x),P()}),g("showLocationInputScreen",()=>function(){S()}),g("handleNext",()=>function(){var R,B,O,l,n,v;const E=((R=u.getElementById("surveyDate"))==null?void 0:R.textContent)??"",x=((B=u.getElementById("categoryInput"))==null?void 0:B.value)??"",D=((O=u.getElementById("buildingSelect"))==null?void 0:O.value)??"",L=((l=u.getElementById("floorSelect"))==null?void 0:l.value)??"",Q=((n=u.getElementById("departmentSelect"))==null?void 0:n.value)??"",T=((v=u.getElementById("sectionSelect"))==null?void 0:v.value)??"";console.log("調査場所データ:",{surveyDate:E,category:x,building:D,floor:L,department:Q,section:T}),S()}),i!=="login"&&C(d);const _=u.getElementById("loginPage"),y=u.getElementById("mainLayout"),b=u.getElementById("assetListScreen"),I="/poc-survey-offline-mock/",j=()=>window.location.pathname.startsWith(`${I}mock`),N=()=>{_&&(_.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),b&&b.classList.remove("active"),j()||r("/mock/login",{replace:!0}),h("/mock/login")},P=()=>{_&&(_.style.display="none"),b&&b.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),j()||r("/mock/dashboard",{replace:!0}),h("/mock/dashboard")},k=()=>{const s=u.getElementById("login-id");s&&!s.value.includes("@hospital")&&(s.value="demo@hospital.example"),typeof p.showAssetListScreen=="function"?p.showAssetListScreen():(_&&(_.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),b&&b.classList.add("active")),j()||r("/mock/assets",{replace:!0}),h("/mock/assets")};i==="login"?N():i==="dashboard"?P():i==="assets"&&k()};return o.addEventListener("load",c),()=>{o.removeEventListener("load",c)}},[i,r]),e.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:e.jsx("iframe",{ref:t,title:"医療コンサル管理システム モック",src:"/poc-survey-offline-mock/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const be=[{path:"/",children:[{index:!0,element:e.jsx(V,{to:"/login",replace:!0})},{path:"mock/login",element:e.jsx(M,{mode:"login"})},{path:"mock/dashboard",element:e.jsx(M,{mode:"dashboard"})},{path:"mock/assets",element:e.jsx(M,{mode:"assets"})},{path:"login",element:e.jsx(xe,{})},{element:e.jsx(he,{}),children:[{path:"home",element:e.jsx(V,{to:"/survey/home",replace:!0})},{path:"survey/home",element:e.jsx(_e,{})},{path:"survey/all",element:e.jsx(re,{})},{path:"survey/department",element:e.jsx(ie,{})},{path:"survey/label",element:e.jsx(ce,{})},{path:"survey/asset",element:e.jsx(le,{})},{path:"survey/product",element:e.jsx(de,{})}]}]}],je=ee(be,{basename:"/poc-survey-offline-mock/"}),we="/poc-survey-offline-mock/";if("serviceWorker"in navigator)navigator.serviceWorker.register(`${we}sw.js`).then(()=>navigator.serviceWorker.ready).then(()=>{ue(),H()}).catch(()=>{try{H()}catch{}});else try{H()}catch{}se.createRoot(document.getElementById("root")).render(e.jsx(te.StrictMode,{children:e.jsx(ne,{router:je})}));
