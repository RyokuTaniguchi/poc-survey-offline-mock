const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/survey-ChHo4KGa.js","assets/vendor-Cpb81dVA.js","assets/vendor-dexie-BWsXn92a.js","assets/vendor-zxing-6Q_caI5h.js"])))=>i.map(i=>d[i]);
import{r as f,u as T,b as Z,j as e,N as F,O as ee,d as se,e as te,R as ne,f as oe}from"./vendor-Cpb81dVA.js";import{u as q,d as a,e as ae,a as re,S as ie,D as ce,L as le,A as de,P as ue,w as me,p as U}from"./survey-ChHo4KGa.js";import"./vendor-dexie-BWsXn92a.js";import"./vendor-zxing-6Q_caI5h.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))m(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&m(l)}).observe(document,{childList:!0,subtree:!0});function r(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function m(o){if(o.ep)return;o.ep=!0;const c=r(o);fetch(o.href,c)}})();function X(){const[i,t]=f.useState(navigator.onLine);return f.useEffect(()=>{const r=()=>t(!0),m=()=>t(!1);return window.addEventListener("online",r),window.addEventListener("offline",m),()=>{window.removeEventListener("online",r),window.removeEventListener("offline",m)}},[]),i}function he(){const[i,t]=f.useState(0),[r,m]=f.useState(0);return f.useEffect(()=>{let o=setInterval(async()=>{if("storage"in navigator&&"estimate"in navigator.storage){const c=await navigator.storage.estimate();t((c.usage||0)/1048576),m((c.quota||0)/1048576)}},1500);return()=>clearInterval(o)},[]),{usedMB:i,quotaMB:r}}function z(i,t){if(typeof window>"u")return t;const r=sessionStorage.getItem(i);return r&&r.trim().length>0?r:t}function pe(){const i=T(),t=Z();if(!(typeof window<"u"?sessionStorage.getItem("mockToken"):null))return e.jsx(F,{to:"/",replace:!0});const m=z("mockHospitalName",""),o=t.pathname.startsWith("/survey")&&t.pathname!=="/survey/home",c=z("mockUserEmail","survey.operator@example.com"),l=X(),{usedMB:u,quotaMB:p}=he(),h=q(g=>g.completedCount),b=m.trim().length>0;return e.jsxs("div",{className:"app survey-app",children:[e.jsxs("header",{className:"survey-header",children:[e.jsxs("div",{className:"survey-header__left",children:[o&&e.jsxs("button",{type:"button",className:"survey-header__back",onClick:()=>i("/survey/home"),children:[e.jsx("span",{className:"survey-header__back-icon",children:"←"}),e.jsx("span",{children:"戻る"})]}),e.jsx("span",{className:"survey-header__chip",children:"現地登録アプリ"}),b&&e.jsx("h1",{className:"survey-header__title",children:m}),e.jsx("p",{className:"survey-header__user",children:c})]}),e.jsxs("div",{className:"survey-header__stats",children:[e.jsxs("div",{className:`survey-badge${l?" is-online":" is-offline"}`,children:[e.jsx("span",{className:"survey-badge__label",children:"通信状態"}),e.jsx("span",{className:"survey-badge__value",children:l?"オンライン":"オフライン"})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"ストレージ"}),e.jsxs("span",{className:"survey-badge__value",children:[u.toFixed(1)," / ",p.toFixed(1)," MB"]})]}),e.jsxs("div",{className:"survey-badge",children:[e.jsx("span",{className:"survey-badge__label",children:"作業済み"}),e.jsxs("span",{className:"survey-badge__value",children:[h," 件"]})]})]})]}),e.jsx("main",{className:"survey-main",children:e.jsx("div",{className:"survey-main__inner",children:e.jsx(ee,{})})})]})}const ge="modulepreload",fe=function(i){return"/poc-survey-offline-mock/"+i},G={},A=function(t,r,m){let o=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));o=Promise.allSettled(r.map(p=>{if(p=fe(p),p in G)return;G[p]=!0;const h=p.endsWith(".css"),b=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${b}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":ge,h||(g.as="script"),g.crossOrigin="",g.href=p,u&&g.setAttribute("nonce",u),document.head.appendChild(g),h)return new Promise((_,y)=>{g.addEventListener("load",_),g.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${p}`)))})}))}function c(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return o.then(l=>{for(const u of l||[])u.status==="rejected"&&c(u.reason);return t().catch(c)})};function K(i){const t=[];let r="",m=!1;for(let o=0;o<i.length;o+=1){const c=i[o];if(c==='"'){m&&i[o+1]==='"'?(r+='"',o+=1):m=!m;continue}if(c===","&&!m){t.push(r),r="";continue}r+=c}return t.push(r),t.map(o=>o.trim())}function J(i){if(!i)return"";const t=i.trim();return t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1).replace(/""/g,'"').trim():t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1).trim():t}function ve(i){const t=i.split(/\r?\n/).filter(m=>m.trim().length>0);if(t.length===0)return[];const r=K(t.shift()).map(J);return t.map(m=>{const o=K(m).map(J),c={};return r.forEach((l,u)=>{c[l]=o[u]??""}),c})}const M="/poc-survey-offline-mock/";function ye(i){const t=i.startsWith("/")?i.slice(1):i;if(typeof window>"u"||typeof window.location>"u")return`${M}${t}`;try{const r=new URL(M,window.location.origin);return new URL(t,r).toString()}catch{return`${M}${t}`}}async function S(i){const t=ye(i),r=await fetch(t,{cache:"no-store"});if(!r.ok)throw new Error(`Failed to download ${i}`);const m=await r.text();return ve(m)}async function _e(){const[i,t,r,m,o,c,l,u,p,h]=await Promise.all([S("/masters/locations_buildings.csv"),S("/masters/locations_floors.csv"),S("/masters/locations_departments.csv"),S("/masters/locations_divisions.csv"),S("/masters/locations_rooms.csv"),S("/masters/product_categories.csv"),S("/masters/product_subcategories.csv"),S("/masters/product_items.csv"),S("/masters/product_makers.csv"),S("/masters/product_models.csv")]),b=i.map(s=>({id:s.id,name:s.name})),g=t.map(s=>({id:s.id,buildingId:s.buildingId,name:s.name})),_=r.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,name:s.name})),y=m.map(s=>({id:s.id,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,name:s.name})),j=o.map(s=>({id:s.roomId??s.id,name:s.name,buildingId:s.buildingId,floorId:s.floorId,departmentId:s.departmentId,divisionId:s.divisionId})),I=c.map(s=>({id:s.id,name:s.name})),w=l.map(s=>({id:s.id,categoryId:s.categoryId,name:s.name})),N=u.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,name:s.name})),P=p.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,name:s.name})),k=h.map(s=>({id:s.id,categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,name:s.name}));await a.transaction("rw",a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.settings,async()=>{await Promise.all([a.location_buildings.clear(),a.location_floors.clear(),a.location_departments.clear(),a.location_divisions.clear(),a.location_rooms.clear(),a.product_categories.clear(),a.product_subcategories.clear(),a.product_items.clear(),a.product_makers.clear(),a.product_models.clear()]),await a.location_buildings.bulkPut(b),await a.location_floors.bulkPut(g),await a.location_departments.bulkPut(_),await a.location_divisions.bulkPut(y),await a.location_rooms.bulkPut(j),await a.product_categories.bulkPut(I),await a.product_subcategories.bulkPut(w),await a.product_items.bulkPut(N),await a.product_makers.bulkPut(P),await a.product_models.bulkPut(k),await a.settings.put({key:"mastersDownloadedAt",value:new Date().toISOString()})})}function xe(){const i=T(),t=X(),r=q(d=>d.completedCount),m=q(d=>d.purgeCompleted),[o,c]=f.useState(!1),[l,u]=f.useState(null),[p,h]=f.useState([]),[b,g]=f.useState(null),[_,y]=f.useState("unknown"),[j,I]=f.useState(!1),[w,N]=f.useState(!1),[P,k]=f.useState(!1),s=async()=>{const d=[a.location_buildings,a.location_floors,a.location_departments,a.location_divisions,a.location_rooms,a.product_categories,a.product_subcategories,a.product_items,a.product_makers,a.product_models,a.survey_masters,a.indices];await a.transaction("rw",...d,a.settings,async()=>{await Promise.all(d.map(n=>n.clear())),await a.settings.delete("mastersDownloadedAt")})};f.useEffect(()=>{const d=sessionStorage.getItem("cameraPermission");if(d==="granted"||d==="denied"){const n=d==="granted";y(n?"granted":"denied"),I(n)}},[]),f.useEffect(()=>{let d=!1;return N(!1),u(null),(async()=>{try{await s(),d||h(v=>[...v,"過去のマスタデータをクリアしました。事前ダウンロードを実行してください。"])}catch(v){const $=v instanceof Error?v.message:String(v);d||h(H=>[...H,"マスタデータの初期化に失敗しました: "+$])}})(),()=>{d=!0}},[]);const E=async()=>{if(!o){c(!0),g(null),N(!1),I(!1),k(!1),u(null),h(d=>[...d,"マスタCSVの読み込みを開始しました"]);try{h(n=>[...n,"既存のマスタデータをクリアしています…"]),await s(),h(n=>[...n,"既存のマスタデータをクリアしました。"]),await Promise.all([A(()=>import("./survey-ChHo4KGa.js").then(n=>n.b),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(n=>n.c),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(n=>n.f),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(n=>n.g),__vite__mapDeps([0,1,2,3])),A(()=>import("./survey-ChHo4KGa.js").then(n=>n.q),__vite__mapDeps([0,1,2,3]))]),await _e();const d=new Date().toISOString();u(d),N(!0),h(n=>[...n,"マスタCSVをローカルDBへ保存しました"]),h(n=>[...n,"カメラアクセスをリクエストします"]);try{await ae(),y("granted"),I(!0),h(n=>[...n,"カメラアクセスを取得しました"])}catch(n){const v=n instanceof Error?n.message:String(n),H=sessionStorage.getItem("cameraPermission")==="denied";y(H?"denied":"unknown"),I(!1),h(Y=>[...Y,`カメラアクセスに失敗しました: ${v}`])}h(n=>[...n,"Tesseract OCRの準備を行っています…"]);try{await re(),k(!0),h(n=>[...n,"Tesseract OCRの準備が完了しました"])}catch(n){const v=n instanceof Error?n.message:String(n);k(!1),h($=>[...$,`Tesseract OCRの準備に失敗しました: ${v}`])}}catch(d){const n=d instanceof Error?d.message:String(d);g(n),N(!1),I(!1),k(!1),h(v=>[...v,`エラー: ${n}`])}finally{c(!1)}}},x=()=>{sessionStorage.setItem("surveyActive","1"),i("/survey/department")},D=async()=>{if(t){sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),h(d=>[...d,"送信処理（ダミー）: Phase2で実装予定です"]);try{const d=await m();d>0?h(n=>[...n,`ローカルに保存されていた作業済みデータを削除しました（${d}件）`]):h(n=>[...n,"削除対象の作業済みデータはありませんでした"])}catch(d){const n=d instanceof Error?d.message:String(d);h(v=>[...v,`作業済みデータ削除時にエラーが発生しました: ${n}`])}}},L=w&&_!=="denied"&&P,W=sessionStorage.getItem("visitedDepartment")==="1"&&r>0,R=l?new Date(l).toLocaleString():"未ダウンロード",B=t?"オンライン":"オフライン",O=_==="granted"?"利用可能":_==="denied"?"拒否されています":"未確認";return e.jsx("div",{className:"page survey-home-page",children:e.jsxs("div",{className:"survey-home",children:[e.jsxs("section",{className:"survey-home__hero",children:[e.jsxs("div",{className:"survey-home__hero-top",children:[e.jsx("span",{className:"survey-home__label",children:"現地登録モード"}),e.jsx("h1",{className:"survey-home__title",children:"現有資産登録"}),e.jsx("p",{className:"survey-home__description",children:"オフライン環境での現地登録を行う前に、マスタデータのダウンロードとカメラアクセスの事前確認を完了してください。 調査開始後は /survey/ 配下の画面のみオフライン遷移が許可されます。"})]}),e.jsxs("div",{className:"survey-home__hero-actions",children:[e.jsx("button",{type:"button",onClick:E,disabled:o,children:"事前ダウンロードを実行"}),w&&e.jsxs("span",{className:"survey-home__badge",children:["最終更新: ",R]}),_==="granted"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可済み"}),_==="denied"&&e.jsx("span",{className:"survey-home__badge",children:"カメラアクセス: 許可なし"})]}),b&&e.jsxs("div",{className:"survey-home__badge",style:{background:"rgba(239, 68, 68, 0.2)",color:"#b91c1c"},children:["エラー: ",b]})]}),e.jsxs("section",{className:"survey-home__status-grid",children:[e.jsxs("div",{className:`survey-home__status-card${w?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"事前ダウンロード"}),e.jsx("strong",{children:w?"完了":"未実行"}),e.jsx("span",{children:R})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"通信状態"}),e.jsx("strong",{children:B}),e.jsx("span",{children:"オンライン時のみ送信処理が有効です"})]}),e.jsxs("div",{className:"survey-home__status-card",children:[e.jsx("h3",{children:"作業済み件数"}),e.jsxs("strong",{children:[r,"件"]}),e.jsx("span",{children:"調査完了後にサーバー送信予定（Phase2）"})]}),e.jsxs("div",{className:`survey-home__status-card${j?"":" status-card--warn"}`,children:[e.jsx("h3",{children:"カメラステータス"}),e.jsx("strong",{children:O}),e.jsx("span",{children:"QRコード読取と撮影に使用します"})]})]}),e.jsxs("section",{className:"survey-home__actions",children:[e.jsxs("div",{className:"survey-home__actions-text",children:[e.jsx("h3",{children:"現地登録を開始する"}),e.jsx("p",{children:"部署入力 → QRコード読取 → 写真撮影 → 商品登録の順に進みます。"})]}),e.jsxs("div",{className:"survey-home__actions-buttons",children:[e.jsx("button",{type:"button",onClick:x,disabled:!L,children:"調査を開始"}),W&&e.jsx("button",{type:"button",className:"ghost",onClick:D,disabled:!t,children:"調査完了（送信想定）"})]})]}),e.jsxs("section",{className:"survey-home__log",children:[e.jsxs("div",{className:"survey-home__log-header",children:[e.jsx("h2",{children:"アクティビティログ"}),e.jsxs("span",{children:[p.length," 件"]})]}),e.jsxs("div",{className:"survey-home__log-body",children:[p.length===0&&e.jsx("div",{className:"survey-home__empty",children:"まだログはありません。事前ダウンロードを実行すると進捗が表示されます。"}),p.map((d,n)=>{const v=d.startsWith("エラー")||d.includes("失敗")||d.includes("エラーが発生");return e.jsx("div",{className:`survey-home__log-line${v?" is-error":""}`,children:d},n)})]})]})]})})}function be(){const i=T(),[t,r]=f.useState("user@example.com"),[m,o]=f.useState("password"),c=typeof window<"u"?sessionStorage.getItem("mockToken"):null;f.useEffect(()=>{c&&i("/survey/home",{replace:!0})},[c,i]);const l=u=>{u.preventDefault(),sessionStorage.setItem("mockToken","ok"),sessionStorage.setItem("mockUserEmail",t.trim()),sessionStorage.removeItem("mockHospitalName"),sessionStorage.removeItem("surveyActive"),sessionStorage.removeItem("visitedDepartment"),i("/survey/home",{replace:!0})};return e.jsx("div",{className:"page",style:{justifyContent:"center",alignItems:"center"},children:e.jsxs("div",{className:"card",style:{maxWidth:420,width:"100%"},children:[e.jsx("h2",{children:"ログイン"}),e.jsxs("form",{className:"grid",onSubmit:l,children:[e.jsxs("label",{children:["メールアドレス",e.jsx("input",{value:t,onChange:u=>r(u.target.value),autoComplete:"username"})]}),e.jsxs("label",{children:["パスワード",e.jsx("input",{value:m,onChange:u=>o(u.target.value),type:"password",autoComplete:"current-password"})]}),e.jsx("button",{type:"submit",children:"ログイン"})]})]})})}function C(i){var l;const r=i.document.getElementById("login-id"),m=((l=r==null?void 0:r.value)==null?void 0:l.trim())||window.sessionStorage.getItem("mockUserEmail")||"survey.operator@example.com",o=i.selectedHospitalName,c=typeof o=="string"&&o.trim().length>0?o.trim():"";window.sessionStorage.setItem("mockToken","ok"),window.sessionStorage.setItem("mockUserEmail",m),c?window.sessionStorage.setItem("mockHospitalName",c):window.sessionStorage.removeItem("mockHospitalName")}function V({mode:i="login"}){const t=f.useRef(null),r=T();return f.useEffect(()=>{const o=t.current;if(!o)return;const c=()=>{const l=o.contentWindow;if(!l)return;const u=l.document,p=l,h=s=>{window.location.pathname!==s&&r(s,{replace:!0})},b=()=>{try{typeof p.hideLocationInputScreen=="function"&&p.hideLocationInputScreen()}catch{}C(l),r("/survey/home")},g=(s,E)=>{const x=p[s];p[s]=E(typeof x=="function"?x:void 0)};g("handleLogin",s=>function(x){var L;s&&s.call(this,x),C(l),(((L=u.getElementById("login-id"))==null?void 0:L.value)??"").includes("@hospital")?k():P()}),g("selectHospital",s=>function(...x){s&&s.apply(this,x),C(l)}),g("showAssetListScreen",s=>function(...x){s&&s.apply(this,x),C(l),h("/mock/assets")}),g("hideAssetListScreen",s=>function(...x){s&&s.apply(this,x),P()}),g("showLocationInputScreen",()=>function(){b()}),g("handleNext",()=>function(){var R,B,O,d,n,v;const E=((R=u.getElementById("surveyDate"))==null?void 0:R.textContent)??"",x=((B=u.getElementById("categoryInput"))==null?void 0:B.value)??"",D=((O=u.getElementById("buildingSelect"))==null?void 0:O.value)??"",L=((d=u.getElementById("floorSelect"))==null?void 0:d.value)??"",Q=((n=u.getElementById("departmentSelect"))==null?void 0:n.value)??"",W=((v=u.getElementById("sectionSelect"))==null?void 0:v.value)??"";console.log("調査場所データ:",{surveyDate:E,category:x,building:D,floor:L,department:Q,section:W}),b()}),i!=="login"&&C(l);const _=u.getElementById("loginPage"),y=u.getElementById("mainLayout"),j=u.getElementById("assetListScreen"),I="/poc-survey-offline-mock/",w=()=>window.location.pathname.startsWith(`${I}mock`),N=()=>{_&&(_.style.display="flex"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.remove("active"),w()||r("/mock/login",{replace:!0}),h("/mock/login")},P=()=>{_&&(_.style.display="none"),j&&j.classList.remove("active"),y&&(y.classList.add("active"),y.style.display="flex"),w()||r("/mock/dashboard",{replace:!0}),h("/mock/dashboard")},k=()=>{const s=u.getElementById("login-id");s&&!s.value.includes("@hospital")&&(s.value="demo@hospital.example"),typeof p.showAssetListScreen=="function"?p.showAssetListScreen():(_&&(_.style.display="none"),y&&(y.classList.remove("active"),y.style.display="none"),j&&j.classList.add("active")),w()||r("/mock/assets",{replace:!0}),h("/mock/assets")};i==="login"?N():i==="dashboard"?P():i==="assets"&&k()};return o.addEventListener("load",c),()=>{o.removeEventListener("load",c)}},[i,r]),e.jsx("div",{style:{width:"100%",height:"100vh",overflow:"hidden",background:"#f5f7fa"},children:e.jsx("iframe",{ref:t,title:"医療コンサル管理システム モック",src:"/poc-survey-offline-mock/mock/index.html",style:{width:"100%",height:"100%",border:"none"}})})}const je=[{path:"/",children:[{index:!0,element:e.jsx(F,{to:"/login",replace:!0})},{path:"mock/login",element:e.jsx(V,{mode:"login"})},{path:"mock/dashboard",element:e.jsx(V,{mode:"dashboard"})},{path:"mock/assets",element:e.jsx(V,{mode:"assets"})},{path:"login",element:e.jsx(be,{})},{element:e.jsx(pe,{}),children:[{path:"home",element:e.jsx(F,{to:"/survey/home",replace:!0})},{path:"survey/home",element:e.jsx(xe,{})},{path:"survey/all",element:e.jsx(ie,{})},{path:"survey/department",element:e.jsx(ce,{})},{path:"survey/label",element:e.jsx(le,{})},{path:"survey/asset",element:e.jsx(de,{})},{path:"survey/product",element:e.jsx(ue,{})}]}]}],we=se(je,{basename:"/poc-survey-offline-mock/"}),Se="/poc-survey-offline-mock/";if("serviceWorker"in navigator)navigator.serviceWorker.register(`${Se}sw.js`).then(()=>navigator.serviceWorker.ready).then(()=>{me(),U()}).catch(()=>{try{U()}catch{}});else try{U()}catch{}te.createRoot(document.getElementById("root")).render(e.jsx(ne.StrictMode,{children:e.jsx(oe,{router:we})}));
