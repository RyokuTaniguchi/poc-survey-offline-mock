var Go=Object.defineProperty;var Ko=(c,a,s)=>a in c?Go(c,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[a]=s;var ae=(c,a,s)=>Ko(c,typeof a!="symbol"?a+"":a,s);import{i as lo,c as Zo,r as o,s as ho,u as _t,j as e}from"./vendor-5jQwBCrV.js";import{D as Vo}from"./vendor-dexie-DWlydIdn.js";import{B as fs}from"./vendor-zxing-DcYOnkv9.js";class Xo extends Vo{constructor(){super("meddx_survey");ae(this,"survey_drafts");ae(this,"survey_photos");ae(this,"survey_masters");ae(this,"indices");ae(this,"settings");ae(this,"location_buildings");ae(this,"location_floors");ae(this,"location_departments");ae(this,"location_divisions");ae(this,"product_categories");ae(this,"product_subcategories");ae(this,"product_items");ae(this,"product_makers");ae(this,"product_models");ae(this,"location_rooms");this.version(1).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key"}),this.version(2).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name"}),this.version(3).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name",location_rooms:"id,buildingId,floorId,departmentId,divisionId,name"})}}const w=new Xo,Yo="/poc-survey-offline-mock/".replace(/\/?$/,"/"),co=`${Yo}vendor/browser-image-compression.js`;async function Jo(c,a=2560){const h=await lo(c,{maxWidthOrHeight:a,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:co}),b=await lo(c,{maxWidthOrHeight:512,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:co});return{blob:h,thumb:b}}const ot=Zo((c,a)=>{const s=async()=>{const r=a().current;if(!r){c({photos:[]});return}const l=await w.survey_photos.where("draftId").equals(r.id).reverse().toArray();c({photos:l})},h=async()=>{const r=await w.survey_drafts.filter(l=>{var u;return((u=l.fields)==null?void 0:u.status)==="completed"}).count();c({completedCount:r})},b=async r=>{await w.survey_drafts.put(r),c({current:r}),await h()},I={current:void 0,photos:[],completedCount:0,async newDraft(){const r=crypto.randomUUID(),l={id:r,fields:{},photoIds:[],updatedAt:Date.now()};return await w.survey_drafts.put(l),c({current:l}),setTimeout(()=>{s()},0),await h(),r},async load(r){let l=await w.survey_drafts.get(r);l||(l={id:r,fields:{},photoIds:[],updatedAt:Date.now()},await w.survey_drafts.put(l)),c({current:l}),await s(),await h()},async setField(r,l){const u=a().current;if(!u)return;const m={...u.fields};l==null||l===""?delete m[r]:m[r]=l;const y={...u,fields:m,updatedAt:Date.now()};await b(y)},async setFields(r){const l=a().current;if(!l)return;const u={...l.fields};Object.entries(r).forEach(([y,_])=>{_==null||_===""?delete u[y]:u[y]=_});const m={...l,fields:u,updatedAt:Date.now()};await b(m)},async setQR(r){const l=a().current;if(!l)return;const u={...l,qr:r,fields:{...l.fields,sealNo:r,qrCode:r},updatedAt:Date.now()};await b(u)},async attachPhoto(r){const l=a().current;if(!l)return;const{blob:u,thumb:m}=await Jo(r),y=await w.survey_photos.where("draftId").equals(l.id).count(),_={id:crypto.randomUUID(),draftId:l.id,blob:u,thumb:m,size:u.size,createdAt:Date.now(),selectedForList:y===0};await w.survey_photos.put(_);const j={...l,photoIds:[...l.photoIds,_.id],updatedAt:Date.now()};await b(j),await s()},async togglePhotoForList(r){const l=a().current;if(!l)return;const u=await w.survey_photos.get(r),m=!(u!=null&&u.selectedForList);await w.survey_photos.where("draftId").equals(l.id).modify(y=>{y.selectedForList=m&&y.id===r}),await s()},async removePhoto(r){const l=a().current;if(!l)return;await w.survey_photos.delete(r);const u=l.photoIds.filter(y=>y!==r),m={...l,photoIds:u,updatedAt:Date.now()};await b(m),await s()},async refreshPhotos(){await s()},async refreshStats(){await h()},async completeCurrent(r){const l=a().current;if(!l)return;const u={...l,fields:{...l.fields,status:"completed",completedAt:Date.now()},updatedAt:Date.now()};await b(u),await s();const m=await a().newDraft();await s();const y=(r==null?void 0:r.preserveKeys)??[];if(y.length>0){const _={};y.forEach(j=>{var O;((O=l.fields)==null?void 0:O[j])!==void 0&&(_[j]=l.fields[j])}),Object.keys(_).length>0&&await a().setFields(_)}return m},async clearCurrent(){const r=a().current;r&&(await w.survey_photos.where("draftId").equals(r.id).delete(),await w.survey_drafts.delete(r.id),c({current:void 0,photos:[]}),await h())},async listHistory(r="asc"){const l=w.survey_drafts.orderBy("updatedAt");return(r==="desc"?await l.reverse().toArray():await l.toArray()).filter(m=>{var y;return((y=m.fields)==null?void 0:y.status)==="completed"})},async purgeCompleted(){const r=await w.survey_drafts.filter(u=>{var m;return((m=u.fields)==null?void 0:m.status)==="completed"}).toArray();if(r.length===0)return 0;await w.transaction("rw",w.survey_drafts,w.survey_photos,async()=>{for(const u of r)await w.survey_photos.where("draftId").equals(u.id).delete(),await w.survey_drafts.delete(u.id)});const l=a().current;return l&&r.some(u=>u.id===l.id)&&c({current:void 0,photos:[]}),await h(),await s(),r.length},async duplicateDraft(r,l){if(l<=0)return 0;const u=await w.survey_drafts.get(r);if(!u)throw new Error("複製元の履歴が見つかりません");const m={...u.fields??{}},y=m.sealNo||m.qr||m.qrCode||u.qr;if(!y)throw new Error("複製元のQRコードが取得できませんでした");const _=y.match(/(\d+)(?!.*\d)/),j=_?_.index??-1:-1,O=_?parseInt(_[1],10):null,k=_?_[1].length:0,B=j>=0?y.slice(0,j):y,M=j>=0?y.slice(j+k):"",z=await w.survey_photos.where("draftId").equals(r).toArray(),C=[],D=[],R=Date.now(),T=v=>{if(O!==null){const g=O+v,L=String(g).padStart(k,"0");return`${B}${L}${M}`}return`${y}-${v}`};for(let v=1;v<=l;v++){const g=crypto.randomUUID(),L=T(v),F=[],N={...m,qr:L,qrCode:L,sealNo:L,status:"completed",completedAt:R+v};z.forEach(E=>{const H=crypto.randomUUID();F.push(H),D.push({...E,id:H,draftId:g,createdAt:R+v})}),C.push({id:g,fields:N,photoIds:F,updatedAt:R+v})}await w.transaction("rw",w.survey_drafts,w.survey_photos,async()=>{D.length>0&&await w.survey_photos.bulkPut(D),C.length>0&&await w.survey_drafts.bulkPut(C)}),await h();const A=a().current;if(A){const v=await w.survey_drafts.get(A.id);v&&c({current:v})}return C.length}};return h(),I});function Dt(){const{current:c,newDraft:a}=ot();o.useEffect(()=>{c||a()},[c,a])}const ea="この端末ではカメラが利用できません",ta="ブラウザ環境ではありません",sa="カメラの利用には HTTPS での接続が必要です";function oa(){if(typeof navigator>"u")return null;const c=navigator.mediaDevices;if(c!=null&&c.getUserMedia)return s=>c.getUserMedia(s);const a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a?s=>new Promise((h,b)=>{a.call(navigator,s,h,b)}):null}async function Vt(){if(typeof navigator>"u")throw new Error(ta);if(typeof window<"u"&&"isSecureContext"in window&&!window.isSecureContext)throw new Error(sa);const c=oa();if(!c)throw new Error(ea);if(sessionStorage.getItem("cameraPermission")==="granted")return"granted";try{return(await c({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1})).getTracks().forEach(h=>h.stop()),sessionStorage.setItem("cameraPermission","granted"),"granted"}catch(s){const h=s;throw(h==null?void 0:h.name)==="NotAllowedError"||(h==null?void 0:h.name)==="SecurityError"?sessionStorage.setItem("cameraPermission","denied"):sessionStorage.removeItem("cameraPermission"),s instanceof Error?s:new Error(String(s))}}const gs={},aa="/poc-survey-offline-mock/".replace(/\/?$/,"/"),vs=c=>`${aa}tesseract/${c.replace(/^\//,"")}`;var mo;const na=(mo=gs==null?void 0:gs.VITE_TESSDATA_URL)==null?void 0:mo.trim(),ia=vs("lang-data/"),fo=(na??ia).replace(/\/?$/,"/");let gt=null,ys=!1;const ra=6e4;function da(c,a,s){return new Promise((h,b)=>{const I=setTimeout(()=>{try{s==null||s()}catch{}b(new Error("OCR処理がタイムアウトしました"))},a);c.then(r=>{clearTimeout(I),h(r)},r=>{clearTimeout(I),b(r)})})}function la(c){return c.replace(/[\uFF01-\uFF5E]/g,a=>String.fromCharCode(a.charCodeAt(0)-65248)).replace(/\u3000/g," ")}function ca(c){return la(c).toUpperCase().replace(/[\u2010-\u2015\u2212\u30FC\uFF0D\uFE63]/g,"-").replace(/[^0-9A-Z-]/g,"")}const Is=()=>{gt=null,ys=!1};async function ua(){return ho.createWorker("eng",void 0,{workerPath:vs("worker.min.js"),corePath:vs("tesseract-core.wasm.js"),langPath:fo,workerBlobURL:!1})}async function xs(){gt||(gt=da(ua(),ra,Is));try{const c=await gt;return ys||(await c.setParameters({tessedit_char_whitelist:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-",tessedit_pageseg_mode:ho.PSM.SINGLE_LINE}),ys=!0),c}catch(c){throw Is(),c instanceof Error?c:new Error("Tesseract workerの初期化に失敗しました")}}function go(){xs().catch(()=>{})}const ma=["tesseract/lang-data/eng.traineddata.gz","tesseract/worker.min.js","tesseract/tesseract-core.wasm","tesseract/tesseract-core.wasm.js"];async function ha(){const c="/poc-survey-offline-mock/".replace(/\/?$/,"/");await Promise.all(ma.map(async a=>{try{await fetch(`${c}${a}`,{cache:"force-cache"})}catch{}}))}async function Ca(){await ha(),await xs()}async function fa(c){const a=await xs(),{data:s}=await a.recognize(c).catch(async u=>{throw await ga(),u}),h=Array.isArray(s.lines)?s.lines:[],b=h.map(u=>{var m,y;return((y=(m=u.text)==null?void 0:m.trim)==null?void 0:y.call(m))??""}).filter(Boolean),I=h.reduce((u,m)=>!u||m.confidence>u.confidence?{text:m.text,confidence:m.confidence}:u,null),r=ca((I==null?void 0:I.text)??s.text??""),l=(I==null?void 0:I.confidence)??s.confidence??0;return{text:r,rawText:s.text??"",candidates:b.length>0?b:(s.text??"").split(/\n+/).map(u=>u.trim()).filter(Boolean),confidence:l,method:"tesseract"}}async function ga(){if(!gt)return;await(await gt).terminate(),Is()}async function pa(c){let a=null;try{return await fa(c)}catch(s){a=s instanceof Error?s:new Error(String(s))}if(a){const s=a.message;throw fo.startsWith("http")?typeof navigator<"u"&&!navigator.onLine?new Error("OCR辞書データが未取得です。オンライン接続時に一度読み取りを実行し、キャッシュを作成してください。"):new Error(`OCR辞書データのダウンロードに失敗しました: ${s}`):new Error(`OCR辞書データの読み込みに失敗しました。詳細: ${s}`)}throw new Error("OCR処理に失敗しました。")}function Kt(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function va(){var re,de,be,ve,Y,oe;Dt();const c=_t(),{current:a,setFields:s}=ot(),[h,b]=o.useState([]),[I,r]=o.useState([]),[l,u]=o.useState([]),[m,y]=o.useState([]),[_,j]=o.useState(""),[O,k]=o.useState(""),[B,M]=o.useState(""),[z,C]=o.useState(""),[D,R]=o.useState(void 0),[T,A]=o.useState(void 0),[v,g]=o.useState(void 0),[L,F]=o.useState(void 0),N=o.useMemo(()=>{const d=new Date;return`${d.getFullYear()}年${String(d.getMonth()+1).padStart(2,"0")}月${String(d.getDate()).padStart(2,"0")}日`},[]),E=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{sessionStorage.setItem("visitedDepartment","1")},[]),o.useEffect(()=>{Promise.all([w.location_buildings.toArray(),w.location_floors.toArray(),w.location_departments.toArray(),w.location_divisions.toArray()]).then(([d,U,K,Z])=>{b(d),r(U),u(K),y(Z)})},[]),o.useEffect(()=>{var U,K;if(!a)return;const d={};(U=a.fields)!=null&&U.surveyDate||(d.surveyDate=N),E&&((K=a.fields)==null?void 0:K.investigator)!==E&&(d.investigator=E),Object.keys(d).length>0&&s(d)},[a,E,s,N]);const H=(re=a==null?void 0:a.fields)==null?void 0:re.buildingId,f=(de=a==null?void 0:a.fields)==null?void 0:de.floorId,P=(be=a==null?void 0:a.fields)==null?void 0:be.departmentId,G=(ve=a==null?void 0:a.fields)==null?void 0:ve.divisionId;o.useEffect(()=>{R(H)},[H]),o.useEffect(()=>{A(f)},[f]),o.useEffect(()=>{g(P)},[P]),o.useEffect(()=>{F(G)},[G]);const X=o.useMemo(()=>h.find(d=>d.id===D),[h,D]),q=o.useMemo(()=>I.find(d=>d.id===T),[I,T]),ge=o.useMemo(()=>l.find(d=>d.id===v),[l,v]),se=o.useMemo(()=>m.find(d=>d.id===L),[m,L]);o.useEffect(()=>{j(X?X.name:"")},[X]),o.useEffect(()=>{k(q?q.name:"")},[q]),o.useEffect(()=>{M(ge?ge.name:"")},[ge]),o.useEffect(()=>{C(se?se.name:"")},[se]);const he=o.useMemo(()=>h.filter(d=>Kt(d.name,_)),[h,_]),Ee=o.useMemo(()=>I.filter(d=>D&&d.buildingId!==D?!1:Kt(d.name,O)),[I,O,D]),fe=o.useMemo(()=>l.filter(d=>D&&d.buildingId!==D||T&&d.floorId!==T?!1:Kt(d.name,B)),[l,B,D,T]),_e=o.useMemo(()=>m.filter(d=>D&&d.buildingId!==D||T&&d.floorId!==T||v&&d.departmentId!==v?!1:Kt(d.name,z)),[m,z,D,T,v]),pe=d=>{if(!d||D===d.id){j(""),k(""),M(""),C(""),R(void 0),A(void 0),g(void 0),F(void 0),s({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0});return}j(d.name),k(""),M(""),C(""),R(d.id),A(void 0),g(void 0),F(void 0),s({buildingId:d.id,floorId:void 0,departmentId:void 0,divisionId:void 0})},xe=d=>{if(!d||T===d.id){k(""),M(""),C(""),A(void 0),g(void 0),F(void 0),s({buildingId:D,floorId:void 0,departmentId:void 0,divisionId:void 0});return}const U=h.find(K=>K.id===d.buildingId);U&&(j(U.name),R(U.id)),k(d.name),M(""),C(""),A(d.id),g(void 0),F(void 0),s({buildingId:d.buildingId,floorId:d.id,departmentId:void 0,divisionId:void 0})},Ne=d=>{if(!d||v===d.id){M(""),C(""),g(void 0),F(void 0),s({buildingId:D,floorId:T,departmentId:void 0,divisionId:void 0});return}const U=h.find(Z=>Z.id===d.buildingId),K=I.find(Z=>Z.id===d.floorId);U&&(j(U.name),R(U.id)),K&&(k(K.name),A(K.id)),M(d.name),C(""),g(d.id),F(void 0),s({buildingId:d.buildingId,floorId:d.floorId,departmentId:d.id,divisionId:void 0})},x=d=>{if(!d||L===d.id){C(""),F(void 0),s({buildingId:D,floorId:T,departmentId:v,divisionId:void 0});return}const U=h.find(J=>J.id===d.buildingId),K=I.find(J=>J.id===d.floorId),Z=l.find(J=>J.id===d.departmentId);U&&(j(U.name),R(U.id)),K&&(k(K.name),A(K.id)),Z&&(M(Z.name),g(Z.id)),C(d.name),F(d.id),s({buildingId:d.buildingId,floorId:d.floorId,departmentId:d.departmentId,divisionId:d.id})},W=!!(D&&T&&v&&L);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"部署入力"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["調査日",e.jsx("input",{value:((Y=a==null?void 0:a.fields)==null?void 0:Y.surveyDate)??N,disabled:!0})]}),e.jsxs("label",{children:["調査担当",e.jsx("input",{value:((oe=a==null?void 0:a.fields)==null?void 0:oe.investigator)??E,disabled:!0})]})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["棟",e.jsx("input",{value:_,onChange:d=>j(d.target.value),placeholder:"棟を検索"})]}),e.jsx("div",{className:"option-list",children:he.map(d=>e.jsx("button",{onClick:()=>pe(d),className:d.id===D?"active":"",children:d.name},d.id))}),e.jsxs("label",{children:["階",e.jsx("input",{value:O,onChange:d=>k(d.target.value),placeholder:"階を検索"})]}),e.jsx("div",{className:"option-list",children:Ee.map(d=>{var U;return e.jsxs("button",{onClick:()=>xe(d),className:d.id===T?"active":"",children:[d.name,"（",((U=h.find(K=>K.id===d.buildingId))==null?void 0:U.name)??"","）"]},d.id)})}),e.jsxs("label",{children:["部署",e.jsx("input",{value:B,onChange:d=>M(d.target.value),placeholder:"部署を検索"})]}),e.jsx("div",{className:"option-list",children:fe.map(d=>e.jsx("button",{onClick:()=>Ne(d),className:d.id===v?"active":"",children:d.name},d.id))}),e.jsxs("label",{children:["部門",e.jsx("input",{value:z,onChange:d=>C(d.target.value),placeholder:"部門を検索"})]}),e.jsx("div",{className:"option-list",children:_e.map(d=>e.jsx("button",{onClick:()=>x(d),className:d.id===L?"active":"",children:d.name},d.id))})]}),e.jsx("p",{className:"helper-text",children:"今日一日がんばって！！"})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>c("/home"),children:"ホーム"}),e.jsx("button",{onClick:()=>c("/survey/all"),disabled:!W,children:"次へ"})]})]})}const Ea=Object.freeze(Object.defineProperty({__proto__:null,default:va},Symbol.toStringTag,{value:"Module"})),Ns=o.forwardRef(({onResult:c},a)=>{const s=o.useRef(null),h=o.useRef(null),b=o.useRef(null),[I,r]=o.useState(!1);o.useEffect(()=>(h.current=new fs,()=>{var m;(m=b.current)==null||m.stop(),b.current=null,fs.releaseAllStreams(),h.current=null,r(!1)}),[]);const l=o.useCallback(()=>{var m;(m=b.current)==null||m.stop(),b.current=null,fs.releaseAllStreams(),r(!1)},[]),u=o.useCallback(async()=>{if(!(!s.current||!h.current)&&!I){r(!0);try{b.current=await h.current.decodeFromConstraints({video:{facingMode:"environment"}},s.current,m=>{m&&(c(m.getText()),l())})}catch(m){console.error(m),r(!1),b.current=null}}},[c,I,l]);return o.useImperativeHandle(a,()=>({start:u,stop:l}),[u,l]),e.jsxs("div",{className:"qr-container",style:{display:I?"block":"none"},children:[e.jsx("video",{ref:s,className:"qr-video",muted:!0,playsInline:!0}),I&&e.jsx("div",{className:"helper-text",style:{marginTop:8},children:"読み取り中です..."})]})}),_a=Object.freeze(Object.defineProperty({__proto__:null,QRScanner:Ns},Symbol.toStringTag,{value:"Module"}));function bs({open:c,onClose:a}){const{listHistory:s,duplicateDraft:h}=ot(),[b,I]=o.useState("asc"),[r,l]=o.useState(!1),[u,m]=o.useState(null),[y,_]=o.useState([]),[j,O]=o.useState(null),[k,B]=o.useState({}),[M,z]=o.useState(null),C=async v=>{l(!0),m(null);try{const g=await s(v);_(g)}catch(g){const L=g instanceof Error?g.message:String(g);m(L),_([])}finally{l(!1)}};o.useEffect(()=>{c?(O(null),B({}),z(null),C(b)):(m(null),_([]))},[c,b]);const D=()=>{I(v=>v==="asc"?"desc":"asc")},R=(v,g)=>{B(L=>({...L,[v]:g}))},T=async v=>{const g=k[v]??"1",L=Number.parseInt(g,10);if(!Number.isFinite(L)||L<=0){O("複製数は1以上の整数を入力してください");return}z(v),O(null);try{const F=await h(v,L);O(`履歴を ${F} 件複製しました`),B(N=>({...N,[v]:""})),await C(b)}catch(F){const N=F instanceof Error?F.message:String(F);O(`複製に失敗しました: ${N}`)}finally{z(null)}},A=o.useMemo(()=>r?e.jsx("p",{className:"helper-text",children:"読み込み中..."}):u?e.jsxs("p",{className:"badge warn",children:["エラー: ",u]}):y.length===0?e.jsx("p",{className:"helper-text",children:"複製可能な履歴がありません。"}):y.map(v=>{const g=v.fields??{},L=g.completedAt??v.updatedAt,F=g.sealNo??g.qr??v.qr??"-",N=g.assetNo??"-",E=g.equipmentNo??"-",H=g.width??"-",f=g.depth??"-",P=g.height??"-",G=g.note??"",X=k[v.id]??"";return e.jsxs("div",{className:"history-row static",children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(L).toLocaleString()}),e.jsxs("span",{className:"pill",children:["QR ",F]}),N!=="-"&&e.jsxs("span",{className:"pill",children:["資産 ",N]}),E!=="-"&&e.jsxs("span",{className:"pill",children:["備品 ",E]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsxs("span",{className:"pill",children:["Category ",g.categoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Sub ",g.subcategoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Item ",g.itemId??"-"]}),e.jsxs("span",{className:"pill",children:["Maker ",g.makerId??"-"]}),e.jsxs("span",{className:"pill",children:["Model ",g.modelId??"-"]})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",H]}),e.jsxs("span",{children:["D: ",f]}),e.jsxs("span",{children:["H: ",P]}),G&&e.jsxs("span",{children:["備考: ",G]})]}),e.jsxs("div",{className:"history-duplicate",children:[e.jsx("input",{type:"number",min:1,placeholder:"複製数",value:X,onChange:q=>R(v.id,q.target.value)}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>T(v.id),disabled:M===v.id,children:M===v.id?"複製中...":"複製"})]})]},v.id)}),[y,k,r,u,M]);return c?e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"複製"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:D,children:b==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:a,children:"閉じる"})]})]}),j&&e.jsx("p",{className:"badge success",style:{marginTop:8},children:j}),e.jsx("div",{className:"history-list",children:A})]})}):null}function ya(){var g,L,F,N,E,H;Dt();const c=_t(),a=o.useRef(null),{current:s,setFields:h,setQR:b}=ot(),[I,r]=o.useState(""),[l,u]=o.useState(""),[m,y]=o.useState([]),[_,j]=o.useState(!1);o.useEffect(()=>{var f,P;r(((f=s==null?void 0:s.fields)==null?void 0:f.sealNo)??""),u(((P=s==null?void 0:s.fields)==null?void 0:P.roomName)??"")},[(g=s==null?void 0:s.fields)==null?void 0:g.sealNo,(L=s==null?void 0:s.fields)==null?void 0:L.roomName]),o.useEffect(()=>()=>{var f;(f=a.current)==null||f.stop()},[]),o.useEffect(()=>{let f=!0;return w.location_rooms.toArray().then(P=>{f&&y(P)}).catch(()=>{f&&y([])}),()=>{f=!1}},[]);const O=(F=s==null?void 0:s.fields)==null?void 0:F.buildingId,k=(N=s==null?void 0:s.fields)==null?void 0:N.floorId,B=(E=s==null?void 0:s.fields)==null?void 0:E.departmentId,M=(H=s==null?void 0:s.fields)==null?void 0:H.divisionId,z=o.useMemo(()=>{if(!O||!k||!B||!M)return[];const f=l.trim().toLowerCase();return m.filter(P=>P.buildingId!==O||P.floorId!==k||P.departmentId!==B||P.divisionId!==M?!1:f?P.name.toLowerCase().includes(f):!0)},[m,O,k,B,M,l]),C=f=>{const P=f.trim(),G=P.match(/medical-record\/([A-Za-z0-9-]+)$/i),X=G?G[1]:P;r(X),b(X)},D=f=>{r(f),h({sealNo:f,qrCode:f})},R=f=>{u(f),h({roomName:f})},T=()=>{var f;(f=a.current)==null||f.stop(),c("/survey/department")},A=()=>{var f;(f=a.current)==null||f.stop(),c("/survey/asset")},v=!!(I.trim()&&l.trim());return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QRコード読取・ラベルNo確認"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:I,onChange:f=>D(f.target.value),placeholder:"シールNoを入力"})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:l,onChange:f=>R(f.target.value),placeholder:"室名を入力"}),z.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:z.map(f=>e.jsx("button",{type:"button",onClick:()=>R(f.name),children:f.name},f.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ns,{ref:a,onResult:C})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>j(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:T,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:async()=>{var f;try{await Vt(),await((f=a.current)==null?void 0:f.start())}catch(P){const G=P instanceof Error?P.message:String(P);alert(`カメラを利用できませんでした: ${G}`)}},children:"QR撮影"}),e.jsx("button",{onClick:A,disabled:!v,children:"次へ"})]}),e.jsx(bs,{open:_,onClose:()=>j(!1)})]})}const Da=Object.freeze(Object.defineProperty({__proto__:null,default:ya},Symbol.toStringTag,{value:"Module"})),Zt={left:.08,top:.425,width:.84,height:.15},uo=1200,Ia=2e3;function ps(c,a){const s=c.split(","),h=s[0].match(/:(.*?);/),b=(h==null?void 0:h[1])??a,I=atob(s[1]??""),r=I.length,l=new Uint8Array(r);for(let u=0;u<r;u+=1)l[u]=I.charCodeAt(u);return new Blob([l],{type:b})}async function xa(c,a,s){return typeof c.toBlob=="function"?await new Promise((h,b)=>{let I=!1;const r=window.setTimeout(()=>{if(!I){I=!0;try{const l=ps(c.toDataURL(a,s),a);h(l)}catch(l){b(l instanceof Error?l:new Error("スナップショットの生成に失敗しました"))}}},Ia);c.toBlob(l=>{if(!I)if(I=!0,window.clearTimeout(r),l)h(l);else try{const u=ps(c.toDataURL(a,s),a);h(u)}catch(u){b(u instanceof Error?u:new Error("スナップショットの生成に失敗しました"))}},a,s)}):ps(c.toDataURL(a,s),a)}function po({open:c,targetLabel:a,onClose:s,onResult:h,onRecognized:b}){const I=o.useRef(null),r=o.useRef(null),l=o.useRef(),u=o.useRef(),[m,y]=o.useState("idle"),[_,j]=o.useState("カメラを初期化しています…"),[O,k]=o.useState(!1),[B,M]=o.useState(null),[z,C]=o.useState(null);o.useEffect(()=>{l.current=document.createElement("canvas"),u.current=document.createElement("canvas")},[]);const D=o.useCallback(()=>{M(null),C(N=>(N&&URL.revokeObjectURL(N),null))},[]),R=()=>{r.current&&(r.current.getTracks().forEach(N=>N.stop()),r.current=null),I.current&&(I.current.pause(),I.current.srcObject=null)},T=o.useCallback(async()=>{var N;if(D(),!((N=navigator.mediaDevices)!=null&&N.getUserMedia)){y("error"),j("この端末ではカメラを利用できません。手入力してください。"),k(!1);return}y("camera"),j("カメラを起動しています…");try{const E=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});r.current=E,I.current&&(I.current.srcObject=E,await I.current.play().catch(()=>{})),y("camera"),j("枠が黒い帯に変わりました。番号を合わせて撮影してください。"),k(!1)}catch(E){const H=E instanceof Error?E.message:String(E);y("error"),j(`カメラにアクセスできません: ${H}`),k(!1)}},[D]);o.useEffect(()=>{if(!c){R(),D(),y("idle"),j("カメラを初期化しています…"),k(!1);return}return T(),()=>{R()}},[c,T]);const A=async(N,E,H)=>{const f=l.current,P=u.current;if(!f||!P||N===0||E===0)throw new Error("画像データを読み込めませんでした。");f.width=N,f.height=E;const G=f.getContext("2d");if(!G)throw new Error("画像の処理に失敗しました。");H(G);const X=P.getContext("2d");if(!X)throw new Error("画像の処理に失敗しました。");const q={x:Math.floor(f.width*Zt.left),y:Math.floor(f.height*Zt.top),width:Math.floor(f.width*Zt.width),height:Math.floor(f.height*Zt.height)},ge=q.width>uo?uo/q.width:1,se=Math.max(320,Math.round(q.width*ge)),he=Math.max(120,Math.round(q.height*ge));return P.width=se,P.height=he,X.filter="contrast(160%) brightness(115%) grayscale(15%)",X.drawImage(f,q.x,q.y,q.width,q.height,0,0,se,he),xa(P,"image/jpeg",.92)},v=async()=>{if(!c||O||m!=="camera")return;const N=I.current;if(!N||N.videoWidth===0||N.videoHeight===0){y("error"),j("カメラ映像を取得できませんでした。");return}k(!0),j("撮影中…");try{const E=await A(N.videoWidth,N.videoHeight,f=>{f.drawImage(N,0,0,N.videoWidth,N.videoHeight)});R(),D();const H=URL.createObjectURL(E);M(E),C(H),y("photo"),j("写真を保存しました。読み取りボタンを押してください。"),k(!1)}catch(E){const H=E instanceof Error?E.message:String(E);y("error"),j(`撮影に失敗しました: ${H}`),k(!1)}},g=async()=>{if(!(!B||O)){y("processing"),k(!0),j("読み取り中です。1秒ほどお待ちください…");try{const N=await pa(B);N.text?(h(N.text),j(`認識した値: ${N.text}`),b==null||b({text:N.text,method:N.method,targetLabel:a}),s()):(y("error"),j("文字を検出できませんでした。撮り直して再試行してください。"),k(!1))}catch(N){const E=N instanceof Error?N.message:String(N);y("error"),j(`読み取りに失敗しました: ${E}`),k(!1)}}},L=()=>{O||(D(),T())},F=o.useMemo(()=>m==="photo"?"撮影した画像を確認し、問題なければ「読み取る」を押してください。":m==="processing"?"しばらくお待ちください…":m==="error"?"カメラや照明の状態を確認してください。":"黒いガイド帯の中央に番号を重ね、影や反射を避けて撮影すると精度が上がります。",[m]);return c?e.jsx("div",{className:"ocr-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"ocr-panel",children:[e.jsxs("header",{className:"ocr-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ocr-eyebrow",children:"テキストスキャン"}),e.jsxs("h3",{children:[a,"の読み取り"]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:s,children:"閉じる"})]}),e.jsx("div",{className:"ocr-video-container",children:z?e.jsx("img",{src:z,alt:"撮影した画像",className:"ocr-preview"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:I,playsInline:!0,autoPlay:!0,muted:!0,className:"ocr-video"}),e.jsx("div",{className:"ocr-frame","aria-hidden":"true",children:e.jsx("span",{className:"ocr-frame__label",children:"黒い帯に合わせてください"})})]})}),e.jsx("p",{className:"helper-text",children:F}),e.jsx("p",{className:`ocr-message ${m==="error"?"is-error":""}`,children:_}),e.jsxs("footer",{className:"ocr-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:s,disabled:O&&m==="processing",children:"キャンセル"}),B&&e.jsx("button",{type:"button",className:"ghost",onClick:L,disabled:O,children:"撮り直し"}),!B&&e.jsx("button",{type:"button",onClick:v,className:"secondary",disabled:O||m!=="camera",children:"撮影"}),B&&e.jsx("button",{type:"button",onClick:g,className:"secondary",disabled:O,children:m==="processing"?"読み取り中...":"読み取る"})]})]})}):null}function Na(){var he,Ee,fe,_e,pe,xe,Ne;Dt();const c=_t(),a=o.useRef(null),{current:s,photos:h,attachPhoto:b,removePhoto:I,setFields:r}=ot(),[l,u]=o.useState(""),[m,y]=o.useState(""),[_,j]=o.useState(""),[O,k]=o.useState(!1),[B,M]=o.useState(!1),[z,C]=o.useState(!1),[D,R]=o.useState("assetNo"),[T,A]=o.useState(!1),[v,g]=o.useState(null);o.useEffect(()=>{go()},[]),o.useEffect(()=>{var x,W,re,de,be;u(((x=s==null?void 0:s.fields)==null?void 0:x.assetNo)??""),y(((W=s==null?void 0:s.fields)==null?void 0:W.equipmentNo)??""),j(((re=s==null?void 0:s.fields)==null?void 0:re.purchaseDate)??""),k(!!((de=s==null?void 0:s.fields)!=null&&de.leaseFlag)),M(!!((be=s==null?void 0:s.fields)!=null&&be.loanedFlag))},[(he=s==null?void 0:s.fields)==null?void 0:he.assetNo,(Ee=s==null?void 0:s.fields)==null?void 0:Ee.equipmentNo,(fe=s==null?void 0:s.fields)==null?void 0:fe.purchaseDate,(_e=s==null?void 0:s.fields)==null?void 0:_e.leaseFlag,(pe=s==null?void 0:s.fields)==null?void 0:pe.loanedFlag]);const L=((xe=s==null?void 0:s.fields)==null?void 0:xe.sealNo)??"",F=((Ne=s==null?void 0:s.fields)==null?void 0:Ne.roomName)??"",N=o.useMemo(()=>h.map(x=>({id:x.id,url:URL.createObjectURL(x.thumb)})),[h]),E=async x=>{if(!x||x.length===0)return;const W=x[0];await b(W),a.current&&(a.current.value="")},H=()=>{const x=!O;k(x),r({leaseFlag:x})},f=()=>{const x=!B;M(x),r({loanedFlag:x})},P=()=>{c("/survey/label")},G=()=>{c("/survey/product")},X=h.length>0,q=x=>{x&&(D==="assetNo"?(u(x),r({assetNo:x})):(y(x),r({equipmentNo:x})))},ge=o.useCallback(x=>{g(`${x.targetLabel}を読み取り: ${x.text}`)},[]);o.useEffect(()=>{if(!v)return;const x=window.setTimeout(()=>g(null),5e3);return()=>{window.clearTimeout(x)}},[v]);const se=x=>{R(x),A(!0)};return e.jsxs("div",{className:"page",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,style:{display:"none"},onChange:x=>E(x.target.files)}),e.jsxs("div",{className:"page-section",children:[v&&e.jsx("div",{className:"ocr-result-banner",children:v}),e.jsx("h2",{className:"section-title",children:"写真撮影・資産No登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:L,disabled:!0})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:F,disabled:!0})]}),e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:l,onChange:x=>{const W=x.target.value;u(W),r({assetNo:W})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>se("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:m,onChange:x=>{const W=x.target.value;y(W),r({equipmentNo:W})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>se("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:_,onChange:x=>{const W=x.target.value;j(W),r({purchaseDate:W})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:O?"secondary":"ghost",onClick:H,children:["リース: ",O?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:B?"secondary":"ghost",onClick:f,children:["貸出品: ",B?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:N.map(x=>e.jsxs("div",{className:"photo-item",children:[e.jsx("button",{type:"button",className:"photo-remove",onClick:()=>I(x.id),"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:x.url,alt:"サムネイル"})]},x.id))})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>C(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:P,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:()=>{var x;return(x=a.current)==null?void 0:x.click()},children:"写真"}),e.jsx("button",{onClick:G,disabled:!X,children:"次へ"})]}),e.jsx(bs,{open:z,onClose:()=>C(!1)}),e.jsx(po,{open:T,targetLabel:D==="assetNo"?"資産番号":"備品番号",onClose:()=>A(!1),onResult:q,onRecognized:ge})]})}const Oa=Object.freeze(Object.defineProperty({__proto__:null,default:Na},Symbol.toStringTag,{value:"Module"}));function Et(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function ba(){var Rt,Ve,At,rt,Ft,dt,Pt,bt,lt;Dt();const c=_t(),{current:a,setFields:s,completeCurrent:h,listHistory:b}=ot(),[I,r]=o.useState([]),[l,u]=o.useState([]),[m,y]=o.useState([]),[_,j]=o.useState([]),[O,k]=o.useState([]),[B,M]=o.useState(""),[z,C]=o.useState(""),[D,R]=o.useState(""),[T,A]=o.useState(""),[v,g]=o.useState(""),[L,F]=o.useState(""),[N,E]=o.useState(""),[H,f]=o.useState(""),[P,G]=o.useState(""),[X,q]=o.useState(!1),[ge,se]=o.useState(!1),[he,Ee]=o.useState([]),[fe,_e]=o.useState(!1),[pe,xe]=o.useState(null),[Ne,x]=o.useState("asc"),W=o.useRef(void 0),re=o.useRef(void 0),de=o.useRef(void 0),be=o.useRef(void 0),ve=o.useRef(void 0);o.useEffect(()=>{Promise.all([w.product_categories.toArray(),w.product_subcategories.toArray(),w.product_items.toArray(),w.product_makers.toArray(),w.product_models.toArray()]).then(([i,S,ce,ye,Qe])=>{r(i),u(S),y(ce),j(ye),k(Qe)})},[]),o.useEffect(()=>{var i,S,ce,ye;F(((i=a==null?void 0:a.fields)==null?void 0:i.width)??""),E(((S=a==null?void 0:a.fields)==null?void 0:S.depth)??""),f(((ce=a==null?void 0:a.fields)==null?void 0:ce.height)??""),G(((ye=a==null?void 0:a.fields)==null?void 0:ye.note)??"")},[(Rt=a==null?void 0:a.fields)==null?void 0:Rt.width,(Ve=a==null?void 0:a.fields)==null?void 0:Ve.depth,(At=a==null?void 0:a.fields)==null?void 0:At.height,(rt=a==null?void 0:a.fields)==null?void 0:rt.note]);const Y=(Ft=a==null?void 0:a.fields)==null?void 0:Ft.categoryId,oe=(dt=a==null?void 0:a.fields)==null?void 0:dt.subcategoryId,d=(Pt=a==null?void 0:a.fields)==null?void 0:Pt.itemId,U=(bt=a==null?void 0:a.fields)==null?void 0:bt.makerId,K=(lt=a==null?void 0:a.fields)==null?void 0:lt.modelId,Z=I.find(i=>i.id===Y),J=l.find(i=>i.id===oe),le=m.find(i=>i.id===d),ee=_.find(i=>i.id===U),je=O.find(i=>i.id===K);o.useEffect(()=>{(Z==null?void 0:Z.id)!==W.current&&(Z?M(Z.name):W.current&&M(""),W.current=Z==null?void 0:Z.id)},[Z]),o.useEffect(()=>{(J==null?void 0:J.id)!==re.current&&(J?C(J.name):re.current&&C(""),re.current=J==null?void 0:J.id)},[J]),o.useEffect(()=>{(le==null?void 0:le.id)!==de.current&&(le?R(le.name):de.current&&R(""),de.current=le==null?void 0:le.id)},[le]),o.useEffect(()=>{(ee==null?void 0:ee.id)!==be.current&&(ee?A(ee.name):be.current&&A(""),be.current=ee==null?void 0:ee.id)},[ee]),o.useEffect(()=>{(je==null?void 0:je.id)!==ve.current&&(je?g(je.name):ve.current&&g(""),ve.current=je==null?void 0:je.id)},[je]);const De=o.useMemo(()=>I.filter(i=>Et(i.name,B)),[I,B]),at=o.useMemo(()=>l.filter(i=>Et(i.name,z)),[l,z]),nt=o.useMemo(()=>m.filter(i=>Et(i.name,D)),[m,D]),it=o.useMemo(()=>_.filter(i=>Et(i.name,T)),[_,T]),Ot=o.useMemo(()=>O.filter(i=>Et(i.name,v)),[O,v]),pt=i=>{if(Y===i.id){M(""),C(""),R(""),A(""),g(""),s({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}M(i.name),C(""),R(""),A(""),g(""),s({categoryId:i.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},vt=i=>{if(oe===i.id){C(""),R(""),A(""),g(""),s({categoryId:Y??i.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}C(i.name),R(""),A(""),g(""),s({categoryId:i.categoryId,subcategoryId:i.id,itemId:void 0,makerId:void 0,modelId:void 0})},yt=i=>{if(d===i.id){R(""),A(""),g(""),s({categoryId:Y??i.categoryId,subcategoryId:oe??i.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}R(i.name),A(""),g(""),s({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.id,makerId:void 0,modelId:void 0})},It=i=>{if(U===i.id){A(""),g(""),s({categoryId:Y??i.categoryId,subcategoryId:oe??i.subcategoryId,itemId:d??i.itemId,makerId:void 0,modelId:void 0});return}A(i.name),g(""),s({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.id,modelId:void 0})},xt=i=>{if(K===i.id){g(""),s({categoryId:Y??i.categoryId,subcategoryId:oe??i.subcategoryId,itemId:d??i.itemId,makerId:U??i.makerId,modelId:void 0});return}g(i.name),s({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.makerId,modelId:i.id})},Nt=o.useCallback(async i=>{_e(!0),xe(null);try{const S=await b(i);Ee(S)}catch(S){const ce=S instanceof Error?S.message:String(S);xe(ce),Ee([])}finally{_e(!1)}},[b]);o.useEffect(()=>{X?Nt(Ne):xe(null)},[X,Ne,Nt]);const Xt=i=>{const S=i.categoryId,ce=i.subcategoryId,ye=i.itemId,Qe=i.makerId,ct=i.modelId,Xe=i.width!=null?String(i.width):"",Re=i.depth!=null?String(i.depth):"",Ye=i.height!=null?String(i.height):"",Je=i.note!=null?String(i.note):"";F(Xe),E(Re),f(Ye),G(Je);const et=I.find(ue=>ue.id===S),Be=l.find(ue=>ue.id===ce),Ue=m.find(ue=>ue.id===ye),$e=_.find(ue=>ue.id===Qe),Ae=O.find(ue=>ue.id===ct);M((et==null?void 0:et.name)??""),C((Be==null?void 0:Be.name)??""),R((Ue==null?void 0:Ue.name)??""),A(($e==null?void 0:$e.name)??""),g((Ae==null?void 0:Ae.name)??""),s({categoryId:S,subcategoryId:ce,itemId:ye,makerId:Qe,modelId:ct,width:Xe,depth:Re,height:Ye,note:Je})},Yt=i=>{Xt(i.fields??{}),q(!1)},Jt=()=>{x(i=>i==="asc"?"desc":"asc")},es=async()=>{await h({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),c("/survey/label")},Mt=()=>{s({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0}),c("/survey/department")};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"商品登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:B,onChange:i=>M(i.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:De.map(i=>e.jsx("button",{onClick:()=>pt(i),className:i.id===Y?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:z,onChange:i=>C(i.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:at.map(i=>e.jsx("button",{onClick:()=>vt(i),className:i.id===oe?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:D,onChange:i=>R(i.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:nt.map(i=>e.jsx("button",{onClick:()=>yt(i),className:i.id===d?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:T,onChange:i=>A(i.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:it.map(i=>e.jsx("button",{onClick:()=>It(i),className:i.id===U?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:v,onChange:i=>g(i.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:Ot.map(i=>e.jsx("button",{onClick:()=>xt(i),className:i.id===K?"active":"",children:i.name},i.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["W",e.jsx("input",{value:L,onChange:i=>{const S=i.target.value;F(S),s({width:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:N,onChange:i=>{const S=i.target.value;E(S),s({depth:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:H,onChange:i=>{const S=i.target.value;f(S),s({height:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:P,onChange:i=>{const S=i.target.value;G(S),s({note:S})},rows:3})]})]}),e.jsx("div",{className:"row",style:{justifyContent:"flex-start",marginTop:8},children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>q(!0),children:"履歴表示"})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>se(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:()=>c("/survey/asset"),children:"戻る"}),e.jsx("button",{className:"secondary",onClick:Mt,children:"部門"}),e.jsx("button",{onClick:es,children:"次へ"})]}),X&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:Jt,children:Ne==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>q(!1),children:"閉じる"})]})]}),fe&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),pe&&e.jsxs("p",{className:"badge warn",children:["エラー: ",pe]}),!fe&&!pe&&he.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!fe&&!pe&&he.length>0&&e.jsx("div",{className:"history-list",children:he.map(i=>{var Be,Ue,$e,Ae,ue;const S=i.fields??{},ce=S.completedAt??i.updatedAt,ye=((Be=I.find(we=>we.id===S.categoryId))==null?void 0:Be.name)??"-",Qe=((Ue=l.find(we=>we.id===S.subcategoryId))==null?void 0:Ue.name)??"-",ct=(($e=m.find(we=>we.id===S.itemId))==null?void 0:$e.name)??"-",Xe=((Ae=_.find(we=>we.id===S.makerId))==null?void 0:Ae.name)??"-",Re=((ue=O.find(we=>we.id===S.modelId))==null?void 0:ue.name)??"-",Ye=S.width??"-",Je=S.depth??"-",et=S.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>Yt(i),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(ce).toLocaleString()}),S.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",S.assetNo]}),S.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",S.equipmentNo]}),S.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",S.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:ye}),e.jsx("span",{className:"pill",children:Qe}),e.jsx("span",{className:"pill",children:ct}),e.jsx("span",{className:"pill",children:Xe}),e.jsx("span",{className:"pill",children:Re})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",Ye]}),e.jsxs("span",{children:["D: ",Je]}),e.jsxs("span",{children:["H: ",et]})]})]},i.id)})})]})}),e.jsx(bs,{open:ge,onClose:()=>se(!1)})]})}const Ma=Object.freeze(Object.defineProperty({__proto__:null,default:ba},Symbol.toStringTag,{value:"Module"}));function Te(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function Ra(){var Os,Ms,Rs,As,Fs,Ps,Ls,Ts,Qs,Bs,Us,$s,Hs,qs,Ws,zs,Gs,Ks,Zs,Vs,Xs,Ys,Js,eo,to,so,oo,ao,no,io,ro;Dt();const c=_t(),a=ot(),{current:s,photos:h,attachPhoto:b,removePhoto:I,setFields:r,completeCurrent:l,listHistory:u,load:m,completedCount:y,duplicateDraft:_,setQR:j,togglePhotoForList:O}=a,[k,B]=o.useState([]),[M,z]=o.useState([]),[C,D]=o.useState([]),[R,T]=o.useState([]),[A,v]=o.useState(""),[g,L]=o.useState(""),[F,N]=o.useState(""),[E,H]=o.useState(""),[f,P]=o.useState(void 0),[G,X]=o.useState(void 0),[q,ge]=o.useState(void 0),[se,he]=o.useState(void 0),Ee=o.useMemo(()=>{const t=new Date;return`${t.getFullYear()}年${String(t.getMonth()+1).padStart(2,"0")}月${String(t.getDate()).padStart(2,"0")}日`},[]),fe=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{Promise.all([w.location_buildings.toArray(),w.location_floors.toArray(),w.location_departments.toArray(),w.location_divisions.toArray()]).then(([t,n,p,Q])=>{B(t),z(n),D(p),T(Q)})},[]),o.useEffect(()=>{var n,p;if(!s)return;const t={};(n=s.fields)!=null&&n.surveyDate||(t.surveyDate=Ee),fe&&((p=s.fields)==null?void 0:p.investigator)!==fe&&(t.investigator=fe),Object.keys(t).length>0&&r(t)},[s,fe,r,Ee]);const _e=(Os=s==null?void 0:s.fields)==null?void 0:Os.buildingId,pe=(Ms=s==null?void 0:s.fields)==null?void 0:Ms.floorId,xe=(Rs=s==null?void 0:s.fields)==null?void 0:Rs.departmentId,Ne=(As=s==null?void 0:s.fields)==null?void 0:As.divisionId;o.useEffect(()=>{P(_e)},[_e]),o.useEffect(()=>{X(pe)},[pe]),o.useEffect(()=>{ge(xe)},[xe]),o.useEffect(()=>{he(Ne)},[Ne]);const x=o.useMemo(()=>k.find(t=>t.id===f),[k,f]),W=o.useMemo(()=>M.find(t=>t.id===G),[M,G]),re=o.useMemo(()=>C.find(t=>t.id===q),[C,q]),de=o.useMemo(()=>R.find(t=>t.id===se),[R,se]);o.useEffect(()=>{v((x==null?void 0:x.name)??"")},[x]),o.useEffect(()=>{L((W==null?void 0:W.name)??"")},[W]),o.useEffect(()=>{N((re==null?void 0:re.name)??"")},[re]),o.useEffect(()=>{H((de==null?void 0:de.name)??"")},[de]),o.useMemo(()=>k.filter(t=>Te(t.name,A)),[k,A]),o.useMemo(()=>M.filter(t=>Te(t.name,g)),[M,g]),o.useMemo(()=>C.filter(t=>Te(t.name,F)),[C,F]),o.useMemo(()=>R.filter(t=>Te(t.name,E)),[R,E]);const be=!!(f&&G&&q&&se),ve=o.useRef(null),[Y,oe]=o.useState(""),[d,U]=o.useState(""),[K,Z]=o.useState([]),[J,le]=o.useState(!1),[ee,je]=o.useState(!1),[De,at]=o.useState(""),[nt,it]=o.useState(""),[Ot,pt]=o.useState("single");o.useEffect(()=>{var t,n;oe(((t=s==null?void 0:s.fields)==null?void 0:t.sealNo)??""),U(((n=s==null?void 0:s.fields)==null?void 0:n.roomName)??"")},[(Fs=s==null?void 0:s.fields)==null?void 0:Fs.sealNo,(Ps=s==null?void 0:s.fields)==null?void 0:Ps.roomName]),o.useEffect(()=>()=>{var t;(t=ve.current)==null||t.stop()},[]),o.useEffect(()=>{let t=!0;return w.location_rooms.toArray().then(n=>{t&&Z(n)}).catch(()=>{t&&Z([])}),()=>{t=!1}},[]);const vt=(Ls=s==null?void 0:s.fields)==null?void 0:Ls.buildingId,yt=(Ts=s==null?void 0:s.fields)==null?void 0:Ts.floorId,It=(Qs=s==null?void 0:s.fields)==null?void 0:Qs.departmentId,xt=(Bs=s==null?void 0:s.fields)==null?void 0:Bs.divisionId,Nt=o.useMemo(()=>{const t=d.trim().toLowerCase();let n=K;return vt&&yt&&It&&xt&&(n=n.filter(p=>!(p.buildingId!==vt||p.floorId!==yt||p.departmentId!==It||p.divisionId!==xt))),t?n.filter(p=>p.name.toLowerCase().includes(t)):n},[K,vt,yt,It,xt,d]),Xt=t=>{const n=t.trim(),p=n.match(/https?:\/\/[^/]+\/x\/([A-Za-z0-9-]+)$/i),Q=n.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i),$=p&&p[1]||Q&&Q[0]||n;Ot==="bulkStart"?(at($),r({bulkStartSealNo:$})):Ot==="bulkEnd"?(it($),r({bulkEndSealNo:$})):(oe($),j($))},Yt=t=>{oe(t),r({sealNo:t,qrCode:t})},Jt=t=>{U(t),r({roomName:t}),le(!1)},es=t=>{je(t),t?Y.trim()&&(at(Y),it(Y),r({bulkStartSealNo:Y,bulkEndSealNo:Y})):De.trim()&&(oe(De),r({sealNo:De,qrCode:De}))},Mt=(t,n)=>{const p=t.match(/(\d+)(?!.*\d)/),Q=n.match(/(\d+)(?!.*\d)/);if(!p||!Q||p.index===void 0||Q.index===void 0)return null;const $=Number.parseInt(p[1],10),ne=Number.parseInt(Q[1],10),ie=p[1].length,ke=Q[1].length===ie,Ie=t.slice(0,p.index),Pe=t.slice(p.index+ie),Me=n.slice(0,Q.index),Ce=n.slice(Q.index+Q[1].length);return!ke||!(Ie===Me&&Pe===Ce)||ne<$?null:ne-$+1},Rt=o.useMemo(()=>{const t=d.trim().length>0,n=Y.trim().length>0,p=Mt(De.trim(),nt.trim()),Q=ee&&p!==null&&p>0;return t&&(!ee&&n||Q)},[ee,De,nt,d,Y]),Ve=o.useRef(null),[At,rt]=o.useState(""),[Ft,dt]=o.useState(""),[Pt,bt]=o.useState(""),[lt,i]=o.useState(!1),[S,ce]=o.useState(!1),[ye,Qe]=o.useState("assetNo"),[ct,Xe]=o.useState(!1),[Re,Ye]=o.useState(null);o.useEffect(()=>{go()},[]),o.useEffect(()=>{var t,n,p,Q,$,ne,ie;rt(((t=s==null?void 0:s.fields)==null?void 0:t.assetNo)??""),dt(((n=s==null?void 0:s.fields)==null?void 0:n.equipmentNo)??""),bt(((p=s==null?void 0:s.fields)==null?void 0:p.purchaseDate)??""),i(!!((Q=s==null?void 0:s.fields)!=null&&Q.leaseFlag)),ce(!!(($=s==null?void 0:s.fields)!=null&&$.loanedFlag)),at(((ne=s==null?void 0:s.fields)==null?void 0:ne.bulkStartSealNo)??""),it(((ie=s==null?void 0:s.fields)==null?void 0:ie.bulkEndSealNo)??"")},[(Us=s==null?void 0:s.fields)==null?void 0:Us.assetNo,($s=s==null?void 0:s.fields)==null?void 0:$s.equipmentNo,(Hs=s==null?void 0:s.fields)==null?void 0:Hs.purchaseDate,(qs=s==null?void 0:s.fields)==null?void 0:qs.leaseFlag,(Ws=s==null?void 0:s.fields)==null?void 0:Ws.loanedFlag,(zs=s==null?void 0:s.fields)==null?void 0:zs.bulkStartSealNo,(Gs=s==null?void 0:s.fields)==null?void 0:Gs.bulkEndSealNo]);const Je=o.useMemo(()=>h.map(t=>({id:t.id,url:URL.createObjectURL(t.thumb),selectedForList:!!t.selectedForList})),[h]),et=async t=>{if(!t||t.length===0)return;const n=t[0];await b(n),Ve.current&&(Ve.current.value="")},Be=()=>{const t=!lt;i(t),r({leaseFlag:t})},Ue=()=>{const t=!S;ce(t),r({loanedFlag:t})},$e=t=>{t&&(ye==="assetNo"?(rt(t),r({assetNo:t})):(dt(t),r({equipmentNo:t})))},Ae=t=>{Qe(t),Xe(!0)},ue=o.useCallback(t=>{Ye(`${t.targetLabel}を読み取り: ${t.text}`)},[]);o.useEffect(()=>{if(!Re)return;const t=window.setTimeout(()=>Ye(null),5e3);return()=>{window.clearTimeout(t)}},[Re]);const we=h.length>0,[tt,vo]=o.useState([]),[He,yo]=o.useState([]),[qe,Io]=o.useState([]),[We,xo]=o.useState([]),[ut,No]=o.useState([]),[jt,wt]=o.useState(""),[St,ze]=o.useState(""),[kt,Se]=o.useState(""),[Ct,me]=o.useState(""),[ts,te]=o.useState(""),[bo,Lt]=o.useState(!1),[jo,Tt]=o.useState(!1),[wo,Qt]=o.useState(!1),[So,Bt]=o.useState(!1),[ko,Ut]=o.useState(!1),[Co,ss]=o.useState(""),[Eo,os]=o.useState(""),[_o,as]=o.useState(""),[Do,ns]=o.useState(""),[is,rs]=o.useState(!1),[ds,js]=o.useState([]),[ls,ws]=o.useState(!1),[$t,cs]=o.useState(null),[us,Oo]=o.useState("asc");o.useEffect(()=>{Promise.all([w.product_categories.toArray(),w.product_subcategories.toArray(),w.product_items.toArray(),w.product_makers.toArray(),w.product_models.toArray()]).then(([t,n,p,Q,$])=>{vo(t),yo(n),Io(p),xo(Q),No($)})},[]),o.useEffect(()=>{var t,n,p,Q;ss(((t=s==null?void 0:s.fields)==null?void 0:t.width)??""),os(((n=s==null?void 0:s.fields)==null?void 0:n.depth)??""),as(((p=s==null?void 0:s.fields)==null?void 0:p.height)??""),ns(((Q=s==null?void 0:s.fields)==null?void 0:Q.note)??"")},[(Ks=s==null?void 0:s.fields)==null?void 0:Ks.width,(Zs=s==null?void 0:s.fields)==null?void 0:Zs.depth,(Vs=s==null?void 0:s.fields)==null?void 0:Vs.height,(Xs=s==null?void 0:s.fields)==null?void 0:Xs.note]);const Oe=(Ys=s==null?void 0:s.fields)==null?void 0:Ys.categoryId,Fe=(Js=s==null?void 0:s.fields)==null?void 0:Js.subcategoryId,Ge=(eo=s==null?void 0:s.fields)==null?void 0:eo.itemId,st=(to=s==null?void 0:s.fields)==null?void 0:to.makerId,ms=(so=s==null?void 0:s.fields)==null?void 0:so.modelId,Ht=tt.find(t=>t.id===Oe),qt=He.find(t=>t.id===Fe),Wt=qe.find(t=>t.id===Ge),zt=We.find(t=>t.id===st),Gt=ut.find(t=>t.id===ms);o.useEffect(()=>{const t=(s==null?void 0:s.fields)??{},n=t.categoryName??(Ht==null?void 0:Ht.name)??"",p=t.subcategoryName??(qt==null?void 0:qt.name)??"",Q=t.itemName??(Wt==null?void 0:Wt.name)??"",$=t.makerName??(zt==null?void 0:zt.name)??"",ne=t.modelName??(Gt==null?void 0:Gt.name)??"";wt(n),ze(p),Se(Q),me($),te(ne)},[(oo=s==null?void 0:s.fields)==null?void 0:oo.categoryName,(ao=s==null?void 0:s.fields)==null?void 0:ao.subcategoryName,(no=s==null?void 0:s.fields)==null?void 0:no.itemName,(io=s==null?void 0:s.fields)==null?void 0:io.makerName,(ro=s==null?void 0:s.fields)==null?void 0:ro.modelName,Ht,qt,Wt,zt,Gt]);const Ss=o.useMemo(()=>tt.filter(t=>Te(t.name,jt)),[tt,jt]),mt=o.useMemo(()=>{if(Oe)return Oe;const t=jt.trim().toLowerCase();if(!t)return null;const n=tt.find(p=>p.name.toLowerCase()===t);return(n==null?void 0:n.id)??null},[tt,Oe,jt]),ks=o.useMemo(()=>(mt?He.filter(n=>n.categoryId===mt):He).filter(n=>Te(n.name,St)),[mt,He,St]),ht=o.useMemo(()=>{if(Fe)return Fe;const t=St.trim().toLowerCase();if(!t||!mt)return null;const n=He.find(p=>p.categoryId===mt&&p.name.toLowerCase()===t);return(n==null?void 0:n.id)??null},[mt,He,Fe,St]),Cs=o.useMemo(()=>(ht?qe.filter(n=>n.subcategoryId===ht):qe).filter(n=>Te(n.name,kt)),[ht,qe,kt]),ft=o.useMemo(()=>{if(Ge)return Ge;const t=kt.trim().toLowerCase();if(!t||!ht)return null;const n=qe.find(p=>p.subcategoryId===ht&&p.name.toLowerCase()===t);return(n==null?void 0:n.id)??null},[ht,qe,Ge,kt]),Es=o.useMemo(()=>(ft?We.filter(n=>n.itemId===ft):We).filter(n=>Te(n.name,Ct)),[ft,We,Ct]),hs=o.useMemo(()=>{if(st)return st;const t=Ct.trim().toLowerCase();if(!t||!ft)return null;const n=We.find(p=>p.itemId===ft&&p.name.toLowerCase()===t);return(n==null?void 0:n.id)??null},[ft,We,st,Ct]),_s=o.useMemo(()=>(hs?ut.filter(n=>n.makerId===hs):ut).filter(n=>Te(n.name,ts)),[hs,ut,ts]),Mo=t=>{wt(t),ze(""),Se(""),me(""),te(""),r({categoryName:t,categoryId:void 0,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Ro=t=>{ze(t),Se(""),me(""),te(""),r({subcategoryName:t,subcategoryId:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Ao=t=>{Se(t),me(""),te(""),r({itemName:t,itemId:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Fo=t=>{me(t),te(""),r({makerName:t,makerId:void 0,modelId:void 0,modelName:void 0})},Po=t=>{te(t),r({modelName:t,modelId:void 0})},Lo=t=>{if(Oe===t.id){wt(""),ze(""),Se(""),me(""),te(""),r({categoryId:void 0,categoryName:void 0,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}wt(t.name),ze(""),Se(""),me(""),te(""),Lt(!1),r({categoryId:t.id,categoryName:t.name,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},To=t=>{if(Fe===t.id){ze(""),Se(""),me(""),te(""),r({categoryId:Oe??t.categoryId,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}ze(t.name),Se(""),me(""),te(""),Tt(!1),r({categoryId:t.categoryId,subcategoryId:t.id,subcategoryName:t.name,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Qo=t=>{if(Ge===t.id){Se(""),me(""),te(""),r({categoryId:Oe??t.categoryId,subcategoryId:Fe??t.subcategoryId,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}Se(t.name),me(""),te(""),Qt(!1),r({categoryId:t.categoryId,subcategoryId:t.subcategoryId,itemId:t.id,itemName:t.name,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Bo=t=>{if(st===t.id){me(""),te(""),r({categoryId:Oe??t.categoryId,subcategoryId:Fe??t.subcategoryId,itemId:Ge??t.itemId,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}me(t.name),te(""),Bt(!1),r({categoryId:t.categoryId,subcategoryId:t.subcategoryId,itemId:t.itemId,makerId:t.id,makerName:t.name,modelId:void 0,modelName:void 0})},Uo=t=>{if(ms===t.id){te(""),r({categoryId:Oe??t.categoryId,subcategoryId:Fe??t.subcategoryId,itemId:Ge??t.itemId,makerId:st??t.makerId,modelId:void 0,modelName:void 0});return}te(t.name),Ut(!1),r({categoryId:t.categoryId,subcategoryId:t.subcategoryId,itemId:t.itemId,makerId:t.makerId,modelId:t.id,modelName:t.name})},Ds=o.useCallback(async t=>{ws(!0),cs(null);try{const n=await u(t);js(n)}catch(n){const p=n instanceof Error?n.message:String(n);cs(p),js([])}finally{ws(!1)}},[u]);o.useEffect(()=>{is?Ds(us):cs(null)},[is,us,Ds]);const $o=t=>{const n=t.categoryId,p=t.subcategoryId,Q=t.itemId,$=t.makerId,ne=t.modelId,ie=t.width!=null?String(t.width):"",ke=t.depth!=null?String(t.depth):"",Ie=t.height!=null?String(t.height):"",Pe=t.note!=null?String(t.note):"";ss(ie),os(ke),as(Ie),ns(Pe);const Me=tt.find(V=>V.id===n),Ce=He.find(V=>V.id===p),Le=qe.find(V=>V.id===Q),Ke=We.find(V=>V.id===$),Ze=ut.find(V=>V.id===ne);wt((Me==null?void 0:Me.name)??""),ze((Ce==null?void 0:Ce.name)??""),Se((Le==null?void 0:Le.name)??""),me((Ke==null?void 0:Ke.name)??""),te((Ze==null?void 0:Ze.name)??""),r({categoryId:n,subcategoryId:p,itemId:Q,makerId:$,modelId:ne,width:ie,depth:ke,height:Ie,note:Pe})},Ho=t=>{$o(t.fields??{}),rs(!1)},qo=()=>{Oo(t=>t==="asc"?"desc":"asc")},Wo=async()=>{var ne;if(!ee){const ie=((ne=s==null?void 0:s.fields)==null?void 0:ne.sealNo)??Y;let ke=null;if(ie){const Ie=ie.match(/(\d+)(?!.*\d)/);if(Ie&&Ie.index!==void 0){const Pe=Ie.index,Me=Number.parseInt(Ie[1],10),Ce=Ie[1].length,Le=ie.slice(0,Pe),Ke=ie.slice(Pe+Ce),Ze=Me+1,V=String(Ze).padStart(Ce,"0");ke=`${Le}${V}${Ke}`}}await l({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),ke&&(oe(ke),await j(ke));return}const t=De.trim(),n=nt.trim(),p=Mt(t,n);if(!p||p<=0){alert("一括登録モードでは、開始・終了シールNoを連番で入力してください。");return}if(!s)return;const Q=s.id;oe(t),await j(t),await l({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});const $=p-1;$>0&&await _(Q,$)},zo=async()=>{try{const n=(await u("desc"))[0];if(!n)return;await m(n.id)}catch(t){console.error(t)}};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["登録モード",e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:ee,onChange:t=>es(t.target.checked),style:{width:16,height:16}}),e.jsx("span",{children:"一括登録モード"})]})]}),ee?e.jsxs("label",{children:["開始シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:De,onChange:t=>{const n=t.target.value;at(n),r({bulkStartSealNo:n})},placeholder:"開始シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var t;try{pt("bulkStart"),await Vt(),await((t=ve.current)==null?void 0:t.start())}catch(n){const p=n instanceof Error?n.message:String(n);alert(`カメラを利用できませんでした: ${p}`)}},children:"QR撮影"})]})]}):e.jsxs("label",{children:["シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Y,onChange:t=>Yt(t.target.value),placeholder:"シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var t;try{pt("single"),await Vt(),await((t=ve.current)==null?void 0:t.start())}catch(n){const p=n instanceof Error?n.message:String(n);alert(`カメラを利用できませんでした: ${p}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:d,onChange:t=>{U(t.target.value),r({roomName:t.target.value}),le(!0)},onFocus:()=>le(!0),onBlur:()=>{window.setTimeout(()=>{le(!1)},100)},placeholder:"室名を入力"}),J&&Nt.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:Nt.map(t=>e.jsx("button",{type:"button",onClick:()=>Jt(t.name),children:t.name},t.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ns,{ref:ve,onResult:Xt})}),e.jsx("div",{className:"section-title-underline-blue",style:{margin:"20px 0"}}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:Ve,style:{display:"none"},onChange:t=>et(t.target.files)}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:At,onChange:t=>{const n=t.target.value;rt(n),r({assetNo:n})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Ae("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Ft,onChange:t=>{const n=t.target.value;dt(n),r({equipmentNo:n})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Ae("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",className:"date-input",value:Pt,onChange:t=>{const n=t.target.value;bt(n),r({purchaseDate:n})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:lt?"secondary":"ghost",onClick:Be,children:["リース: ",lt?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:S?"secondary":"ghost",onClick:Ue,children:["貸出品: ",S?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:Je.length===0?e.jsx("div",{className:"photo-strip-empty",children:"撮影した写真がここに表示されます"}):Je.map(t=>e.jsxs("div",{className:`photo-item${t.selectedForList?" is-selected":""}`,onClick:()=>{O(t.id)},children:[e.jsx("span",{className:"visually-hidden",children:"一覧表示用の写真として選択"}),e.jsx("button",{type:"button",className:"photo-remove",onClick:n=>{n.stopPropagation(),I(t.id)},"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:t.url,alt:"サムネイル"})]},t.id))}),Re&&e.jsx("div",{className:"ocr-result-banner",children:Re}),e.jsx("div",{className:"section-title-underline-blue",style:{margin:"20px 0"}}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:jt,onChange:t=>{Mo(t.target.value),Lt(!0)},onFocus:()=>Lt(!0),onBlur:()=>{window.setTimeout(()=>{Lt(!1)},100)},placeholder:"大分類を検索"})]}),bo&&Ss.length>0&&e.jsx("div",{className:"option-list",children:Ss.map(t=>e.jsx("button",{onClick:()=>Lo(t),className:t.id===Oe?"active":"",children:t.name},t.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:St,onChange:t=>{Ro(t.target.value),Tt(!0)},onFocus:()=>Tt(!0),onBlur:()=>{window.setTimeout(()=>{Tt(!1)},100)},placeholder:"中分類を検索"})]}),jo&&ks.length>0&&e.jsx("div",{className:"option-list",children:ks.map(t=>e.jsx("button",{onClick:()=>To(t),className:t.id===Fe?"active":"",children:t.name},t.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:kt,onChange:t=>{Ao(t.target.value),Qt(!0)},onFocus:()=>Qt(!0),onBlur:()=>{window.setTimeout(()=>{Qt(!1)},100)},placeholder:"品目を検索"})]}),wo&&Cs.length>0&&e.jsx("div",{className:"option-list",children:Cs.map(t=>e.jsx("button",{onClick:()=>Qo(t),className:t.id===Ge?"active":"",children:t.name},t.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:Ct,onChange:t=>{Fo(t.target.value),Bt(!0)},onFocus:()=>Bt(!0),onBlur:()=>{window.setTimeout(()=>{Bt(!1)},100)},placeholder:"メーカー名を検索"})]}),So&&Es.length>0&&e.jsx("div",{className:"option-list",children:Es.map(t=>e.jsx("button",{onClick:()=>Bo(t),className:t.id===st?"active":"",children:t.name},t.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:ts,onChange:t=>{Po(t.target.value),Ut(!0)},onFocus:()=>Ut(!0),onBlur:()=>{window.setTimeout(()=>{Ut(!1)},100)},placeholder:"型式を検索"})]}),ko&&_s.length>0&&e.jsx("div",{className:"option-list",children:_s.map(t=>e.jsx("button",{onClick:()=>Uo(t),className:t.id===ms?"active":"",children:t.name},t.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("div",{className:"asset-size-row",children:[e.jsxs("label",{children:["W",e.jsx("input",{value:Co,onChange:t=>{const n=t.target.value;ss(n),r({width:n})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:Eo,onChange:t=>{const n=t.target.value;os(n),r({depth:n})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:_o,onChange:t=>{const n=t.target.value;as(n),r({height:n})},placeholder:"mm"})]})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:Do,onChange:t=>{const n=t.target.value;ns(n),r({note:n})},rows:3})]})]}),ee&&e.jsx("div",{className:"grid",style:{marginTop:12},children:e.jsxs("label",{children:["終了シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:nt,onChange:t=>{const n=t.target.value;it(n),r({bulkEndSealNo:n})},placeholder:"終了シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var t;try{pt("bulkEnd"),await Vt(),await((t=ve.current)==null?void 0:t.start())}catch(n){const p=n instanceof Error?n.message:String(n);alert(`カメラを利用できませんでした: ${p}`)}},children:"QR撮影"})]})]})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/survey/home"),children:"ホーム"}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>c("/survey/department"),children:["部門",e.jsx("br",{}),"入力へ"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>rs(!0),children:["履歴",e.jsx("br",{}),"表示"]}),e.jsxs("button",{type:"button",className:"secondary",onClick:()=>{var t;return(t=Ve.current)==null?void 0:t.click()},children:["写真",e.jsx("br",{}),"撮影"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:zo,disabled:y===0,children:["前の商品に",e.jsx("br",{}),"戻る"]}),e.jsxs("button",{type:"button",onClick:Wo,disabled:!(be&&Rt&&we),children:["商品",e.jsx("br",{}),"登録"]})]}),e.jsx(po,{open:ct,targetLabel:ye==="assetNo"?"資産番号":"備品番号",onClose:()=>Xe(!1),onResult:$e,onRecognized:ue}),is&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:qo,children:us==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>rs(!1),children:"閉じる"})]})]}),ls&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),$t&&e.jsxs("p",{className:"badge warn",children:["エラー: ",$t]}),!ls&&!$t&&ds.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!ls&&!$t&&ds.length>0&&e.jsx("div",{className:"history-list",children:e.jsxs("table",{className:"history-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"大分類"}),e.jsx("th",{children:"中分類"}),e.jsx("th",{children:"品目"}),e.jsx("th",{children:"メーカー名"}),e.jsx("th",{children:"型式"}),e.jsx("th",{children:"W"}),e.jsx("th",{children:"D"}),e.jsx("th",{children:"H"})]})}),e.jsx("tbody",{children:ds.map(t=>{var Me,Ce,Le,Ke,Ze;const n=t.fields??{},p=n.categoryName??((Me=tt.find(V=>V.id===n.categoryId))==null?void 0:Me.name)??"-",Q=n.subcategoryName??((Ce=He.find(V=>V.id===n.subcategoryId))==null?void 0:Ce.name)??"-",$=n.itemName??((Le=qe.find(V=>V.id===n.itemId))==null?void 0:Le.name)??"-",ne=n.makerName??((Ke=We.find(V=>V.id===n.makerId))==null?void 0:Ke.name)??"-",ie=n.modelName??((Ze=ut.find(V=>V.id===n.modelId))==null?void 0:Ze.name)??"-",ke=n.width??"-",Ie=n.depth??"-",Pe=n.height??"-";return e.jsxs("tr",{className:"history-row",onClick:()=>Ho(t),children:[e.jsx("td",{children:p}),e.jsx("td",{children:Q}),e.jsx("td",{children:$}),e.jsx("td",{children:ne}),e.jsx("td",{children:ie}),e.jsx("td",{children:ke}),e.jsx("td",{children:Ie}),e.jsx("td",{children:Pe})]},t.id)})})]})})]})})]})}export{Na as A,va as D,ya as L,ba as P,Ra as S,Ca as a,Ea as b,Da as c,w as d,Vt as e,Oa as f,Ma as g,go as p,_a as q,ot as u,ha as w};
