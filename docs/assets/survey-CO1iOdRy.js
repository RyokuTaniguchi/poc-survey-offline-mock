var wo=Object.defineProperty;var So=(l,a,t)=>a in l?wo(l,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[a]=t;var oe=(l,a,t)=>So(l,typeof a!="symbol"?a+"":a,t);import{i as Ks,c as Co,r as o,s as Ys,u as Nt,j as e}from"./vendor-5jQwBCrV.js";import{D as ko}from"./vendor-dexie-DWlydIdn.js";import{B as rs}from"./vendor-zxing-DcYOnkv9.js";class Eo extends ko{constructor(){super("meddx_survey");oe(this,"survey_drafts");oe(this,"survey_photos");oe(this,"survey_masters");oe(this,"indices");oe(this,"settings");oe(this,"location_buildings");oe(this,"location_floors");oe(this,"location_departments");oe(this,"location_divisions");oe(this,"product_categories");oe(this,"product_subcategories");oe(this,"product_items");oe(this,"product_makers");oe(this,"product_models");oe(this,"location_rooms");this.version(1).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key"}),this.version(2).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name"}),this.version(3).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name",location_rooms:"id,buildingId,floorId,departmentId,divisionId,name"})}}const N=new Eo,_o="/poc-survey-offline-mock/".replace(/\/?$/,"/"),Zs=`${_o}vendor/browser-image-compression.js`;async function Do(l,a=2560){const h=await Ks(l,{maxWidthOrHeight:a,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Zs}),b=await Ks(l,{maxWidthOrHeight:512,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Zs});return{blob:h,thumb:b}}const Xe=Co((l,a)=>{const t=async()=>{const i=a().current;if(!i){l({photos:[]});return}const d=await N.survey_photos.where("draftId").equals(i.id).reverse().toArray();l({photos:d})},h=async()=>{const i=await N.survey_drafts.filter(d=>{var u;return((u=d.fields)==null?void 0:u.status)==="completed"}).count();l({completedCount:i})},b=async i=>{await N.survey_drafts.put(i),l({current:i}),await h()},y={current:void 0,photos:[],completedCount:0,async newDraft(){const i=crypto.randomUUID(),d={id:i,fields:{},photoIds:[],updatedAt:Date.now()};return await N.survey_drafts.put(d),l({current:d}),setTimeout(()=>{t()},0),await h(),i},async load(i){let d=await N.survey_drafts.get(i);d||(d={id:i,fields:{},photoIds:[],updatedAt:Date.now()},await N.survey_drafts.put(d)),l({current:d}),await t(),await h()},async setField(i,d){const u=a().current;if(!u)return;const m={...u.fields};d==null||d===""?delete m[i]:m[i]=d;const v={...u,fields:m,updatedAt:Date.now()};await b(v)},async setFields(i){const d=a().current;if(!d)return;const u={...d.fields};Object.entries(i).forEach(([v,E])=>{E==null||E===""?delete u[v]:u[v]=E});const m={...d,fields:u,updatedAt:Date.now()};await b(m)},async setQR(i){const d=a().current;if(!d)return;const u={...d,qr:i,fields:{...d.fields,sealNo:i,qrCode:i},updatedAt:Date.now()};await b(u)},async attachPhoto(i){const d=a().current;if(!d)return;const{blob:u,thumb:m}=await Do(i),v=await N.survey_photos.where("draftId").equals(d.id).count(),E={id:crypto.randomUUID(),draftId:d.id,blob:u,thumb:m,size:u.size,createdAt:Date.now(),selectedForList:v===0};await N.survey_photos.put(E);const j={...d,photoIds:[...d.photoIds,E.id],updatedAt:Date.now()};await b(j),await t()},async togglePhotoForList(i){const d=a().current;if(!d)return;const u=await N.survey_photos.get(i),m=!(u!=null&&u.selectedForList);await N.survey_photos.where("draftId").equals(d.id).modify(v=>{v.selectedForList=m&&v.id===i}),await t()},async removePhoto(i){const d=a().current;if(!d)return;await N.survey_photos.delete(i);const u=d.photoIds.filter(v=>v!==i),m={...d,photoIds:u,updatedAt:Date.now()};await b(m),await t()},async refreshPhotos(){await t()},async refreshStats(){await h()},async completeCurrent(i){const d=a().current;if(!d)return;const u={...d,fields:{...d.fields,status:"completed",completedAt:Date.now()},updatedAt:Date.now()};await b(u),await t();const m=await a().newDraft();await t();const v=(i==null?void 0:i.preserveKeys)??[];if(v.length>0){const E={};v.forEach(j=>{var D;((D=d.fields)==null?void 0:D[j])!==void 0&&(E[j]=d.fields[j])}),Object.keys(E).length>0&&await a().setFields(E)}return m},async clearCurrent(){const i=a().current;i&&(await N.survey_photos.where("draftId").equals(i.id).delete(),await N.survey_drafts.delete(i.id),l({current:void 0,photos:[]}),await h())},async listHistory(i="asc"){const d=N.survey_drafts.orderBy("updatedAt");return(i==="desc"?await d.reverse().toArray():await d.toArray()).filter(m=>{var v;return((v=m.fields)==null?void 0:v.status)==="completed"})},async purgeCompleted(){const i=await N.survey_drafts.filter(u=>{var m;return((m=u.fields)==null?void 0:m.status)==="completed"}).toArray();if(i.length===0)return 0;await N.transaction("rw",N.survey_drafts,N.survey_photos,async()=>{for(const u of i)await N.survey_photos.where("draftId").equals(u.id).delete(),await N.survey_drafts.delete(u.id)});const d=a().current;return d&&i.some(u=>u.id===d.id)&&l({current:void 0,photos:[]}),await h(),await t(),i.length},async duplicateDraft(i,d){if(d<=0)return 0;const u=await N.survey_drafts.get(i);if(!u)throw new Error("複製元の履歴が見つかりません");const m={...u.fields??{}},v=m.sealNo||m.qr||m.qrCode||u.qr;if(!v)throw new Error("複製元のQRコードが取得できませんでした");const E=v.match(/(\d+)(?!.*\d)/),j=E?E.index??-1:-1,D=E?parseInt(E[1],10):null,S=E?E[1].length:0,Q=j>=0?v.slice(0,j):v,R=j>=0?v.slice(j+S):"",q=await N.survey_photos.where("draftId").equals(i).toArray(),C=[],_=[],O=Date.now(),T=p=>{if(D!==null){const g=D+p,P=String(g).padStart(S,"0");return`${Q}${P}${R}`}return`${v}-${p}`};for(let p=1;p<=d;p++){const g=crypto.randomUUID(),P=T(p),A=[],x={...m,qr:P,qrCode:P,sealNo:P,status:"completed",completedAt:O+p};q.forEach(k=>{const B=crypto.randomUUID();A.push(B),_.push({...k,id:B,draftId:g,createdAt:O+p})}),C.push({id:g,fields:x,photoIds:A,updatedAt:O+p})}await N.transaction("rw",N.survey_drafts,N.survey_photos,async()=>{_.length>0&&await N.survey_photos.bulkPut(_),C.length>0&&await N.survey_drafts.bulkPut(C)}),await h();const M=a().current;if(M){const p=await N.survey_drafts.get(M.id);p&&l({current:p})}return C.length}};return h(),y});function wt(){const{current:l,newDraft:a}=Xe();o.useEffect(()=>{l||a()},[l,a])}const Ro="この端末ではカメラが利用できません",Oo="ブラウザ環境ではありません",Mo="カメラの利用には HTTPS での接続が必要です";function Ao(){if(typeof navigator>"u")return null;const l=navigator.mediaDevices;if(l!=null&&l.getUserMedia)return t=>l.getUserMedia(t);const a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a?t=>new Promise((h,b)=>{a.call(navigator,t,h,b)}):null}async function cs(){if(typeof navigator>"u")throw new Error(Oo);if(typeof window<"u"&&"isSecureContext"in window&&!window.isSecureContext)throw new Error(Mo);const l=Ao();if(!l)throw new Error(Ro);if(sessionStorage.getItem("cameraPermission")==="granted")return"granted";try{return(await l({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1})).getTracks().forEach(h=>h.stop()),sessionStorage.setItem("cameraPermission","granted"),"granted"}catch(t){const h=t;throw(h==null?void 0:h.name)==="NotAllowedError"||(h==null?void 0:h.name)==="SecurityError"?sessionStorage.setItem("cameraPermission","denied"):sessionStorage.removeItem("cameraPermission"),t instanceof Error?t:new Error(String(t))}}const ds={},Fo="/poc-survey-offline-mock/".replace(/\/?$/,"/"),us=l=>`${Fo}tesseract/${l.replace(/^\//,"")}`;var Xs;const Po=(Xs=ds==null?void 0:ds.VITE_TESSDATA_URL)==null?void 0:Xs.trim(),To=us("lang-data/"),Js=(Po??To).replace(/\/?$/,"/");let ct=null,ms=!1;const Lo=6e4;function Qo(l,a,t){return new Promise((h,b)=>{const y=setTimeout(()=>{try{t==null||t()}catch{}b(new Error("OCR処理がタイムアウトしました"))},a);l.then(i=>{clearTimeout(y),h(i)},i=>{clearTimeout(y),b(i)})})}function Uo(l){return l.replace(/[\uFF01-\uFF5E]/g,a=>String.fromCharCode(a.charCodeAt(0)-65248)).replace(/\u3000/g," ")}function Bo(l){return Uo(l).toUpperCase().replace(/[\u2010-\u2015\u2212\u30FC\uFF0D\uFE63]/g,"-").replace(/[^0-9A-Z-]/g,"")}const hs=()=>{ct=null,ms=!1};async function $o(){return Ys.createWorker("eng",void 0,{workerPath:us("worker.min.js"),corePath:us("tesseract-core.wasm.js"),langPath:Js,workerBlobURL:!1})}async function fs(){ct||(ct=Qo($o(),Lo,hs));try{const l=await ct;return ms||(await l.setParameters({tessedit_char_whitelist:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-",tessedit_pageseg_mode:Ys.PSM.SINGLE_LINE}),ms=!0),l}catch(l){throw hs(),l instanceof Error?l:new Error("Tesseract workerの初期化に失敗しました")}}function eo(){fs().catch(()=>{})}const Ho=["tesseract/lang-data/eng.traineddata.gz","tesseract/worker.min.js","tesseract/tesseract-core.wasm","tesseract/tesseract-core.wasm.js"];async function qo(){const l="/poc-survey-offline-mock/".replace(/\/?$/,"/");await Promise.all(Ho.map(async a=>{try{await fetch(`${l}${a}`,{cache:"force-cache"})}catch{}}))}async function aa(){await qo(),await fs()}async function Wo(l){const a=await fs(),{data:t}=await a.recognize(l).catch(async u=>{throw await zo(),u}),h=Array.isArray(t.lines)?t.lines:[],b=h.map(u=>{var m,v;return((v=(m=u.text)==null?void 0:m.trim)==null?void 0:v.call(m))??""}).filter(Boolean),y=h.reduce((u,m)=>!u||m.confidence>u.confidence?{text:m.text,confidence:m.confidence}:u,null),i=Bo((y==null?void 0:y.text)??t.text??""),d=(y==null?void 0:y.confidence)??t.confidence??0;return{text:i,rawText:t.text??"",candidates:b.length>0?b:(t.text??"").split(/\n+/).map(u=>u.trim()).filter(Boolean),confidence:d,method:"tesseract"}}async function zo(){if(!ct)return;await(await ct).terminate(),hs()}async function Go(l){let a=null;try{return await Wo(l)}catch(t){a=t instanceof Error?t:new Error(String(t))}if(a){const t=a.message;throw Js.startsWith("http")?typeof navigator<"u"&&!navigator.onLine?new Error("OCR辞書データが未取得です。オンライン接続時に一度読み取りを実行し、キャッシュを作成してください。"):new Error(`OCR辞書データのダウンロードに失敗しました: ${t}`):new Error(`OCR辞書データの読み込みに失敗しました。詳細: ${t}`)}throw new Error("OCR処理に失敗しました。")}function Mt(l,a){return a?l.toLowerCase().includes(a.toLowerCase()):!0}function Ko(){var ne,ie,xe,be,ee,se;wt();const l=Nt(),{current:a,setFields:t}=Xe(),[h,b]=o.useState([]),[y,i]=o.useState([]),[d,u]=o.useState([]),[m,v]=o.useState([]),[E,j]=o.useState(""),[D,S]=o.useState(""),[Q,R]=o.useState(""),[q,C]=o.useState(""),[_,O]=o.useState(void 0),[T,M]=o.useState(void 0),[p,g]=o.useState(void 0),[P,A]=o.useState(void 0),x=o.useMemo(()=>{const r=new Date;return`${r.getFullYear()}年${String(r.getMonth()+1).padStart(2,"0")}月${String(r.getDate()).padStart(2,"0")}日`},[]),k=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{sessionStorage.setItem("visitedDepartment","1")},[]),o.useEffect(()=>{Promise.all([N.location_buildings.toArray(),N.location_floors.toArray(),N.location_departments.toArray(),N.location_divisions.toArray()]).then(([r,U,z,K])=>{b(r),i(U),u(z),v(K)})},[]),o.useEffect(()=>{var U,z;if(!a)return;const r={};(U=a.fields)!=null&&U.surveyDate||(r.surveyDate=x),k&&((z=a.fields)==null?void 0:z.investigator)!==k&&(r.investigator=k),Object.keys(r).length>0&&t(r)},[a,k,t,x]);const B=(ne=a==null?void 0:a.fields)==null?void 0:ne.buildingId,f=(ie=a==null?void 0:a.fields)==null?void 0:ie.floorId,F=(xe=a==null?void 0:a.fields)==null?void 0:xe.departmentId,W=(be=a==null?void 0:a.fields)==null?void 0:be.divisionId;o.useEffect(()=>{O(B)},[B]),o.useEffect(()=>{M(f)},[f]),o.useEffect(()=>{g(F)},[F]),o.useEffect(()=>{A(W)},[W]);const V=o.useMemo(()=>h.find(r=>r.id===_),[h,_]),$=o.useMemo(()=>y.find(r=>r.id===T),[y,T]),he=o.useMemo(()=>d.find(r=>r.id===p),[d,p]),te=o.useMemo(()=>m.find(r=>r.id===P),[m,P]);o.useEffect(()=>{j(V?V.name:"")},[V]),o.useEffect(()=>{S($?$.name:"")},[$]),o.useEffect(()=>{R(he?he.name:"")},[he]),o.useEffect(()=>{C(te?te.name:"")},[te]);const le=o.useMemo(()=>h.filter(r=>Mt(r.name,E)),[h,E]),we=o.useMemo(()=>y.filter(r=>_&&r.buildingId!==_?!1:Mt(r.name,D)),[y,D,_]),ce=o.useMemo(()=>d.filter(r=>_&&r.buildingId!==_||T&&r.floorId!==T?!1:Mt(r.name,Q)),[d,Q,_,T]),Se=o.useMemo(()=>m.filter(r=>_&&r.buildingId!==_||T&&r.floorId!==T||p&&r.departmentId!==p?!1:Mt(r.name,q)),[m,q,_,T,p]),fe=r=>{if(!r||_===r.id){j(""),S(""),R(""),C(""),O(void 0),M(void 0),g(void 0),A(void 0),t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0});return}j(r.name),S(""),R(""),C(""),O(r.id),M(void 0),g(void 0),A(void 0),t({buildingId:r.id,floorId:void 0,departmentId:void 0,divisionId:void 0})},ye=r=>{if(!r||T===r.id){S(""),R(""),C(""),M(void 0),g(void 0),A(void 0),t({buildingId:_,floorId:void 0,departmentId:void 0,divisionId:void 0});return}const U=h.find(z=>z.id===r.buildingId);U&&(j(U.name),O(U.id)),S(r.name),R(""),C(""),M(r.id),g(void 0),A(void 0),t({buildingId:r.buildingId,floorId:r.id,departmentId:void 0,divisionId:void 0})},Ie=r=>{if(!r||p===r.id){R(""),C(""),g(void 0),A(void 0),t({buildingId:_,floorId:T,departmentId:void 0,divisionId:void 0});return}const U=h.find(K=>K.id===r.buildingId),z=y.find(K=>K.id===r.floorId);U&&(j(U.name),O(U.id)),z&&(S(z.name),M(z.id)),R(r.name),C(""),g(r.id),A(void 0),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.id,divisionId:void 0})},I=r=>{if(!r||P===r.id){C(""),A(void 0),t({buildingId:_,floorId:T,departmentId:p,divisionId:void 0});return}const U=h.find(Z=>Z.id===r.buildingId),z=y.find(Z=>Z.id===r.floorId),K=d.find(Z=>Z.id===r.departmentId);U&&(j(U.name),O(U.id)),z&&(S(z.name),M(z.id)),K&&(R(K.name),g(K.id)),C(r.name),A(r.id),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.departmentId,divisionId:r.id})},H=!!(_&&T&&p&&P);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"部署入力"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["調査日",e.jsx("input",{value:((ee=a==null?void 0:a.fields)==null?void 0:ee.surveyDate)??x,disabled:!0})]}),e.jsxs("label",{children:["調査担当",e.jsx("input",{value:((se=a==null?void 0:a.fields)==null?void 0:se.investigator)??k,disabled:!0})]})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["棟",e.jsx("input",{value:E,onChange:r=>j(r.target.value),placeholder:"棟を検索"})]}),e.jsx("div",{className:"option-list",children:le.map(r=>e.jsx("button",{onClick:()=>fe(r),className:r.id===_?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["階",e.jsx("input",{value:D,onChange:r=>S(r.target.value),placeholder:"階を検索"})]}),e.jsx("div",{className:"option-list",children:we.map(r=>{var U;return e.jsxs("button",{onClick:()=>ye(r),className:r.id===T?"active":"",children:[r.name,"（",((U=h.find(z=>z.id===r.buildingId))==null?void 0:U.name)??"","）"]},r.id)})}),e.jsxs("label",{children:["部署",e.jsx("input",{value:Q,onChange:r=>R(r.target.value),placeholder:"部署を検索"})]}),e.jsx("div",{className:"option-list",children:ce.map(r=>e.jsx("button",{onClick:()=>Ie(r),className:r.id===p?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["部門",e.jsx("input",{value:q,onChange:r=>C(r.target.value),placeholder:"部門を検索"})]}),e.jsx("div",{className:"option-list",children:Se.map(r=>e.jsx("button",{onClick:()=>I(r),className:r.id===P?"active":"",children:r.name},r.id))})]}),e.jsx("p",{className:"helper-text",children:"今日一日がんばって！！"})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>l("/home"),children:"ホーム"}),e.jsx("button",{onClick:()=>l("/survey/all"),disabled:!H,children:"次へ"})]})]})}const na=Object.freeze(Object.defineProperty({__proto__:null,default:Ko},Symbol.toStringTag,{value:"Module"})),gs=o.forwardRef(({onResult:l},a)=>{const t=o.useRef(null),h=o.useRef(null),b=o.useRef(null),[y,i]=o.useState(!1);o.useEffect(()=>(h.current=new rs,()=>{var m;(m=b.current)==null||m.stop(),b.current=null,rs.releaseAllStreams(),h.current=null,i(!1)}),[]);const d=o.useCallback(()=>{var m;(m=b.current)==null||m.stop(),b.current=null,rs.releaseAllStreams(),i(!1)},[]),u=o.useCallback(async()=>{if(!(!t.current||!h.current)&&!y){i(!0);try{b.current=await h.current.decodeFromConstraints({video:{facingMode:"environment"}},t.current,m=>{m&&(l(m.getText()),d())})}catch(m){console.error(m),i(!1),b.current=null}}},[l,y,d]);return o.useImperativeHandle(a,()=>({start:u,stop:d}),[u,d]),e.jsxs("div",{className:"qr-container",style:{display:y?"block":"none"},children:[e.jsx("video",{ref:t,className:"qr-video",muted:!0,playsInline:!0}),y&&e.jsx("div",{className:"helper-text",style:{marginTop:8},children:"読み取り中です..."})]})}),ia=Object.freeze(Object.defineProperty({__proto__:null,QRScanner:gs},Symbol.toStringTag,{value:"Module"}));function ps({open:l,onClose:a}){const{listHistory:t,duplicateDraft:h}=Xe(),[b,y]=o.useState("asc"),[i,d]=o.useState(!1),[u,m]=o.useState(null),[v,E]=o.useState([]),[j,D]=o.useState(null),[S,Q]=o.useState({}),[R,q]=o.useState(null),C=async p=>{d(!0),m(null);try{const g=await t(p);E(g)}catch(g){const P=g instanceof Error?g.message:String(g);m(P),E([])}finally{d(!1)}};o.useEffect(()=>{l?(D(null),Q({}),q(null),C(b)):(m(null),E([]))},[l,b]);const _=()=>{y(p=>p==="asc"?"desc":"asc")},O=(p,g)=>{Q(P=>({...P,[p]:g}))},T=async p=>{const g=S[p]??"1",P=Number.parseInt(g,10);if(!Number.isFinite(P)||P<=0){D("複製数は1以上の整数を入力してください");return}q(p),D(null);try{const A=await h(p,P);D(`履歴を ${A} 件複製しました`),Q(x=>({...x,[p]:""})),await C(b)}catch(A){const x=A instanceof Error?A.message:String(A);D(`複製に失敗しました: ${x}`)}finally{q(null)}},M=o.useMemo(()=>i?e.jsx("p",{className:"helper-text",children:"読み込み中..."}):u?e.jsxs("p",{className:"badge warn",children:["エラー: ",u]}):v.length===0?e.jsx("p",{className:"helper-text",children:"複製可能な履歴がありません。"}):v.map(p=>{const g=p.fields??{},P=g.completedAt??p.updatedAt,A=g.sealNo??g.qr??p.qr??"-",x=g.assetNo??"-",k=g.equipmentNo??"-",B=g.width??"-",f=g.depth??"-",F=g.height??"-",W=g.note??"",V=S[p.id]??"";return e.jsxs("div",{className:"history-row static",children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(P).toLocaleString()}),e.jsxs("span",{className:"pill",children:["QR ",A]}),x!=="-"&&e.jsxs("span",{className:"pill",children:["資産 ",x]}),k!=="-"&&e.jsxs("span",{className:"pill",children:["備品 ",k]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsxs("span",{className:"pill",children:["Category ",g.categoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Sub ",g.subcategoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Item ",g.itemId??"-"]}),e.jsxs("span",{className:"pill",children:["Maker ",g.makerId??"-"]}),e.jsxs("span",{className:"pill",children:["Model ",g.modelId??"-"]})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",B]}),e.jsxs("span",{children:["D: ",f]}),e.jsxs("span",{children:["H: ",F]}),W&&e.jsxs("span",{children:["備考: ",W]})]}),e.jsxs("div",{className:"history-duplicate",children:[e.jsx("input",{type:"number",min:1,placeholder:"複製数",value:V,onChange:$=>O(p.id,$.target.value)}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>T(p.id),disabled:R===p.id,children:R===p.id?"複製中...":"複製"})]})]},p.id)}),[v,S,i,u,R]);return l?e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"複製"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:_,children:b==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:a,children:"閉じる"})]})]}),j&&e.jsx("p",{className:"badge success",style:{marginTop:8},children:j}),e.jsx("div",{className:"history-list",children:M})]})}):null}function Zo(){var g,P,A,x,k,B;wt();const l=Nt(),a=o.useRef(null),{current:t,setFields:h,setQR:b}=Xe(),[y,i]=o.useState(""),[d,u]=o.useState(""),[m,v]=o.useState([]),[E,j]=o.useState(!1);o.useEffect(()=>{var f,F;i(((f=t==null?void 0:t.fields)==null?void 0:f.sealNo)??""),u(((F=t==null?void 0:t.fields)==null?void 0:F.roomName)??"")},[(g=t==null?void 0:t.fields)==null?void 0:g.sealNo,(P=t==null?void 0:t.fields)==null?void 0:P.roomName]),o.useEffect(()=>()=>{var f;(f=a.current)==null||f.stop()},[]),o.useEffect(()=>{let f=!0;return N.location_rooms.toArray().then(F=>{f&&v(F)}).catch(()=>{f&&v([])}),()=>{f=!1}},[]);const D=(A=t==null?void 0:t.fields)==null?void 0:A.buildingId,S=(x=t==null?void 0:t.fields)==null?void 0:x.floorId,Q=(k=t==null?void 0:t.fields)==null?void 0:k.departmentId,R=(B=t==null?void 0:t.fields)==null?void 0:B.divisionId,q=o.useMemo(()=>{if(!D||!S||!Q||!R)return[];const f=d.trim().toLowerCase();return m.filter(F=>F.buildingId!==D||F.floorId!==S||F.departmentId!==Q||F.divisionId!==R?!1:f?F.name.toLowerCase().includes(f):!0)},[m,D,S,Q,R,d]),C=f=>{const F=f.trim(),W=F.match(/medical-record\/([A-Za-z0-9-]+)$/i),V=W?W[1]:F;i(V),b(V)},_=f=>{i(f),h({sealNo:f,qrCode:f})},O=f=>{u(f),h({roomName:f})},T=()=>{var f;(f=a.current)==null||f.stop(),l("/survey/department")},M=()=>{var f;(f=a.current)==null||f.stop(),l("/survey/asset")},p=!!(y.trim()&&d.trim());return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QRコード読取・ラベルNo確認"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:y,onChange:f=>_(f.target.value),placeholder:"シールNoを入力"})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:d,onChange:f=>O(f.target.value),placeholder:"室名を入力"}),q.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:q.map(f=>e.jsx("button",{type:"button",onClick:()=>O(f.name),children:f.name},f.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:a,onResult:C})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>j(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:T,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:async()=>{var f;try{await cs(),await((f=a.current)==null?void 0:f.start())}catch(F){const W=F instanceof Error?F.message:String(F);alert(`カメラを利用できませんでした: ${W}`)}},children:"QR撮影"}),e.jsx("button",{onClick:M,disabled:!p,children:"次へ"})]}),e.jsx(ps,{open:E,onClose:()=>j(!1)})]})}const ra=Object.freeze(Object.defineProperty({__proto__:null,default:Zo},Symbol.toStringTag,{value:"Module"})),At={left:.08,top:.425,width:.84,height:.15},Vs=1200,Vo=2e3;function ls(l,a){const t=l.split(","),h=t[0].match(/:(.*?);/),b=(h==null?void 0:h[1])??a,y=atob(t[1]??""),i=y.length,d=new Uint8Array(i);for(let u=0;u<i;u+=1)d[u]=y.charCodeAt(u);return new Blob([d],{type:b})}async function Xo(l,a,t){return typeof l.toBlob=="function"?await new Promise((h,b)=>{let y=!1;const i=window.setTimeout(()=>{if(!y){y=!0;try{const d=ls(l.toDataURL(a,t),a);h(d)}catch(d){b(d instanceof Error?d:new Error("スナップショットの生成に失敗しました"))}}},Vo);l.toBlob(d=>{if(!y)if(y=!0,window.clearTimeout(i),d)h(d);else try{const u=ls(l.toDataURL(a,t),a);h(u)}catch(u){b(u instanceof Error?u:new Error("スナップショットの生成に失敗しました"))}},a,t)}):ls(l.toDataURL(a,t),a)}function to({open:l,targetLabel:a,onClose:t,onResult:h,onRecognized:b}){const y=o.useRef(null),i=o.useRef(null),d=o.useRef(),u=o.useRef(),[m,v]=o.useState("idle"),[E,j]=o.useState("カメラを初期化しています…"),[D,S]=o.useState(!1),[Q,R]=o.useState(null),[q,C]=o.useState(null);o.useEffect(()=>{d.current=document.createElement("canvas"),u.current=document.createElement("canvas")},[]);const _=o.useCallback(()=>{R(null),C(x=>(x&&URL.revokeObjectURL(x),null))},[]),O=()=>{i.current&&(i.current.getTracks().forEach(x=>x.stop()),i.current=null),y.current&&(y.current.pause(),y.current.srcObject=null)},T=o.useCallback(async()=>{var x;if(_(),!((x=navigator.mediaDevices)!=null&&x.getUserMedia)){v("error"),j("この端末ではカメラを利用できません。手入力してください。"),S(!1);return}v("camera"),j("カメラを起動しています…");try{const k=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});i.current=k,y.current&&(y.current.srcObject=k,await y.current.play().catch(()=>{})),v("camera"),j("枠が黒い帯に変わりました。番号を合わせて撮影してください。"),S(!1)}catch(k){const B=k instanceof Error?k.message:String(k);v("error"),j(`カメラにアクセスできません: ${B}`),S(!1)}},[_]);o.useEffect(()=>{if(!l){O(),_(),v("idle"),j("カメラを初期化しています…"),S(!1);return}return T(),()=>{O()}},[l,T]);const M=async(x,k,B)=>{const f=d.current,F=u.current;if(!f||!F||x===0||k===0)throw new Error("画像データを読み込めませんでした。");f.width=x,f.height=k;const W=f.getContext("2d");if(!W)throw new Error("画像の処理に失敗しました。");B(W);const V=F.getContext("2d");if(!V)throw new Error("画像の処理に失敗しました。");const $={x:Math.floor(f.width*At.left),y:Math.floor(f.height*At.top),width:Math.floor(f.width*At.width),height:Math.floor(f.height*At.height)},he=$.width>Vs?Vs/$.width:1,te=Math.max(320,Math.round($.width*he)),le=Math.max(120,Math.round($.height*he));return F.width=te,F.height=le,V.filter="contrast(160%) brightness(115%) grayscale(15%)",V.drawImage(f,$.x,$.y,$.width,$.height,0,0,te,le),Xo(F,"image/jpeg",.92)},p=async()=>{if(!l||D||m!=="camera")return;const x=y.current;if(!x||x.videoWidth===0||x.videoHeight===0){v("error"),j("カメラ映像を取得できませんでした。");return}S(!0),j("撮影中…");try{const k=await M(x.videoWidth,x.videoHeight,f=>{f.drawImage(x,0,0,x.videoWidth,x.videoHeight)});O(),_();const B=URL.createObjectURL(k);R(k),C(B),v("photo"),j("写真を保存しました。読み取りボタンを押してください。"),S(!1)}catch(k){const B=k instanceof Error?k.message:String(k);v("error"),j(`撮影に失敗しました: ${B}`),S(!1)}},g=async()=>{if(!(!Q||D)){v("processing"),S(!0),j("読み取り中です。1秒ほどお待ちください…");try{const x=await Go(Q);x.text?(h(x.text),j(`認識した値: ${x.text}`),b==null||b({text:x.text,method:x.method,targetLabel:a}),t()):(v("error"),j("文字を検出できませんでした。撮り直して再試行してください。"),S(!1))}catch(x){const k=x instanceof Error?x.message:String(x);v("error"),j(`読み取りに失敗しました: ${k}`),S(!1)}}},P=()=>{D||(_(),T())},A=o.useMemo(()=>m==="photo"?"撮影した画像を確認し、問題なければ「読み取る」を押してください。":m==="processing"?"しばらくお待ちください…":m==="error"?"カメラや照明の状態を確認してください。":"黒いガイド帯の中央に番号を重ね、影や反射を避けて撮影すると精度が上がります。",[m]);return l?e.jsx("div",{className:"ocr-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"ocr-panel",children:[e.jsxs("header",{className:"ocr-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ocr-eyebrow",children:"テキストスキャン"}),e.jsxs("h3",{children:[a,"の読み取り"]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:t,children:"閉じる"})]}),e.jsx("div",{className:"ocr-video-container",children:q?e.jsx("img",{src:q,alt:"撮影した画像",className:"ocr-preview"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:y,playsInline:!0,autoPlay:!0,muted:!0,className:"ocr-video"}),e.jsx("div",{className:"ocr-frame","aria-hidden":"true",children:e.jsx("span",{className:"ocr-frame__label",children:"黒い帯に合わせてください"})})]})}),e.jsx("p",{className:"helper-text",children:A}),e.jsx("p",{className:`ocr-message ${m==="error"?"is-error":""}`,children:E}),e.jsxs("footer",{className:"ocr-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:t,disabled:D&&m==="processing",children:"キャンセル"}),Q&&e.jsx("button",{type:"button",className:"ghost",onClick:P,disabled:D,children:"撮り直し"}),!Q&&e.jsx("button",{type:"button",onClick:p,className:"secondary",disabled:D||m!=="camera",children:"撮影"}),Q&&e.jsx("button",{type:"button",onClick:g,className:"secondary",disabled:D,children:m==="processing"?"読み取り中...":"読み取る"})]})]})}):null}function Yo(){var le,we,ce,Se,fe,ye,Ie;wt();const l=Nt(),a=o.useRef(null),{current:t,photos:h,attachPhoto:b,removePhoto:y,setFields:i}=Xe(),[d,u]=o.useState(""),[m,v]=o.useState(""),[E,j]=o.useState(""),[D,S]=o.useState(!1),[Q,R]=o.useState(!1),[q,C]=o.useState(!1),[_,O]=o.useState("assetNo"),[T,M]=o.useState(!1),[p,g]=o.useState(null);o.useEffect(()=>{eo()},[]),o.useEffect(()=>{var I,H,ne,ie,xe;u(((I=t==null?void 0:t.fields)==null?void 0:I.assetNo)??""),v(((H=t==null?void 0:t.fields)==null?void 0:H.equipmentNo)??""),j(((ne=t==null?void 0:t.fields)==null?void 0:ne.purchaseDate)??""),S(!!((ie=t==null?void 0:t.fields)!=null&&ie.leaseFlag)),R(!!((xe=t==null?void 0:t.fields)!=null&&xe.loanedFlag))},[(le=t==null?void 0:t.fields)==null?void 0:le.assetNo,(we=t==null?void 0:t.fields)==null?void 0:we.equipmentNo,(ce=t==null?void 0:t.fields)==null?void 0:ce.purchaseDate,(Se=t==null?void 0:t.fields)==null?void 0:Se.leaseFlag,(fe=t==null?void 0:t.fields)==null?void 0:fe.loanedFlag]);const P=((ye=t==null?void 0:t.fields)==null?void 0:ye.sealNo)??"",A=((Ie=t==null?void 0:t.fields)==null?void 0:Ie.roomName)??"",x=o.useMemo(()=>h.map(I=>({id:I.id,url:URL.createObjectURL(I.thumb)})),[h]),k=async I=>{if(!I||I.length===0)return;const H=I[0];await b(H),a.current&&(a.current.value="")},B=()=>{const I=!D;S(I),i({leaseFlag:I})},f=()=>{const I=!Q;R(I),i({loanedFlag:I})},F=()=>{l("/survey/label")},W=()=>{l("/survey/product")},V=h.length>0,$=I=>{I&&(_==="assetNo"?(u(I),i({assetNo:I})):(v(I),i({equipmentNo:I})))},he=o.useCallback(I=>{g(`${I.targetLabel}を読み取り: ${I.text}`)},[]);o.useEffect(()=>{if(!p)return;const I=window.setTimeout(()=>g(null),5e3);return()=>{window.clearTimeout(I)}},[p]);const te=I=>{O(I),M(!0)};return e.jsxs("div",{className:"page",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,style:{display:"none"},onChange:I=>k(I.target.files)}),e.jsxs("div",{className:"page-section",children:[p&&e.jsx("div",{className:"ocr-result-banner",children:p}),e.jsx("h2",{className:"section-title",children:"写真撮影・資産No登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:P,disabled:!0})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:A,disabled:!0})]}),e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:d,onChange:I=>{const H=I.target.value;u(H),i({assetNo:H})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:m,onChange:I=>{const H=I.target.value;v(H),i({equipmentNo:H})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:E,onChange:I=>{const H=I.target.value;j(H),i({purchaseDate:H})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:D?"secondary":"ghost",onClick:B,children:["リース: ",D?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:Q?"secondary":"ghost",onClick:f,children:["貸出品: ",Q?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:x.map(I=>e.jsxs("div",{className:"photo-item",children:[e.jsx("button",{type:"button",className:"photo-remove",onClick:()=>y(I.id),"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:I.url,alt:"サムネイル"})]},I.id))})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>C(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:F,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:()=>{var I;return(I=a.current)==null?void 0:I.click()},children:"写真"}),e.jsx("button",{onClick:W,disabled:!V,children:"次へ"})]}),e.jsx(ps,{open:q,onClose:()=>C(!1)}),e.jsx(to,{open:T,targetLabel:_==="assetNo"?"資産番号":"備品番号",onClose:()=>M(!1),onResult:$,onRecognized:he})]})}const da=Object.freeze(Object.defineProperty({__proto__:null,default:Yo},Symbol.toStringTag,{value:"Module"}));function jt(l,a){return a?l.toLowerCase().includes(a.toLowerCase()):!0}function Jo(){var et,_t,tt,Dt,gt,st,pt,ot,vt;wt();const l=Nt(),{current:a,setFields:t,completeCurrent:h,listHistory:b}=Xe(),[y,i]=o.useState([]),[d,u]=o.useState([]),[m,v]=o.useState([]),[E,j]=o.useState([]),[D,S]=o.useState([]),[Q,R]=o.useState(""),[q,C]=o.useState(""),[_,O]=o.useState(""),[T,M]=o.useState(""),[p,g]=o.useState(""),[P,A]=o.useState(""),[x,k]=o.useState(""),[B,f]=o.useState(""),[F,W]=o.useState(""),[V,$]=o.useState(!1),[he,te]=o.useState(!1),[le,we]=o.useState([]),[ce,Se]=o.useState(!1),[fe,ye]=o.useState(null),[Ie,I]=o.useState("asc"),H=o.useRef(void 0),ne=o.useRef(void 0),ie=o.useRef(void 0),xe=o.useRef(void 0),be=o.useRef(void 0);o.useEffect(()=>{Promise.all([N.product_categories.toArray(),N.product_subcategories.toArray(),N.product_items.toArray(),N.product_makers.toArray(),N.product_models.toArray()]).then(([n,w,me,ge,Ne])=>{i(n),u(w),v(me),j(ge),S(Ne)})},[]),o.useEffect(()=>{var n,w,me,ge;A(((n=a==null?void 0:a.fields)==null?void 0:n.width)??""),k(((w=a==null?void 0:a.fields)==null?void 0:w.depth)??""),f(((me=a==null?void 0:a.fields)==null?void 0:me.height)??""),W(((ge=a==null?void 0:a.fields)==null?void 0:ge.note)??"")},[(et=a==null?void 0:a.fields)==null?void 0:et.width,(_t=a==null?void 0:a.fields)==null?void 0:_t.depth,(tt=a==null?void 0:a.fields)==null?void 0:tt.height,(Dt=a==null?void 0:a.fields)==null?void 0:Dt.note]);const ee=(gt=a==null?void 0:a.fields)==null?void 0:gt.categoryId,se=(st=a==null?void 0:a.fields)==null?void 0:st.subcategoryId,r=(pt=a==null?void 0:a.fields)==null?void 0:pt.itemId,U=(ot=a==null?void 0:a.fields)==null?void 0:ot.makerId,z=(vt=a==null?void 0:a.fields)==null?void 0:vt.modelId,K=y.find(n=>n.id===ee),Z=d.find(n=>n.id===se),je=m.find(n=>n.id===r),Y=E.find(n=>n.id===U),ue=D.find(n=>n.id===z);o.useEffect(()=>{(K==null?void 0:K.id)!==H.current&&(K?R(K.name):H.current&&R(""),H.current=K==null?void 0:K.id)},[K]),o.useEffect(()=>{(Z==null?void 0:Z.id)!==ne.current&&(Z?C(Z.name):ne.current&&C(""),ne.current=Z==null?void 0:Z.id)},[Z]),o.useEffect(()=>{(je==null?void 0:je.id)!==ie.current&&(je?O(je.name):ie.current&&O(""),ie.current=je==null?void 0:je.id)},[je]),o.useEffect(()=>{(Y==null?void 0:Y.id)!==xe.current&&(Y?M(Y.name):xe.current&&M(""),xe.current=Y==null?void 0:Y.id)},[Y]),o.useEffect(()=>{(ue==null?void 0:ue.id)!==be.current&&(ue?g(ue.name):be.current&&g(""),be.current=ue==null?void 0:ue.id)},[ue]);const Ye=o.useMemo(()=>y.filter(n=>jt(n.name,Q)),[y,Q]),Ft=o.useMemo(()=>d.filter(n=>jt(n.name,q)),[d,q]),Pt=o.useMemo(()=>m.filter(n=>jt(n.name,_)),[m,_]),St=o.useMemo(()=>E.filter(n=>jt(n.name,T)),[E,T]),ut=o.useMemo(()=>D.filter(n=>jt(n.name,p)),[D,p]),mt=n=>{if(ee===n.id){R(""),C(""),O(""),M(""),g(""),t({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}R(n.name),C(""),O(""),M(""),g(""),t({categoryId:n.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},ht=n=>{if(se===n.id){C(""),O(""),M(""),g(""),t({categoryId:ee??n.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}C(n.name),O(""),M(""),g(""),t({categoryId:n.categoryId,subcategoryId:n.id,itemId:void 0,makerId:void 0,modelId:void 0})},ft=n=>{if(r===n.id){O(""),M(""),g(""),t({categoryId:ee??n.categoryId,subcategoryId:se??n.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}O(n.name),M(""),g(""),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.id,makerId:void 0,modelId:void 0})},Ct=n=>{if(U===n.id){M(""),g(""),t({categoryId:ee??n.categoryId,subcategoryId:se??n.subcategoryId,itemId:r??n.itemId,makerId:void 0,modelId:void 0});return}M(n.name),g(""),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.itemId,makerId:n.id,modelId:void 0})},Tt=n=>{if(z===n.id){g(""),t({categoryId:ee??n.categoryId,subcategoryId:se??n.subcategoryId,itemId:r??n.itemId,makerId:U??n.makerId,modelId:void 0});return}g(n.name),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.itemId,makerId:n.makerId,modelId:n.id})},kt=o.useCallback(async n=>{Se(!0),ye(null);try{const w=await b(n);we(w)}catch(w){const me=w instanceof Error?w.message:String(w);ye(me),we([])}finally{Se(!1)}},[b]);o.useEffect(()=>{V?kt(Ie):ye(null)},[V,Ie,kt]);const Et=n=>{const w=n.categoryId,me=n.subcategoryId,ge=n.itemId,Ne=n.makerId,ze=n.modelId,Ge=n.width!=null?String(n.width):"",at=n.depth!=null?String(n.depth):"",nt=n.height!=null?String(n.height):"",it=n.note!=null?String(n.note):"";A(Ge),k(at),f(nt),W(it);const Ke=y.find(re=>re.id===w),_e=d.find(re=>re.id===me),Le=m.find(re=>re.id===ge),Qe=E.find(re=>re.id===Ne),pe=D.find(re=>re.id===ze);R((Ke==null?void 0:Ke.name)??""),C((_e==null?void 0:_e.name)??""),O((Le==null?void 0:Le.name)??""),M((Qe==null?void 0:Qe.name)??""),g((pe==null?void 0:pe.name)??""),t({categoryId:w,subcategoryId:me,itemId:ge,makerId:Ne,modelId:ze,width:Ge,depth:at,height:nt,note:it})},Lt=n=>{Et(n.fields??{}),$(!1)},Qt=()=>{I(n=>n==="asc"?"desc":"asc")},Je=async()=>{await h({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),l("/survey/label")},Ut=()=>{t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0}),l("/survey/department")};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"商品登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:Q,onChange:n=>R(n.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:Ye.map(n=>e.jsx("button",{onClick:()=>mt(n),className:n.id===ee?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:q,onChange:n=>C(n.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:Ft.map(n=>e.jsx("button",{onClick:()=>ht(n),className:n.id===se?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:_,onChange:n=>O(n.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:Pt.map(n=>e.jsx("button",{onClick:()=>ft(n),className:n.id===r?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:T,onChange:n=>M(n.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:St.map(n=>e.jsx("button",{onClick:()=>Ct(n),className:n.id===U?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:p,onChange:n=>g(n.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:ut.map(n=>e.jsx("button",{onClick:()=>Tt(n),className:n.id===z?"active":"",children:n.name},n.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["W",e.jsx("input",{value:P,onChange:n=>{const w=n.target.value;A(w),t({width:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:x,onChange:n=>{const w=n.target.value;k(w),t({depth:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:B,onChange:n=>{const w=n.target.value;f(w),t({height:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:F,onChange:n=>{const w=n.target.value;W(w),t({note:w})},rows:3})]})]}),e.jsx("div",{className:"row",style:{justifyContent:"flex-start",marginTop:8},children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>$(!0),children:"履歴表示"})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>te(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:()=>l("/survey/asset"),children:"戻る"}),e.jsx("button",{className:"secondary",onClick:Ut,children:"部門"}),e.jsx("button",{onClick:Je,children:"次へ"})]}),V&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:Qt,children:Ie==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>$(!1),children:"閉じる"})]})]}),ce&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),fe&&e.jsxs("p",{className:"badge warn",children:["エラー: ",fe]}),!ce&&!fe&&le.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!ce&&!fe&&le.length>0&&e.jsx("div",{className:"history-list",children:le.map(n=>{var _e,Le,Qe,pe,re;const w=n.fields??{},me=w.completedAt??n.updatedAt,ge=((_e=y.find(ae=>ae.id===w.categoryId))==null?void 0:_e.name)??"-",Ne=((Le=d.find(ae=>ae.id===w.subcategoryId))==null?void 0:Le.name)??"-",ze=((Qe=m.find(ae=>ae.id===w.itemId))==null?void 0:Qe.name)??"-",Ge=((pe=E.find(ae=>ae.id===w.makerId))==null?void 0:pe.name)??"-",at=((re=D.find(ae=>ae.id===w.modelId))==null?void 0:re.name)??"-",nt=w.width??"-",it=w.depth??"-",Ke=w.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>Lt(n),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(me).toLocaleString()}),w.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",w.assetNo]}),w.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",w.equipmentNo]}),w.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",w.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:ge}),e.jsx("span",{className:"pill",children:Ne}),e.jsx("span",{className:"pill",children:ze}),e.jsx("span",{className:"pill",children:Ge}),e.jsx("span",{className:"pill",children:at})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",nt]}),e.jsxs("span",{children:["D: ",it]}),e.jsxs("span",{children:["H: ",Ke]})]})]},n.id)})})]})}),e.jsx(ps,{open:he,onClose:()=>te(!1)})]})}const la=Object.freeze(Object.defineProperty({__proto__:null,default:Jo},Symbol.toStringTag,{value:"Module"}));function Te(l,a){return a?l.toLowerCase().includes(a.toLowerCase()):!0}function ca(){var ws,Ss,Cs,ks,Es,_s,Ds,Rs,Os,Ms,As,Fs,Ps,Ts,Ls,Qs,Us,Bs,$s,Hs,qs,Ws,zs,Gs;wt();const l=Nt(),a=Xe(),{current:t,photos:h,attachPhoto:b,removePhoto:y,setFields:i,completeCurrent:d,listHistory:u,load:m,completedCount:v,duplicateDraft:E,setQR:j,togglePhotoForList:D}=a,[S,Q]=o.useState([]),[R,q]=o.useState([]),[C,_]=o.useState([]),[O,T]=o.useState([]),[M,p]=o.useState(""),[g,P]=o.useState(""),[A,x]=o.useState(""),[k,B]=o.useState(""),[f,F]=o.useState(void 0),[W,V]=o.useState(void 0),[$,he]=o.useState(void 0),[te,le]=o.useState(void 0),we=o.useMemo(()=>{const s=new Date;return`${s.getFullYear()}年${String(s.getMonth()+1).padStart(2,"0")}月${String(s.getDate()).padStart(2,"0")}日`},[]),ce=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{Promise.all([N.location_buildings.toArray(),N.location_floors.toArray(),N.location_departments.toArray(),N.location_divisions.toArray()]).then(([s,c,L,G])=>{Q(s),q(c),_(L),T(G)})},[]),o.useEffect(()=>{var c,L;if(!t)return;const s={};(c=t.fields)!=null&&c.surveyDate||(s.surveyDate=we),ce&&((L=t.fields)==null?void 0:L.investigator)!==ce&&(s.investigator=ce),Object.keys(s).length>0&&i(s)},[t,ce,i,we]);const Se=(ws=t==null?void 0:t.fields)==null?void 0:ws.buildingId,fe=(Ss=t==null?void 0:t.fields)==null?void 0:Ss.floorId,ye=(Cs=t==null?void 0:t.fields)==null?void 0:Cs.departmentId,Ie=(ks=t==null?void 0:t.fields)==null?void 0:ks.divisionId;o.useEffect(()=>{F(Se)},[Se]),o.useEffect(()=>{V(fe)},[fe]),o.useEffect(()=>{he(ye)},[ye]),o.useEffect(()=>{le(Ie)},[Ie]);const I=o.useMemo(()=>S.find(s=>s.id===f),[S,f]),H=o.useMemo(()=>R.find(s=>s.id===W),[R,W]),ne=o.useMemo(()=>C.find(s=>s.id===$),[C,$]),ie=o.useMemo(()=>O.find(s=>s.id===te),[O,te]);o.useEffect(()=>{p((I==null?void 0:I.name)??"")},[I]),o.useEffect(()=>{P((H==null?void 0:H.name)??"")},[H]),o.useEffect(()=>{x((ne==null?void 0:ne.name)??"")},[ne]),o.useEffect(()=>{B((ie==null?void 0:ie.name)??"")},[ie]),o.useMemo(()=>S.filter(s=>Te(s.name,M)),[S,M]),o.useMemo(()=>R.filter(s=>Te(s.name,g)),[R,g]),o.useMemo(()=>C.filter(s=>Te(s.name,A)),[C,A]),o.useMemo(()=>O.filter(s=>Te(s.name,k)),[O,k]);const xe=!!(f&&W&&$&&te),be=o.useRef(null),[ee,se]=o.useState(""),[r,U]=o.useState(""),[z,K]=o.useState([]),[Z,je]=o.useState(!1),[Y,ue]=o.useState(""),[Ye,Ft]=o.useState(""),[Pt,St]=o.useState("single");o.useEffect(()=>{var s,c;se(((s=t==null?void 0:t.fields)==null?void 0:s.sealNo)??""),U(((c=t==null?void 0:t.fields)==null?void 0:c.roomName)??"")},[(Es=t==null?void 0:t.fields)==null?void 0:Es.sealNo,(_s=t==null?void 0:t.fields)==null?void 0:_s.roomName]),o.useEffect(()=>()=>{var s;(s=be.current)==null||s.stop()},[]),o.useEffect(()=>{let s=!0;return N.location_rooms.toArray().then(c=>{s&&K(c)}).catch(()=>{s&&K([])}),()=>{s=!1}},[]);const ut=(Ds=t==null?void 0:t.fields)==null?void 0:Ds.buildingId,mt=(Rs=t==null?void 0:t.fields)==null?void 0:Rs.floorId,ht=(Os=t==null?void 0:t.fields)==null?void 0:Os.departmentId,ft=(Ms=t==null?void 0:t.fields)==null?void 0:Ms.divisionId,Ct=o.useMemo(()=>{if(!ut||!mt||!ht||!ft)return[];const s=r.trim().toLowerCase();return z.filter(c=>c.buildingId!==ut||c.floorId!==mt||c.departmentId!==ht||c.divisionId!==ft?!1:s?c.name.toLowerCase().includes(s):!0)},[z,ut,mt,ht,ft,r]),Tt=s=>{const c=s.trim(),L=c.match(/https?:\/\/[^/]+\/x\/([A-Za-z0-9-]+)$/i),G=c.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i),J=L&&L[1]||G&&G[0]||c;Pt==="bulkStart"?ue(J):(se(J),j(J))},kt=s=>{se(s),i({sealNo:s,qrCode:s})},Et=s=>{U(s),i({roomName:s})},Lt=s=>{je(s),s?ee.trim()&&ue(ee):Y.trim()&&(se(Y),i({sealNo:Y,qrCode:Y}))},Qt=o.useMemo(()=>{const s=r.trim().length>0,c=ee.trim().length>0,L=Y.trim().length>0,G=Number.parseInt(Ye,10),J=Z&&L&&Number.isFinite(G)&&G>0;return s&&(!Z&&c||J)},[Z,Ye,Y,r,ee]),Je=o.useRef(null),[Ut,et]=o.useState(""),[_t,tt]=o.useState(""),[Dt,gt]=o.useState(""),[st,pt]=o.useState(!1),[ot,vt]=o.useState(!1),[n,w]=o.useState("assetNo"),[me,ge]=o.useState(!1),[Ne,ze]=o.useState(null);o.useEffect(()=>{eo()},[]),o.useEffect(()=>{var s,c,L,G,J;et(((s=t==null?void 0:t.fields)==null?void 0:s.assetNo)??""),tt(((c=t==null?void 0:t.fields)==null?void 0:c.equipmentNo)??""),gt(((L=t==null?void 0:t.fields)==null?void 0:L.purchaseDate)??""),pt(!!((G=t==null?void 0:t.fields)!=null&&G.leaseFlag)),vt(!!((J=t==null?void 0:t.fields)!=null&&J.loanedFlag))},[(As=t==null?void 0:t.fields)==null?void 0:As.assetNo,(Fs=t==null?void 0:t.fields)==null?void 0:Fs.equipmentNo,(Ps=t==null?void 0:t.fields)==null?void 0:Ps.purchaseDate,(Ts=t==null?void 0:t.fields)==null?void 0:Ts.leaseFlag,(Ls=t==null?void 0:t.fields)==null?void 0:Ls.loanedFlag]);const Ge=o.useMemo(()=>h.map(s=>({id:s.id,url:URL.createObjectURL(s.thumb),selectedForList:!!s.selectedForList})),[h]),at=async s=>{if(!s||s.length===0)return;const c=s[0];await b(c),Je.current&&(Je.current.value="")},nt=()=>{const s=!st;pt(s),i({leaseFlag:s})},it=()=>{const s=!ot;vt(s),i({loanedFlag:s})},Ke=s=>{s&&(n==="assetNo"?(et(s),i({assetNo:s})):(tt(s),i({equipmentNo:s})))},_e=s=>{w(s),ge(!0)},Le=o.useCallback(s=>{ze(`${s.targetLabel}を読み取り: ${s.text}`)},[]);o.useEffect(()=>{if(!Ne)return;const s=window.setTimeout(()=>ze(null),5e3);return()=>{window.clearTimeout(s)}},[Ne]);const Qe=h.length>0,[pe,re]=o.useState([]),[ae,so]=o.useState([]),[yt,oo]=o.useState([]),[It,ao]=o.useState([]),[xt,no]=o.useState([]),[Bt,rt]=o.useState(""),[$t,Ue]=o.useState(""),[Ht,Ce]=o.useState(""),[qt,ve]=o.useState(""),[Wt,de]=o.useState(""),[vs,zt]=o.useState(""),[ys,Gt]=o.useState(""),[Is,Kt]=o.useState(""),[xs,Zt]=o.useState(""),[Vt,Xt]=o.useState(!1),[Yt,bs]=o.useState([]),[Jt,js]=o.useState(!1),[Rt,es]=o.useState(null),[ts,io]=o.useState("asc"),ss=o.useRef(void 0),os=o.useRef(void 0),as=o.useRef(void 0),ns=o.useRef(void 0),is=o.useRef(void 0);o.useEffect(()=>{Promise.all([N.product_categories.toArray(),N.product_subcategories.toArray(),N.product_items.toArray(),N.product_makers.toArray(),N.product_models.toArray()]).then(([s,c,L,G,J])=>{re(s),so(c),oo(L),ao(G),no(J)})},[]),o.useEffect(()=>{var s,c,L,G;zt(((s=t==null?void 0:t.fields)==null?void 0:s.width)??""),Gt(((c=t==null?void 0:t.fields)==null?void 0:c.depth)??""),Kt(((L=t==null?void 0:t.fields)==null?void 0:L.height)??""),Zt(((G=t==null?void 0:t.fields)==null?void 0:G.note)??"")},[(Qs=t==null?void 0:t.fields)==null?void 0:Qs.width,(Us=t==null?void 0:t.fields)==null?void 0:Us.depth,(Bs=t==null?void 0:t.fields)==null?void 0:Bs.height,($s=t==null?void 0:t.fields)==null?void 0:$s.note]);const Be=(Hs=t==null?void 0:t.fields)==null?void 0:Hs.categoryId,Ze=(qs=t==null?void 0:t.fields)==null?void 0:qs.subcategoryId,dt=(Ws=t==null?void 0:t.fields)==null?void 0:Ws.itemId,bt=(zs=t==null?void 0:t.fields)==null?void 0:zs.makerId,Ot=(Gs=t==null?void 0:t.fields)==null?void 0:Gs.modelId,De=pe.find(s=>s.id===Be),Re=ae.find(s=>s.id===Ze),Oe=yt.find(s=>s.id===dt),Me=It.find(s=>s.id===bt),Ae=xt.find(s=>s.id===Ot);o.useEffect(()=>{(De==null?void 0:De.id)!==ss.current&&(De?rt(De.name):ss.current&&rt(""),ss.current=De==null?void 0:De.id)},[De]),o.useEffect(()=>{(Re==null?void 0:Re.id)!==os.current&&(Re?Ue(Re.name):os.current&&Ue(""),os.current=Re==null?void 0:Re.id)},[Re]),o.useEffect(()=>{(Oe==null?void 0:Oe.id)!==as.current&&(Oe?Ce(Oe.name):as.current&&Ce(""),as.current=Oe==null?void 0:Oe.id)},[Oe]),o.useEffect(()=>{(Me==null?void 0:Me.id)!==ns.current&&(Me?ve(Me.name):ns.current&&ve(""),ns.current=Me==null?void 0:Me.id)},[Me]),o.useEffect(()=>{(Ae==null?void 0:Ae.id)!==is.current&&(Ae?de(Ae.name):is.current&&de(""),is.current=Ae==null?void 0:Ae.id)},[Ae]);const ro=o.useMemo(()=>pe.filter(s=>Te(s.name,Bt)),[pe,Bt]),lo=o.useMemo(()=>ae.filter(s=>Te(s.name,$t)),[ae,$t]),co=o.useMemo(()=>yt.filter(s=>Te(s.name,Ht)),[yt,Ht]),uo=o.useMemo(()=>It.filter(s=>Te(s.name,qt)),[It,qt]),mo=o.useMemo(()=>xt.filter(s=>Te(s.name,Wt)),[xt,Wt]),ho=s=>{if(Be===s.id){rt(""),Ue(""),Ce(""),ve(""),de(""),i({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}rt(s.name),Ue(""),Ce(""),ve(""),de(""),i({categoryId:s.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},fo=s=>{if(Ze===s.id){Ue(""),Ce(""),ve(""),de(""),i({categoryId:Be??s.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}Ue(s.name),Ce(""),ve(""),de(""),i({categoryId:s.categoryId,subcategoryId:s.id,itemId:void 0,makerId:void 0,modelId:void 0})},go=s=>{if(dt===s.id){Ce(""),ve(""),de(""),i({categoryId:Be??s.categoryId,subcategoryId:Ze??s.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}Ce(s.name),ve(""),de(""),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.id,makerId:void 0,modelId:void 0})},po=s=>{if(bt===s.id){ve(""),de(""),i({categoryId:Be??s.categoryId,subcategoryId:Ze??s.subcategoryId,itemId:dt??s.itemId,makerId:void 0,modelId:void 0});return}ve(s.name),de(""),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.id,modelId:void 0})},vo=s=>{if(Ot===s.id){de(""),i({categoryId:Be??s.categoryId,subcategoryId:Ze??s.subcategoryId,itemId:dt??s.itemId,makerId:bt??s.makerId,modelId:void 0});return}de(s.name),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,modelId:s.id})},Ns=o.useCallback(async s=>{js(!0),es(null);try{const c=await u(s);bs(c)}catch(c){const L=c instanceof Error?c.message:String(c);es(L),bs([])}finally{js(!1)}},[u]);o.useEffect(()=>{Vt?Ns(ts):es(null)},[Vt,ts,Ns]);const yo=s=>{const c=s.categoryId,L=s.subcategoryId,G=s.itemId,J=s.makerId,ke=s.modelId,Fe=s.width!=null?String(s.width):"",Ee=s.depth!=null?String(s.depth):"",Ve=s.height!=null?String(s.height):"",lt=s.note!=null?String(s.note):"";zt(Fe),Gt(Ee),Kt(Ve),Zt(lt);const Pe=pe.find(X=>X.id===c),$e=ae.find(X=>X.id===L),He=yt.find(X=>X.id===G),qe=It.find(X=>X.id===J),We=xt.find(X=>X.id===ke);rt((Pe==null?void 0:Pe.name)??""),Ue(($e==null?void 0:$e.name)??""),Ce((He==null?void 0:He.name)??""),ve((qe==null?void 0:qe.name)??""),de((We==null?void 0:We.name)??""),i({categoryId:c,subcategoryId:L,itemId:G,makerId:J,modelId:ke,width:Fe,depth:Ee,height:Ve,note:lt})},Io=s=>{yo(s.fields??{}),Xt(!1)},xo=()=>{io(s=>s==="asc"?"desc":"asc")},bo=async()=>{var J;if(!Z){const ke=((J=t==null?void 0:t.fields)==null?void 0:J.sealNo)??ee;let Fe=null;if(ke){const Ee=ke.match(/(\d+)(?!.*\d)/);if(Ee&&Ee.index!==void 0){const Ve=Ee.index,lt=Number.parseInt(Ee[1],10),Pe=Ee[1].length,$e=ke.slice(0,Ve),He=ke.slice(Ve+Pe),qe=lt+1,We=String(qe).padStart(Pe,"0");Fe=`${$e}${We}${He}`}}await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),Fe&&(se(Fe),await j(Fe));return}const s=Y.trim(),c=Number.parseInt(Ye,10);if(!s||!Number.isFinite(c)||c<=0){alert("一括登録モードでは、開始シールNoと1以上の登録個数を入力してください。");return}if(!t)return;const L=t.id;se(s),await j(s),await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});const G=c-1;G>0&&await E(L,G)},jo=async()=>{try{const c=(await u("desc"))[0];if(!c)return;await m(c.id)}catch(s){console.error(s)}},No=!!(Be&&Ze&&dt&&bt&&Ot)&&!!(vs||ys||Is||xs);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QR読取・基本情報"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["登録モード",e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:s=>Lt(s.target.checked),style:{width:16,height:16}}),e.jsx("span",{children:"一括登録モード"})]})]}),Z?e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:["開始シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Y,onChange:s=>ue(s.target.value),placeholder:"開始シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{St("bulkStart"),await cs(),await((s=be.current)==null?void 0:s.start())}catch(c){const L=c instanceof Error?c.message:String(c);alert(`カメラを利用できませんでした: ${L}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["登録個数",e.jsx("input",{type:"number",min:1,value:Ye,onChange:s=>Ft(s.target.value),placeholder:"個数を入力（例：椅子50脚の場合は「50」と入力）"})]})]}):e.jsxs("label",{children:["シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:ee,onChange:s=>kt(s.target.value),placeholder:"シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{St("single"),await cs(),await((s=be.current)==null?void 0:s.start())}catch(c){const L=c instanceof Error?c.message:String(c);alert(`カメラを利用できませんでした: ${L}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:r,onChange:s=>Et(s.target.value),placeholder:"室名を入力"}),Ct.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:Ct.map(s=>e.jsx("button",{type:"button",onClick:()=>Et(s.name),children:s.name},s.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:be,onResult:Tt})})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"写真撮影・資産番号"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:Je,style:{display:"none"},onChange:s=>at(s.target.files)}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Ut,onChange:s=>{const c=s.target.value;et(c),i({assetNo:c})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>_e("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:_t,onChange:s=>{const c=s.target.value;tt(c),i({equipmentNo:c})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>_e("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",className:"date-input",value:Dt,onChange:s=>{const c=s.target.value;gt(c),i({purchaseDate:c})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:st?"secondary":"ghost",onClick:nt,children:["リース: ",st?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:ot?"secondary":"ghost",onClick:it,children:["貸出品: ",ot?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:Ge.length===0?e.jsx("div",{className:"photo-strip-empty",children:"撮影した写真がここに表示されます"}):Ge.map(s=>e.jsxs("div",{className:`photo-item${s.selectedForList?" is-selected":""}`,onClick:()=>{D(s.id)},children:[e.jsx("span",{className:"visually-hidden",children:"一覧表示用の写真として選択"}),e.jsx("button",{type:"button",className:"photo-remove",onClick:c=>{c.stopPropagation(),y(s.id)},"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:s.url,alt:"サムネイル"})]},s.id))}),Ne&&e.jsx("div",{className:"ocr-result-banner",children:Ne})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"資産情報登録"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:Bt,onChange:s=>rt(s.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:ro.map(s=>e.jsx("button",{onClick:()=>ho(s),className:s.id===Be?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:$t,onChange:s=>Ue(s.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:lo.map(s=>e.jsx("button",{onClick:()=>fo(s),className:s.id===Ze?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:Ht,onChange:s=>Ce(s.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:co.map(s=>e.jsx("button",{onClick:()=>go(s),className:s.id===dt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:qt,onChange:s=>ve(s.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:uo.map(s=>e.jsx("button",{onClick:()=>po(s),className:s.id===bt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:Wt,onChange:s=>de(s.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:mo.map(s=>e.jsx("button",{onClick:()=>vo(s),className:s.id===Ot?"active":"",children:s.name},s.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("div",{className:"asset-size-row",children:[e.jsxs("label",{children:["W",e.jsx("input",{value:vs,onChange:s=>{const c=s.target.value;zt(c),i({width:c})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:ys,onChange:s=>{const c=s.target.value;Gt(c),i({depth:c})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:Is,onChange:s=>{const c=s.target.value;Kt(c),i({height:c})},placeholder:"mm"})]})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:xs,onChange:s=>{const c=s.target.value;Zt(c),i({note:c})},rows:3})]})]})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>l("/survey/home"),children:"ホーム"}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>l("/survey/department"),children:["部門",e.jsx("br",{}),"入力へ"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>Xt(!0),children:["履歴",e.jsx("br",{}),"表示"]}),e.jsxs("button",{type:"button",className:"secondary",onClick:()=>{var s;return(s=Je.current)==null?void 0:s.click()},children:["写真",e.jsx("br",{}),"撮影"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:jo,disabled:v===0,children:["前の商品に",e.jsx("br",{}),"戻る"]}),e.jsxs("button",{type:"button",onClick:bo,disabled:!(xe&&Qt&&Qe&&No),children:["商品",e.jsx("br",{}),"登録"]})]}),e.jsx(to,{open:me,targetLabel:n==="assetNo"?"資産番号":"備品番号",onClose:()=>ge(!1),onResult:Ke,onRecognized:Le}),Vt&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:xo,children:ts==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>Xt(!1),children:"閉じる"})]})]}),Jt&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),Rt&&e.jsxs("p",{className:"badge warn",children:["エラー: ",Rt]}),!Jt&&!Rt&&Yt.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!Jt&&!Rt&&Yt.length>0&&e.jsx("div",{className:"history-list",children:e.jsxs("table",{className:"history-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"大分類"}),e.jsx("th",{children:"中分類"}),e.jsx("th",{children:"品目"}),e.jsx("th",{children:"メーカー名"}),e.jsx("th",{children:"型式"}),e.jsx("th",{children:"W"}),e.jsx("th",{children:"D"}),e.jsx("th",{children:"H"})]})}),e.jsx("tbody",{children:Yt.map(s=>{var Pe,$e,He,qe,We;const c=s.fields??{},L=((Pe=pe.find(X=>X.id===c.categoryId))==null?void 0:Pe.name)??"-",G=(($e=ae.find(X=>X.id===c.subcategoryId))==null?void 0:$e.name)??"-",J=((He=yt.find(X=>X.id===c.itemId))==null?void 0:He.name)??"-",ke=((qe=It.find(X=>X.id===c.makerId))==null?void 0:qe.name)??"-",Fe=((We=xt.find(X=>X.id===c.modelId))==null?void 0:We.name)??"-",Ee=c.width??"-",Ve=c.depth??"-",lt=c.height??"-";return e.jsxs("tr",{className:"history-row",onClick:()=>Io(s),children:[e.jsx("td",{children:L}),e.jsx("td",{children:G}),e.jsx("td",{children:J}),e.jsx("td",{children:ke}),e.jsx("td",{children:Fe}),e.jsx("td",{children:Ee}),e.jsx("td",{children:Ve}),e.jsx("td",{children:lt})]},s.id)})})]})})]})})]})}export{Yo as A,Ko as D,Zo as L,Jo as P,ca as S,aa as a,na as b,ra as c,N as d,cs as e,da as f,la as g,eo as p,ia as q,Xe as u,qo as w};
