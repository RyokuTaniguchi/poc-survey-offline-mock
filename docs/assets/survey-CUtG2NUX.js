var So=Object.defineProperty;var Co=(u,a,t)=>a in u?So(u,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[a]=t;var oe=(u,a,t)=>Co(u,typeof a!="symbol"?a+"":a,t);import{i as Vs,c as ko,r as o,s as eo,u as bt,j as e}from"./vendor-5jQwBCrV.js";import{D as Eo}from"./vendor-dexie-DWlydIdn.js";import{B as ds}from"./vendor-zxing-DcYOnkv9.js";class Do extends Eo{constructor(){super("meddx_survey");oe(this,"survey_drafts");oe(this,"survey_photos");oe(this,"survey_masters");oe(this,"indices");oe(this,"settings");oe(this,"location_buildings");oe(this,"location_floors");oe(this,"location_departments");oe(this,"location_divisions");oe(this,"product_categories");oe(this,"product_subcategories");oe(this,"product_items");oe(this,"product_makers");oe(this,"product_models");oe(this,"location_rooms");this.version(1).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key"}),this.version(2).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name"}),this.version(3).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name",location_rooms:"id,buildingId,floorId,departmentId,divisionId,name"})}}const w=new Do,_o="/poc-survey-offline-mock/".replace(/\/?$/,"/"),Xs=`${_o}vendor/browser-image-compression.js`;async function Ro(u,a=2560){const f=await Vs(u,{maxWidthOrHeight:a,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Xs}),j=await Vs(u,{maxWidthOrHeight:512,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Xs});return{blob:f,thumb:j}}const He=ko((u,a)=>{const t=async()=>{const i=a().current;if(!i){u({photos:[]});return}const d=await w.survey_photos.where("draftId").equals(i.id).reverse().toArray();u({photos:d})},f=async()=>{const i=await w.survey_drafts.filter(d=>{var m;return((m=d.fields)==null?void 0:m.status)==="completed"}).count();u({completedCount:i})},j=async i=>{await w.survey_drafts.put(i),u({current:i}),await f()},y={current:void 0,photos:[],completedCount:0,async newDraft(){const i=crypto.randomUUID(),d={id:i,fields:{},photoIds:[],updatedAt:Date.now()};return await w.survey_drafts.put(d),u({current:d}),setTimeout(()=>{t()},0),await f(),i},async load(i){let d=await w.survey_drafts.get(i);d||(d={id:i,fields:{},photoIds:[],updatedAt:Date.now()},await w.survey_drafts.put(d)),u({current:d}),await t(),await f()},async setField(i,d){const m=a().current;if(!m)return;const h={...m.fields};d==null||d===""?delete h[i]:h[i]=d;const I={...m,fields:h,updatedAt:Date.now()};await j(I)},async setFields(i){const d=a().current;if(!d)return;const m={...d.fields};Object.entries(i).forEach(([I,x])=>{x==null||x===""?delete m[I]:m[I]=x});const h={...d,fields:m,updatedAt:Date.now()};await j(h)},async setQR(i){const d=a().current;if(!d)return;const m={...d,qr:i,fields:{...d.fields,sealNo:i,qrCode:i},updatedAt:Date.now()};await j(m)},async attachPhoto(i){const d=a().current;if(!d)return;const{blob:m,thumb:h}=await Ro(i),I=await w.survey_photos.where("draftId").equals(d.id).count(),x={id:crypto.randomUUID(),draftId:d.id,blob:m,thumb:h,size:m.size,createdAt:Date.now(),selectedForList:I===0};await w.survey_photos.put(x);const M={...d,photoIds:[...d.photoIds,x.id],updatedAt:Date.now()};await j(M),await t()},async togglePhotoForList(i){const d=a().current;if(!d)return;const m=await w.survey_photos.get(i),h=!(m!=null&&m.selectedForList);await w.survey_photos.where("draftId").equals(d.id).modify(I=>{I.selectedForList=h&&I.id===i}),await t()},async removePhoto(i){const d=a().current;if(!d)return;await w.survey_photos.delete(i);const m=d.photoIds.filter(I=>I!==i),h={...d,photoIds:m,updatedAt:Date.now()};await j(h),await t()},async refreshPhotos(){await t()},async refreshStats(){await f()},async completeCurrent(i){const d=a().current;if(!d)return;const m={...d,fields:{...d.fields,status:"completed",completedAt:Date.now()},updatedAt:Date.now()};await j(m),await t();const h=await a().newDraft();await t();const I=(i==null?void 0:i.preserveKeys)??[];if(I.length>0){const x={};I.forEach(M=>{var N;((N=d.fields)==null?void 0:N[M])!==void 0&&(x[M]=d.fields[M])}),Object.keys(x).length>0&&await a().setFields(x)}return h},async clearCurrent(){const i=a().current;i&&(await w.survey_photos.where("draftId").equals(i.id).delete(),await w.survey_drafts.delete(i.id),u({current:void 0,photos:[]}),await f())},async listHistory(i="asc"){const d=w.survey_drafts.orderBy("updatedAt");return(i==="desc"?await d.reverse().toArray():await d.toArray()).filter(h=>{var I;return((I=h.fields)==null?void 0:I.status)==="completed"})},async purgeCompleted(){const i=await w.survey_drafts.filter(m=>{var h;return((h=m.fields)==null?void 0:h.status)==="completed"}).toArray();if(i.length===0)return 0;await w.transaction("rw",w.survey_drafts,w.survey_photos,async()=>{for(const m of i)await w.survey_photos.where("draftId").equals(m.id).delete(),await w.survey_drafts.delete(m.id)});const d=a().current;return d&&i.some(m=>m.id===d.id)&&u({current:void 0,photos:[]}),await f(),await t(),i.length},async duplicateDraft(i,d){if(d<=0)return 0;const m=await w.survey_drafts.get(i);if(!m)throw new Error("複製元の履歴が見つかりません");const h={...m.fields??{}},I=h.sealNo||h.qr||h.qrCode||m.qr;if(!I)throw new Error("複製元のQRコードが取得できませんでした");const x=I.match(/(\d+)(?!.*\d)/),M=x?x.index??-1:-1,N=x?parseInt(x[1],10):null,D=x?x[1].length:0,F=M>=0?I.slice(0,M):I,C=M>=0?I.slice(M+D):"",q=await w.survey_photos.where("draftId").equals(i).toArray(),k=[],O=[],E=Date.now(),U=g=>{if(N!==null){const p=N+g,Q=String(p).padStart(D,"0");return`${F}${Q}${C}`}return`${I}-${g}`};for(let g=1;g<=d;g++){const p=crypto.randomUUID(),Q=U(g),P=[],$={...h,qr:Q,qrCode:Q,sealNo:Q,status:"completed",completedAt:E+g};q.forEach(W=>{const J=crypto.randomUUID();P.push(J),O.push({...W,id:J,draftId:p,createdAt:E+g})}),k.push({id:p,fields:$,photoIds:P,updatedAt:E+g})}await w.transaction("rw",w.survey_drafts,w.survey_photos,async()=>{O.length>0&&await w.survey_photos.bulkPut(O),k.length>0&&await w.survey_drafts.bulkPut(k)}),await f();const A=a().current;if(A){const g=await w.survey_drafts.get(A.id);g&&u({current:g})}return k.length}};return f(),y});function jt(){const{current:u,newDraft:a}=He();o.useEffect(()=>{u||a()},[u,a])}const Oo="この端末ではカメラが利用できません",Ao="ブラウザ環境ではありません",Mo="カメラの利用には HTTPS での接続が必要です";function Fo(){if(typeof navigator>"u")return null;const u=navigator.mediaDevices;if(u!=null&&u.getUserMedia)return t=>u.getUserMedia(t);const a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a?t=>new Promise((f,j)=>{a.call(navigator,t,f,j)}):null}async function us(){if(typeof navigator>"u")throw new Error(Ao);if(typeof window<"u"&&"isSecureContext"in window&&!window.isSecureContext)throw new Error(Mo);const u=Fo();if(!u)throw new Error(Oo);if(sessionStorage.getItem("cameraPermission")==="granted")return"granted";try{return(await u({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1})).getTracks().forEach(f=>f.stop()),sessionStorage.setItem("cameraPermission","granted"),"granted"}catch(t){const f=t;throw(f==null?void 0:f.name)==="NotAllowedError"||(f==null?void 0:f.name)==="SecurityError"?sessionStorage.setItem("cameraPermission","denied"):sessionStorage.removeItem("cameraPermission"),t instanceof Error?t:new Error(String(t))}}const ls={},Lo="/poc-survey-offline-mock/".replace(/\/?$/,"/"),ms=u=>`${Lo}tesseract/${u.replace(/^\//,"")}`;var Js;const Po=(Js=ls==null?void 0:ls.VITE_TESSDATA_URL)==null?void 0:Js.trim(),To=ms("lang-data/"),to=(Po??To).replace(/\/?$/,"/");let nt=null,hs=!1;const Uo=6e4;function Qo(u,a,t){return new Promise((f,j)=>{const y=setTimeout(()=>{try{t==null||t()}catch{}j(new Error("OCR処理がタイムアウトしました"))},a);u.then(i=>{clearTimeout(y),f(i)},i=>{clearTimeout(y),j(i)})})}function Bo(u){return u.replace(/[\uFF01-\uFF5E]/g,a=>String.fromCharCode(a.charCodeAt(0)-65248)).replace(/\u3000/g," ")}function Ho(u){return Bo(u).toUpperCase().replace(/[\u2010-\u2015\u2212\u30FC\uFF0D\uFE63]/g,"-").replace(/[^0-9A-Z-]/g,"")}const fs=()=>{nt=null,hs=!1};async function $o(){return eo.createWorker("eng",void 0,{workerPath:ms("worker.min.js"),corePath:ms("tesseract-core.wasm.js"),langPath:to,workerBlobURL:!1})}async function ps(){nt||(nt=Qo($o(),Uo,fs));try{const u=await nt;return hs||(await u.setParameters({tessedit_char_whitelist:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-",tessedit_pageseg_mode:eo.PSM.SINGLE_LINE}),hs=!0),u}catch(u){throw fs(),u instanceof Error?u:new Error("Tesseract workerの初期化に失敗しました")}}function so(){ps().catch(()=>{})}const qo=["tesseract/lang-data/eng.traineddata.gz","tesseract/worker.min.js","tesseract/tesseract-core.wasm","tesseract/tesseract-core.wasm.js"];async function Wo(){const u="/poc-survey-offline-mock/".replace(/\/?$/,"/");await Promise.all(qo.map(async a=>{try{await fetch(`${u}${a}`,{cache:"force-cache"})}catch{}}))}async function na(){await Wo(),await ps()}async function zo(u){const a=await ps(),{data:t}=await a.recognize(u).catch(async m=>{throw await Go(),m}),f=Array.isArray(t.lines)?t.lines:[],j=f.map(m=>{var h,I;return((I=(h=m.text)==null?void 0:h.trim)==null?void 0:I.call(h))??""}).filter(Boolean),y=f.reduce((m,h)=>!m||h.confidence>m.confidence?{text:h.text,confidence:h.confidence}:m,null),i=Ho((y==null?void 0:y.text)??t.text??""),d=(y==null?void 0:y.confidence)??t.confidence??0;return{text:i,rawText:t.text??"",candidates:j.length>0?j:(t.text??"").split(/\n+/).map(m=>m.trim()).filter(Boolean),confidence:d,method:"tesseract"}}async function Go(){if(!nt)return;await(await nt).terminate(),fs()}async function Ko(u){let a=null;try{return await zo(u)}catch(t){a=t instanceof Error?t:new Error(String(t))}if(a){const t=a.message;throw to.startsWith("http")?typeof navigator<"u"&&!navigator.onLine?new Error("OCR辞書データが未取得です。オンライン接続時に一度読み取りを実行し、キャッシュを作成してください。"):new Error(`OCR辞書データのダウンロードに失敗しました: ${t}`):new Error(`OCR辞書データの読み込みに失敗しました。詳細: ${t}`)}throw new Error("OCR処理に失敗しました。")}function Ft(u,a){return a?u.toLowerCase().includes(a.toLowerCase()):!0}function Zo(){var B,te,je,ne,ie,re;jt();const u=bt(),{current:a,setFields:t}=He(),[f,j]=o.useState([]),[y,i]=o.useState([]),[d,m]=o.useState([]),[h,I]=o.useState([]),[x,M]=o.useState(""),[N,D]=o.useState(""),[F,C]=o.useState(""),[q,k]=o.useState(""),[O,E]=o.useState(void 0),[U,A]=o.useState(void 0),[g,p]=o.useState(void 0),[Q,P]=o.useState(void 0),$=o.useMemo(()=>{const r=new Date;return`${r.getFullYear()}年${String(r.getMonth()+1).padStart(2,"0")}月${String(r.getDate()).padStart(2,"0")}日`},[]),W=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{sessionStorage.setItem("visitedDepartment","1")},[]),o.useEffect(()=>{Promise.all([w.location_buildings.toArray(),w.location_floors.toArray(),w.location_departments.toArray(),w.location_divisions.toArray()]).then(([r,H,z,K])=>{j(r),i(H),m(z),I(K)})},[]),o.useEffect(()=>{var H,z;if(!a)return;const r={};(H=a.fields)!=null&&H.surveyDate||(r.surveyDate=$),W&&((z=a.fields)==null?void 0:z.investigator)!==W&&(r.investigator=W),Object.keys(r).length>0&&t(r)},[a,W,t,$]);const J=(B=a==null?void 0:a.fields)==null?void 0:B.buildingId,c=(te=a==null?void 0:a.fields)==null?void 0:te.floorId,b=(je=a==null?void 0:a.fields)==null?void 0:je.departmentId,_=(ne=a==null?void 0:a.fields)==null?void 0:ne.divisionId;o.useEffect(()=>{E(J)},[J]),o.useEffect(()=>{A(c)},[c]),o.useEffect(()=>{p(b)},[b]),o.useEffect(()=>{P(_)},[_]);const L=o.useMemo(()=>f.find(r=>r.id===O),[f,O]),R=o.useMemo(()=>y.find(r=>r.id===U),[y,U]),Y=o.useMemo(()=>d.find(r=>r.id===g),[d,g]),X=o.useMemo(()=>h.find(r=>r.id===Q),[h,Q]);o.useEffect(()=>{M(L?L.name:"")},[L]),o.useEffect(()=>{D(R?R.name:"")},[R]),o.useEffect(()=>{C(Y?Y.name:"")},[Y]),o.useEffect(()=>{k(X?X.name:"")},[X]);const V=o.useMemo(()=>f.filter(r=>Ft(r.name,x)),[f,x]),me=o.useMemo(()=>y.filter(r=>O&&r.buildingId!==O?!1:Ft(r.name,N)),[y,N,O]),se=o.useMemo(()=>d.filter(r=>O&&r.buildingId!==O||U&&r.floorId!==U?!1:Ft(r.name,F)),[d,F,O,U]),he=o.useMemo(()=>h.filter(r=>O&&r.buildingId!==O||U&&r.floorId!==U||g&&r.departmentId!==g?!1:Ft(r.name,q)),[h,q,O,U,g]),fe=r=>{if(!r||O===r.id){M(""),D(""),C(""),k(""),E(void 0),A(void 0),p(void 0),P(void 0),t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0});return}M(r.name),D(""),C(""),k(""),E(r.id),A(void 0),p(void 0),P(void 0),t({buildingId:r.id,floorId:void 0,departmentId:void 0,divisionId:void 0})},Ie=r=>{if(!r||U===r.id){D(""),C(""),k(""),A(void 0),p(void 0),P(void 0),t({buildingId:O,floorId:void 0,departmentId:void 0,divisionId:void 0});return}const H=f.find(z=>z.id===r.buildingId);H&&(M(H.name),E(H.id)),D(r.name),C(""),k(""),A(r.id),p(void 0),P(void 0),t({buildingId:r.buildingId,floorId:r.id,departmentId:void 0,divisionId:void 0})},xe=r=>{if(!r||g===r.id){C(""),k(""),p(void 0),P(void 0),t({buildingId:O,floorId:U,departmentId:void 0,divisionId:void 0});return}const H=f.find(K=>K.id===r.buildingId),z=y.find(K=>K.id===r.floorId);H&&(M(H.name),E(H.id)),z&&(D(z.name),A(z.id)),C(r.name),k(""),p(r.id),P(void 0),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.id,divisionId:void 0})},be=r=>{if(!r||Q===r.id){k(""),P(void 0),t({buildingId:O,floorId:U,departmentId:g,divisionId:void 0});return}const H=f.find(Z=>Z.id===r.buildingId),z=y.find(Z=>Z.id===r.floorId),K=d.find(Z=>Z.id===r.departmentId);H&&(M(H.name),E(H.id)),z&&(D(z.name),A(z.id)),K&&(C(K.name),p(K.id)),k(r.name),P(r.id),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.departmentId,divisionId:r.id})},v=!!(O&&U&&g&&Q);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"部署入力"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["調査日",e.jsx("input",{value:((ie=a==null?void 0:a.fields)==null?void 0:ie.surveyDate)??$,disabled:!0})]}),e.jsxs("label",{children:["調査担当",e.jsx("input",{value:((re=a==null?void 0:a.fields)==null?void 0:re.investigator)??W,disabled:!0})]})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["棟",e.jsx("input",{value:x,onChange:r=>M(r.target.value),placeholder:"棟を検索"})]}),e.jsx("div",{className:"option-list",children:V.map(r=>e.jsx("button",{onClick:()=>fe(r),className:r.id===O?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["階",e.jsx("input",{value:N,onChange:r=>D(r.target.value),placeholder:"階を検索"})]}),e.jsx("div",{className:"option-list",children:me.map(r=>{var H;return e.jsxs("button",{onClick:()=>Ie(r),className:r.id===U?"active":"",children:[r.name,"（",((H=f.find(z=>z.id===r.buildingId))==null?void 0:H.name)??"","）"]},r.id)})}),e.jsxs("label",{children:["部署",e.jsx("input",{value:F,onChange:r=>C(r.target.value),placeholder:"部署を検索"})]}),e.jsx("div",{className:"option-list",children:se.map(r=>e.jsx("button",{onClick:()=>xe(r),className:r.id===g?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["部門",e.jsx("input",{value:q,onChange:r=>k(r.target.value),placeholder:"部門を検索"})]}),e.jsx("div",{className:"option-list",children:he.map(r=>e.jsx("button",{onClick:()=>be(r),className:r.id===Q?"active":"",children:r.name},r.id))})]}),e.jsx("p",{className:"helper-text",children:"今日一日がんばって！！"})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>u("/home"),children:"ホーム"}),e.jsx("button",{onClick:()=>u("/survey/all"),disabled:!v,children:"次へ"})]})]})}const ia=Object.freeze(Object.defineProperty({__proto__:null,default:Zo},Symbol.toStringTag,{value:"Module"})),gs=o.forwardRef(({onResult:u},a)=>{const t=o.useRef(null),f=o.useRef(null),j=o.useRef(null),[y,i]=o.useState(!1);o.useEffect(()=>(f.current=new ds,()=>{var h;(h=j.current)==null||h.stop(),j.current=null,ds.releaseAllStreams(),f.current=null,i(!1)}),[]);const d=o.useCallback(()=>{var h;(h=j.current)==null||h.stop(),j.current=null,ds.releaseAllStreams(),i(!1)},[]),m=o.useCallback(async()=>{if(!(!t.current||!f.current)&&!y){i(!0);try{j.current=await f.current.decodeFromConstraints({video:{facingMode:"environment"}},t.current,h=>{h&&(u(h.getText()),d())})}catch(h){console.error(h),i(!1),j.current=null}}},[u,y,d]);return o.useImperativeHandle(a,()=>({start:m,stop:d}),[m,d]),e.jsxs("div",{className:"qr-container",style:{display:y?"block":"none"},children:[e.jsx("video",{ref:t,className:"qr-video",muted:!0,playsInline:!0}),y&&e.jsx("div",{className:"helper-text",style:{marginTop:8},children:"読み取り中です..."})]})}),ra=Object.freeze(Object.defineProperty({__proto__:null,QRScanner:gs},Symbol.toStringTag,{value:"Module"}));function vs({open:u,onClose:a}){const{listHistory:t,duplicateDraft:f}=He(),[j,y]=o.useState("asc"),[i,d]=o.useState(!1),[m,h]=o.useState(null),[I,x]=o.useState([]),[M,N]=o.useState(null),[D,F]=o.useState({}),[C,q]=o.useState(null),k=async g=>{d(!0),h(null);try{const p=await t(g);x(p)}catch(p){const Q=p instanceof Error?p.message:String(p);h(Q),x([])}finally{d(!1)}};o.useEffect(()=>{u?(N(null),F({}),q(null),k(j)):(h(null),x([]))},[u,j]);const O=()=>{y(g=>g==="asc"?"desc":"asc")},E=(g,p)=>{F(Q=>({...Q,[g]:p}))},U=async g=>{const p=D[g]??"1",Q=Number.parseInt(p,10);if(!Number.isFinite(Q)||Q<=0){N("複製数は1以上の整数を入力してください");return}q(g),N(null);try{const P=await f(g,Q);N(`履歴を ${P} 件複製しました`),F($=>({...$,[g]:""})),await k(j)}catch(P){const $=P instanceof Error?P.message:String(P);N(`複製に失敗しました: ${$}`)}finally{q(null)}},A=o.useMemo(()=>i?e.jsx("p",{className:"helper-text",children:"読み込み中..."}):m?e.jsxs("p",{className:"badge warn",children:["エラー: ",m]}):I.length===0?e.jsx("p",{className:"helper-text",children:"複製可能な履歴がありません。"}):I.map(g=>{const p=g.fields??{},Q=p.completedAt??g.updatedAt,P=p.sealNo??p.qr??g.qr??"-",$=p.assetNo??"-",W=p.equipmentNo??"-",J=p.width??"-",c=p.depth??"-",b=p.height??"-",_=p.note??"",L=D[g.id]??"";return e.jsxs("div",{className:"history-row static",children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(Q).toLocaleString()}),e.jsxs("span",{className:"pill",children:["QR ",P]}),$!=="-"&&e.jsxs("span",{className:"pill",children:["資産 ",$]}),W!=="-"&&e.jsxs("span",{className:"pill",children:["備品 ",W]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsxs("span",{className:"pill",children:["Category ",p.categoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Sub ",p.subcategoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Item ",p.itemId??"-"]}),e.jsxs("span",{className:"pill",children:["Maker ",p.makerId??"-"]}),e.jsxs("span",{className:"pill",children:["Model ",p.modelId??"-"]})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",J]}),e.jsxs("span",{children:["D: ",c]}),e.jsxs("span",{children:["H: ",b]}),_&&e.jsxs("span",{children:["備考: ",_]})]}),e.jsxs("div",{className:"history-duplicate",children:[e.jsx("input",{type:"number",min:1,placeholder:"複製数",value:L,onChange:R=>E(g.id,R.target.value)}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>U(g.id),disabled:C===g.id,children:C===g.id?"複製中...":"複製"})]})]},g.id)}),[I,D,i,m,C]);return u?e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"複製"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:O,children:j==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:a,children:"閉じる"})]})]}),M&&e.jsx("p",{className:"badge success",style:{marginTop:8},children:M}),e.jsx("div",{className:"history-list",children:A})]})}):null}function Vo(){var p,Q,P,$,W,J;jt();const u=bt(),a=o.useRef(null),{current:t,setFields:f,setQR:j}=He(),[y,i]=o.useState(""),[d,m]=o.useState(""),[h,I]=o.useState([]),[x,M]=o.useState(!1);o.useEffect(()=>{var c,b;i(((c=t==null?void 0:t.fields)==null?void 0:c.sealNo)??""),m(((b=t==null?void 0:t.fields)==null?void 0:b.roomName)??"")},[(p=t==null?void 0:t.fields)==null?void 0:p.sealNo,(Q=t==null?void 0:t.fields)==null?void 0:Q.roomName]),o.useEffect(()=>()=>{var c;(c=a.current)==null||c.stop()},[]),o.useEffect(()=>{let c=!0;return w.location_rooms.toArray().then(b=>{c&&I(b)}).catch(()=>{c&&I([])}),()=>{c=!1}},[]);const N=(P=t==null?void 0:t.fields)==null?void 0:P.buildingId,D=($=t==null?void 0:t.fields)==null?void 0:$.floorId,F=(W=t==null?void 0:t.fields)==null?void 0:W.departmentId,C=(J=t==null?void 0:t.fields)==null?void 0:J.divisionId,q=o.useMemo(()=>{if(!N||!D||!F||!C)return[];const c=d.trim().toLowerCase();return h.filter(b=>b.buildingId!==N||b.floorId!==D||b.departmentId!==F||b.divisionId!==C?!1:c?b.name.toLowerCase().includes(c):!0)},[h,N,D,F,C,d]),k=c=>{const b=c.trim(),_=b.match(/medical-record\/([A-Za-z0-9-]+)$/i),L=_?_[1]:b;i(L),j(L)},O=c=>{i(c),f({sealNo:c,qrCode:c})},E=c=>{m(c),f({roomName:c})},U=()=>{var c;(c=a.current)==null||c.stop(),u("/survey/department")},A=()=>{var c;(c=a.current)==null||c.stop(),u("/survey/asset")},g=!!(y.trim()&&d.trim());return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QRコード読取・ラベルNo確認"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:y,onChange:c=>O(c.target.value),placeholder:"シールNoを入力"})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:d,onChange:c=>E(c.target.value),placeholder:"室名を入力"}),q.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:q.map(c=>e.jsx("button",{type:"button",onClick:()=>E(c.name),children:c.name},c.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:a,onResult:k})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>M(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:U,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:async()=>{var c;try{await us(),await((c=a.current)==null?void 0:c.start())}catch(b){const _=b instanceof Error?b.message:String(b);alert(`カメラを利用できませんでした: ${_}`)}},children:"QR撮影"}),e.jsx("button",{onClick:A,disabled:!g,children:"次へ"})]}),e.jsx(vs,{open:x,onClose:()=>M(!1)})]})}const da=Object.freeze(Object.defineProperty({__proto__:null,default:Vo},Symbol.toStringTag,{value:"Module"})),Lt={left:.08,top:.425,width:.84,height:.15},Ys=1200,Xo=2e3;function cs(u,a){const t=u.split(","),f=t[0].match(/:(.*?);/),j=(f==null?void 0:f[1])??a,y=atob(t[1]??""),i=y.length,d=new Uint8Array(i);for(let m=0;m<i;m+=1)d[m]=y.charCodeAt(m);return new Blob([d],{type:j})}async function Yo(u,a,t){return typeof u.toBlob=="function"?await new Promise((f,j)=>{let y=!1;const i=window.setTimeout(()=>{if(!y){y=!0;try{const d=cs(u.toDataURL(a,t),a);f(d)}catch(d){j(d instanceof Error?d:new Error("スナップショットの生成に失敗しました"))}}},Xo);u.toBlob(d=>{if(!y)if(y=!0,window.clearTimeout(i),d)f(d);else try{const m=cs(u.toDataURL(a,t),a);f(m)}catch(m){j(m instanceof Error?m:new Error("スナップショットの生成に失敗しました"))}},a,t)}):cs(u.toDataURL(a,t),a)}function oo({open:u,targetLabel:a,onClose:t,onResult:f,onRecognized:j}){const y=o.useRef(null),i=o.useRef(null),d=o.useRef(),m=o.useRef(),h=o.useRef(null),[I,x]=o.useState("idle"),[M,N]=o.useState("カメラを初期化しています…"),[D,F]=o.useState(!1),[C,q]=o.useState(null),[k,O]=o.useState(null);o.useEffect(()=>{d.current=document.createElement("canvas"),m.current=document.createElement("canvas")},[]);const E=o.useCallback(()=>{q(null),O(c=>(c&&URL.revokeObjectURL(c),null))},[]),U=()=>{i.current&&(i.current.getTracks().forEach(c=>c.stop()),i.current=null),y.current&&(y.current.pause(),y.current.srcObject=null)},A=o.useCallback(async()=>{var c;if(E(),!((c=navigator.mediaDevices)!=null&&c.getUserMedia)){x("error"),N("この端末ではカメラを利用できません。手入力してください。"),F(!1);return}x("camera"),N("カメラを起動しています…");try{const b=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});i.current=b,y.current&&(y.current.srcObject=b,await y.current.play().catch(()=>{})),x("camera"),N("枠が黒い帯に変わりました。番号を合わせて撮影してください。"),F(!1)}catch(b){const _=b instanceof Error?b.message:String(b);x("error"),N(`カメラにアクセスできません: ${_}`),F(!1)}},[E]);o.useEffect(()=>{if(!u){U(),E(),x("idle"),N("カメラを初期化しています…"),F(!1);return}return A(),()=>{U()}},[u,A]);const g=async(c,b,_)=>{const L=d.current,R=m.current;if(!L||!R||c===0||b===0)throw new Error("画像データを読み込めませんでした。");L.width=c,L.height=b;const Y=L.getContext("2d");if(!Y)throw new Error("画像の処理に失敗しました。");_(Y);const X=R.getContext("2d");if(!X)throw new Error("画像の処理に失敗しました。");const V={x:Math.floor(L.width*Lt.left),y:Math.floor(L.height*Lt.top),width:Math.floor(L.width*Lt.width),height:Math.floor(L.height*Lt.height)},me=V.width>Ys?Ys/V.width:1,se=Math.max(320,Math.round(V.width*me)),he=Math.max(120,Math.round(V.height*me));return R.width=se,R.height=he,X.filter="contrast(160%) brightness(115%) grayscale(15%)",X.drawImage(L,V.x,V.y,V.width,V.height,0,0,se,he),Yo(R,"image/jpeg",.92)},p=async()=>{if(!u||D||I!=="camera")return;const c=y.current;if(!c||c.videoWidth===0||c.videoHeight===0){x("error"),N("カメラ映像を取得できませんでした。");return}F(!0),N("撮影中…");try{const b=await g(c.videoWidth,c.videoHeight,L=>{L.drawImage(c,0,0,c.videoWidth,c.videoHeight)});U(),E();const _=URL.createObjectURL(b);q(b),O(_),x("photo"),N("写真を保存しました。読み取りボタンを押してください。"),F(!1)}catch(b){const _=b instanceof Error?b.message:String(b);x("error"),N(`撮影に失敗しました: ${_}`),F(!1)}},Q=c=>new Promise((b,_)=>{const L=URL.createObjectURL(c),R=new Image;R.onload=()=>{URL.revokeObjectURL(L),b(R)},R.onerror=Y=>{URL.revokeObjectURL(L),_(Y)},R.src=L}),P=async c=>{if(!c||c.length===0)return;const b=c[0];F(!0),N("画像を処理しています…");try{let _;if(typeof createImageBitmap=="function"){const R=await createImageBitmap(b);_=await g(R.width,R.height,Y=>{Y.drawImage(R,0,0,R.width,R.height)}),R.close()}else{const R=await Q(b),Y=R.naturalWidth||R.width,X=R.naturalHeight||R.height;_=await g(Y,X,V=>{V.drawImage(R,0,0,Y,X)})}U(),E();const L=URL.createObjectURL(_);q(_),O(L),x("photo"),N("写真を保存しました。読み取りボタンを押してください。")}catch(_){const L=_ instanceof Error?_.message:String(_);x("error"),N(`画像の処理に失敗しました: ${L}`)}finally{F(!1),h.current&&(h.current.value="")}},$=async()=>{if(!(!C||D)){x("processing"),F(!0),N("読み取り中です。1秒ほどお待ちください…");try{const c=await Ko(C);c.text?(f(c.text),N(`認識した値: ${c.text}`),j==null||j({text:c.text,method:c.method,targetLabel:a}),t()):(x("error"),N("文字を検出できませんでした。撮り直して再試行してください。"),F(!1))}catch(c){const b=c instanceof Error?c.message:String(c);x("error"),N(`読み取りに失敗しました: ${b}`),F(!1)}}},W=()=>{D||(E(),A())},J=o.useMemo(()=>I==="photo"?"撮影した画像を確認し、問題なければ「読み取る」を押してください。":I==="processing"?"しばらくお待ちください…":I==="error"?"カメラや照明の状態を確認してください。":"黒いガイド帯の中央に番号を重ね、影や反射を避けて撮影すると精度が上がります。",[I]);return u?e.jsx("div",{className:"ocr-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"ocr-panel",children:[e.jsxs("header",{className:"ocr-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ocr-eyebrow",children:"テキストスキャン"}),e.jsxs("h3",{children:[a,"の読み取り"]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:t,children:"閉じる"})]}),e.jsxs("div",{className:"ocr-video-container",children:[e.jsx("input",{type:"file",accept:"image/*",ref:h,style:{display:"none"},onChange:c=>P(c.target.files)}),k?e.jsx("img",{src:k,alt:"撮影した画像",className:"ocr-preview"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:y,playsInline:!0,autoPlay:!0,muted:!0,className:"ocr-video"}),e.jsx("div",{className:"ocr-frame","aria-hidden":"true",children:e.jsx("span",{className:"ocr-frame__label",children:"黒い帯に合わせてください"})})]})]}),e.jsx("p",{className:"helper-text",children:J}),e.jsx("p",{className:`ocr-message ${I==="error"?"is-error":""}`,children:M}),e.jsxs("footer",{className:"ocr-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:t,disabled:D&&I==="processing",children:"キャンセル"}),e.jsx("button",{type:"button",className:"ghost",onClick:()=>{var c;return(c=h.current)==null?void 0:c.click()},disabled:D,children:"画像をアップロード"}),C&&e.jsx("button",{type:"button",className:"ghost",onClick:W,disabled:D,children:"撮り直し"}),!C&&e.jsx("button",{type:"button",onClick:p,className:"secondary",disabled:D||I!=="camera",children:"撮影する"}),C&&e.jsx("button",{type:"button",onClick:$,className:"secondary",disabled:D,children:I==="processing"?"読み取り中...":"読み取る"})]})]})}):null}function Jo(){var V,me,se,he,fe,Ie,xe,be;jt();const u=bt(),a=o.useRef(null),{current:t,photos:f,attachPhoto:j,removePhoto:y,setFields:i}=He(),[d,m]=o.useState(""),[h,I]=o.useState(""),[x,M]=o.useState(""),[N,D]=o.useState(!1),[F,C]=o.useState(!1),[q,k]=o.useState(!1),[O,E]=o.useState("assetNo"),[U,A]=o.useState(!1),[g,p]=o.useState(null);o.useEffect(()=>{so()},[]),o.useEffect(()=>{var v,B,te,je,ne;m(((v=t==null?void 0:t.fields)==null?void 0:v.assetNo)??""),I(((B=t==null?void 0:t.fields)==null?void 0:B.equipmentNo)??""),M(((te=t==null?void 0:t.fields)==null?void 0:te.purchaseDate)??""),D(!!((je=t==null?void 0:t.fields)!=null&&je.leaseFlag)),C(!!((ne=t==null?void 0:t.fields)!=null&&ne.loanedFlag))},[(V=t==null?void 0:t.fields)==null?void 0:V.assetNo,(me=t==null?void 0:t.fields)==null?void 0:me.equipmentNo,(se=t==null?void 0:t.fields)==null?void 0:se.purchaseDate,(he=t==null?void 0:t.fields)==null?void 0:he.leaseFlag,(fe=t==null?void 0:t.fields)==null?void 0:fe.loanedFlag]),o.useEffect(()=>{var v;if(!((v=t==null?void 0:t.fields)!=null&&v.purchaseDate)){const B=new Date;B.setHours(0,0,0,0);const te=B.toISOString().slice(0,10);M(te),i({purchaseDate:te})}},[(Ie=t==null?void 0:t.fields)==null?void 0:Ie.purchaseDate,i]);const Q=((xe=t==null?void 0:t.fields)==null?void 0:xe.sealNo)??"",P=((be=t==null?void 0:t.fields)==null?void 0:be.roomName)??"",$=o.useMemo(()=>f.map(v=>({id:v.id,url:URL.createObjectURL(v.thumb)})),[f]);o.useEffect(()=>()=>{$.forEach(v=>URL.revokeObjectURL(v.url))},[$]);const W=async v=>{if(!v||v.length===0)return;const B=v[0];await j(B),a.current&&(a.current.value="")},J=()=>{const v=!N;D(v),i({leaseFlag:v})},c=()=>{const v=!F;C(v),i({loanedFlag:v})},b=()=>{u("/survey/label")},_=()=>{u("/survey/product")},L=f.length>0,R=v=>{v&&(O==="assetNo"?(m(v),i({assetNo:v})):(I(v),i({equipmentNo:v})))},Y=o.useCallback(v=>{p(`${v.targetLabel}を読み取り: ${v.text}`)},[]);o.useEffect(()=>{if(!g)return;const v=window.setTimeout(()=>p(null),5e3);return()=>{window.clearTimeout(v)}},[g]);const X=v=>{E(v),A(!0)};return e.jsxs("div",{className:"page",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,style:{display:"none"},onChange:v=>W(v.target.files)}),e.jsxs("div",{className:"page-section",children:[g&&e.jsx("div",{className:"ocr-result-banner",children:g}),e.jsx("h2",{className:"section-title",children:"写真撮影・資産No登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:Q,disabled:!0})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:P,disabled:!0})]}),e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:d,onChange:v=>{const B=v.target.value;m(B),i({assetNo:B})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>X("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:h,onChange:v=>{const B=v.target.value;I(B),i({equipmentNo:B})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>X("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:x,onChange:v=>{const B=v.target.value;M(B),i({purchaseDate:B})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:N?"secondary":"ghost",onClick:J,children:["リース: ",N?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:F?"secondary":"ghost",onClick:c,children:["貸出品: ",F?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:$.map(v=>e.jsxs("div",{className:"photo-item",children:[e.jsx("button",{type:"button",className:"photo-remove",onClick:()=>y(v.id),"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:v.url,alt:"サムネイル"})]},v.id))})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>k(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:b,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:()=>{var v;return(v=a.current)==null?void 0:v.click()},children:"写真"}),e.jsx("button",{onClick:_,disabled:!L,children:"次へ"})]}),e.jsx(vs,{open:q,onClose:()=>k(!1)}),e.jsx(oo,{open:U,targetLabel:O==="assetNo"?"資産番号":"備品番号",onClose:()=>A(!1),onResult:R,onRecognized:Y})]})}const la=Object.freeze(Object.defineProperty({__proto__:null,default:Jo},Symbol.toStringTag,{value:"Module"}));function xt(u,a){return a?u.toLowerCase().includes(a.toLowerCase()):!0}function ea(){var kt,We,Et,ze,Ge,ut,Ke,mt,ht;jt();const u=bt(),{current:a,setFields:t,completeCurrent:f,listHistory:j}=He(),[y,i]=o.useState([]),[d,m]=o.useState([]),[h,I]=o.useState([]),[x,M]=o.useState([]),[N,D]=o.useState([]),[F,C]=o.useState(""),[q,k]=o.useState(""),[O,E]=o.useState(""),[U,A]=o.useState(""),[g,p]=o.useState(""),[Q,P]=o.useState(""),[$,W]=o.useState(""),[J,c]=o.useState(""),[b,_]=o.useState(""),[L,R]=o.useState(!1),[Y,X]=o.useState(!1),[V,me]=o.useState([]),[se,he]=o.useState(!1),[fe,Ie]=o.useState(null),[xe,be]=o.useState("asc"),v=o.useRef(void 0),B=o.useRef(void 0),te=o.useRef(void 0),je=o.useRef(void 0),ne=o.useRef(void 0);o.useEffect(()=>{Promise.all([w.product_categories.toArray(),w.product_subcategories.toArray(),w.product_items.toArray(),w.product_makers.toArray(),w.product_models.toArray()]).then(([n,S,le,ce,Ce])=>{i(n),m(S),I(le),M(ce),D(Ce)})},[]),o.useEffect(()=>{var n,S,le,ce;P(((n=a==null?void 0:a.fields)==null?void 0:n.width)??""),W(((S=a==null?void 0:a.fields)==null?void 0:S.depth)??""),c(((le=a==null?void 0:a.fields)==null?void 0:le.height)??""),_(((ce=a==null?void 0:a.fields)==null?void 0:ce.note)??"")},[(kt=a==null?void 0:a.fields)==null?void 0:kt.width,(We=a==null?void 0:a.fields)==null?void 0:We.depth,(Et=a==null?void 0:a.fields)==null?void 0:Et.height,(ze=a==null?void 0:a.fields)==null?void 0:ze.note]);const ie=(Ge=a==null?void 0:a.fields)==null?void 0:Ge.categoryId,re=(ut=a==null?void 0:a.fields)==null?void 0:ut.subcategoryId,r=(Ke=a==null?void 0:a.fields)==null?void 0:Ke.itemId,H=(mt=a==null?void 0:a.fields)==null?void 0:mt.makerId,z=(ht=a==null?void 0:a.fields)==null?void 0:ht.modelId,K=y.find(n=>n.id===ie),Z=d.find(n=>n.id===re),Ne=h.find(n=>n.id===r),de=x.find(n=>n.id===H),pe=N.find(n=>n.id===z);o.useEffect(()=>{(K==null?void 0:K.id)!==v.current&&(K?C(K.name):v.current&&C(""),v.current=K==null?void 0:K.id)},[K]),o.useEffect(()=>{(Z==null?void 0:Z.id)!==B.current&&(Z?k(Z.name):B.current&&k(""),B.current=Z==null?void 0:Z.id)},[Z]),o.useEffect(()=>{(Ne==null?void 0:Ne.id)!==te.current&&(Ne?E(Ne.name):te.current&&E(""),te.current=Ne==null?void 0:Ne.id)},[Ne]),o.useEffect(()=>{(de==null?void 0:de.id)!==je.current&&(de?A(de.name):je.current&&A(""),je.current=de==null?void 0:de.id)},[de]),o.useEffect(()=>{(pe==null?void 0:pe.id)!==ne.current&&(pe?p(pe.name):ne.current&&p(""),ne.current=pe==null?void 0:pe.id)},[pe]);const $e=o.useMemo(()=>y.filter(n=>xt(n.name,F)),[y,F]),Pt=o.useMemo(()=>d.filter(n=>xt(n.name,q)),[d,q]),Tt=o.useMemo(()=>h.filter(n=>xt(n.name,O)),[h,O]),Nt=o.useMemo(()=>x.filter(n=>xt(n.name,U)),[x,U]),it=o.useMemo(()=>N.filter(n=>xt(n.name,g)),[N,g]),rt=n=>{if(ie===n.id){C(""),k(""),E(""),A(""),p(""),t({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}C(n.name),k(""),E(""),A(""),p(""),t({categoryId:n.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},dt=n=>{if(re===n.id){k(""),E(""),A(""),p(""),t({categoryId:ie??n.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}k(n.name),E(""),A(""),p(""),t({categoryId:n.categoryId,subcategoryId:n.id,itemId:void 0,makerId:void 0,modelId:void 0})},lt=n=>{if(r===n.id){E(""),A(""),p(""),t({categoryId:ie??n.categoryId,subcategoryId:re??n.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}E(n.name),A(""),p(""),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.id,makerId:void 0,modelId:void 0})},wt=n=>{if(H===n.id){A(""),p(""),t({categoryId:ie??n.categoryId,subcategoryId:re??n.subcategoryId,itemId:r??n.itemId,makerId:void 0,modelId:void 0});return}A(n.name),p(""),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.itemId,makerId:n.id,modelId:void 0})},Ut=n=>{if(z===n.id){p(""),t({categoryId:ie??n.categoryId,subcategoryId:re??n.subcategoryId,itemId:r??n.itemId,makerId:H??n.makerId,modelId:void 0});return}p(n.name),t({categoryId:n.categoryId,subcategoryId:n.subcategoryId,itemId:n.itemId,makerId:n.makerId,modelId:n.id})},St=o.useCallback(async n=>{he(!0),Ie(null);try{const S=await j(n);me(S)}catch(S){const le=S instanceof Error?S.message:String(S);Ie(le),me([])}finally{he(!1)}},[j]);o.useEffect(()=>{L?St(xe):Ie(null)},[L,xe,St]);const Ct=n=>{const S=n.categoryId,le=n.subcategoryId,ce=n.itemId,Ce=n.makerId,ke=n.modelId,Ze=n.width!=null?String(n.width):"",Ve=n.depth!=null?String(n.depth):"",Xe=n.height!=null?String(n.height):"",Ye=n.note!=null?String(n.note):"";P(Ze),W(Ve),c(Xe),_(Ye);const Fe=y.find(ee=>ee.id===S),Le=d.find(ee=>ee.id===le),Pe=h.find(ee=>ee.id===ce),ge=x.find(ee=>ee.id===Ce),Te=N.find(ee=>ee.id===ke);C((Fe==null?void 0:Fe.name)??""),k((Le==null?void 0:Le.name)??""),E((Pe==null?void 0:Pe.name)??""),A((ge==null?void 0:ge.name)??""),p((Te==null?void 0:Te.name)??""),t({categoryId:S,subcategoryId:le,itemId:ce,makerId:Ce,modelId:ke,width:Ze,depth:Ve,height:Xe,note:Ye})},Qt=n=>{Ct(n.fields??{}),R(!1)},qe=()=>{be(n=>n==="asc"?"desc":"asc")},Bt=async()=>{await f({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),u("/survey/label")},ct=()=>{t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0}),u("/survey/department")};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"商品登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:F,onChange:n=>C(n.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:$e.map(n=>e.jsx("button",{onClick:()=>rt(n),className:n.id===ie?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:q,onChange:n=>k(n.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:Pt.map(n=>e.jsx("button",{onClick:()=>dt(n),className:n.id===re?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:O,onChange:n=>E(n.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:Tt.map(n=>e.jsx("button",{onClick:()=>lt(n),className:n.id===r?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:U,onChange:n=>A(n.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:Nt.map(n=>e.jsx("button",{onClick:()=>wt(n),className:n.id===H?"active":"",children:n.name},n.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:g,onChange:n=>p(n.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:it.map(n=>e.jsx("button",{onClick:()=>Ut(n),className:n.id===z?"active":"",children:n.name},n.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["W",e.jsx("input",{value:Q,onChange:n=>{const S=n.target.value;P(S),t({width:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:$,onChange:n=>{const S=n.target.value;W(S),t({depth:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:J,onChange:n=>{const S=n.target.value;c(S),t({height:S})},placeholder:"mm"})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:b,onChange:n=>{const S=n.target.value;_(S),t({note:S})},rows:3})]})]}),e.jsx("div",{className:"row",style:{justifyContent:"flex-start",marginTop:8},children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>R(!0),children:"履歴表示"})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>X(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:()=>u("/survey/asset"),children:"戻る"}),e.jsx("button",{className:"secondary",onClick:ct,children:"部門"}),e.jsx("button",{onClick:Bt,children:"次へ"})]}),L&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:qe,children:xe==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>R(!1),children:"閉じる"})]})]}),se&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),fe&&e.jsxs("p",{className:"badge warn",children:["エラー: ",fe]}),!se&&!fe&&V.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!se&&!fe&&V.length>0&&e.jsx("div",{className:"history-list",children:V.map(n=>{var Le,Pe,ge,Te,ee;const S=n.fields??{},le=S.completedAt??n.updatedAt,ce=((Le=y.find(we=>we.id===S.categoryId))==null?void 0:Le.name)??"-",Ce=((Pe=d.find(we=>we.id===S.subcategoryId))==null?void 0:Pe.name)??"-",ke=((ge=h.find(we=>we.id===S.itemId))==null?void 0:ge.name)??"-",Ze=((Te=x.find(we=>we.id===S.makerId))==null?void 0:Te.name)??"-",Ve=((ee=N.find(we=>we.id===S.modelId))==null?void 0:ee.name)??"-",Xe=S.width??"-",Ye=S.depth??"-",Fe=S.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>Qt(n),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(le).toLocaleString()}),S.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",S.assetNo]}),S.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",S.equipmentNo]}),S.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",S.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:ce}),e.jsx("span",{className:"pill",children:Ce}),e.jsx("span",{className:"pill",children:ke}),e.jsx("span",{className:"pill",children:Ze}),e.jsx("span",{className:"pill",children:Ve})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",Xe]}),e.jsxs("span",{children:["D: ",Ye]}),e.jsxs("span",{children:["H: ",Fe]})]})]},n.id)})})]})}),e.jsx(vs,{open:Y,onClose:()=>X(!1)})]})}const ca=Object.freeze(Object.defineProperty({__proto__:null,default:ea},Symbol.toStringTag,{value:"Module"}));function Me(u,a){return a?u.toLowerCase().includes(a.toLowerCase()):!0}function ua(){var Ss,Cs,ks,Es,Ds,_s,Rs,Os,As,Ms,Fs,Ls,Ps,Ts,Us,Qs,Bs,Hs,$s,qs,Ws,zs,Gs,Ks,Zs;jt();const u=bt(),a=He(),{current:t,photos:f,attachPhoto:j,removePhoto:y,setFields:i,completeCurrent:d,listHistory:m,load:h,completedCount:I,duplicateDraft:x,setQR:M,togglePhotoForList:N}=a,[D,F]=o.useState([]),[C,q]=o.useState([]),[k,O]=o.useState([]),[E,U]=o.useState([]),[A,g]=o.useState(""),[p,Q]=o.useState(""),[P,$]=o.useState(""),[W,J]=o.useState(""),[c,b]=o.useState(void 0),[_,L]=o.useState(void 0),[R,Y]=o.useState(void 0),[X,V]=o.useState(void 0),me=o.useMemo(()=>{const s=new Date;return`${s.getFullYear()}年${String(s.getMonth()+1).padStart(2,"0")}月${String(s.getDate()).padStart(2,"0")}日`},[]),se=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{Promise.all([w.location_buildings.toArray(),w.location_floors.toArray(),w.location_departments.toArray(),w.location_divisions.toArray()]).then(([s,l,T,G])=>{F(s),q(l),O(T),U(G)})},[]),o.useEffect(()=>{var l,T;if(!t)return;const s={};(l=t.fields)!=null&&l.surveyDate||(s.surveyDate=me),se&&((T=t.fields)==null?void 0:T.investigator)!==se&&(s.investigator=se),Object.keys(s).length>0&&i(s)},[t,se,i,me]);const he=(Ss=t==null?void 0:t.fields)==null?void 0:Ss.buildingId,fe=(Cs=t==null?void 0:t.fields)==null?void 0:Cs.floorId,Ie=(ks=t==null?void 0:t.fields)==null?void 0:ks.departmentId,xe=(Es=t==null?void 0:t.fields)==null?void 0:Es.divisionId;o.useEffect(()=>{b(he)},[he]),o.useEffect(()=>{L(fe)},[fe]),o.useEffect(()=>{Y(Ie)},[Ie]),o.useEffect(()=>{V(xe)},[xe]);const be=o.useMemo(()=>D.find(s=>s.id===c),[D,c]),v=o.useMemo(()=>C.find(s=>s.id===_),[C,_]),B=o.useMemo(()=>k.find(s=>s.id===R),[k,R]),te=o.useMemo(()=>E.find(s=>s.id===X),[E,X]);o.useEffect(()=>{g((be==null?void 0:be.name)??"")},[be]),o.useEffect(()=>{Q((v==null?void 0:v.name)??"")},[v]),o.useEffect(()=>{$((B==null?void 0:B.name)??"")},[B]),o.useEffect(()=>{J((te==null?void 0:te.name)??"")},[te]),o.useMemo(()=>D.filter(s=>Me(s.name,A)),[D,A]),o.useMemo(()=>C.filter(s=>Me(s.name,p)),[C,p]),o.useMemo(()=>k.filter(s=>Me(s.name,P)),[k,P]),o.useMemo(()=>E.filter(s=>Me(s.name,W)),[E,W]);const je=!!(c&&_&&R&&X),ne=o.useRef(null),[ie,re]=o.useState(""),[r,H]=o.useState(""),[z,K]=o.useState([]),[Z,Ne]=o.useState(!1),[de,pe]=o.useState(""),[$e,Pt]=o.useState(""),[Tt,Nt]=o.useState("single");o.useEffect(()=>{var s,l;re(((s=t==null?void 0:t.fields)==null?void 0:s.sealNo)??""),H(((l=t==null?void 0:t.fields)==null?void 0:l.roomName)??"")},[(Ds=t==null?void 0:t.fields)==null?void 0:Ds.sealNo,(_s=t==null?void 0:t.fields)==null?void 0:_s.roomName]),o.useEffect(()=>()=>{var s;(s=ne.current)==null||s.stop()},[]),o.useEffect(()=>{let s=!0;return w.location_rooms.toArray().then(l=>{s&&K(l)}).catch(()=>{s&&K([])}),()=>{s=!1}},[]);const it=(Rs=t==null?void 0:t.fields)==null?void 0:Rs.buildingId,rt=(Os=t==null?void 0:t.fields)==null?void 0:Os.floorId,dt=(As=t==null?void 0:t.fields)==null?void 0:As.departmentId,lt=(Ms=t==null?void 0:t.fields)==null?void 0:Ms.divisionId,wt=o.useMemo(()=>{if(!it||!rt||!dt||!lt)return[];const s=r.trim().toLowerCase();return z.filter(l=>l.buildingId!==it||l.floorId!==rt||l.departmentId!==dt||l.divisionId!==lt?!1:s?l.name.toLowerCase().includes(s):!0)},[z,it,rt,dt,lt,r]),Ut=s=>{const l=s.trim(),T=l.match(/https?:\/\/[^/]+\/x\/([A-Za-z0-9-]+)$/i),G=l.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i),ae=T&&T[1]||G&&G[0]||l;Tt==="bulkStart"?pe(ae):(re(ae),M(ae))},St=s=>{re(s),i({sealNo:s,qrCode:s})},Ct=s=>{H(s),i({roomName:s})},Qt=o.useMemo(()=>{const s=r.trim().length>0,l=ie.trim().length>0,T=de.trim().length>0,G=Number.parseInt($e,10),ae=Z&&T&&Number.isFinite(G)&&G>0;return s&&(!Z&&l||ae)},[Z,$e,de,r,ie]),qe=o.useRef(null),[Bt,ct]=o.useState(""),[kt,We]=o.useState(""),[Et,ze]=o.useState(""),[Ge,ut]=o.useState(!1),[Ke,mt]=o.useState(!1),[ht,n]=o.useState("assetNo"),[S,le]=o.useState(!1),[ce,Ce]=o.useState(null);o.useEffect(()=>{so()},[]),o.useEffect(()=>{var s,l,T,G,ae;ct(((s=t==null?void 0:t.fields)==null?void 0:s.assetNo)??""),We(((l=t==null?void 0:t.fields)==null?void 0:l.equipmentNo)??""),ze(((T=t==null?void 0:t.fields)==null?void 0:T.purchaseDate)??""),ut(!!((G=t==null?void 0:t.fields)!=null&&G.leaseFlag)),mt(!!((ae=t==null?void 0:t.fields)!=null&&ae.loanedFlag))},[(Fs=t==null?void 0:t.fields)==null?void 0:Fs.assetNo,(Ls=t==null?void 0:t.fields)==null?void 0:Ls.equipmentNo,(Ps=t==null?void 0:t.fields)==null?void 0:Ps.purchaseDate,(Ts=t==null?void 0:t.fields)==null?void 0:Ts.leaseFlag,(Us=t==null?void 0:t.fields)==null?void 0:Us.loanedFlag]),o.useEffect(()=>{var s;if(!((s=t==null?void 0:t.fields)!=null&&s.purchaseDate)){const l=new Date;l.setHours(0,0,0,0);const T=l.toISOString().slice(0,10);ze(T),i({purchaseDate:T})}},[(Qs=t==null?void 0:t.fields)==null?void 0:Qs.purchaseDate,i]);const ke=o.useMemo(()=>f.map(s=>({id:s.id,url:URL.createObjectURL(s.thumb),selectedForList:!!s.selectedForList})),[f]);o.useEffect(()=>()=>{ke.forEach(s=>URL.revokeObjectURL(s.url))},[ke]);const Ze=async s=>{if(!s||s.length===0)return;const l=s[0];await j(l),qe.current&&(qe.current.value="")},Ve=()=>{const s=!Ge;ut(s),i({leaseFlag:s})},Xe=()=>{const s=!Ke;mt(s),i({loanedFlag:s})},Ye=s=>{s&&(ht==="assetNo"?(ct(s),i({assetNo:s})):(We(s),i({equipmentNo:s})))},Fe=s=>{n(s),le(!0)},Le=o.useCallback(s=>{Ce(`${s.targetLabel}を読み取り: ${s.text}`)},[]);o.useEffect(()=>{if(!ce)return;const s=window.setTimeout(()=>Ce(null),5e3);return()=>{window.clearTimeout(s)}},[ce]);const Pe=f.length>0,[ge,Te]=o.useState([]),[ee,we]=o.useState([]),[ft,ao]=o.useState([]),[pt,no]=o.useState([]),[gt,io]=o.useState([]),[Ht,Je]=o.useState(""),[$t,Ue]=o.useState(""),[qt,Se]=o.useState(""),[Wt,ve]=o.useState(""),[zt,ue]=o.useState(""),[ys,Gt]=o.useState(""),[Is,Kt]=o.useState(""),[xs,Zt]=o.useState(""),[bs,Vt]=o.useState(""),[Xt,Yt]=o.useState(!1),[Jt,js]=o.useState([]),[es,Ns]=o.useState(!1),[Dt,ts]=o.useState(null),[ss,ro]=o.useState("asc"),os=o.useRef(void 0),as=o.useRef(void 0),ns=o.useRef(void 0),is=o.useRef(void 0),rs=o.useRef(void 0);o.useEffect(()=>{Promise.all([w.product_categories.toArray(),w.product_subcategories.toArray(),w.product_items.toArray(),w.product_makers.toArray(),w.product_models.toArray()]).then(([s,l,T,G,ae])=>{Te(s),we(l),ao(T),no(G),io(ae)})},[]),o.useEffect(()=>{var s,l,T,G;Gt(((s=t==null?void 0:t.fields)==null?void 0:s.width)??""),Kt(((l=t==null?void 0:t.fields)==null?void 0:l.depth)??""),Zt(((T=t==null?void 0:t.fields)==null?void 0:T.height)??""),Vt(((G=t==null?void 0:t.fields)==null?void 0:G.note)??"")},[(Bs=t==null?void 0:t.fields)==null?void 0:Bs.width,(Hs=t==null?void 0:t.fields)==null?void 0:Hs.depth,($s=t==null?void 0:t.fields)==null?void 0:$s.height,(qs=t==null?void 0:t.fields)==null?void 0:qs.note]);const Qe=(Ws=t==null?void 0:t.fields)==null?void 0:Ws.categoryId,Be=(zs=t==null?void 0:t.fields)==null?void 0:zs.subcategoryId,et=(Gs=t==null?void 0:t.fields)==null?void 0:Gs.itemId,vt=(Ks=t==null?void 0:t.fields)==null?void 0:Ks.makerId,_t=(Zs=t==null?void 0:t.fields)==null?void 0:Zs.modelId,Ee=ge.find(s=>s.id===Qe),De=ee.find(s=>s.id===Be),_e=ft.find(s=>s.id===et),Re=pt.find(s=>s.id===vt),Oe=gt.find(s=>s.id===_t);o.useEffect(()=>{(Ee==null?void 0:Ee.id)!==os.current&&(Ee?Je(Ee.name):os.current&&Je(""),os.current=Ee==null?void 0:Ee.id)},[Ee]),o.useEffect(()=>{(De==null?void 0:De.id)!==as.current&&(De?Ue(De.name):as.current&&Ue(""),as.current=De==null?void 0:De.id)},[De]),o.useEffect(()=>{(_e==null?void 0:_e.id)!==ns.current&&(_e?Se(_e.name):ns.current&&Se(""),ns.current=_e==null?void 0:_e.id)},[_e]),o.useEffect(()=>{(Re==null?void 0:Re.id)!==is.current&&(Re?ve(Re.name):is.current&&ve(""),is.current=Re==null?void 0:Re.id)},[Re]),o.useEffect(()=>{(Oe==null?void 0:Oe.id)!==rs.current&&(Oe?ue(Oe.name):rs.current&&ue(""),rs.current=Oe==null?void 0:Oe.id)},[Oe]);const lo=o.useMemo(()=>ge.filter(s=>Me(s.name,Ht)),[ge,Ht]),co=o.useMemo(()=>ee.filter(s=>Me(s.name,$t)),[ee,$t]),uo=o.useMemo(()=>ft.filter(s=>Me(s.name,qt)),[ft,qt]),mo=o.useMemo(()=>pt.filter(s=>Me(s.name,Wt)),[pt,Wt]),ho=o.useMemo(()=>gt.filter(s=>Me(s.name,zt)),[gt,zt]),fo=s=>{if(Qe===s.id){Je(""),Ue(""),Se(""),ve(""),ue(""),i({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}Je(s.name),Ue(""),Se(""),ve(""),ue(""),i({categoryId:s.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},po=s=>{if(Be===s.id){Ue(""),Se(""),ve(""),ue(""),i({categoryId:Qe??s.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}Ue(s.name),Se(""),ve(""),ue(""),i({categoryId:s.categoryId,subcategoryId:s.id,itemId:void 0,makerId:void 0,modelId:void 0})},go=s=>{if(et===s.id){Se(""),ve(""),ue(""),i({categoryId:Qe??s.categoryId,subcategoryId:Be??s.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}Se(s.name),ve(""),ue(""),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.id,makerId:void 0,modelId:void 0})},vo=s=>{if(vt===s.id){ve(""),ue(""),i({categoryId:Qe??s.categoryId,subcategoryId:Be??s.subcategoryId,itemId:et??s.itemId,makerId:void 0,modelId:void 0});return}ve(s.name),ue(""),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.id,modelId:void 0})},yo=s=>{if(_t===s.id){ue(""),i({categoryId:Qe??s.categoryId,subcategoryId:Be??s.subcategoryId,itemId:et??s.itemId,makerId:vt??s.makerId,modelId:void 0});return}ue(s.name),i({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,modelId:s.id})},ws=o.useCallback(async s=>{Ns(!0),ts(null);try{const l=await m(s);js(l)}catch(l){const T=l instanceof Error?l.message:String(l);ts(T),js([])}finally{Ns(!1)}},[m]);o.useEffect(()=>{Xt?ws(ss):ts(null)},[Xt,ss,ws]);const Io=s=>{const l=s.categoryId,T=s.subcategoryId,G=s.itemId,ae=s.makerId,yt=s.modelId,Rt=s.width!=null?String(s.width):"",Ot=s.depth!=null?String(s.depth):"",At=s.height!=null?String(s.height):"",Mt=s.note!=null?String(s.note):"";Gt(Rt),Kt(Ot),Zt(At),Vt(Mt);const It=ge.find(ye=>ye.id===l),tt=ee.find(ye=>ye.id===T),st=ft.find(ye=>ye.id===G),ot=pt.find(ye=>ye.id===ae),at=gt.find(ye=>ye.id===yt);Je((It==null?void 0:It.name)??""),Ue((tt==null?void 0:tt.name)??""),Se((st==null?void 0:st.name)??""),ve((ot==null?void 0:ot.name)??""),ue((at==null?void 0:at.name)??""),i({categoryId:l,subcategoryId:T,itemId:G,makerId:ae,modelId:yt,width:Rt,depth:Ot,height:At,note:Mt})},xo=s=>{Io(s.fields??{}),Yt(!1)},bo=()=>{ro(s=>s==="asc"?"desc":"asc")},jo=async()=>{if(!Z){await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});return}const s=de.trim(),l=Number.parseInt($e,10);if(!s||!Number.isFinite(l)||l<=0){alert("一括登録モードでは、開始シールNoと1以上の登録個数を入力してください。");return}if(!t)return;const T=t.id;re(s),await M(s),await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});const G=l-1;G>0&&await x(T,G)},No=async()=>{try{const l=(await m("desc"))[0];if(!l)return;await h(l.id)}catch(s){console.error(s)}},wo=!!(Qe&&Be&&et&&vt&&_t)&&!!(ys||Is||xs||bs);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QR読取・基本情報"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["登録モード",e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:s=>Ne(s.target.checked),style:{width:16,height:16}}),e.jsx("span",{children:"一括登録モード"})]})]}),Z?e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:["開始シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:de,onChange:s=>pe(s.target.value),placeholder:"開始シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{Nt("bulkStart"),await us(),await((s=ne.current)==null?void 0:s.start())}catch(l){const T=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${T}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["登録個数",e.jsx("input",{type:"number",min:1,value:$e,onChange:s=>Pt(s.target.value),placeholder:"個数を入力（例：椅子50脚の場合は「50」と入力）"})]})]}):e.jsxs("label",{children:["シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:ie,onChange:s=>St(s.target.value),placeholder:"シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{Nt("single"),await us(),await((s=ne.current)==null?void 0:s.start())}catch(l){const T=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${T}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:r,onChange:s=>Ct(s.target.value),placeholder:"室名を入力"}),wt.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:wt.map(s=>e.jsx("button",{type:"button",onClick:()=>Ct(s.name),children:s.name},s.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:ne,onResult:Ut})})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"写真撮影・資産番号"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:qe,style:{display:"none"},onChange:s=>Ze(s.target.files)}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Bt,onChange:s=>{const l=s.target.value;ct(l),i({assetNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Fe("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:kt,onChange:s=>{const l=s.target.value;We(l),i({equipmentNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Fe("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:Et,onChange:s=>{const l=s.target.value;ze(l),i({purchaseDate:l})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:Ge?"secondary":"ghost",onClick:Ve,children:["リース: ",Ge?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:Ke?"secondary":"ghost",onClick:Xe,children:["貸出品: ",Ke?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:ke.length===0?e.jsx("div",{className:"photo-strip-empty",children:"撮影した写真がここに表示されます"}):ke.map(s=>e.jsxs("button",{type:"button",className:`photo-item${s.selectedForList?" is-selected":""}`,onClick:()=>{N(s.id)},children:[e.jsx("span",{className:"visually-hidden",children:"一覧表示用の写真として選択"}),e.jsx("button",{type:"button",className:"photo-remove",onClick:l=>{l.stopPropagation(),y(s.id)},"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:s.url,alt:"サムネイル"})]},s.id))}),ce&&e.jsx("div",{className:"ocr-result-banner",children:ce})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"資産情報登録"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:Ht,onChange:s=>Je(s.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:lo.map(s=>e.jsx("button",{onClick:()=>fo(s),className:s.id===Qe?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:$t,onChange:s=>Ue(s.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:co.map(s=>e.jsx("button",{onClick:()=>po(s),className:s.id===Be?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:qt,onChange:s=>Se(s.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:uo.map(s=>e.jsx("button",{onClick:()=>go(s),className:s.id===et?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:Wt,onChange:s=>ve(s.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:mo.map(s=>e.jsx("button",{onClick:()=>vo(s),className:s.id===vt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:zt,onChange:s=>ue(s.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:ho.map(s=>e.jsx("button",{onClick:()=>yo(s),className:s.id===_t?"active":"",children:s.name},s.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("div",{className:"asset-size-row",children:[e.jsxs("label",{children:["W",e.jsx("input",{value:ys,onChange:s=>{const l=s.target.value;Gt(l),i({width:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:Is,onChange:s=>{const l=s.target.value;Kt(l),i({depth:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:xs,onChange:s=>{const l=s.target.value;Zt(l),i({height:l})},placeholder:"mm"})]})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:bs,onChange:s=>{const l=s.target.value;Vt(l),i({note:l})},rows:3})]})]})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>u("/survey/home"),children:"ホーム"}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>u("/survey/department"),children:["部門",e.jsx("br",{}),"入力へ"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>Yt(!0),children:["履歴",e.jsx("br",{}),"表示"]}),e.jsxs("button",{type:"button",className:"secondary",onClick:()=>{var s;return(s=qe.current)==null?void 0:s.click()},children:["写真",e.jsx("br",{}),"撮影"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:No,disabled:I===0,children:["前の商品に",e.jsx("br",{}),"戻る"]}),e.jsxs("button",{type:"button",onClick:jo,disabled:!(je&&Qt&&Pe&&wo),children:["商品",e.jsx("br",{}),"登録"]})]}),e.jsx(oo,{open:S,targetLabel:ht==="assetNo"?"資産番号":"備品番号",onClose:()=>le(!1),onResult:Ye,onRecognized:Le}),Xt&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:bo,children:ss==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>Yt(!1),children:"閉じる"})]})]}),es&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),Dt&&e.jsxs("p",{className:"badge warn",children:["エラー: ",Dt]}),!es&&!Dt&&Jt.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!es&&!Dt&&Jt.length>0&&e.jsx("div",{className:"history-list",children:Jt.map(s=>{var tt,st,ot,at,ye;const l=s.fields??{},T=l.completedAt??s.updatedAt,G=((tt=ge.find(Ae=>Ae.id===l.categoryId))==null?void 0:tt.name)??"-",ae=((st=ee.find(Ae=>Ae.id===l.subcategoryId))==null?void 0:st.name)??"-",yt=((ot=ft.find(Ae=>Ae.id===l.itemId))==null?void 0:ot.name)??"-",Rt=((at=pt.find(Ae=>Ae.id===l.makerId))==null?void 0:at.name)??"-",Ot=((ye=gt.find(Ae=>Ae.id===l.modelId))==null?void 0:ye.name)??"-",At=l.width??"-",Mt=l.depth??"-",It=l.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>xo(s),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(T).toLocaleString()}),l.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",l.assetNo]}),l.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",l.equipmentNo]}),l.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",l.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:G}),e.jsx("span",{className:"pill",children:ae}),e.jsx("span",{className:"pill",children:yt}),e.jsx("span",{className:"pill",children:Rt}),e.jsx("span",{className:"pill",children:Ot})]}),e.jsx("div",{className:"history-meta",children:e.jsxs("span",{children:["W:",At," / D:",Mt," / H:",It]})})]},s.id)})})]})})]})}export{Jo as A,Zo as D,Vo as L,ea as P,ua as S,na as a,ia as b,da as c,w as d,us as e,la as f,ca as g,so as p,ra as q,He as u,Wo as w};
