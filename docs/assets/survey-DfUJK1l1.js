var Co=Object.defineProperty;var ko=(c,a,t)=>a in c?Co(c,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[a]=t;var oe=(c,a,t)=>ko(c,typeof a!="symbol"?a+"":a,t);import{i as Vs,c as Eo,r as o,s as eo,u as wt,j as e}from"./vendor-5jQwBCrV.js";import{D as Do}from"./vendor-dexie-DWlydIdn.js";import{B as ds}from"./vendor-zxing-DcYOnkv9.js";class _o extends Do{constructor(){super("meddx_survey");oe(this,"survey_drafts");oe(this,"survey_photos");oe(this,"survey_masters");oe(this,"indices");oe(this,"settings");oe(this,"location_buildings");oe(this,"location_floors");oe(this,"location_departments");oe(this,"location_divisions");oe(this,"product_categories");oe(this,"product_subcategories");oe(this,"product_items");oe(this,"product_makers");oe(this,"product_models");oe(this,"location_rooms");this.version(1).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key"}),this.version(2).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name"}),this.version(3).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name",location_rooms:"id,buildingId,floorId,departmentId,divisionId,name"})}}const j=new _o,Ro="/poc-survey-offline-mock/".replace(/\/?$/,"/"),Xs=`${Ro}vendor/browser-image-compression.js`;async function Oo(c,a=2560){const h=await Vs(c,{maxWidthOrHeight:a,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Xs}),b=await Vs(c,{maxWidthOrHeight:512,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Xs});return{blob:h,thumb:b}}const Ye=Eo((c,a)=>{const t=async()=>{const n=a().current;if(!n){c({photos:[]});return}const d=await j.survey_photos.where("draftId").equals(n.id).reverse().toArray();c({photos:d})},h=async()=>{const n=await j.survey_drafts.filter(d=>{var u;return((u=d.fields)==null?void 0:u.status)==="completed"}).count();c({completedCount:n})},b=async n=>{await j.survey_drafts.put(n),c({current:n}),await h()},I={current:void 0,photos:[],completedCount:0,async newDraft(){const n=crypto.randomUUID(),d={id:n,fields:{},photoIds:[],updatedAt:Date.now()};return await j.survey_drafts.put(d),c({current:d}),setTimeout(()=>{t()},0),await h(),n},async load(n){let d=await j.survey_drafts.get(n);d||(d={id:n,fields:{},photoIds:[],updatedAt:Date.now()},await j.survey_drafts.put(d)),c({current:d}),await t(),await h()},async setField(n,d){const u=a().current;if(!u)return;const m={...u.fields};d==null||d===""?delete m[n]:m[n]=d;const y={...u,fields:m,updatedAt:Date.now()};await b(y)},async setFields(n){const d=a().current;if(!d)return;const u={...d.fields};Object.entries(n).forEach(([y,E])=>{E==null||E===""?delete u[y]:u[y]=E});const m={...d,fields:u,updatedAt:Date.now()};await b(m)},async setQR(n){const d=a().current;if(!d)return;const u={...d,qr:n,fields:{...d.fields,sealNo:n,qrCode:n},updatedAt:Date.now()};await b(u)},async attachPhoto(n){const d=a().current;if(!d)return;const{blob:u,thumb:m}=await Oo(n),y=await j.survey_photos.where("draftId").equals(d.id).count(),E={id:crypto.randomUUID(),draftId:d.id,blob:u,thumb:m,size:u.size,createdAt:Date.now(),selectedForList:y===0};await j.survey_photos.put(E);const N={...d,photoIds:[...d.photoIds,E.id],updatedAt:Date.now()};await b(N),await t()},async togglePhotoForList(n){const d=a().current;if(!d)return;const u=await j.survey_photos.get(n),m=!(u!=null&&u.selectedForList);await j.survey_photos.where("draftId").equals(d.id).modify(y=>{y.selectedForList=m&&y.id===n}),await t()},async removePhoto(n){const d=a().current;if(!d)return;await j.survey_photos.delete(n);const u=d.photoIds.filter(y=>y!==n),m={...d,photoIds:u,updatedAt:Date.now()};await b(m),await t()},async refreshPhotos(){await t()},async refreshStats(){await h()},async completeCurrent(n){const d=a().current;if(!d)return;const u={...d,fields:{...d.fields,status:"completed",completedAt:Date.now()},updatedAt:Date.now()};await b(u),await t();const m=await a().newDraft();await t();const y=(n==null?void 0:n.preserveKeys)??[];if(y.length>0){const E={};y.forEach(N=>{var _;((_=d.fields)==null?void 0:_[N])!==void 0&&(E[N]=d.fields[N])}),Object.keys(E).length>0&&await a().setFields(E)}return m},async clearCurrent(){const n=a().current;n&&(await j.survey_photos.where("draftId").equals(n.id).delete(),await j.survey_drafts.delete(n.id),c({current:void 0,photos:[]}),await h())},async listHistory(n="asc"){const d=j.survey_drafts.orderBy("updatedAt");return(n==="desc"?await d.reverse().toArray():await d.toArray()).filter(m=>{var y;return((y=m.fields)==null?void 0:y.status)==="completed"})},async purgeCompleted(){const n=await j.survey_drafts.filter(u=>{var m;return((m=u.fields)==null?void 0:m.status)==="completed"}).toArray();if(n.length===0)return 0;await j.transaction("rw",j.survey_drafts,j.survey_photos,async()=>{for(const u of n)await j.survey_photos.where("draftId").equals(u.id).delete(),await j.survey_drafts.delete(u.id)});const d=a().current;return d&&n.some(u=>u.id===d.id)&&c({current:void 0,photos:[]}),await h(),await t(),n.length},async duplicateDraft(n,d){if(d<=0)return 0;const u=await j.survey_drafts.get(n);if(!u)throw new Error("複製元の履歴が見つかりません");const m={...u.fields??{}},y=m.sealNo||m.qr||m.qrCode||u.qr;if(!y)throw new Error("複製元のQRコードが取得できませんでした");const E=y.match(/(\d+)(?!.*\d)/),N=E?E.index??-1:-1,_=E?parseInt(E[1],10):null,S=E?E[1].length:0,Q=N>=0?y.slice(0,N):y,R=N>=0?y.slice(N+S):"",q=await j.survey_photos.where("draftId").equals(n).toArray(),C=[],D=[],O=Date.now(),T=v=>{if(_!==null){const p=_+v,L=String(p).padStart(S,"0");return`${Q}${L}${R}`}return`${y}-${v}`};for(let v=1;v<=d;v++){const p=crypto.randomUUID(),L=T(v),M=[],x={...m,qr:L,qrCode:L,sealNo:L,status:"completed",completedAt:O+v};q.forEach(k=>{const $=crypto.randomUUID();M.push($),D.push({...k,id:$,draftId:p,createdAt:O+v})}),C.push({id:p,fields:x,photoIds:M,updatedAt:O+v})}await j.transaction("rw",j.survey_drafts,j.survey_photos,async()=>{D.length>0&&await j.survey_photos.bulkPut(D),C.length>0&&await j.survey_drafts.bulkPut(C)}),await h();const A=a().current;if(A){const v=await j.survey_drafts.get(A.id);v&&c({current:v})}return C.length}};return h(),I});function St(){const{current:c,newDraft:a}=Ye();o.useEffect(()=>{c||a()},[c,a])}const Ao="この端末ではカメラが利用できません",Mo="ブラウザ環境ではありません",Fo="カメラの利用には HTTPS での接続が必要です";function Po(){if(typeof navigator>"u")return null;const c=navigator.mediaDevices;if(c!=null&&c.getUserMedia)return t=>c.getUserMedia(t);const a=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a?t=>new Promise((h,b)=>{a.call(navigator,t,h,b)}):null}async function us(){if(typeof navigator>"u")throw new Error(Mo);if(typeof window<"u"&&"isSecureContext"in window&&!window.isSecureContext)throw new Error(Fo);const c=Po();if(!c)throw new Error(Ao);if(sessionStorage.getItem("cameraPermission")==="granted")return"granted";try{return(await c({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1})).getTracks().forEach(h=>h.stop()),sessionStorage.setItem("cameraPermission","granted"),"granted"}catch(t){const h=t;throw(h==null?void 0:h.name)==="NotAllowedError"||(h==null?void 0:h.name)==="SecurityError"?sessionStorage.setItem("cameraPermission","denied"):sessionStorage.removeItem("cameraPermission"),t instanceof Error?t:new Error(String(t))}}const ls={},Lo="/poc-survey-offline-mock/".replace(/\/?$/,"/"),ms=c=>`${Lo}tesseract/${c.replace(/^\//,"")}`;var Js;const To=(Js=ls==null?void 0:ls.VITE_TESSDATA_URL)==null?void 0:Js.trim(),Qo=ms("lang-data/"),to=(To??Qo).replace(/\/?$/,"/");let mt=null,hs=!1;const Uo=6e4;function Bo(c,a,t){return new Promise((h,b)=>{const I=setTimeout(()=>{try{t==null||t()}catch{}b(new Error("OCR処理がタイムアウトしました"))},a);c.then(n=>{clearTimeout(I),h(n)},n=>{clearTimeout(I),b(n)})})}function $o(c){return c.replace(/[\uFF01-\uFF5E]/g,a=>String.fromCharCode(a.charCodeAt(0)-65248)).replace(/\u3000/g," ")}function Ho(c){return $o(c).toUpperCase().replace(/[\u2010-\u2015\u2212\u30FC\uFF0D\uFE63]/g,"-").replace(/[^0-9A-Z-]/g,"")}const fs=()=>{mt=null,hs=!1};async function qo(){return eo.createWorker("eng",void 0,{workerPath:ms("worker.min.js"),corePath:ms("tesseract-core.wasm.js"),langPath:to,workerBlobURL:!1})}async function ps(){mt||(mt=Bo(qo(),Uo,fs));try{const c=await mt;return hs||(await c.setParameters({tessedit_char_whitelist:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-",tessedit_pageseg_mode:eo.PSM.SINGLE_LINE}),hs=!0),c}catch(c){throw fs(),c instanceof Error?c:new Error("Tesseract workerの初期化に失敗しました")}}function so(){ps().catch(()=>{})}const Wo=["tesseract/lang-data/eng.traineddata.gz","tesseract/worker.min.js","tesseract/tesseract-core.wasm","tesseract/tesseract-core.wasm.js"];async function zo(){const c="/poc-survey-offline-mock/".replace(/\/?$/,"/");await Promise.all(Wo.map(async a=>{try{await fetch(`${c}${a}`,{cache:"force-cache"})}catch{}}))}async function na(){await zo(),await ps()}async function Go(c){const a=await ps(),{data:t}=await a.recognize(c).catch(async u=>{throw await Ko(),u}),h=Array.isArray(t.lines)?t.lines:[],b=h.map(u=>{var m,y;return((y=(m=u.text)==null?void 0:m.trim)==null?void 0:y.call(m))??""}).filter(Boolean),I=h.reduce((u,m)=>!u||m.confidence>u.confidence?{text:m.text,confidence:m.confidence}:u,null),n=Ho((I==null?void 0:I.text)??t.text??""),d=(I==null?void 0:I.confidence)??t.confidence??0;return{text:n,rawText:t.text??"",candidates:b.length>0?b:(t.text??"").split(/\n+/).map(u=>u.trim()).filter(Boolean),confidence:d,method:"tesseract"}}async function Ko(){if(!mt)return;await(await mt).terminate(),fs()}async function Zo(c){let a=null;try{return await Go(c)}catch(t){a=t instanceof Error?t:new Error(String(t))}if(a){const t=a.message;throw to.startsWith("http")?typeof navigator<"u"&&!navigator.onLine?new Error("OCR辞書データが未取得です。オンライン接続時に一度読み取りを実行し、キャッシュを作成してください。"):new Error(`OCR辞書データのダウンロードに失敗しました: ${t}`):new Error(`OCR辞書データの読み込みに失敗しました。詳細: ${t}`)}throw new Error("OCR処理に失敗しました。")}function Mt(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function Vo(){var U,J,be,ie,ee,se;St();const c=wt(),{current:a,setFields:t}=Ye(),[h,b]=o.useState([]),[I,n]=o.useState([]),[d,u]=o.useState([]),[m,y]=o.useState([]),[E,N]=o.useState(""),[_,S]=o.useState(""),[Q,R]=o.useState(""),[q,C]=o.useState(""),[D,O]=o.useState(void 0),[T,A]=o.useState(void 0),[v,p]=o.useState(void 0),[L,M]=o.useState(void 0),x=o.useMemo(()=>{const r=new Date;return`${r.getFullYear()}年${String(r.getMonth()+1).padStart(2,"0")}月${String(r.getDate()).padStart(2,"0")}日`},[]),k=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{sessionStorage.setItem("visitedDepartment","1")},[]),o.useEffect(()=>{Promise.all([j.location_buildings.toArray(),j.location_floors.toArray(),j.location_departments.toArray(),j.location_divisions.toArray()]).then(([r,B,z,K])=>{b(r),n(B),u(z),y(K)})},[]),o.useEffect(()=>{var B,z;if(!a)return;const r={};(B=a.fields)!=null&&B.surveyDate||(r.surveyDate=x),k&&((z=a.fields)==null?void 0:z.investigator)!==k&&(r.investigator=k),Object.keys(r).length>0&&t(r)},[a,k,t,x]);const $=(U=a==null?void 0:a.fields)==null?void 0:U.buildingId,f=(J=a==null?void 0:a.fields)==null?void 0:J.floorId,F=(be=a==null?void 0:a.fields)==null?void 0:be.departmentId,W=(ie=a==null?void 0:a.fields)==null?void 0:ie.divisionId;o.useEffect(()=>{O($)},[$]),o.useEffect(()=>{A(f)},[f]),o.useEffect(()=>{p(F)},[F]),o.useEffect(()=>{M(W)},[W]);const V=o.useMemo(()=>h.find(r=>r.id===D),[h,D]),H=o.useMemo(()=>I.find(r=>r.id===T),[I,T]),me=o.useMemo(()=>d.find(r=>r.id===v),[d,v]),te=o.useMemo(()=>m.find(r=>r.id===L),[m,L]);o.useEffect(()=>{N(V?V.name:"")},[V]),o.useEffect(()=>{S(H?H.name:"")},[H]),o.useEffect(()=>{R(me?me.name:"")},[me]),o.useEffect(()=>{C(te?te.name:"")},[te]);const de=o.useMemo(()=>h.filter(r=>Mt(r.name,E)),[h,E]),we=o.useMemo(()=>I.filter(r=>D&&r.buildingId!==D?!1:Mt(r.name,_)),[I,_,D]),le=o.useMemo(()=>d.filter(r=>D&&r.buildingId!==D||T&&r.floorId!==T?!1:Mt(r.name,Q)),[d,Q,D,T]),Se=o.useMemo(()=>m.filter(r=>D&&r.buildingId!==D||T&&r.floorId!==T||v&&r.departmentId!==v?!1:Mt(r.name,q)),[m,q,D,T,v]),he=r=>{if(!r||D===r.id){N(""),S(""),R(""),C(""),O(void 0),A(void 0),p(void 0),M(void 0),t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0});return}N(r.name),S(""),R(""),C(""),O(r.id),A(void 0),p(void 0),M(void 0),t({buildingId:r.id,floorId:void 0,departmentId:void 0,divisionId:void 0})},ye=r=>{if(!r||T===r.id){S(""),R(""),C(""),A(void 0),p(void 0),M(void 0),t({buildingId:D,floorId:void 0,departmentId:void 0,divisionId:void 0});return}const B=h.find(z=>z.id===r.buildingId);B&&(N(B.name),O(B.id)),S(r.name),R(""),C(""),A(r.id),p(void 0),M(void 0),t({buildingId:r.buildingId,floorId:r.id,departmentId:void 0,divisionId:void 0})},Ie=r=>{if(!r||v===r.id){R(""),C(""),p(void 0),M(void 0),t({buildingId:D,floorId:T,departmentId:void 0,divisionId:void 0});return}const B=h.find(K=>K.id===r.buildingId),z=I.find(K=>K.id===r.floorId);B&&(N(B.name),O(B.id)),z&&(S(z.name),A(z.id)),R(r.name),C(""),p(r.id),M(void 0),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.id,divisionId:void 0})},xe=r=>{if(!r||L===r.id){C(""),M(void 0),t({buildingId:D,floorId:T,departmentId:v,divisionId:void 0});return}const B=h.find(Z=>Z.id===r.buildingId),z=I.find(Z=>Z.id===r.floorId),K=d.find(Z=>Z.id===r.departmentId);B&&(N(B.name),O(B.id)),z&&(S(z.name),A(z.id)),K&&(R(K.name),p(K.id)),C(r.name),M(r.id),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.departmentId,divisionId:r.id})},g=!!(D&&T&&v&&L);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"部署入力"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["調査日",e.jsx("input",{value:((ee=a==null?void 0:a.fields)==null?void 0:ee.surveyDate)??x,disabled:!0})]}),e.jsxs("label",{children:["調査担当",e.jsx("input",{value:((se=a==null?void 0:a.fields)==null?void 0:se.investigator)??k,disabled:!0})]})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["棟",e.jsx("input",{value:E,onChange:r=>N(r.target.value),placeholder:"棟を検索"})]}),e.jsx("div",{className:"option-list",children:de.map(r=>e.jsx("button",{onClick:()=>he(r),className:r.id===D?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["階",e.jsx("input",{value:_,onChange:r=>S(r.target.value),placeholder:"階を検索"})]}),e.jsx("div",{className:"option-list",children:we.map(r=>{var B;return e.jsxs("button",{onClick:()=>ye(r),className:r.id===T?"active":"",children:[r.name,"（",((B=h.find(z=>z.id===r.buildingId))==null?void 0:B.name)??"","）"]},r.id)})}),e.jsxs("label",{children:["部署",e.jsx("input",{value:Q,onChange:r=>R(r.target.value),placeholder:"部署を検索"})]}),e.jsx("div",{className:"option-list",children:le.map(r=>e.jsx("button",{onClick:()=>Ie(r),className:r.id===v?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["部門",e.jsx("input",{value:q,onChange:r=>C(r.target.value),placeholder:"部門を検索"})]}),e.jsx("div",{className:"option-list",children:Se.map(r=>e.jsx("button",{onClick:()=>xe(r),className:r.id===L?"active":"",children:r.name},r.id))})]}),e.jsx("p",{className:"helper-text",children:"今日一日がんばって！！"})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>c("/home"),children:"ホーム"}),e.jsx("button",{onClick:()=>c("/survey/all"),disabled:!g,children:"次へ"})]})]})}const ra=Object.freeze(Object.defineProperty({__proto__:null,default:Vo},Symbol.toStringTag,{value:"Module"})),gs=o.forwardRef(({onResult:c},a)=>{const t=o.useRef(null),h=o.useRef(null),b=o.useRef(null),[I,n]=o.useState(!1);o.useEffect(()=>(h.current=new ds,()=>{var m;(m=b.current)==null||m.stop(),b.current=null,ds.releaseAllStreams(),h.current=null,n(!1)}),[]);const d=o.useCallback(()=>{var m;(m=b.current)==null||m.stop(),b.current=null,ds.releaseAllStreams(),n(!1)},[]),u=o.useCallback(async()=>{if(!(!t.current||!h.current)&&!I){n(!0);try{b.current=await h.current.decodeFromConstraints({video:{facingMode:"environment"}},t.current,m=>{m&&(c(m.getText()),d())})}catch(m){console.error(m),n(!1),b.current=null}}},[c,I,d]);return o.useImperativeHandle(a,()=>({start:u,stop:d}),[u,d]),e.jsxs("div",{className:"qr-container",style:{display:I?"block":"none"},children:[e.jsx("video",{ref:t,className:"qr-video",muted:!0,playsInline:!0}),I&&e.jsx("div",{className:"helper-text",style:{marginTop:8},children:"読み取り中です..."})]})}),da=Object.freeze(Object.defineProperty({__proto__:null,QRScanner:gs},Symbol.toStringTag,{value:"Module"}));function vs({open:c,onClose:a}){const{listHistory:t,duplicateDraft:h}=Ye(),[b,I]=o.useState("asc"),[n,d]=o.useState(!1),[u,m]=o.useState(null),[y,E]=o.useState([]),[N,_]=o.useState(null),[S,Q]=o.useState({}),[R,q]=o.useState(null),C=async v=>{d(!0),m(null);try{const p=await t(v);E(p)}catch(p){const L=p instanceof Error?p.message:String(p);m(L),E([])}finally{d(!1)}};o.useEffect(()=>{c?(_(null),Q({}),q(null),C(b)):(m(null),E([]))},[c,b]);const D=()=>{I(v=>v==="asc"?"desc":"asc")},O=(v,p)=>{Q(L=>({...L,[v]:p}))},T=async v=>{const p=S[v]??"1",L=Number.parseInt(p,10);if(!Number.isFinite(L)||L<=0){_("複製数は1以上の整数を入力してください");return}q(v),_(null);try{const M=await h(v,L);_(`履歴を ${M} 件複製しました`),Q(x=>({...x,[v]:""})),await C(b)}catch(M){const x=M instanceof Error?M.message:String(M);_(`複製に失敗しました: ${x}`)}finally{q(null)}},A=o.useMemo(()=>n?e.jsx("p",{className:"helper-text",children:"読み込み中..."}):u?e.jsxs("p",{className:"badge warn",children:["エラー: ",u]}):y.length===0?e.jsx("p",{className:"helper-text",children:"複製可能な履歴がありません。"}):y.map(v=>{const p=v.fields??{},L=p.completedAt??v.updatedAt,M=p.sealNo??p.qr??v.qr??"-",x=p.assetNo??"-",k=p.equipmentNo??"-",$=p.width??"-",f=p.depth??"-",F=p.height??"-",W=p.note??"",V=S[v.id]??"";return e.jsxs("div",{className:"history-row static",children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(L).toLocaleString()}),e.jsxs("span",{className:"pill",children:["QR ",M]}),x!=="-"&&e.jsxs("span",{className:"pill",children:["資産 ",x]}),k!=="-"&&e.jsxs("span",{className:"pill",children:["備品 ",k]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsxs("span",{className:"pill",children:["Category ",p.categoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Sub ",p.subcategoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Item ",p.itemId??"-"]}),e.jsxs("span",{className:"pill",children:["Maker ",p.makerId??"-"]}),e.jsxs("span",{className:"pill",children:["Model ",p.modelId??"-"]})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",$]}),e.jsxs("span",{children:["D: ",f]}),e.jsxs("span",{children:["H: ",F]}),W&&e.jsxs("span",{children:["備考: ",W]})]}),e.jsxs("div",{className:"history-duplicate",children:[e.jsx("input",{type:"number",min:1,placeholder:"複製数",value:V,onChange:H=>O(v.id,H.target.value)}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>T(v.id),disabled:R===v.id,children:R===v.id?"複製中...":"複製"})]})]},v.id)}),[y,S,n,u,R]);return c?e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"複製"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:D,children:b==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:a,children:"閉じる"})]})]}),N&&e.jsx("p",{className:"badge success",style:{marginTop:8},children:N}),e.jsx("div",{className:"history-list",children:A})]})}):null}function Xo(){var p,L,M,x,k,$;St();const c=wt(),a=o.useRef(null),{current:t,setFields:h,setQR:b}=Ye(),[I,n]=o.useState(""),[d,u]=o.useState(""),[m,y]=o.useState([]),[E,N]=o.useState(!1);o.useEffect(()=>{var f,F;n(((f=t==null?void 0:t.fields)==null?void 0:f.sealNo)??""),u(((F=t==null?void 0:t.fields)==null?void 0:F.roomName)??"")},[(p=t==null?void 0:t.fields)==null?void 0:p.sealNo,(L=t==null?void 0:t.fields)==null?void 0:L.roomName]),o.useEffect(()=>()=>{var f;(f=a.current)==null||f.stop()},[]),o.useEffect(()=>{let f=!0;return j.location_rooms.toArray().then(F=>{f&&y(F)}).catch(()=>{f&&y([])}),()=>{f=!1}},[]);const _=(M=t==null?void 0:t.fields)==null?void 0:M.buildingId,S=(x=t==null?void 0:t.fields)==null?void 0:x.floorId,Q=(k=t==null?void 0:t.fields)==null?void 0:k.departmentId,R=($=t==null?void 0:t.fields)==null?void 0:$.divisionId,q=o.useMemo(()=>{if(!_||!S||!Q||!R)return[];const f=d.trim().toLowerCase();return m.filter(F=>F.buildingId!==_||F.floorId!==S||F.departmentId!==Q||F.divisionId!==R?!1:f?F.name.toLowerCase().includes(f):!0)},[m,_,S,Q,R,d]),C=f=>{const F=f.trim(),W=F.match(/medical-record\/([A-Za-z0-9-]+)$/i),V=W?W[1]:F;n(V),b(V)},D=f=>{n(f),h({sealNo:f,qrCode:f})},O=f=>{u(f),h({roomName:f})},T=()=>{var f;(f=a.current)==null||f.stop(),c("/survey/department")},A=()=>{var f;(f=a.current)==null||f.stop(),c("/survey/asset")},v=!!(I.trim()&&d.trim());return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QRコード読取・ラベルNo確認"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:I,onChange:f=>D(f.target.value),placeholder:"シールNoを入力"})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:d,onChange:f=>O(f.target.value),placeholder:"室名を入力"}),q.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:q.map(f=>e.jsx("button",{type:"button",onClick:()=>O(f.name),children:f.name},f.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:a,onResult:C})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>N(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:T,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:async()=>{var f;try{await us(),await((f=a.current)==null?void 0:f.start())}catch(F){const W=F instanceof Error?F.message:String(F);alert(`カメラを利用できませんでした: ${W}`)}},children:"QR撮影"}),e.jsx("button",{onClick:A,disabled:!v,children:"次へ"})]}),e.jsx(vs,{open:E,onClose:()=>N(!1)})]})}const la=Object.freeze(Object.defineProperty({__proto__:null,default:Xo},Symbol.toStringTag,{value:"Module"})),Ft={left:.08,top:.425,width:.84,height:.15},Ys=1200,Yo=2e3;function cs(c,a){const t=c.split(","),h=t[0].match(/:(.*?);/),b=(h==null?void 0:h[1])??a,I=atob(t[1]??""),n=I.length,d=new Uint8Array(n);for(let u=0;u<n;u+=1)d[u]=I.charCodeAt(u);return new Blob([d],{type:b})}async function Jo(c,a,t){return typeof c.toBlob=="function"?await new Promise((h,b)=>{let I=!1;const n=window.setTimeout(()=>{if(!I){I=!0;try{const d=cs(c.toDataURL(a,t),a);h(d)}catch(d){b(d instanceof Error?d:new Error("スナップショットの生成に失敗しました"))}}},Yo);c.toBlob(d=>{if(!I)if(I=!0,window.clearTimeout(n),d)h(d);else try{const u=cs(c.toDataURL(a,t),a);h(u)}catch(u){b(u instanceof Error?u:new Error("スナップショットの生成に失敗しました"))}},a,t)}):cs(c.toDataURL(a,t),a)}function oo({open:c,targetLabel:a,onClose:t,onResult:h,onRecognized:b}){const I=o.useRef(null),n=o.useRef(null),d=o.useRef(),u=o.useRef(),[m,y]=o.useState("idle"),[E,N]=o.useState("カメラを初期化しています…"),[_,S]=o.useState(!1),[Q,R]=o.useState(null),[q,C]=o.useState(null);o.useEffect(()=>{d.current=document.createElement("canvas"),u.current=document.createElement("canvas")},[]);const D=o.useCallback(()=>{R(null),C(x=>(x&&URL.revokeObjectURL(x),null))},[]),O=()=>{n.current&&(n.current.getTracks().forEach(x=>x.stop()),n.current=null),I.current&&(I.current.pause(),I.current.srcObject=null)},T=o.useCallback(async()=>{var x;if(D(),!((x=navigator.mediaDevices)!=null&&x.getUserMedia)){y("error"),N("この端末ではカメラを利用できません。手入力してください。"),S(!1);return}y("camera"),N("カメラを起動しています…");try{const k=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});n.current=k,I.current&&(I.current.srcObject=k,await I.current.play().catch(()=>{})),y("camera"),N("枠が黒い帯に変わりました。番号を合わせて撮影してください。"),S(!1)}catch(k){const $=k instanceof Error?k.message:String(k);y("error"),N(`カメラにアクセスできません: ${$}`),S(!1)}},[D]);o.useEffect(()=>{if(!c){O(),D(),y("idle"),N("カメラを初期化しています…"),S(!1);return}return T(),()=>{O()}},[c,T]);const A=async(x,k,$)=>{const f=d.current,F=u.current;if(!f||!F||x===0||k===0)throw new Error("画像データを読み込めませんでした。");f.width=x,f.height=k;const W=f.getContext("2d");if(!W)throw new Error("画像の処理に失敗しました。");$(W);const V=F.getContext("2d");if(!V)throw new Error("画像の処理に失敗しました。");const H={x:Math.floor(f.width*Ft.left),y:Math.floor(f.height*Ft.top),width:Math.floor(f.width*Ft.width),height:Math.floor(f.height*Ft.height)},me=H.width>Ys?Ys/H.width:1,te=Math.max(320,Math.round(H.width*me)),de=Math.max(120,Math.round(H.height*me));return F.width=te,F.height=de,V.filter="contrast(160%) brightness(115%) grayscale(15%)",V.drawImage(f,H.x,H.y,H.width,H.height,0,0,te,de),Jo(F,"image/jpeg",.92)},v=async()=>{if(!c||_||m!=="camera")return;const x=I.current;if(!x||x.videoWidth===0||x.videoHeight===0){y("error"),N("カメラ映像を取得できませんでした。");return}S(!0),N("撮影中…");try{const k=await A(x.videoWidth,x.videoHeight,f=>{f.drawImage(x,0,0,x.videoWidth,x.videoHeight)});O(),D();const $=URL.createObjectURL(k);R(k),C($),y("photo"),N("写真を保存しました。読み取りボタンを押してください。"),S(!1)}catch(k){const $=k instanceof Error?k.message:String(k);y("error"),N(`撮影に失敗しました: ${$}`),S(!1)}},p=async()=>{if(!(!Q||_)){y("processing"),S(!0),N("読み取り中です。1秒ほどお待ちください…");try{const x=await Zo(Q);x.text?(h(x.text),N(`認識した値: ${x.text}`),b==null||b({text:x.text,method:x.method,targetLabel:a}),t()):(y("error"),N("文字を検出できませんでした。撮り直して再試行してください。"),S(!1))}catch(x){const k=x instanceof Error?x.message:String(x);y("error"),N(`読み取りに失敗しました: ${k}`),S(!1)}}},L=()=>{_||(D(),T())},M=o.useMemo(()=>m==="photo"?"撮影した画像を確認し、問題なければ「読み取る」を押してください。":m==="processing"?"しばらくお待ちください…":m==="error"?"カメラや照明の状態を確認してください。":"黒いガイド帯の中央に番号を重ね、影や反射を避けて撮影すると精度が上がります。",[m]);return c?e.jsx("div",{className:"ocr-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"ocr-panel",children:[e.jsxs("header",{className:"ocr-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ocr-eyebrow",children:"テキストスキャン"}),e.jsxs("h3",{children:[a,"の読み取り"]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:t,children:"閉じる"})]}),e.jsx("div",{className:"ocr-video-container",children:q?e.jsx("img",{src:q,alt:"撮影した画像",className:"ocr-preview"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:I,playsInline:!0,autoPlay:!0,muted:!0,className:"ocr-video"}),e.jsx("div",{className:"ocr-frame","aria-hidden":"true",children:e.jsx("span",{className:"ocr-frame__label",children:"黒い帯に合わせてください"})})]})}),e.jsx("p",{className:"helper-text",children:M}),e.jsx("p",{className:`ocr-message ${m==="error"?"is-error":""}`,children:E}),e.jsxs("footer",{className:"ocr-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:t,disabled:_&&m==="processing",children:"キャンセル"}),Q&&e.jsx("button",{type:"button",className:"ghost",onClick:L,disabled:_,children:"撮り直し"}),!Q&&e.jsx("button",{type:"button",onClick:v,className:"secondary",disabled:_||m!=="camera",children:"撮影"}),Q&&e.jsx("button",{type:"button",onClick:p,className:"secondary",disabled:_,children:m==="processing"?"読み取り中...":"読み取る"})]})]})}):null}function ea(){var de,we,le,Se,he,ye,Ie,xe;St();const c=wt(),a=o.useRef(null),{current:t,photos:h,attachPhoto:b,removePhoto:I,setFields:n}=Ye(),[d,u]=o.useState(""),[m,y]=o.useState(""),[E,N]=o.useState(""),[_,S]=o.useState(!1),[Q,R]=o.useState(!1),[q,C]=o.useState(!1),[D,O]=o.useState("assetNo"),[T,A]=o.useState(!1),[v,p]=o.useState(null);o.useEffect(()=>{so()},[]),o.useEffect(()=>{var g,U,J,be,ie;u(((g=t==null?void 0:t.fields)==null?void 0:g.assetNo)??""),y(((U=t==null?void 0:t.fields)==null?void 0:U.equipmentNo)??""),N(((J=t==null?void 0:t.fields)==null?void 0:J.purchaseDate)??""),S(!!((be=t==null?void 0:t.fields)!=null&&be.leaseFlag)),R(!!((ie=t==null?void 0:t.fields)!=null&&ie.loanedFlag))},[(de=t==null?void 0:t.fields)==null?void 0:de.assetNo,(we=t==null?void 0:t.fields)==null?void 0:we.equipmentNo,(le=t==null?void 0:t.fields)==null?void 0:le.purchaseDate,(Se=t==null?void 0:t.fields)==null?void 0:Se.leaseFlag,(he=t==null?void 0:t.fields)==null?void 0:he.loanedFlag]),o.useEffect(()=>{var g;if(!((g=t==null?void 0:t.fields)!=null&&g.purchaseDate)){const U=new Date;U.setHours(0,0,0,0);const J=U.toISOString().slice(0,10);N(J),n({purchaseDate:J})}},[(ye=t==null?void 0:t.fields)==null?void 0:ye.purchaseDate,n]);const L=((Ie=t==null?void 0:t.fields)==null?void 0:Ie.sealNo)??"",M=((xe=t==null?void 0:t.fields)==null?void 0:xe.roomName)??"",x=o.useMemo(()=>h.map(g=>({id:g.id,url:URL.createObjectURL(g.thumb)})),[h]);o.useEffect(()=>()=>{x.forEach(g=>URL.revokeObjectURL(g.url))},[x]);const k=async g=>{if(!g||g.length===0)return;const U=g[0];await b(U),a.current&&(a.current.value="")},$=()=>{const g=!_;S(g),n({leaseFlag:g})},f=()=>{const g=!Q;R(g),n({loanedFlag:g})},F=()=>{c("/survey/label")},W=()=>{c("/survey/product")},V=h.length>0,H=g=>{g&&(D==="assetNo"?(u(g),n({assetNo:g})):(y(g),n({equipmentNo:g})))},me=o.useCallback(g=>{p(`${g.targetLabel}を読み取り: ${g.text}`)},[]);o.useEffect(()=>{if(!v)return;const g=window.setTimeout(()=>p(null),5e3);return()=>{window.clearTimeout(g)}},[v]);const te=g=>{O(g),A(!0)};return e.jsxs("div",{className:"page",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:a,style:{display:"none"},onChange:g=>k(g.target.files)}),e.jsxs("div",{className:"page-section",children:[v&&e.jsx("div",{className:"ocr-result-banner",children:v}),e.jsx("h2",{className:"section-title",children:"写真撮影・資産No登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:L,disabled:!0})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:M,disabled:!0})]}),e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:d,onChange:g=>{const U=g.target.value;u(U),n({assetNo:U})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:m,onChange:g=>{const U=g.target.value;y(U),n({equipmentNo:U})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:E,onChange:g=>{const U=g.target.value;N(U),n({purchaseDate:U})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:_?"secondary":"ghost",onClick:$,children:["リース: ",_?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:Q?"secondary":"ghost",onClick:f,children:["貸出品: ",Q?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:x.map(g=>e.jsxs("div",{className:"photo-item",children:[e.jsx("button",{type:"button",className:"photo-remove",onClick:()=>I(g.id),"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:g.url,alt:"サムネイル"})]},g.id))})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>C(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:F,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:()=>{var g;return(g=a.current)==null?void 0:g.click()},children:"写真"}),e.jsx("button",{onClick:W,disabled:!V,children:"次へ"})]}),e.jsx(vs,{open:q,onClose:()=>C(!1)}),e.jsx(oo,{open:T,targetLabel:D==="assetNo"?"資産番号":"備品番号",onClose:()=>A(!1),onResult:H,onRecognized:me})]})}const ca=Object.freeze(Object.defineProperty({__proto__:null,default:ea},Symbol.toStringTag,{value:"Module"}));function jt(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function ta(){var tt,_t,st,Rt,ot,at,vt,it,yt;St();const c=wt(),{current:a,setFields:t,completeCurrent:h,listHistory:b}=Ye(),[I,n]=o.useState([]),[d,u]=o.useState([]),[m,y]=o.useState([]),[E,N]=o.useState([]),[_,S]=o.useState([]),[Q,R]=o.useState(""),[q,C]=o.useState(""),[D,O]=o.useState(""),[T,A]=o.useState(""),[v,p]=o.useState(""),[L,M]=o.useState(""),[x,k]=o.useState(""),[$,f]=o.useState(""),[F,W]=o.useState(""),[V,H]=o.useState(!1),[me,te]=o.useState(!1),[de,we]=o.useState([]),[le,Se]=o.useState(!1),[he,ye]=o.useState(null),[Ie,xe]=o.useState("asc"),g=o.useRef(void 0),U=o.useRef(void 0),J=o.useRef(void 0),be=o.useRef(void 0),ie=o.useRef(void 0);o.useEffect(()=>{Promise.all([j.product_categories.toArray(),j.product_subcategories.toArray(),j.product_items.toArray(),j.product_makers.toArray(),j.product_models.toArray()]).then(([i,w,ue,fe,je])=>{n(i),u(w),y(ue),N(fe),S(je)})},[]),o.useEffect(()=>{var i,w,ue,fe;M(((i=a==null?void 0:a.fields)==null?void 0:i.width)??""),k(((w=a==null?void 0:a.fields)==null?void 0:w.depth)??""),f(((ue=a==null?void 0:a.fields)==null?void 0:ue.height)??""),W(((fe=a==null?void 0:a.fields)==null?void 0:fe.note)??"")},[(tt=a==null?void 0:a.fields)==null?void 0:tt.width,(_t=a==null?void 0:a.fields)==null?void 0:_t.depth,(st=a==null?void 0:a.fields)==null?void 0:st.height,(Rt=a==null?void 0:a.fields)==null?void 0:Rt.note]);const ee=(ot=a==null?void 0:a.fields)==null?void 0:ot.categoryId,se=(at=a==null?void 0:a.fields)==null?void 0:at.subcategoryId,r=(vt=a==null?void 0:a.fields)==null?void 0:vt.itemId,B=(it=a==null?void 0:a.fields)==null?void 0:it.makerId,z=(yt=a==null?void 0:a.fields)==null?void 0:yt.modelId,K=I.find(i=>i.id===ee),Z=d.find(i=>i.id===se),Ne=m.find(i=>i.id===r),X=E.find(i=>i.id===B),ce=_.find(i=>i.id===z);o.useEffect(()=>{(K==null?void 0:K.id)!==g.current&&(K?R(K.name):g.current&&R(""),g.current=K==null?void 0:K.id)},[K]),o.useEffect(()=>{(Z==null?void 0:Z.id)!==U.current&&(Z?C(Z.name):U.current&&C(""),U.current=Z==null?void 0:Z.id)},[Z]),o.useEffect(()=>{(Ne==null?void 0:Ne.id)!==J.current&&(Ne?O(Ne.name):J.current&&O(""),J.current=Ne==null?void 0:Ne.id)},[Ne]),o.useEffect(()=>{(X==null?void 0:X.id)!==be.current&&(X?A(X.name):be.current&&A(""),be.current=X==null?void 0:X.id)},[X]),o.useEffect(()=>{(ce==null?void 0:ce.id)!==ie.current&&(ce?p(ce.name):ie.current&&p(""),ie.current=ce==null?void 0:ce.id)},[ce]);const Je=o.useMemo(()=>I.filter(i=>jt(i.name,Q)),[I,Q]),Pt=o.useMemo(()=>d.filter(i=>jt(i.name,q)),[d,q]),Lt=o.useMemo(()=>m.filter(i=>jt(i.name,D)),[m,D]),Ct=o.useMemo(()=>E.filter(i=>jt(i.name,T)),[E,T]),ht=o.useMemo(()=>_.filter(i=>jt(i.name,v)),[_,v]),ft=i=>{if(ee===i.id){R(""),C(""),O(""),A(""),p(""),t({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}R(i.name),C(""),O(""),A(""),p(""),t({categoryId:i.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},pt=i=>{if(se===i.id){C(""),O(""),A(""),p(""),t({categoryId:ee??i.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}C(i.name),O(""),A(""),p(""),t({categoryId:i.categoryId,subcategoryId:i.id,itemId:void 0,makerId:void 0,modelId:void 0})},gt=i=>{if(r===i.id){O(""),A(""),p(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}O(i.name),A(""),p(""),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.id,makerId:void 0,modelId:void 0})},kt=i=>{if(B===i.id){A(""),p(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:r??i.itemId,makerId:void 0,modelId:void 0});return}A(i.name),p(""),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.id,modelId:void 0})},Tt=i=>{if(z===i.id){p(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:r??i.itemId,makerId:B??i.makerId,modelId:void 0});return}p(i.name),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.makerId,modelId:i.id})},Et=o.useCallback(async i=>{Se(!0),ye(null);try{const w=await b(i);we(w)}catch(w){const ue=w instanceof Error?w.message:String(w);ye(ue),we([])}finally{Se(!1)}},[b]);o.useEffect(()=>{V?Et(Ie):ye(null)},[V,Ie,Et]);const Dt=i=>{const w=i.categoryId,ue=i.subcategoryId,fe=i.itemId,je=i.makerId,Ke=i.modelId,De=i.width!=null?String(i.width):"",nt=i.depth!=null?String(i.depth):"",rt=i.height!=null?String(i.height):"",dt=i.note!=null?String(i.note):"";M(De),k(nt),f(rt),W(dt);const Ze=I.find(ne=>ne.id===w),_e=d.find(ne=>ne.id===ue),Qe=m.find(ne=>ne.id===fe),Ue=E.find(ne=>ne.id===je),pe=_.find(ne=>ne.id===Ke);R((Ze==null?void 0:Ze.name)??""),C((_e==null?void 0:_e.name)??""),O((Qe==null?void 0:Qe.name)??""),A((Ue==null?void 0:Ue.name)??""),p((pe==null?void 0:pe.name)??""),t({categoryId:w,subcategoryId:ue,itemId:fe,makerId:je,modelId:Ke,width:De,depth:nt,height:rt,note:dt})},Qt=i=>{Dt(i.fields??{}),H(!1)},Ut=()=>{xe(i=>i==="asc"?"desc":"asc")},et=async()=>{await h({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),c("/survey/label")},Bt=()=>{t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0}),c("/survey/department")};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"商品登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:Q,onChange:i=>R(i.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:Je.map(i=>e.jsx("button",{onClick:()=>ft(i),className:i.id===ee?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:q,onChange:i=>C(i.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:Pt.map(i=>e.jsx("button",{onClick:()=>pt(i),className:i.id===se?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:D,onChange:i=>O(i.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:Lt.map(i=>e.jsx("button",{onClick:()=>gt(i),className:i.id===r?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:T,onChange:i=>A(i.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:Ct.map(i=>e.jsx("button",{onClick:()=>kt(i),className:i.id===B?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:v,onChange:i=>p(i.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:ht.map(i=>e.jsx("button",{onClick:()=>Tt(i),className:i.id===z?"active":"",children:i.name},i.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["W",e.jsx("input",{value:L,onChange:i=>{const w=i.target.value;M(w),t({width:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:x,onChange:i=>{const w=i.target.value;k(w),t({depth:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:$,onChange:i=>{const w=i.target.value;f(w),t({height:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:F,onChange:i=>{const w=i.target.value;W(w),t({note:w})},rows:3})]})]}),e.jsx("div",{className:"row",style:{justifyContent:"flex-start",marginTop:8},children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(!0),children:"履歴表示"})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>te(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:()=>c("/survey/asset"),children:"戻る"}),e.jsx("button",{className:"secondary",onClick:Bt,children:"部門"}),e.jsx("button",{onClick:et,children:"次へ"})]}),V&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:Ut,children:Ie==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>H(!1),children:"閉じる"})]})]}),le&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),he&&e.jsxs("p",{className:"badge warn",children:["エラー: ",he]}),!le&&!he&&de.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!le&&!he&&de.length>0&&e.jsx("div",{className:"history-list",children:de.map(i=>{var _e,Qe,Ue,pe,ne;const w=i.fields??{},ue=w.completedAt??i.updatedAt,fe=((_e=I.find(ae=>ae.id===w.categoryId))==null?void 0:_e.name)??"-",je=((Qe=d.find(ae=>ae.id===w.subcategoryId))==null?void 0:Qe.name)??"-",Ke=((Ue=m.find(ae=>ae.id===w.itemId))==null?void 0:Ue.name)??"-",De=((pe=E.find(ae=>ae.id===w.makerId))==null?void 0:pe.name)??"-",nt=((ne=_.find(ae=>ae.id===w.modelId))==null?void 0:ne.name)??"-",rt=w.width??"-",dt=w.depth??"-",Ze=w.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>Qt(i),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(ue).toLocaleString()}),w.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",w.assetNo]}),w.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",w.equipmentNo]}),w.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",w.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:fe}),e.jsx("span",{className:"pill",children:je}),e.jsx("span",{className:"pill",children:Ke}),e.jsx("span",{className:"pill",children:De}),e.jsx("span",{className:"pill",children:nt})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",rt]}),e.jsxs("span",{children:["D: ",dt]}),e.jsxs("span",{children:["H: ",Ze]})]})]},i.id)})})]})}),e.jsx(vs,{open:me,onClose:()=>te(!1)})]})}const ua=Object.freeze(Object.defineProperty({__proto__:null,default:ta},Symbol.toStringTag,{value:"Module"}));function Te(c,a){return a?c.toLowerCase().includes(a.toLowerCase()):!0}function ma(){var Ss,Cs,ks,Es,Ds,_s,Rs,Os,As,Ms,Fs,Ps,Ls,Ts,Qs,Us,Bs,$s,Hs,qs,Ws,zs,Gs,Ks,Zs;St();const c=wt(),a=Ye(),{current:t,photos:h,attachPhoto:b,removePhoto:I,setFields:n,completeCurrent:d,listHistory:u,load:m,completedCount:y,duplicateDraft:E,setQR:N,togglePhotoForList:_}=a,[S,Q]=o.useState([]),[R,q]=o.useState([]),[C,D]=o.useState([]),[O,T]=o.useState([]),[A,v]=o.useState(""),[p,L]=o.useState(""),[M,x]=o.useState(""),[k,$]=o.useState(""),[f,F]=o.useState(void 0),[W,V]=o.useState(void 0),[H,me]=o.useState(void 0),[te,de]=o.useState(void 0),we=o.useMemo(()=>{const s=new Date;return`${s.getFullYear()}年${String(s.getMonth()+1).padStart(2,"0")}月${String(s.getDate()).padStart(2,"0")}日`},[]),le=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";o.useEffect(()=>{Promise.all([j.location_buildings.toArray(),j.location_floors.toArray(),j.location_departments.toArray(),j.location_divisions.toArray()]).then(([s,l,P,G])=>{Q(s),q(l),D(P),T(G)})},[]),o.useEffect(()=>{var l,P;if(!t)return;const s={};(l=t.fields)!=null&&l.surveyDate||(s.surveyDate=we),le&&((P=t.fields)==null?void 0:P.investigator)!==le&&(s.investigator=le),Object.keys(s).length>0&&n(s)},[t,le,n,we]);const Se=(Ss=t==null?void 0:t.fields)==null?void 0:Ss.buildingId,he=(Cs=t==null?void 0:t.fields)==null?void 0:Cs.floorId,ye=(ks=t==null?void 0:t.fields)==null?void 0:ks.departmentId,Ie=(Es=t==null?void 0:t.fields)==null?void 0:Es.divisionId;o.useEffect(()=>{F(Se)},[Se]),o.useEffect(()=>{V(he)},[he]),o.useEffect(()=>{me(ye)},[ye]),o.useEffect(()=>{de(Ie)},[Ie]);const xe=o.useMemo(()=>S.find(s=>s.id===f),[S,f]),g=o.useMemo(()=>R.find(s=>s.id===W),[R,W]),U=o.useMemo(()=>C.find(s=>s.id===H),[C,H]),J=o.useMemo(()=>O.find(s=>s.id===te),[O,te]);o.useEffect(()=>{v((xe==null?void 0:xe.name)??"")},[xe]),o.useEffect(()=>{L((g==null?void 0:g.name)??"")},[g]),o.useEffect(()=>{x((U==null?void 0:U.name)??"")},[U]),o.useEffect(()=>{$((J==null?void 0:J.name)??"")},[J]),o.useMemo(()=>S.filter(s=>Te(s.name,A)),[S,A]),o.useMemo(()=>R.filter(s=>Te(s.name,p)),[R,p]),o.useMemo(()=>C.filter(s=>Te(s.name,M)),[C,M]),o.useMemo(()=>O.filter(s=>Te(s.name,k)),[O,k]);const be=!!(f&&W&&H&&te),ie=o.useRef(null),[ee,se]=o.useState(""),[r,B]=o.useState(""),[z,K]=o.useState([]),[Z,Ne]=o.useState(!1),[X,ce]=o.useState(""),[Je,Pt]=o.useState(""),[Lt,Ct]=o.useState("single");o.useEffect(()=>{var s,l;se(((s=t==null?void 0:t.fields)==null?void 0:s.sealNo)??""),B(((l=t==null?void 0:t.fields)==null?void 0:l.roomName)??"")},[(Ds=t==null?void 0:t.fields)==null?void 0:Ds.sealNo,(_s=t==null?void 0:t.fields)==null?void 0:_s.roomName]),o.useEffect(()=>()=>{var s;(s=ie.current)==null||s.stop()},[]),o.useEffect(()=>{let s=!0;return j.location_rooms.toArray().then(l=>{s&&K(l)}).catch(()=>{s&&K([])}),()=>{s=!1}},[]);const ht=(Rs=t==null?void 0:t.fields)==null?void 0:Rs.buildingId,ft=(Os=t==null?void 0:t.fields)==null?void 0:Os.floorId,pt=(As=t==null?void 0:t.fields)==null?void 0:As.departmentId,gt=(Ms=t==null?void 0:t.fields)==null?void 0:Ms.divisionId,kt=o.useMemo(()=>{if(!ht||!ft||!pt||!gt)return[];const s=r.trim().toLowerCase();return z.filter(l=>l.buildingId!==ht||l.floorId!==ft||l.departmentId!==pt||l.divisionId!==gt?!1:s?l.name.toLowerCase().includes(s):!0)},[z,ht,ft,pt,gt,r]),Tt=s=>{const l=s.trim(),P=l.match(/https?:\/\/[^/]+\/x\/([A-Za-z0-9-]+)$/i),G=l.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i),Y=P&&P[1]||G&&G[0]||l;Lt==="bulkStart"?ce(Y):(se(Y),N(Y))},Et=s=>{se(s),n({sealNo:s,qrCode:s})},Dt=s=>{B(s),n({roomName:s})},Qt=s=>{Ne(s),s?ee.trim()&&ce(ee):X.trim()&&(se(X),n({sealNo:X,qrCode:X}))},Ut=o.useMemo(()=>{const s=r.trim().length>0,l=ee.trim().length>0,P=X.trim().length>0,G=Number.parseInt(Je,10),Y=Z&&P&&Number.isFinite(G)&&G>0;return s&&(!Z&&l||Y)},[Z,Je,X,r,ee]),et=o.useRef(null),[Bt,tt]=o.useState(""),[_t,st]=o.useState(""),[Rt,ot]=o.useState(""),[at,vt]=o.useState(!1),[it,yt]=o.useState(!1),[i,w]=o.useState("assetNo"),[ue,fe]=o.useState(!1),[je,Ke]=o.useState(null);o.useEffect(()=>{so()},[]),o.useEffect(()=>{var s,l,P,G,Y;tt(((s=t==null?void 0:t.fields)==null?void 0:s.assetNo)??""),st(((l=t==null?void 0:t.fields)==null?void 0:l.equipmentNo)??""),ot(((P=t==null?void 0:t.fields)==null?void 0:P.purchaseDate)??""),vt(!!((G=t==null?void 0:t.fields)!=null&&G.leaseFlag)),yt(!!((Y=t==null?void 0:t.fields)!=null&&Y.loanedFlag))},[(Fs=t==null?void 0:t.fields)==null?void 0:Fs.assetNo,(Ps=t==null?void 0:t.fields)==null?void 0:Ps.equipmentNo,(Ls=t==null?void 0:t.fields)==null?void 0:Ls.purchaseDate,(Ts=t==null?void 0:t.fields)==null?void 0:Ts.leaseFlag,(Qs=t==null?void 0:t.fields)==null?void 0:Qs.loanedFlag]),o.useEffect(()=>{var s;if(!((s=t==null?void 0:t.fields)!=null&&s.purchaseDate)){const l=new Date;l.setHours(0,0,0,0);const P=l.toISOString().slice(0,10);ot(P),n({purchaseDate:P})}},[(Us=t==null?void 0:t.fields)==null?void 0:Us.purchaseDate,n]);const De=o.useMemo(()=>h.map(s=>({id:s.id,url:URL.createObjectURL(s.thumb),selectedForList:!!s.selectedForList})),[h]);o.useEffect(()=>()=>{De.forEach(s=>URL.revokeObjectURL(s.url))},[De]);const nt=async s=>{if(!s||s.length===0)return;const l=s[0];await b(l),et.current&&(et.current.value="")},rt=()=>{const s=!at;vt(s),n({leaseFlag:s})},dt=()=>{const s=!it;yt(s),n({loanedFlag:s})},Ze=s=>{s&&(i==="assetNo"?(tt(s),n({assetNo:s})):(st(s),n({equipmentNo:s})))},_e=s=>{w(s),fe(!0)},Qe=o.useCallback(s=>{Ke(`${s.targetLabel}を読み取り: ${s.text}`)},[]);o.useEffect(()=>{if(!je)return;const s=window.setTimeout(()=>Ke(null),5e3);return()=>{window.clearTimeout(s)}},[je]);const Ue=h.length>0,[pe,ne]=o.useState([]),[ae,ao]=o.useState([]),[It,io]=o.useState([]),[xt,no]=o.useState([]),[bt,ro]=o.useState([]),[$t,lt]=o.useState(""),[Ht,Be]=o.useState(""),[qt,Ce]=o.useState(""),[Wt,ge]=o.useState(""),[zt,re]=o.useState(""),[ys,Gt]=o.useState(""),[Is,Kt]=o.useState(""),[xs,Zt]=o.useState(""),[bs,Vt]=o.useState(""),[Xt,Yt]=o.useState(!1),[Jt,Ns]=o.useState([]),[es,js]=o.useState(!1),[Ot,ts]=o.useState(null),[ss,lo]=o.useState("asc"),os=o.useRef(void 0),as=o.useRef(void 0),is=o.useRef(void 0),ns=o.useRef(void 0),rs=o.useRef(void 0);o.useEffect(()=>{Promise.all([j.product_categories.toArray(),j.product_subcategories.toArray(),j.product_items.toArray(),j.product_makers.toArray(),j.product_models.toArray()]).then(([s,l,P,G,Y])=>{ne(s),ao(l),io(P),no(G),ro(Y)})},[]),o.useEffect(()=>{var s,l,P,G;Gt(((s=t==null?void 0:t.fields)==null?void 0:s.width)??""),Kt(((l=t==null?void 0:t.fields)==null?void 0:l.depth)??""),Zt(((P=t==null?void 0:t.fields)==null?void 0:P.height)??""),Vt(((G=t==null?void 0:t.fields)==null?void 0:G.note)??"")},[(Bs=t==null?void 0:t.fields)==null?void 0:Bs.width,($s=t==null?void 0:t.fields)==null?void 0:$s.depth,(Hs=t==null?void 0:t.fields)==null?void 0:Hs.height,(qs=t==null?void 0:t.fields)==null?void 0:qs.note]);const $e=(Ws=t==null?void 0:t.fields)==null?void 0:Ws.categoryId,Ve=(zs=t==null?void 0:t.fields)==null?void 0:zs.subcategoryId,ct=(Gs=t==null?void 0:t.fields)==null?void 0:Gs.itemId,Nt=(Ks=t==null?void 0:t.fields)==null?void 0:Ks.makerId,At=(Zs=t==null?void 0:t.fields)==null?void 0:Zs.modelId,Re=pe.find(s=>s.id===$e),Oe=ae.find(s=>s.id===Ve),Ae=It.find(s=>s.id===ct),Me=xt.find(s=>s.id===Nt),Fe=bt.find(s=>s.id===At);o.useEffect(()=>{(Re==null?void 0:Re.id)!==os.current&&(Re?lt(Re.name):os.current&&lt(""),os.current=Re==null?void 0:Re.id)},[Re]),o.useEffect(()=>{(Oe==null?void 0:Oe.id)!==as.current&&(Oe?Be(Oe.name):as.current&&Be(""),as.current=Oe==null?void 0:Oe.id)},[Oe]),o.useEffect(()=>{(Ae==null?void 0:Ae.id)!==is.current&&(Ae?Ce(Ae.name):is.current&&Ce(""),is.current=Ae==null?void 0:Ae.id)},[Ae]),o.useEffect(()=>{(Me==null?void 0:Me.id)!==ns.current&&(Me?ge(Me.name):ns.current&&ge(""),ns.current=Me==null?void 0:Me.id)},[Me]),o.useEffect(()=>{(Fe==null?void 0:Fe.id)!==rs.current&&(Fe?re(Fe.name):rs.current&&re(""),rs.current=Fe==null?void 0:Fe.id)},[Fe]);const co=o.useMemo(()=>pe.filter(s=>Te(s.name,$t)),[pe,$t]),uo=o.useMemo(()=>ae.filter(s=>Te(s.name,Ht)),[ae,Ht]),mo=o.useMemo(()=>It.filter(s=>Te(s.name,qt)),[It,qt]),ho=o.useMemo(()=>xt.filter(s=>Te(s.name,Wt)),[xt,Wt]),fo=o.useMemo(()=>bt.filter(s=>Te(s.name,zt)),[bt,zt]),po=s=>{if($e===s.id){lt(""),Be(""),Ce(""),ge(""),re(""),n({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}lt(s.name),Be(""),Ce(""),ge(""),re(""),n({categoryId:s.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},go=s=>{if(Ve===s.id){Be(""),Ce(""),ge(""),re(""),n({categoryId:$e??s.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}Be(s.name),Ce(""),ge(""),re(""),n({categoryId:s.categoryId,subcategoryId:s.id,itemId:void 0,makerId:void 0,modelId:void 0})},vo=s=>{if(ct===s.id){Ce(""),ge(""),re(""),n({categoryId:$e??s.categoryId,subcategoryId:Ve??s.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}Ce(s.name),ge(""),re(""),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.id,makerId:void 0,modelId:void 0})},yo=s=>{if(Nt===s.id){ge(""),re(""),n({categoryId:$e??s.categoryId,subcategoryId:Ve??s.subcategoryId,itemId:ct??s.itemId,makerId:void 0,modelId:void 0});return}ge(s.name),re(""),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.id,modelId:void 0})},Io=s=>{if(At===s.id){re(""),n({categoryId:$e??s.categoryId,subcategoryId:Ve??s.subcategoryId,itemId:ct??s.itemId,makerId:Nt??s.makerId,modelId:void 0});return}re(s.name),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,modelId:s.id})},ws=o.useCallback(async s=>{js(!0),ts(null);try{const l=await u(s);Ns(l)}catch(l){const P=l instanceof Error?l.message:String(l);ts(P),Ns([])}finally{js(!1)}},[u]);o.useEffect(()=>{Xt?ws(ss):ts(null)},[Xt,ss,ws]);const xo=s=>{const l=s.categoryId,P=s.subcategoryId,G=s.itemId,Y=s.makerId,ke=s.modelId,Pe=s.width!=null?String(s.width):"",Ee=s.depth!=null?String(s.depth):"",Xe=s.height!=null?String(s.height):"",ut=s.note!=null?String(s.note):"";Gt(Pe),Kt(Ee),Zt(Xe),Vt(ut);const He=pe.find(ve=>ve.id===l),qe=ae.find(ve=>ve.id===P),We=It.find(ve=>ve.id===G),ze=xt.find(ve=>ve.id===Y),Ge=bt.find(ve=>ve.id===ke);lt((He==null?void 0:He.name)??""),Be((qe==null?void 0:qe.name)??""),Ce((We==null?void 0:We.name)??""),ge((ze==null?void 0:ze.name)??""),re((Ge==null?void 0:Ge.name)??""),n({categoryId:l,subcategoryId:P,itemId:G,makerId:Y,modelId:ke,width:Pe,depth:Ee,height:Xe,note:ut})},bo=s=>{xo(s.fields??{}),Yt(!1)},No=()=>{lo(s=>s==="asc"?"desc":"asc")},jo=async()=>{var Y;if(!Z){const ke=((Y=t==null?void 0:t.fields)==null?void 0:Y.sealNo)??ee;let Pe=null;if(ke){const Ee=ke.match(/(\d+)(?!.*\d)/);if(Ee&&Ee.index!==void 0){const Xe=Ee.index,ut=Number.parseInt(Ee[1],10),He=Ee[1].length,qe=ke.slice(0,Xe),We=ke.slice(Xe+He),ze=ut+1,Ge=String(ze).padStart(He,"0");Pe=`${qe}${Ge}${We}`}}await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),Pe&&(se(Pe),await N(Pe));return}const s=X.trim(),l=Number.parseInt(Je,10);if(!s||!Number.isFinite(l)||l<=0){alert("一括登録モードでは、開始シールNoと1以上の登録個数を入力してください。");return}if(!t)return;const P=t.id;se(s),await N(s),await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});const G=l-1;G>0&&await E(P,G)},wo=async()=>{try{const l=(await u("desc"))[0];if(!l)return;await m(l.id)}catch(s){console.error(s)}},So=!!($e&&Ve&&ct&&Nt&&At)&&!!(ys||Is||xs||bs);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QR読取・基本情報"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["登録モード",e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:s=>Qt(s.target.checked),style:{width:16,height:16}}),e.jsx("span",{children:"一括登録モード"})]})]}),Z?e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:["開始シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:X,onChange:s=>ce(s.target.value),placeholder:"開始シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{Ct("bulkStart"),await us(),await((s=ie.current)==null?void 0:s.start())}catch(l){const P=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${P}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["登録個数",e.jsx("input",{type:"number",min:1,value:Je,onChange:s=>Pt(s.target.value),placeholder:"個数を入力（例：椅子50脚の場合は「50」と入力）"})]})]}):e.jsxs("label",{children:["シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:ee,onChange:s=>Et(s.target.value),placeholder:"シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{Ct("single"),await us(),await((s=ie.current)==null?void 0:s.start())}catch(l){const P=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${P}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:r,onChange:s=>Dt(s.target.value),placeholder:"室名を入力"}),kt.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:kt.map(s=>e.jsx("button",{type:"button",onClick:()=>Dt(s.name),children:s.name},s.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(gs,{ref:ie,onResult:Tt})})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"写真撮影・資産番号"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:et,style:{display:"none"},onChange:s=>nt(s.target.files)}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Bt,onChange:s=>{const l=s.target.value;tt(l),n({assetNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>_e("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:_t,onChange:s=>{const l=s.target.value;st(l),n({equipmentNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>_e("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:Rt,onChange:s=>{const l=s.target.value;ot(l),n({purchaseDate:l})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:at?"secondary":"ghost",onClick:rt,children:["リース: ",at?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:it?"secondary":"ghost",onClick:dt,children:["貸出品: ",it?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:De.length===0?e.jsx("div",{className:"photo-strip-empty",children:"撮影した写真がここに表示されます"}):De.map(s=>e.jsxs("div",{className:`photo-item${s.selectedForList?" is-selected":""}`,onClick:()=>{_(s.id)},children:[e.jsx("span",{className:"visually-hidden",children:"一覧表示用の写真として選択"}),e.jsx("button",{type:"button",className:"photo-remove",onClick:l=>{l.stopPropagation(),I(s.id)},"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:s.url,alt:"サムネイル"})]},s.id))}),je&&e.jsx("div",{className:"ocr-result-banner",children:je})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"資産情報登録"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:$t,onChange:s=>lt(s.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:co.map(s=>e.jsx("button",{onClick:()=>po(s),className:s.id===$e?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:Ht,onChange:s=>Be(s.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:uo.map(s=>e.jsx("button",{onClick:()=>go(s),className:s.id===Ve?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:qt,onChange:s=>Ce(s.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:mo.map(s=>e.jsx("button",{onClick:()=>vo(s),className:s.id===ct?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:Wt,onChange:s=>ge(s.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:ho.map(s=>e.jsx("button",{onClick:()=>yo(s),className:s.id===Nt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:zt,onChange:s=>re(s.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:fo.map(s=>e.jsx("button",{onClick:()=>Io(s),className:s.id===At?"active":"",children:s.name},s.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("div",{className:"asset-size-row",children:[e.jsxs("label",{children:["W",e.jsx("input",{value:ys,onChange:s=>{const l=s.target.value;Gt(l),n({width:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:Is,onChange:s=>{const l=s.target.value;Kt(l),n({depth:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:xs,onChange:s=>{const l=s.target.value;Zt(l),n({height:l})},placeholder:"mm"})]})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:bs,onChange:s=>{const l=s.target.value;Vt(l),n({note:l})},rows:3})]})]})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/survey/home"),children:"ホーム"}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>c("/survey/department"),children:["部門",e.jsx("br",{}),"入力へ"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>Yt(!0),children:["履歴",e.jsx("br",{}),"表示"]}),e.jsxs("button",{type:"button",className:"secondary",onClick:()=>{var s;return(s=et.current)==null?void 0:s.click()},children:["写真",e.jsx("br",{}),"撮影"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:wo,disabled:y===0,children:["前の商品に",e.jsx("br",{}),"戻る"]}),e.jsxs("button",{type:"button",onClick:jo,disabled:!(be&&Ut&&Ue&&So),children:["商品",e.jsx("br",{}),"登録"]})]}),e.jsx(oo,{open:ue,targetLabel:i==="assetNo"?"資産番号":"備品番号",onClose:()=>fe(!1),onResult:Ze,onRecognized:Qe}),Xt&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:No,children:ss==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>Yt(!1),children:"閉じる"})]})]}),es&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),Ot&&e.jsxs("p",{className:"badge warn",children:["エラー: ",Ot]}),!es&&!Ot&&Jt.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!es&&!Ot&&Jt.length>0&&e.jsx("div",{className:"history-list",children:Jt.map(s=>{var qe,We,ze,Ge,ve;const l=s.fields??{},P=l.completedAt??s.updatedAt,G=((qe=pe.find(Le=>Le.id===l.categoryId))==null?void 0:qe.name)??"-",Y=((We=ae.find(Le=>Le.id===l.subcategoryId))==null?void 0:We.name)??"-",ke=((ze=It.find(Le=>Le.id===l.itemId))==null?void 0:ze.name)??"-",Pe=((Ge=xt.find(Le=>Le.id===l.makerId))==null?void 0:Ge.name)??"-",Ee=((ve=bt.find(Le=>Le.id===l.modelId))==null?void 0:ve.name)??"-",Xe=l.width??"-",ut=l.depth??"-",He=l.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>bo(s),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(P).toLocaleString()}),l.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",l.assetNo]}),l.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",l.equipmentNo]}),l.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",l.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:G}),e.jsx("span",{className:"pill",children:Y}),e.jsx("span",{className:"pill",children:ke}),e.jsx("span",{className:"pill",children:Pe}),e.jsx("span",{className:"pill",children:Ee})]}),e.jsx("div",{className:"history-meta",children:e.jsxs("span",{children:["W:",Xe," / D:",ut," / H:",He]})})]},s.id)})})]})})]})}export{ea as A,Vo as D,Xo as L,ta as P,ma as S,na as a,ra as b,la as c,j as d,us as e,ca as f,ua as g,so as p,da as q,Ye as u,zo as w};
