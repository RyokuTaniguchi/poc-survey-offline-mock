var ka=Object.defineProperty;var Ea=(c,o,t)=>o in c?ka(c,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[o]=t;var ae=(c,o,t)=>Ea(c,typeof o!="symbol"?o+"":o,t);import{i as qs,c as _a,r as a,s as Ks,u as vt,j as e}from"./vendor-5jQwBCrV.js";import{D as Da}from"./vendor-dexie-DWlydIdn.js";import{B as ss}from"./vendor-zxing-DcYOnkv9.js";class Ra extends Da{constructor(){super("meddx_survey");ae(this,"survey_drafts");ae(this,"survey_photos");ae(this,"survey_masters");ae(this,"indices");ae(this,"settings");ae(this,"location_buildings");ae(this,"location_floors");ae(this,"location_departments");ae(this,"location_divisions");ae(this,"product_categories");ae(this,"product_subcategories");ae(this,"product_items");ae(this,"product_makers");ae(this,"product_models");ae(this,"location_rooms");this.version(1).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key"}),this.version(2).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name"}),this.version(3).stores({survey_drafts:"id,updatedAt,qr",survey_photos:"id,draftId,createdAt",survey_masters:"id,updatedAt,nameNfkc,makerNfkc,model",indices:"id",settings:"key",location_buildings:"id,name",location_floors:"id,buildingId,name",location_departments:"id,buildingId,floorId,name",location_divisions:"id,buildingId,floorId,departmentId,name",product_categories:"id,name",product_subcategories:"id,categoryId,name",product_items:"id,categoryId,subcategoryId,name",product_makers:"id,categoryId,subcategoryId,itemId,name",product_models:"id,categoryId,subcategoryId,itemId,makerId,name",location_rooms:"id,buildingId,floorId,departmentId,divisionId,name"})}}const j=new Ra,Oa="/poc-survey-offline-mock/".replace(/\/?$/,"/"),Ws=`${Oa}vendor/browser-image-compression.js`;async function Ma(c,o=2560){const h=await qs(c,{maxWidthOrHeight:o,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Ws}),N=await qs(c,{maxWidthOrHeight:512,initialQuality:.7,fileType:"image/webp",useWebWorker:!0,libURL:Ws});return{blob:h,thumb:N}}const We=_a((c,o)=>{const t=async()=>{const n=o().current;if(!n){c({photos:[]});return}const d=await j.survey_photos.where("draftId").equals(n.id).reverse().toArray();c({photos:d})},h=async()=>{const n=await j.survey_drafts.filter(d=>{var u;return((u=d.fields)==null?void 0:u.status)==="completed"}).count();c({completedCount:n})},N=async n=>{await j.survey_drafts.put(n),c({current:n}),await h()},y={current:void 0,photos:[],completedCount:0,async newDraft(){const n=crypto.randomUUID(),d={id:n,fields:{},photoIds:[],updatedAt:Date.now()};return await j.survey_drafts.put(d),c({current:d}),setTimeout(()=>{t()},0),await h(),n},async load(n){let d=await j.survey_drafts.get(n);d||(d={id:n,fields:{},photoIds:[],updatedAt:Date.now()},await j.survey_drafts.put(d)),c({current:d}),await t(),await h()},async setField(n,d){const u=o().current;if(!u)return;const m={...u.fields};d==null||d===""?delete m[n]:m[n]=d;const v={...u,fields:m,updatedAt:Date.now()};await N(v)},async setFields(n){const d=o().current;if(!d)return;const u={...d.fields};Object.entries(n).forEach(([v,E])=>{E==null||E===""?delete u[v]:u[v]=E});const m={...d,fields:u,updatedAt:Date.now()};await N(m)},async setQR(n){const d=o().current;if(!d)return;const u={...d,qr:n,fields:{...d.fields,sealNo:n,qrCode:n},updatedAt:Date.now()};await N(u)},async attachPhoto(n){const d=o().current;if(!d)return;const{blob:u,thumb:m}=await Ma(n),v=await j.survey_photos.where("draftId").equals(d.id).count(),E={id:crypto.randomUUID(),draftId:d.id,blob:u,thumb:m,size:u.size,createdAt:Date.now(),selectedForList:v===0};await j.survey_photos.put(E);const b={...d,photoIds:[...d.photoIds,E.id],updatedAt:Date.now()};await N(b),await t()},async togglePhotoForList(n){const d=o().current;if(!d)return;const u=await j.survey_photos.get(n),m=!(u!=null&&u.selectedForList);await j.survey_photos.where("draftId").equals(d.id).modify(v=>{v.selectedForList=m&&v.id===n}),await t()},async removePhoto(n){const d=o().current;if(!d)return;await j.survey_photos.delete(n);const u=d.photoIds.filter(v=>v!==n),m={...d,photoIds:u,updatedAt:Date.now()};await N(m),await t()},async refreshPhotos(){await t()},async refreshStats(){await h()},async completeCurrent(n){const d=o().current;if(!d)return;const u={...d,fields:{...d.fields,status:"completed",completedAt:Date.now()},updatedAt:Date.now()};await N(u),await t();const m=await o().newDraft();await t();const v=(n==null?void 0:n.preserveKeys)??[];if(v.length>0){const E={};v.forEach(b=>{var D;((D=d.fields)==null?void 0:D[b])!==void 0&&(E[b]=d.fields[b])}),Object.keys(E).length>0&&await o().setFields(E)}return m},async clearCurrent(){const n=o().current;n&&(await j.survey_photos.where("draftId").equals(n.id).delete(),await j.survey_drafts.delete(n.id),c({current:void 0,photos:[]}),await h())},async listHistory(n="asc"){const d=j.survey_drafts.orderBy("updatedAt");return(n==="desc"?await d.reverse().toArray():await d.toArray()).filter(m=>{var v;return((v=m.fields)==null?void 0:v.status)==="completed"})},async purgeCompleted(){const n=await j.survey_drafts.filter(u=>{var m;return((m=u.fields)==null?void 0:m.status)==="completed"}).toArray();if(n.length===0)return 0;await j.transaction("rw",j.survey_drafts,j.survey_photos,async()=>{for(const u of n)await j.survey_photos.where("draftId").equals(u.id).delete(),await j.survey_drafts.delete(u.id)});const d=o().current;return d&&n.some(u=>u.id===d.id)&&c({current:void 0,photos:[]}),await h(),await t(),n.length},async duplicateDraft(n,d){if(d<=0)return 0;const u=await j.survey_drafts.get(n);if(!u)throw new Error("複製元の履歴が見つかりません");const m={...u.fields??{}},v=m.sealNo||m.qr||m.qrCode||u.qr;if(!v)throw new Error("複製元のQRコードが取得できませんでした");const E=v.match(/(\d+)(?!.*\d)/),b=E?E.index??-1:-1,D=E?parseInt(E[1],10):null,S=E?E[1].length:0,L=b>=0?v.slice(0,b):v,R=b>=0?v.slice(b+S):"",W=await j.survey_photos.where("draftId").equals(n).toArray(),C=[],_=[],O=Date.now(),T=p=>{if(D!==null){const g=D+p,P=String(g).padStart(S,"0");return`${L}${P}${R}`}return`${v}-${p}`};for(let p=1;p<=d;p++){const g=crypto.randomUUID(),P=T(p),A=[],I={...m,qr:P,qrCode:P,sealNo:P,status:"completed",completedAt:O+p};W.forEach(k=>{const $=crypto.randomUUID();A.push($),_.push({...k,id:$,draftId:g,createdAt:O+p})}),C.push({id:g,fields:I,photoIds:A,updatedAt:O+p})}await j.transaction("rw",j.survey_drafts,j.survey_photos,async()=>{_.length>0&&await j.survey_photos.bulkPut(_),C.length>0&&await j.survey_drafts.bulkPut(C)}),await h();const M=o().current;if(M){const p=await j.survey_drafts.get(M.id);p&&c({current:p})}return C.length}};return h(),y});function yt(){const{current:c,newDraft:o}=We();a.useEffect(()=>{c||o()},[c,o])}const Aa="この端末ではカメラが利用できません",Fa="ブラウザ環境ではありません",Pa="カメラの利用には HTTPS での接続が必要です";function Qa(){if(typeof navigator>"u")return null;const c=navigator.mediaDevices;if(c!=null&&c.getUserMedia)return t=>c.getUserMedia(t);const o=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return o?t=>new Promise((h,N)=>{o.call(navigator,t,h,N)}):null}async function is(){if(typeof navigator>"u")throw new Error(Fa);if(typeof window<"u"&&"isSecureContext"in window&&!window.isSecureContext)throw new Error(Pa);const c=Qa();if(!c)throw new Error(Aa);if(sessionStorage.getItem("cameraPermission")==="granted")return"granted";try{return(await c({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},audio:!1})).getTracks().forEach(h=>h.stop()),sessionStorage.setItem("cameraPermission","granted"),"granted"}catch(t){const h=t;throw(h==null?void 0:h.name)==="NotAllowedError"||(h==null?void 0:h.name)==="SecurityError"?sessionStorage.setItem("cameraPermission","denied"):sessionStorage.removeItem("cameraPermission"),t instanceof Error?t:new Error(String(t))}}const as={},Ta="/poc-survey-offline-mock/".replace(/\/?$/,"/"),ns=c=>`${Ta}tesseract/${c.replace(/^\//,"")}`;var Gs;const La=(Gs=as==null?void 0:as.VITE_TESSDATA_URL)==null?void 0:Gs.trim(),Ua=ns("lang-data/"),Zs=(La??Ua).replace(/\/?$/,"/");let at=null,rs=!1;const Ba=6e4;function $a(c,o,t){return new Promise((h,N)=>{const y=setTimeout(()=>{try{t==null||t()}catch{}N(new Error("OCR処理がタイムアウトしました"))},o);c.then(n=>{clearTimeout(y),h(n)},n=>{clearTimeout(y),N(n)})})}function Ha(c){return c.replace(/[\uFF01-\uFF5E]/g,o=>String.fromCharCode(o.charCodeAt(0)-65248)).replace(/\u3000/g," ")}function qa(c){return Ha(c).toUpperCase().replace(/[\u2010-\u2015\u2212\u30FC\uFF0D\uFE63]/g,"-").replace(/[^0-9A-Z-]/g,"")}const ds=()=>{at=null,rs=!1};async function Wa(){return Ks.createWorker("eng",void 0,{workerPath:ns("worker.min.js"),corePath:ns("tesseract-core.wasm.js"),langPath:Zs,workerBlobURL:!1})}async function ls(){at||(at=$a(Wa(),Ba,ds));try{const c=await at;return rs||(await c.setParameters({tessedit_char_whitelist:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ-",tessedit_pageseg_mode:Ks.PSM.SINGLE_LINE}),rs=!0),c}catch(c){throw ds(),c instanceof Error?c:new Error("Tesseract workerの初期化に失敗しました")}}function Vs(){ls().catch(()=>{})}const za=["tesseract/lang-data/eng.traineddata.gz","tesseract/worker.min.js","tesseract/tesseract-core.wasm","tesseract/tesseract-core.wasm.js"];async function Ga(){const c="/poc-survey-offline-mock/".replace(/\/?$/,"/");await Promise.all(za.map(async o=>{try{await fetch(`${c}${o}`,{cache:"force-cache"})}catch{}}))}async function ro(){await Ga(),await ls()}async function Ka(c){const o=await ls(),{data:t}=await o.recognize(c).catch(async u=>{throw await Za(),u}),h=Array.isArray(t.lines)?t.lines:[],N=h.map(u=>{var m,v;return((v=(m=u.text)==null?void 0:m.trim)==null?void 0:v.call(m))??""}).filter(Boolean),y=h.reduce((u,m)=>!u||m.confidence>u.confidence?{text:m.text,confidence:m.confidence}:u,null),n=qa((y==null?void 0:y.text)??t.text??""),d=(y==null?void 0:y.confidence)??t.confidence??0;return{text:n,rawText:t.text??"",candidates:N.length>0?N:(t.text??"").split(/\n+/).map(u=>u.trim()).filter(Boolean),confidence:d,method:"tesseract"}}async function Za(){if(!at)return;await(await at).terminate(),ds()}async function Va(c){let o=null;try{return await Ka(c)}catch(t){o=t instanceof Error?t:new Error(String(t))}if(o){const t=o.message;throw Zs.startsWith("http")?typeof navigator<"u"&&!navigator.onLine?new Error("OCR辞書データが未取得です。オンライン接続時に一度読み取りを実行し、キャッシュを作成してください。"):new Error(`OCR辞書データのダウンロードに失敗しました: ${t}`):new Error(`OCR辞書データの読み込みに失敗しました。詳細: ${t}`)}throw new Error("OCR処理に失敗しました。")}function Ot(c,o){return o?c.toLowerCase().includes(o.toLowerCase()):!0}function Xa(){var ie,ne,Ie,Ne,ee,se;yt();const c=vt(),{current:o,setFields:t}=We(),[h,N]=a.useState([]),[y,n]=a.useState([]),[d,u]=a.useState([]),[m,v]=a.useState([]),[E,b]=a.useState(""),[D,S]=a.useState(""),[L,R]=a.useState(""),[W,C]=a.useState(""),[_,O]=a.useState(void 0),[T,M]=a.useState(void 0),[p,g]=a.useState(void 0),[P,A]=a.useState(void 0),I=a.useMemo(()=>{const r=new Date;return`${r.getFullYear()}年${String(r.getMonth()+1).padStart(2,"0")}月${String(r.getDate()).padStart(2,"0")}日`},[]),k=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";a.useEffect(()=>{sessionStorage.setItem("visitedDepartment","1")},[]),a.useEffect(()=>{Promise.all([j.location_buildings.toArray(),j.location_floors.toArray(),j.location_departments.toArray(),j.location_divisions.toArray()]).then(([r,U,G,K])=>{N(r),n(U),u(G),v(K)})},[]),a.useEffect(()=>{var U,G;if(!o)return;const r={};(U=o.fields)!=null&&U.surveyDate||(r.surveyDate=I),k&&((G=o.fields)==null?void 0:G.investigator)!==k&&(r.investigator=k),Object.keys(r).length>0&&t(r)},[o,k,t,I]);const $=(ie=o==null?void 0:o.fields)==null?void 0:ie.buildingId,f=(ne=o==null?void 0:o.fields)==null?void 0:ne.floorId,F=(Ie=o==null?void 0:o.fields)==null?void 0:Ie.departmentId,z=(Ne=o==null?void 0:o.fields)==null?void 0:Ne.divisionId;a.useEffect(()=>{O($)},[$]),a.useEffect(()=>{M(f)},[f]),a.useEffect(()=>{g(F)},[F]),a.useEffect(()=>{A(z)},[z]);const V=a.useMemo(()=>h.find(r=>r.id===_),[h,_]),H=a.useMemo(()=>y.find(r=>r.id===T),[y,T]),he=a.useMemo(()=>d.find(r=>r.id===p),[d,p]),te=a.useMemo(()=>m.find(r=>r.id===P),[m,P]);a.useEffect(()=>{b(V?V.name:"")},[V]),a.useEffect(()=>{S(H?H.name:"")},[H]),a.useEffect(()=>{R(he?he.name:"")},[he]),a.useEffect(()=>{C(te?te.name:"")},[te]);const de=a.useMemo(()=>h.filter(r=>Ot(r.name,E)),[h,E]),Se=a.useMemo(()=>y.filter(r=>_&&r.buildingId!==_?!1:Ot(r.name,D)),[y,D,_]),le=a.useMemo(()=>d.filter(r=>_&&r.buildingId!==_||T&&r.floorId!==T?!1:Ot(r.name,L)),[d,L,_,T]),Ce=a.useMemo(()=>m.filter(r=>_&&r.buildingId!==_||T&&r.floorId!==T||p&&r.departmentId!==p?!1:Ot(r.name,W)),[m,W,_,T,p]),fe=r=>{if(!r||_===r.id){b(""),S(""),R(""),C(""),O(void 0),M(void 0),g(void 0),A(void 0),t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0});return}b(r.name),S(""),R(""),C(""),O(r.id),M(void 0),g(void 0),A(void 0),t({buildingId:r.id,floorId:void 0,departmentId:void 0,divisionId:void 0})},ye=r=>{if(!r||T===r.id){S(""),R(""),C(""),M(void 0),g(void 0),A(void 0),t({buildingId:_,floorId:void 0,departmentId:void 0,divisionId:void 0});return}const U=h.find(G=>G.id===r.buildingId);U&&(b(U.name),O(U.id)),S(r.name),R(""),C(""),M(r.id),g(void 0),A(void 0),t({buildingId:r.buildingId,floorId:r.id,departmentId:void 0,divisionId:void 0})},xe=r=>{if(!r||p===r.id){R(""),C(""),g(void 0),A(void 0),t({buildingId:_,floorId:T,departmentId:void 0,divisionId:void 0});return}const U=h.find(K=>K.id===r.buildingId),G=y.find(K=>K.id===r.floorId);U&&(b(U.name),O(U.id)),G&&(S(G.name),M(G.id)),R(r.name),C(""),g(r.id),A(void 0),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.id,divisionId:void 0})},x=r=>{if(!r||P===r.id){C(""),A(void 0),t({buildingId:_,floorId:T,departmentId:p,divisionId:void 0});return}const U=h.find(Z=>Z.id===r.buildingId),G=y.find(Z=>Z.id===r.floorId),K=d.find(Z=>Z.id===r.departmentId);U&&(b(U.name),O(U.id)),G&&(S(G.name),M(G.id)),K&&(R(K.name),g(K.id)),C(r.name),A(r.id),t({buildingId:r.buildingId,floorId:r.floorId,departmentId:r.departmentId,divisionId:r.id})},q=!!(_&&T&&p&&P);return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"部署入力"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["調査日",e.jsx("input",{value:((ee=o==null?void 0:o.fields)==null?void 0:ee.surveyDate)??I,disabled:!0})]}),e.jsxs("label",{children:["調査担当",e.jsx("input",{value:((se=o==null?void 0:o.fields)==null?void 0:se.investigator)??k,disabled:!0})]})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["棟",e.jsx("input",{value:E,onChange:r=>b(r.target.value),placeholder:"棟を検索"})]}),e.jsx("div",{className:"option-list",children:de.map(r=>e.jsx("button",{onClick:()=>fe(r),className:r.id===_?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["階",e.jsx("input",{value:D,onChange:r=>S(r.target.value),placeholder:"階を検索"})]}),e.jsx("div",{className:"option-list",children:Se.map(r=>{var U;return e.jsxs("button",{onClick:()=>ye(r),className:r.id===T?"active":"",children:[r.name,"（",((U=h.find(G=>G.id===r.buildingId))==null?void 0:U.name)??"","）"]},r.id)})}),e.jsxs("label",{children:["部署",e.jsx("input",{value:L,onChange:r=>R(r.target.value),placeholder:"部署を検索"})]}),e.jsx("div",{className:"option-list",children:le.map(r=>e.jsx("button",{onClick:()=>xe(r),className:r.id===p?"active":"",children:r.name},r.id))}),e.jsxs("label",{children:["部門",e.jsx("input",{value:W,onChange:r=>C(r.target.value),placeholder:"部門を検索"})]}),e.jsx("div",{className:"option-list",children:Ce.map(r=>e.jsx("button",{onClick:()=>x(r),className:r.id===P?"active":"",children:r.name},r.id))})]}),e.jsx("p",{className:"helper-text",children:"今日一日がんばって！！"})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>c("/home"),children:"ホーム"}),e.jsx("button",{onClick:()=>c("/survey/all"),disabled:!q,children:"次へ"})]})]})}const lo=Object.freeze(Object.defineProperty({__proto__:null,default:Xa},Symbol.toStringTag,{value:"Module"})),cs=a.forwardRef(({onResult:c},o)=>{const t=a.useRef(null),h=a.useRef(null),N=a.useRef(null),[y,n]=a.useState(!1);a.useEffect(()=>(h.current=new ss,()=>{var m;(m=N.current)==null||m.stop(),N.current=null,ss.releaseAllStreams(),h.current=null,n(!1)}),[]);const d=a.useCallback(()=>{var m;(m=N.current)==null||m.stop(),N.current=null,ss.releaseAllStreams(),n(!1)},[]),u=a.useCallback(async()=>{if(!(!t.current||!h.current)&&!y){n(!0);try{N.current=await h.current.decodeFromConstraints({video:{facingMode:"environment"}},t.current,m=>{m&&(c(m.getText()),d())})}catch(m){console.error(m),n(!1),N.current=null}}},[c,y,d]);return a.useImperativeHandle(o,()=>({start:u,stop:d}),[u,d]),e.jsxs("div",{className:"qr-container",style:{display:y?"block":"none"},children:[e.jsx("video",{ref:t,className:"qr-video",muted:!0,playsInline:!0}),y&&e.jsx("div",{className:"helper-text",style:{marginTop:8},children:"読み取り中です..."})]})}),co=Object.freeze(Object.defineProperty({__proto__:null,QRScanner:cs},Symbol.toStringTag,{value:"Module"}));function us({open:c,onClose:o}){const{listHistory:t,duplicateDraft:h}=We(),[N,y]=a.useState("asc"),[n,d]=a.useState(!1),[u,m]=a.useState(null),[v,E]=a.useState([]),[b,D]=a.useState(null),[S,L]=a.useState({}),[R,W]=a.useState(null),C=async p=>{d(!0),m(null);try{const g=await t(p);E(g)}catch(g){const P=g instanceof Error?g.message:String(g);m(P),E([])}finally{d(!1)}};a.useEffect(()=>{c?(D(null),L({}),W(null),C(N)):(m(null),E([]))},[c,N]);const _=()=>{y(p=>p==="asc"?"desc":"asc")},O=(p,g)=>{L(P=>({...P,[p]:g}))},T=async p=>{const g=S[p]??"1",P=Number.parseInt(g,10);if(!Number.isFinite(P)||P<=0){D("複製数は1以上の整数を入力してください");return}W(p),D(null);try{const A=await h(p,P);D(`履歴を ${A} 件複製しました`),L(I=>({...I,[p]:""})),await C(N)}catch(A){const I=A instanceof Error?A.message:String(A);D(`複製に失敗しました: ${I}`)}finally{W(null)}},M=a.useMemo(()=>n?e.jsx("p",{className:"helper-text",children:"読み込み中..."}):u?e.jsxs("p",{className:"badge warn",children:["エラー: ",u]}):v.length===0?e.jsx("p",{className:"helper-text",children:"複製可能な履歴がありません。"}):v.map(p=>{const g=p.fields??{},P=g.completedAt??p.updatedAt,A=g.sealNo??g.qr??p.qr??"-",I=g.assetNo??"-",k=g.equipmentNo??"-",$=g.width??"-",f=g.depth??"-",F=g.height??"-",z=g.note??"",V=S[p.id]??"";return e.jsxs("div",{className:"history-row static",children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(P).toLocaleString()}),e.jsxs("span",{className:"pill",children:["QR ",A]}),I!=="-"&&e.jsxs("span",{className:"pill",children:["資産 ",I]}),k!=="-"&&e.jsxs("span",{className:"pill",children:["備品 ",k]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsxs("span",{className:"pill",children:["Category ",g.categoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Sub ",g.subcategoryId??"-"]}),e.jsxs("span",{className:"pill",children:["Item ",g.itemId??"-"]}),e.jsxs("span",{className:"pill",children:["Maker ",g.makerId??"-"]}),e.jsxs("span",{className:"pill",children:["Model ",g.modelId??"-"]})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",$]}),e.jsxs("span",{children:["D: ",f]}),e.jsxs("span",{children:["H: ",F]}),z&&e.jsxs("span",{children:["備考: ",z]})]}),e.jsxs("div",{className:"history-duplicate",children:[e.jsx("input",{type:"number",min:1,placeholder:"複製数",value:V,onChange:H=>O(p.id,H.target.value)}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>T(p.id),disabled:R===p.id,children:R===p.id?"複製中...":"複製"})]})]},p.id)}),[v,S,n,u,R]);return c?e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"複製"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:_,children:N==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:o,children:"閉じる"})]})]}),b&&e.jsx("p",{className:"badge success",style:{marginTop:8},children:b}),e.jsx("div",{className:"history-list",children:M})]})}):null}function Ya(){var g,P,A,I,k,$;yt();const c=vt(),o=a.useRef(null),{current:t,setFields:h,setQR:N}=We(),[y,n]=a.useState(""),[d,u]=a.useState(""),[m,v]=a.useState([]),[E,b]=a.useState(!1);a.useEffect(()=>{var f,F;n(((f=t==null?void 0:t.fields)==null?void 0:f.sealNo)??""),u(((F=t==null?void 0:t.fields)==null?void 0:F.roomName)??"")},[(g=t==null?void 0:t.fields)==null?void 0:g.sealNo,(P=t==null?void 0:t.fields)==null?void 0:P.roomName]),a.useEffect(()=>()=>{var f;(f=o.current)==null||f.stop()},[]),a.useEffect(()=>{let f=!0;return j.location_rooms.toArray().then(F=>{f&&v(F)}).catch(()=>{f&&v([])}),()=>{f=!1}},[]);const D=(A=t==null?void 0:t.fields)==null?void 0:A.buildingId,S=(I=t==null?void 0:t.fields)==null?void 0:I.floorId,L=(k=t==null?void 0:t.fields)==null?void 0:k.departmentId,R=($=t==null?void 0:t.fields)==null?void 0:$.divisionId,W=a.useMemo(()=>{if(!D||!S||!L||!R)return[];const f=d.trim().toLowerCase();return m.filter(F=>F.buildingId!==D||F.floorId!==S||F.departmentId!==L||F.divisionId!==R?!1:f?F.name.toLowerCase().includes(f):!0)},[m,D,S,L,R,d]),C=f=>{const F=f.trim(),z=F.match(/medical-record\/([A-Za-z0-9-]+)$/i),V=z?z[1]:F;n(V),N(V)},_=f=>{n(f),h({sealNo:f,qrCode:f})},O=f=>{u(f),h({roomName:f})},T=()=>{var f;(f=o.current)==null||f.stop(),c("/survey/department")},M=()=>{var f;(f=o.current)==null||f.stop(),c("/survey/asset")},p=!!(y.trim()&&d.trim());return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QRコード読取・ラベルNo確認"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:y,onChange:f=>_(f.target.value),placeholder:"シールNoを入力"})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:d,onChange:f=>O(f.target.value),placeholder:"室名を入力"}),W.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:W.map(f=>e.jsx("button",{type:"button",onClick:()=>O(f.name),children:f.name},f.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(cs,{ref:o,onResult:C})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>b(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:T,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:async()=>{var f;try{await is(),await((f=o.current)==null?void 0:f.start())}catch(F){const z=F instanceof Error?F.message:String(F);alert(`カメラを利用できませんでした: ${z}`)}},children:"QR撮影"}),e.jsx("button",{onClick:M,disabled:!p,children:"次へ"})]}),e.jsx(us,{open:E,onClose:()=>b(!1)})]})}const uo=Object.freeze(Object.defineProperty({__proto__:null,default:Ya},Symbol.toStringTag,{value:"Module"})),Mt={left:.08,top:.425,width:.84,height:.15},zs=1200,Ja=2e3;function os(c,o){const t=c.split(","),h=t[0].match(/:(.*?);/),N=(h==null?void 0:h[1])??o,y=atob(t[1]??""),n=y.length,d=new Uint8Array(n);for(let u=0;u<n;u+=1)d[u]=y.charCodeAt(u);return new Blob([d],{type:N})}async function eo(c,o,t){return typeof c.toBlob=="function"?await new Promise((h,N)=>{let y=!1;const n=window.setTimeout(()=>{if(!y){y=!0;try{const d=os(c.toDataURL(o,t),o);h(d)}catch(d){N(d instanceof Error?d:new Error("スナップショットの生成に失敗しました"))}}},Ja);c.toBlob(d=>{if(!y)if(y=!0,window.clearTimeout(n),d)h(d);else try{const u=os(c.toDataURL(o,t),o);h(u)}catch(u){N(u instanceof Error?u:new Error("スナップショットの生成に失敗しました"))}},o,t)}):os(c.toDataURL(o,t),o)}function Xs({open:c,targetLabel:o,onClose:t,onResult:h,onRecognized:N}){const y=a.useRef(null),n=a.useRef(null),d=a.useRef(),u=a.useRef(),[m,v]=a.useState("idle"),[E,b]=a.useState("カメラを初期化しています…"),[D,S]=a.useState(!1),[L,R]=a.useState(null),[W,C]=a.useState(null);a.useEffect(()=>{d.current=document.createElement("canvas"),u.current=document.createElement("canvas")},[]);const _=a.useCallback(()=>{R(null),C(I=>(I&&URL.revokeObjectURL(I),null))},[]),O=()=>{n.current&&(n.current.getTracks().forEach(I=>I.stop()),n.current=null),y.current&&(y.current.pause(),y.current.srcObject=null)},T=a.useCallback(async()=>{var I;if(_(),!((I=navigator.mediaDevices)!=null&&I.getUserMedia)){v("error"),b("この端末ではカメラを利用できません。手入力してください。"),S(!1);return}v("camera"),b("カメラを起動しています…");try{const k=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}});n.current=k,y.current&&(y.current.srcObject=k,await y.current.play().catch(()=>{})),v("camera"),b("枠が黒い帯に変わりました。番号を合わせて撮影してください。"),S(!1)}catch(k){const $=k instanceof Error?k.message:String(k);v("error"),b(`カメラにアクセスできません: ${$}`),S(!1)}},[_]);a.useEffect(()=>{if(!c){O(),_(),v("idle"),b("カメラを初期化しています…"),S(!1);return}return T(),()=>{O()}},[c,T]);const M=async(I,k,$)=>{const f=d.current,F=u.current;if(!f||!F||I===0||k===0)throw new Error("画像データを読み込めませんでした。");f.width=I,f.height=k;const z=f.getContext("2d");if(!z)throw new Error("画像の処理に失敗しました。");$(z);const V=F.getContext("2d");if(!V)throw new Error("画像の処理に失敗しました。");const H={x:Math.floor(f.width*Mt.left),y:Math.floor(f.height*Mt.top),width:Math.floor(f.width*Mt.width),height:Math.floor(f.height*Mt.height)},he=H.width>zs?zs/H.width:1,te=Math.max(320,Math.round(H.width*he)),de=Math.max(120,Math.round(H.height*he));return F.width=te,F.height=de,V.filter="contrast(160%) brightness(115%) grayscale(15%)",V.drawImage(f,H.x,H.y,H.width,H.height,0,0,te,de),eo(F,"image/jpeg",.92)},p=async()=>{if(!c||D||m!=="camera")return;const I=y.current;if(!I||I.videoWidth===0||I.videoHeight===0){v("error"),b("カメラ映像を取得できませんでした。");return}S(!0),b("撮影中…");try{const k=await M(I.videoWidth,I.videoHeight,f=>{f.drawImage(I,0,0,I.videoWidth,I.videoHeight)});O(),_();const $=URL.createObjectURL(k);R(k),C($),v("photo"),b("写真を保存しました。読み取りボタンを押してください。"),S(!1)}catch(k){const $=k instanceof Error?k.message:String(k);v("error"),b(`撮影に失敗しました: ${$}`),S(!1)}},g=async()=>{if(!(!L||D)){v("processing"),S(!0),b("読み取り中です。1秒ほどお待ちください…");try{const I=await Va(L);I.text?(h(I.text),b(`認識した値: ${I.text}`),N==null||N({text:I.text,method:I.method,targetLabel:o}),t()):(v("error"),b("文字を検出できませんでした。撮り直して再試行してください。"),S(!1))}catch(I){const k=I instanceof Error?I.message:String(I);v("error"),b(`読み取りに失敗しました: ${k}`),S(!1)}}},P=()=>{D||(_(),T())},A=a.useMemo(()=>m==="photo"?"撮影した画像を確認し、問題なければ「読み取る」を押してください。":m==="processing"?"しばらくお待ちください…":m==="error"?"カメラや照明の状態を確認してください。":"黒いガイド帯の中央に番号を重ね、影や反射を避けて撮影すると精度が上がります。",[m]);return c?e.jsx("div",{className:"ocr-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"ocr-panel",children:[e.jsxs("header",{className:"ocr-header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"ocr-eyebrow",children:"テキストスキャン"}),e.jsxs("h3",{children:[o,"の読み取り"]})]}),e.jsx("button",{type:"button",className:"ghost",onClick:t,children:"閉じる"})]}),e.jsx("div",{className:"ocr-video-container",children:W?e.jsx("img",{src:W,alt:"撮影した画像",className:"ocr-preview"}):e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:y,playsInline:!0,autoPlay:!0,muted:!0,className:"ocr-video"}),e.jsx("div",{className:"ocr-frame","aria-hidden":"true",children:e.jsx("span",{className:"ocr-frame__label",children:"黒い帯に合わせてください"})})]})}),e.jsx("p",{className:"helper-text",children:A}),e.jsx("p",{className:`ocr-message ${m==="error"?"is-error":""}`,children:E}),e.jsxs("footer",{className:"ocr-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:t,disabled:D&&m==="processing",children:"キャンセル"}),L&&e.jsx("button",{type:"button",className:"ghost",onClick:P,disabled:D,children:"撮り直し"}),!L&&e.jsx("button",{type:"button",onClick:p,className:"secondary",disabled:D||m!=="camera",children:"撮影"}),L&&e.jsx("button",{type:"button",onClick:g,className:"secondary",disabled:D,children:m==="processing"?"読み取り中...":"読み取る"})]})]})}):null}function to(){var de,Se,le,Ce,fe,ye,xe;yt();const c=vt(),o=a.useRef(null),{current:t,photos:h,attachPhoto:N,removePhoto:y,setFields:n}=We(),[d,u]=a.useState(""),[m,v]=a.useState(""),[E,b]=a.useState(""),[D,S]=a.useState(!1),[L,R]=a.useState(!1),[W,C]=a.useState(!1),[_,O]=a.useState("assetNo"),[T,M]=a.useState(!1),[p,g]=a.useState(null);a.useEffect(()=>{Vs()},[]),a.useEffect(()=>{var x,q,ie,ne,Ie;u(((x=t==null?void 0:t.fields)==null?void 0:x.assetNo)??""),v(((q=t==null?void 0:t.fields)==null?void 0:q.equipmentNo)??""),b(((ie=t==null?void 0:t.fields)==null?void 0:ie.purchaseDate)??""),S(!!((ne=t==null?void 0:t.fields)!=null&&ne.leaseFlag)),R(!!((Ie=t==null?void 0:t.fields)!=null&&Ie.loanedFlag))},[(de=t==null?void 0:t.fields)==null?void 0:de.assetNo,(Se=t==null?void 0:t.fields)==null?void 0:Se.equipmentNo,(le=t==null?void 0:t.fields)==null?void 0:le.purchaseDate,(Ce=t==null?void 0:t.fields)==null?void 0:Ce.leaseFlag,(fe=t==null?void 0:t.fields)==null?void 0:fe.loanedFlag]);const P=((ye=t==null?void 0:t.fields)==null?void 0:ye.sealNo)??"",A=((xe=t==null?void 0:t.fields)==null?void 0:xe.roomName)??"",I=a.useMemo(()=>h.map(x=>({id:x.id,url:URL.createObjectURL(x.thumb)})),[h]),k=async x=>{if(!x||x.length===0)return;const q=x[0];await N(q),o.current&&(o.current.value="")},$=()=>{const x=!D;S(x),n({leaseFlag:x})},f=()=>{const x=!L;R(x),n({loanedFlag:x})},F=()=>{c("/survey/label")},z=()=>{c("/survey/product")},V=h.length>0,H=x=>{x&&(_==="assetNo"?(u(x),n({assetNo:x})):(v(x),n({equipmentNo:x})))},he=a.useCallback(x=>{g(`${x.targetLabel}を読み取り: ${x.text}`)},[]);a.useEffect(()=>{if(!p)return;const x=window.setTimeout(()=>g(null),5e3);return()=>{window.clearTimeout(x)}},[p]);const te=x=>{O(x),M(!0)};return e.jsxs("div",{className:"page",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:o,style:{display:"none"},onChange:x=>k(x.target.files)}),e.jsxs("div",{className:"page-section",children:[p&&e.jsx("div",{className:"ocr-result-banner",children:p}),e.jsx("h2",{className:"section-title",children:"写真撮影・資産No登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["シールNo",e.jsx("input",{value:P,disabled:!0})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:A,disabled:!0})]}),e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:d,onChange:x=>{const q=x.target.value;u(q),n({assetNo:q})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:m,onChange:x=>{const q=x.target.value;v(q),n({equipmentNo:q})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>te("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",value:E,onChange:x=>{const q=x.target.value;b(q),n({purchaseDate:q})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:D?"secondary":"ghost",onClick:$,children:["リース: ",D?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:L?"secondary":"ghost",onClick:f,children:["貸出品: ",L?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:I.map(x=>e.jsxs("div",{className:"photo-item",children:[e.jsx("button",{type:"button",className:"photo-remove",onClick:()=>y(x.id),"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:x.url,alt:"サムネイル"})]},x.id))})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{className:"ghost",onClick:()=>C(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:F,children:"戻る"}),e.jsx("button",{className:"secondary",onClick:()=>{var x;return(x=o.current)==null?void 0:x.click()},children:"写真"}),e.jsx("button",{onClick:z,disabled:!V,children:"次へ"})]}),e.jsx(us,{open:W,onClose:()=>C(!1)}),e.jsx(Xs,{open:T,targetLabel:_==="assetNo"?"資産番号":"備品番号",onClose:()=>M(!1),onResult:H,onRecognized:he})]})}const mo=Object.freeze(Object.defineProperty({__proto__:null,default:to},Symbol.toStringTag,{value:"Module"}));function pt(c,o){return o?c.toLowerCase().includes(o.toLowerCase()):!0}function so(){var Ke,jt,Ze,wt,dt,Ve,lt,Xe,ct;yt();const c=vt(),{current:o,setFields:t,completeCurrent:h,listHistory:N}=We(),[y,n]=a.useState([]),[d,u]=a.useState([]),[m,v]=a.useState([]),[E,b]=a.useState([]),[D,S]=a.useState([]),[L,R]=a.useState(""),[W,C]=a.useState(""),[_,O]=a.useState(""),[T,M]=a.useState(""),[p,g]=a.useState(""),[P,A]=a.useState(""),[I,k]=a.useState(""),[$,f]=a.useState(""),[F,z]=a.useState(""),[V,H]=a.useState(!1),[he,te]=a.useState(!1),[de,Se]=a.useState([]),[le,Ce]=a.useState(!1),[fe,ye]=a.useState(null),[xe,x]=a.useState("asc"),q=a.useRef(void 0),ie=a.useRef(void 0),ne=a.useRef(void 0),Ie=a.useRef(void 0),Ne=a.useRef(void 0);a.useEffect(()=>{Promise.all([j.product_categories.toArray(),j.product_subcategories.toArray(),j.product_items.toArray(),j.product_makers.toArray(),j.product_models.toArray()]).then(([i,w,ue,ge,je])=>{n(i),u(w),v(ue),b(ge),S(je)})},[]),a.useEffect(()=>{var i,w,ue,ge;A(((i=o==null?void 0:o.fields)==null?void 0:i.width)??""),k(((w=o==null?void 0:o.fields)==null?void 0:w.depth)??""),f(((ue=o==null?void 0:o.fields)==null?void 0:ue.height)??""),z(((ge=o==null?void 0:o.fields)==null?void 0:ge.note)??"")},[(Ke=o==null?void 0:o.fields)==null?void 0:Ke.width,(jt=o==null?void 0:o.fields)==null?void 0:jt.depth,(Ze=o==null?void 0:o.fields)==null?void 0:Ze.height,(wt=o==null?void 0:o.fields)==null?void 0:wt.note]);const ee=(dt=o==null?void 0:o.fields)==null?void 0:dt.categoryId,se=(Ve=o==null?void 0:o.fields)==null?void 0:Ve.subcategoryId,r=(lt=o==null?void 0:o.fields)==null?void 0:lt.itemId,U=(Xe=o==null?void 0:o.fields)==null?void 0:Xe.makerId,G=(ct=o==null?void 0:o.fields)==null?void 0:ct.modelId,K=y.find(i=>i.id===ee),Z=d.find(i=>i.id===se),be=m.find(i=>i.id===r),J=E.find(i=>i.id===U),ce=D.find(i=>i.id===G);a.useEffect(()=>{(K==null?void 0:K.id)!==q.current&&(K?R(K.name):q.current&&R(""),q.current=K==null?void 0:K.id)},[K]),a.useEffect(()=>{(Z==null?void 0:Z.id)!==ie.current&&(Z?C(Z.name):ie.current&&C(""),ie.current=Z==null?void 0:Z.id)},[Z]),a.useEffect(()=>{(be==null?void 0:be.id)!==ne.current&&(be?O(be.name):ne.current&&O(""),ne.current=be==null?void 0:be.id)},[be]),a.useEffect(()=>{(J==null?void 0:J.id)!==Ie.current&&(J?M(J.name):Ie.current&&M(""),Ie.current=J==null?void 0:J.id)},[J]),a.useEffect(()=>{(ce==null?void 0:ce.id)!==Ne.current&&(ce?g(ce.name):Ne.current&&g(""),Ne.current=ce==null?void 0:ce.id)},[ce]);const ze=a.useMemo(()=>y.filter(i=>pt(i.name,L)),[y,L]),At=a.useMemo(()=>d.filter(i=>pt(i.name,W)),[d,W]),Ft=a.useMemo(()=>m.filter(i=>pt(i.name,_)),[m,_]),xt=a.useMemo(()=>E.filter(i=>pt(i.name,T)),[E,T]),ot=a.useMemo(()=>D.filter(i=>pt(i.name,p)),[D,p]),it=i=>{if(ee===i.id){R(""),C(""),O(""),M(""),g(""),t({categoryId:void 0,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}R(i.name),C(""),O(""),M(""),g(""),t({categoryId:i.id,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0})},nt=i=>{if(se===i.id){C(""),O(""),M(""),g(""),t({categoryId:ee??i.categoryId,subcategoryId:void 0,itemId:void 0,makerId:void 0,modelId:void 0});return}C(i.name),O(""),M(""),g(""),t({categoryId:i.categoryId,subcategoryId:i.id,itemId:void 0,makerId:void 0,modelId:void 0})},rt=i=>{if(r===i.id){O(""),M(""),g(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:void 0,makerId:void 0,modelId:void 0});return}O(i.name),M(""),g(""),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.id,makerId:void 0,modelId:void 0})},It=i=>{if(U===i.id){M(""),g(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:r??i.itemId,makerId:void 0,modelId:void 0});return}M(i.name),g(""),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.id,modelId:void 0})},Pt=i=>{if(G===i.id){g(""),t({categoryId:ee??i.categoryId,subcategoryId:se??i.subcategoryId,itemId:r??i.itemId,makerId:U??i.makerId,modelId:void 0});return}g(i.name),t({categoryId:i.categoryId,subcategoryId:i.subcategoryId,itemId:i.itemId,makerId:i.makerId,modelId:i.id})},Nt=a.useCallback(async i=>{Ce(!0),ye(null);try{const w=await N(i);Se(w)}catch(w){const ue=w instanceof Error?w.message:String(w);ye(ue),Se([])}finally{Ce(!1)}},[N]);a.useEffect(()=>{V?Nt(xe):ye(null)},[V,xe,Nt]);const bt=i=>{const w=i.categoryId,ue=i.subcategoryId,ge=i.itemId,je=i.makerId,Le=i.modelId,Ue=i.width!=null?String(i.width):"",Ye=i.depth!=null?String(i.depth):"",Je=i.height!=null?String(i.height):"",et=i.note!=null?String(i.note):"";A(Ue),k(Ye),f(Je),z(et);const Be=y.find(re=>re.id===w),Ee=d.find(re=>re.id===ue),Me=m.find(re=>re.id===ge),Ae=E.find(re=>re.id===je),pe=D.find(re=>re.id===Le);R((Be==null?void 0:Be.name)??""),C((Ee==null?void 0:Ee.name)??""),O((Me==null?void 0:Me.name)??""),M((Ae==null?void 0:Ae.name)??""),g((pe==null?void 0:pe.name)??""),t({categoryId:w,subcategoryId:ue,itemId:ge,makerId:je,modelId:Le,width:Ue,depth:Ye,height:Je,note:et})},Qt=i=>{bt(i.fields??{}),H(!1)},Tt=()=>{x(i=>i==="asc"?"desc":"asc")},Ge=async()=>{await h({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),c("/survey/label")},Lt=()=>{t({buildingId:void 0,floorId:void 0,departmentId:void 0,divisionId:void 0}),c("/survey/department")};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"商品登録"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:L,onChange:i=>R(i.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:ze.map(i=>e.jsx("button",{onClick:()=>it(i),className:i.id===ee?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:W,onChange:i=>C(i.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:At.map(i=>e.jsx("button",{onClick:()=>nt(i),className:i.id===se?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:_,onChange:i=>O(i.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:Ft.map(i=>e.jsx("button",{onClick:()=>rt(i),className:i.id===r?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:T,onChange:i=>M(i.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:xt.map(i=>e.jsx("button",{onClick:()=>It(i),className:i.id===U?"active":"",children:i.name},i.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:p,onChange:i=>g(i.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:ot.map(i=>e.jsx("button",{onClick:()=>Pt(i),className:i.id===G?"active":"",children:i.name},i.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("label",{children:["W",e.jsx("input",{value:P,onChange:i=>{const w=i.target.value;A(w),t({width:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:I,onChange:i=>{const w=i.target.value;k(w),t({depth:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:$,onChange:i=>{const w=i.target.value;f(w),t({height:w})},placeholder:"mm"})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:F,onChange:i=>{const w=i.target.value;z(w),t({note:w})},rows:3})]})]}),e.jsx("div",{className:"row",style:{justifyContent:"flex-start",marginTop:8},children:e.jsx("button",{type:"button",className:"ghost",onClick:()=>H(!0),children:"履歴表示"})})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>te(!0),children:"複製"}),e.jsx("button",{className:"ghost",onClick:()=>c("/survey/asset"),children:"戻る"}),e.jsx("button",{className:"secondary",onClick:Lt,children:"部門"}),e.jsx("button",{onClick:Ge,children:"次へ"})]}),V&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:Tt,children:xe==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>H(!1),children:"閉じる"})]})]}),le&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),fe&&e.jsxs("p",{className:"badge warn",children:["エラー: ",fe]}),!le&&!fe&&de.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!le&&!fe&&de.length>0&&e.jsx("div",{className:"history-list",children:de.map(i=>{var Ee,Me,Ae,pe,re;const w=i.fields??{},ue=w.completedAt??i.updatedAt,ge=((Ee=y.find(oe=>oe.id===w.categoryId))==null?void 0:Ee.name)??"-",je=((Me=d.find(oe=>oe.id===w.subcategoryId))==null?void 0:Me.name)??"-",Le=((Ae=m.find(oe=>oe.id===w.itemId))==null?void 0:Ae.name)??"-",Ue=((pe=E.find(oe=>oe.id===w.makerId))==null?void 0:pe.name)??"-",Ye=((re=D.find(oe=>oe.id===w.modelId))==null?void 0:re.name)??"-",Je=w.width??"-",et=w.depth??"-",Be=w.height??"-";return e.jsxs("button",{type:"button",className:"history-row",onClick:()=>Qt(i),children:[e.jsxs("div",{className:"history-meta",children:[e.jsx("span",{children:new Date(ue).toLocaleString()}),w.assetNo&&e.jsxs("span",{className:"pill",children:["資産 ",w.assetNo]}),w.equipmentNo&&e.jsxs("span",{className:"pill",children:["備品 ",w.equipmentNo]}),w.sealNo&&e.jsxs("span",{className:"pill",children:["QR ",w.sealNo]})]}),e.jsxs("div",{className:"history-tags",children:[e.jsx("span",{className:"pill",children:ge}),e.jsx("span",{className:"pill",children:je}),e.jsx("span",{className:"pill",children:Le}),e.jsx("span",{className:"pill",children:Ue}),e.jsx("span",{className:"pill",children:Ye})]}),e.jsxs("div",{className:"history-meta",children:[e.jsxs("span",{children:["W: ",Je]}),e.jsxs("span",{children:["D: ",et]}),e.jsxs("span",{children:["H: ",Be]})]})]},i.id)})})]})}),e.jsx(us,{open:he,onClose:()=>te(!1)})]})}const ho=Object.freeze(Object.defineProperty({__proto__:null,default:so},Symbol.toStringTag,{value:"Module"}));function Oe(c,o){return o?c.toLowerCase().includes(o.toLowerCase()):!0}function fo(){var gs,ps,vs,ys,xs,Is,Ns,bs,js,ws,Ss,Cs,ks,Es,_s,Ds,Rs,Os,Ms,As,Fs,Ps,Qs,Ts,Ls,Us,Bs,$s,Hs;yt();const c=vt(),o=We(),{current:t,photos:h,attachPhoto:N,removePhoto:y,setFields:n,completeCurrent:d,listHistory:u,load:m,completedCount:v,duplicateDraft:E,setQR:b,togglePhotoForList:D}=o,[S,L]=a.useState([]),[R,W]=a.useState([]),[C,_]=a.useState([]),[O,T]=a.useState([]),[M,p]=a.useState(""),[g,P]=a.useState(""),[A,I]=a.useState(""),[k,$]=a.useState(""),[f,F]=a.useState(void 0),[z,V]=a.useState(void 0),[H,he]=a.useState(void 0),[te,de]=a.useState(void 0),Se=a.useMemo(()=>{const s=new Date;return`${s.getFullYear()}年${String(s.getMonth()+1).padStart(2,"0")}月${String(s.getDate()).padStart(2,"0")}日`},[]),le=typeof window<"u"?sessionStorage.getItem("mockUserEmail")??"":"";a.useEffect(()=>{Promise.all([j.location_buildings.toArray(),j.location_floors.toArray(),j.location_departments.toArray(),j.location_divisions.toArray()]).then(([s,l,Q,B])=>{L(s),W(l),_(Q),T(B)})},[]),a.useEffect(()=>{var l,Q;if(!t)return;const s={};(l=t.fields)!=null&&l.surveyDate||(s.surveyDate=Se),le&&((Q=t.fields)==null?void 0:Q.investigator)!==le&&(s.investigator=le),Object.keys(s).length>0&&n(s)},[t,le,n,Se]);const Ce=(gs=t==null?void 0:t.fields)==null?void 0:gs.buildingId,fe=(ps=t==null?void 0:t.fields)==null?void 0:ps.floorId,ye=(vs=t==null?void 0:t.fields)==null?void 0:vs.departmentId,xe=(ys=t==null?void 0:t.fields)==null?void 0:ys.divisionId;a.useEffect(()=>{F(Ce)},[Ce]),a.useEffect(()=>{V(fe)},[fe]),a.useEffect(()=>{he(ye)},[ye]),a.useEffect(()=>{de(xe)},[xe]);const x=a.useMemo(()=>S.find(s=>s.id===f),[S,f]),q=a.useMemo(()=>R.find(s=>s.id===z),[R,z]),ie=a.useMemo(()=>C.find(s=>s.id===H),[C,H]),ne=a.useMemo(()=>O.find(s=>s.id===te),[O,te]);a.useEffect(()=>{p((x==null?void 0:x.name)??"")},[x]),a.useEffect(()=>{P((q==null?void 0:q.name)??"")},[q]),a.useEffect(()=>{I((ie==null?void 0:ie.name)??"")},[ie]),a.useEffect(()=>{$((ne==null?void 0:ne.name)??"")},[ne]),a.useMemo(()=>S.filter(s=>Oe(s.name,M)),[S,M]),a.useMemo(()=>R.filter(s=>Oe(s.name,g)),[R,g]),a.useMemo(()=>C.filter(s=>Oe(s.name,A)),[C,A]),a.useMemo(()=>O.filter(s=>Oe(s.name,k)),[O,k]);const Ie=!!(f&&z&&H&&te),Ne=a.useRef(null),[ee,se]=a.useState(""),[r,U]=a.useState(""),[G,K]=a.useState([]),[Z,be]=a.useState(!1),[J,ce]=a.useState(""),[ze,At]=a.useState(""),[Ft,xt]=a.useState("single");a.useEffect(()=>{var s,l;se(((s=t==null?void 0:t.fields)==null?void 0:s.sealNo)??""),U(((l=t==null?void 0:t.fields)==null?void 0:l.roomName)??"")},[(xs=t==null?void 0:t.fields)==null?void 0:xs.sealNo,(Is=t==null?void 0:t.fields)==null?void 0:Is.roomName]),a.useEffect(()=>()=>{var s;(s=Ne.current)==null||s.stop()},[]),a.useEffect(()=>{let s=!0;return j.location_rooms.toArray().then(l=>{s&&K(l)}).catch(()=>{s&&K([])}),()=>{s=!1}},[]);const ot=(Ns=t==null?void 0:t.fields)==null?void 0:Ns.buildingId,it=(bs=t==null?void 0:t.fields)==null?void 0:bs.floorId,nt=(js=t==null?void 0:t.fields)==null?void 0:js.departmentId,rt=(ws=t==null?void 0:t.fields)==null?void 0:ws.divisionId,It=a.useMemo(()=>{if(!ot||!it||!nt||!rt)return[];const s=r.trim().toLowerCase();return G.filter(l=>l.buildingId!==ot||l.floorId!==it||l.departmentId!==nt||l.divisionId!==rt?!1:s?l.name.toLowerCase().includes(s):!0)},[G,ot,it,nt,rt,r]),Pt=s=>{const l=s.trim(),Q=l.match(/https?:\/\/[^/]+\/x\/([A-Za-z0-9-]+)$/i),B=l.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i),X=Q&&Q[1]||B&&B[0]||l;Ft==="bulkStart"?ce(X):(se(X),b(X))},Nt=s=>{se(s),n({sealNo:s,qrCode:s})},bt=s=>{U(s),n({roomName:s})},Qt=s=>{be(s),s?ee.trim()&&ce(ee):J.trim()&&(se(J),n({sealNo:J,qrCode:J}))},Tt=a.useMemo(()=>{const s=r.trim().length>0,l=ee.trim().length>0,Q=J.trim().length>0,B=Number.parseInt(ze,10),X=Z&&Q&&Number.isFinite(B)&&B>0;return s&&(!Z&&l||X)},[Z,ze,J,r,ee]),Ge=a.useRef(null),[Lt,Ke]=a.useState(""),[jt,Ze]=a.useState(""),[wt,dt]=a.useState(""),[Ve,lt]=a.useState(!1),[Xe,ct]=a.useState(!1),[i,w]=a.useState("assetNo"),[ue,ge]=a.useState(!1),[je,Le]=a.useState(null);a.useEffect(()=>{Vs()},[]),a.useEffect(()=>{var s,l,Q,B,X;Ke(((s=t==null?void 0:t.fields)==null?void 0:s.assetNo)??""),Ze(((l=t==null?void 0:t.fields)==null?void 0:l.equipmentNo)??""),dt(((Q=t==null?void 0:t.fields)==null?void 0:Q.purchaseDate)??""),lt(!!((B=t==null?void 0:t.fields)!=null&&B.leaseFlag)),ct(!!((X=t==null?void 0:t.fields)!=null&&X.loanedFlag))},[(Ss=t==null?void 0:t.fields)==null?void 0:Ss.assetNo,(Cs=t==null?void 0:t.fields)==null?void 0:Cs.equipmentNo,(ks=t==null?void 0:t.fields)==null?void 0:ks.purchaseDate,(Es=t==null?void 0:t.fields)==null?void 0:Es.leaseFlag,(_s=t==null?void 0:t.fields)==null?void 0:_s.loanedFlag]);const Ue=a.useMemo(()=>h.map(s=>({id:s.id,url:URL.createObjectURL(s.thumb),selectedForList:!!s.selectedForList})),[h]),Ye=async s=>{if(!s||s.length===0)return;const l=s[0];await N(l),Ge.current&&(Ge.current.value="")},Je=()=>{const s=!Ve;lt(s),n({leaseFlag:s})},et=()=>{const s=!Xe;ct(s),n({loanedFlag:s})},Be=s=>{s&&(i==="assetNo"?(Ke(s),n({assetNo:s})):(Ze(s),n({equipmentNo:s})))},Ee=s=>{w(s),ge(!0)},Me=a.useCallback(s=>{Le(`${s.targetLabel}を読み取り: ${s.text}`)},[]);a.useEffect(()=>{if(!je)return;const s=window.setTimeout(()=>Le(null),5e3);return()=>{window.clearTimeout(s)}},[je]);const Ae=h.length>0,[pe,re]=a.useState([]),[oe,Ys]=a.useState([]),[ut,Js]=a.useState([]),[mt,ea]=a.useState([]),[ht,ta]=a.useState([]),[Ut,ft]=a.useState(""),[Bt,$e]=a.useState(""),[$t,_e]=a.useState(""),[Ht,we]=a.useState(""),[qt,me]=a.useState(""),[sa,Wt]=a.useState(""),[aa,zt]=a.useState(""),[oa,Gt]=a.useState(""),[ia,Kt]=a.useState(""),[Zt,Vt]=a.useState(!1),[Xt,ms]=a.useState([]),[Yt,hs]=a.useState(!1),[St,Jt]=a.useState(null),[es,na]=a.useState("asc");a.useEffect(()=>{Promise.all([j.product_categories.toArray(),j.product_subcategories.toArray(),j.product_items.toArray(),j.product_makers.toArray(),j.product_models.toArray()]).then(([s,l,Q,B,X])=>{re(s),Ys(l),Js(Q),ea(B),ta(X)})},[]),a.useEffect(()=>{var s,l,Q,B;Wt(((s=t==null?void 0:t.fields)==null?void 0:s.width)??""),zt(((l=t==null?void 0:t.fields)==null?void 0:l.depth)??""),Gt(((Q=t==null?void 0:t.fields)==null?void 0:Q.height)??""),Kt(((B=t==null?void 0:t.fields)==null?void 0:B.note)??"")},[(Ds=t==null?void 0:t.fields)==null?void 0:Ds.width,(Rs=t==null?void 0:t.fields)==null?void 0:Rs.depth,(Os=t==null?void 0:t.fields)==null?void 0:Os.height,(Ms=t==null?void 0:t.fields)==null?void 0:Ms.note]);const He=(As=t==null?void 0:t.fields)==null?void 0:As.categoryId,tt=(Fs=t==null?void 0:t.fields)==null?void 0:Fs.subcategoryId,gt=(Ps=t==null?void 0:t.fields)==null?void 0:Ps.itemId,Ct=(Qs=t==null?void 0:t.fields)==null?void 0:Qs.makerId,ts=(Ts=t==null?void 0:t.fields)==null?void 0:Ts.modelId,kt=pe.find(s=>s.id===He),Et=oe.find(s=>s.id===tt),_t=ut.find(s=>s.id===gt),Dt=mt.find(s=>s.id===Ct),Rt=ht.find(s=>s.id===ts);a.useEffect(()=>{const s=(t==null?void 0:t.fields)??{},l=s.categoryName??(kt==null?void 0:kt.name)??"",Q=s.subcategoryName??(Et==null?void 0:Et.name)??"",B=s.itemName??(_t==null?void 0:_t.name)??"",X=s.makerName??(Dt==null?void 0:Dt.name)??"",ve=s.modelName??(Rt==null?void 0:Rt.name)??"";ft(l),$e(Q),_e(B),we(X),me(ve)},[(Ls=t==null?void 0:t.fields)==null?void 0:Ls.categoryName,(Us=t==null?void 0:t.fields)==null?void 0:Us.subcategoryName,(Bs=t==null?void 0:t.fields)==null?void 0:Bs.itemName,($s=t==null?void 0:t.fields)==null?void 0:$s.makerName,(Hs=t==null?void 0:t.fields)==null?void 0:Hs.modelName,kt,Et,_t,Dt,Rt]);const ra=a.useMemo(()=>pe.filter(s=>Oe(s.name,Ut)),[pe,Ut]),da=a.useMemo(()=>oe.filter(s=>Oe(s.name,Bt)),[oe,Bt]),la=a.useMemo(()=>ut.filter(s=>Oe(s.name,$t)),[ut,$t]),ca=a.useMemo(()=>mt.filter(s=>Oe(s.name,Ht)),[mt,Ht]),ua=a.useMemo(()=>ht.filter(s=>Oe(s.name,qt)),[ht,qt]),ma=s=>{ft(s),n({categoryName:s})},ha=s=>{$e(s),n({subcategoryName:s})},fa=s=>{_e(s),n({itemName:s})},ga=s=>{we(s),n({makerName:s})},pa=s=>{me(s),n({modelName:s})},va=s=>{if(He===s.id){ft(""),$e(""),_e(""),we(""),me(""),n({categoryId:void 0,categoryName:void 0,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}ft(s.name),$e(""),_e(""),we(""),me(""),n({categoryId:s.id,categoryName:s.name,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},ya=s=>{if(tt===s.id){$e(""),_e(""),we(""),me(""),n({categoryId:He??s.categoryId,subcategoryId:void 0,subcategoryName:void 0,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}$e(s.name),_e(""),we(""),me(""),n({categoryId:s.categoryId,subcategoryId:s.id,subcategoryName:s.name,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},xa=s=>{if(gt===s.id){_e(""),we(""),me(""),n({categoryId:He??s.categoryId,subcategoryId:tt??s.subcategoryId,itemId:void 0,itemName:void 0,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}_e(s.name),we(""),me(""),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.id,itemName:s.name,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0})},Ia=s=>{if(Ct===s.id){we(""),me(""),n({categoryId:He??s.categoryId,subcategoryId:tt??s.subcategoryId,itemId:gt??s.itemId,makerId:void 0,makerName:void 0,modelId:void 0,modelName:void 0});return}we(s.name),me(""),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.id,makerName:s.name,modelId:void 0,modelName:void 0})},Na=s=>{if(ts===s.id){me(""),n({categoryId:He??s.categoryId,subcategoryId:tt??s.subcategoryId,itemId:gt??s.itemId,makerId:Ct??s.makerId,modelId:void 0,modelName:void 0});return}me(s.name),n({categoryId:s.categoryId,subcategoryId:s.subcategoryId,itemId:s.itemId,makerId:s.makerId,modelId:s.id,modelName:s.name})},fs=a.useCallback(async s=>{hs(!0),Jt(null);try{const l=await u(s);ms(l)}catch(l){const Q=l instanceof Error?l.message:String(l);Jt(Q),ms([])}finally{hs(!1)}},[u]);a.useEffect(()=>{Zt?fs(es):Jt(null)},[Zt,es,fs]);const ba=s=>{const l=s.categoryId,Q=s.subcategoryId,B=s.itemId,X=s.makerId,ve=s.modelId,De=s.width!=null?String(s.width):"",ke=s.depth!=null?String(s.depth):"",qe=s.height!=null?String(s.height):"",st=s.note!=null?String(s.note):"";Wt(De),zt(ke),Gt(qe),Kt(st);const Re=pe.find(Y=>Y.id===l),Fe=oe.find(Y=>Y.id===Q),Pe=ut.find(Y=>Y.id===B),Qe=mt.find(Y=>Y.id===X),Te=ht.find(Y=>Y.id===ve);ft((Re==null?void 0:Re.name)??""),$e((Fe==null?void 0:Fe.name)??""),_e((Pe==null?void 0:Pe.name)??""),we((Qe==null?void 0:Qe.name)??""),me((Te==null?void 0:Te.name)??""),n({categoryId:l,subcategoryId:Q,itemId:B,makerId:X,modelId:ve,width:De,depth:ke,height:qe,note:st})},ja=s=>{ba(s.fields??{}),Vt(!1)},wa=()=>{na(s=>s==="asc"?"desc":"asc")},Sa=async()=>{var X;if(!Z){const ve=((X=t==null?void 0:t.fields)==null?void 0:X.sealNo)??ee;let De=null;if(ve){const ke=ve.match(/(\d+)(?!.*\d)/);if(ke&&ke.index!==void 0){const qe=ke.index,st=Number.parseInt(ke[1],10),Re=ke[1].length,Fe=ve.slice(0,qe),Pe=ve.slice(qe+Re),Qe=st+1,Te=String(Qe).padStart(Re,"0");De=`${Fe}${Te}${Pe}`}}await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]}),De&&(se(De),await b(De));return}const s=J.trim(),l=Number.parseInt(ze,10);if(!s||!Number.isFinite(l)||l<=0){alert("一括登録モードでは、開始シールNoと1以上の登録個数を入力してください。");return}if(!t)return;const Q=t.id;se(s),await b(s),await d({preserveKeys:["surveyDate","investigator","buildingId","floorId","departmentId","divisionId"]});const B=l-1;B>0&&await E(Q,B)},Ca=async()=>{try{const l=(await u("desc"))[0];if(!l)return;await m(l.id)}catch(s){console.error(s)}};return e.jsxs("div",{className:"page",children:[e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"QR読取・基本情報"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["登録モード",e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"checkbox",checked:Z,onChange:s=>Qt(s.target.checked),style:{width:16,height:16}}),e.jsx("span",{children:"一括登録モード"})]})]}),Z?e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:["開始シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:J,onChange:s=>ce(s.target.value),placeholder:"開始シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{xt("bulkStart"),await is(),await((s=Ne.current)==null?void 0:s.start())}catch(l){const Q=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${Q}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["登録個数",e.jsx("input",{type:"number",min:1,value:ze,onChange:s=>At(s.target.value),placeholder:"個数を入力（例：椅子50脚の場合は「50」と入力）"})]})]}):e.jsxs("label",{children:["シールNo",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:ee,onChange:s=>Nt(s.target.value),placeholder:"シールNoを入力"}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:async()=>{var s;try{xt("single"),await is(),await((s=Ne.current)==null?void 0:s.start())}catch(l){const Q=l instanceof Error?l.message:String(l);alert(`カメラを利用できませんでした: ${Q}`)}},children:"QR撮影"})]})]}),e.jsxs("label",{children:["室名",e.jsx("input",{value:r,onChange:s=>bt(s.target.value),placeholder:"室名を入力"}),It.length>0&&e.jsx("div",{className:"option-list",style:{marginTop:6},children:It.map(s=>e.jsx("button",{type:"button",onClick:()=>bt(s.name),children:s.name},s.id))})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsx(cs,{ref:Ne,onResult:Pt})})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"写真撮影・資産番号"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsx("input",{type:"file",accept:"image/*",capture:"environment",ref:Ge,style:{display:"none"},onChange:s=>Ye(s.target.files)}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["資産番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:Lt,onChange:s=>{const l=s.target.value;Ke(l),n({assetNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Ee("assetNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["備品番号",e.jsxs("div",{className:"input-with-action",children:[e.jsx("input",{value:jt,onChange:s=>{const l=s.target.value;Ze(l),n({equipmentNo:l})}}),e.jsx("button",{type:"button",className:"ghost input-action",onClick:()=>Ee("equipmentNo"),children:"読み取り"})]})]}),e.jsxs("label",{children:["購入年月日",e.jsx("input",{type:"date",className:"date-input",value:wt,onChange:s=>{const l=s.target.value;dt(l),n({purchaseDate:l})}})]}),e.jsxs("div",{className:"row",children:[e.jsxs("button",{type:"button",className:Ve?"secondary":"ghost",onClick:Je,children:["リース: ",Ve?"ON":"OFF"]}),e.jsxs("button",{type:"button",className:Xe?"secondary":"ghost",onClick:et,children:["貸出品: ",Xe?"ON":"OFF"]})]})]}),e.jsx("div",{className:"photo-strip",children:Ue.length===0?e.jsx("div",{className:"photo-strip-empty",children:"撮影した写真がここに表示されます"}):Ue.map(s=>e.jsxs("div",{className:`photo-item${s.selectedForList?" is-selected":""}`,onClick:()=>{D(s.id)},children:[e.jsx("span",{className:"visually-hidden",children:"一覧表示用の写真として選択"}),e.jsx("button",{type:"button",className:"photo-remove",onClick:l=>{l.stopPropagation(),y(s.id)},"aria-label":"写真を削除",children:"×"}),e.jsx("img",{src:s.url,alt:"サムネイル"})]},s.id))}),je&&e.jsx("div",{className:"ocr-result-banner",children:je})]}),e.jsxs("div",{className:"page-section",children:[e.jsx("h2",{className:"section-title",children:"資産情報登録"}),e.jsx("div",{className:"section-title-underline-blue"}),e.jsxs("div",{className:"grid",children:[e.jsxs("label",{children:["大分類",e.jsx("input",{value:Ut,onChange:s=>ma(s.target.value),placeholder:"大分類を検索"})]}),e.jsx("div",{className:"option-list",children:ra.map(s=>e.jsx("button",{onClick:()=>va(s),className:s.id===He?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["中分類",e.jsx("input",{value:Bt,onChange:s=>ha(s.target.value),placeholder:"中分類を検索"})]}),e.jsx("div",{className:"option-list",children:da.map(s=>e.jsx("button",{onClick:()=>ya(s),className:s.id===tt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["品目",e.jsx("input",{value:$t,onChange:s=>fa(s.target.value),placeholder:"品目を検索"})]}),e.jsx("div",{className:"option-list",children:la.map(s=>e.jsx("button",{onClick:()=>xa(s),className:s.id===gt?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["メーカー名",e.jsx("input",{value:Ht,onChange:s=>ga(s.target.value),placeholder:"メーカー名を検索"})]}),e.jsx("div",{className:"option-list",children:ca.map(s=>e.jsx("button",{onClick:()=>Ia(s),className:s.id===Ct?"active":"",children:s.name},s.id))}),e.jsxs("label",{children:["型式",e.jsx("input",{value:qt,onChange:s=>pa(s.target.value),placeholder:"型式を検索"})]}),e.jsx("div",{className:"option-list",children:ua.map(s=>e.jsx("button",{onClick:()=>Na(s),className:s.id===ts?"active":"",children:s.name},s.id))})]}),e.jsxs("div",{className:"grid",style:{marginTop:16},children:[e.jsxs("div",{className:"asset-size-row",children:[e.jsxs("label",{children:["W",e.jsx("input",{value:sa,onChange:s=>{const l=s.target.value;Wt(l),n({width:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["D",e.jsx("input",{value:aa,onChange:s=>{const l=s.target.value;zt(l),n({depth:l})},placeholder:"mm"})]}),e.jsxs("label",{children:["H",e.jsx("input",{value:oa,onChange:s=>{const l=s.target.value;Gt(l),n({height:l})},placeholder:"mm"})]})]}),e.jsxs("label",{children:["備考",e.jsx("textarea",{value:ia,onChange:s=>{const l=s.target.value;Kt(l),n({note:l})},rows:3})]})]})]}),e.jsxs("footer",{className:"page-footer",children:[e.jsx("button",{type:"button",className:"ghost",onClick:()=>c("/survey/home"),children:"ホーム"}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>c("/survey/department"),children:["部門",e.jsx("br",{}),"入力へ"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:()=>Vt(!0),children:["履歴",e.jsx("br",{}),"表示"]}),e.jsxs("button",{type:"button",className:"secondary",onClick:()=>{var s;return(s=Ge.current)==null?void 0:s.click()},children:["写真",e.jsx("br",{}),"撮影"]}),e.jsxs("button",{type:"button",className:"ghost",onClick:Ca,disabled:v===0,children:["前の商品に",e.jsx("br",{}),"戻る"]}),e.jsxs("button",{type:"button",onClick:Sa,disabled:!(Ie&&Tt&&Ae),children:["商品",e.jsx("br",{}),"登録"]})]}),e.jsx(Xs,{open:ue,targetLabel:i==="assetNo"?"資産番号":"備品番号",onClose:()=>ge(!1),onResult:Be,onRecognized:Me}),Zt&&e.jsx("div",{className:"history-overlay",children:e.jsxs("div",{className:"history-panel",children:[e.jsxs("div",{className:"history-header",children:[e.jsx("h3",{children:"作業履歴"}),e.jsxs("div",{className:"row",children:[e.jsx("button",{className:"ghost",onClick:wa,children:es==="asc"?"降順にする":"昇順にする"}),e.jsx("button",{className:"ghost",onClick:()=>Vt(!1),children:"閉じる"})]})]}),Yt&&e.jsx("p",{className:"helper-text",children:"読み込み中..."}),St&&e.jsxs("p",{className:"badge warn",children:["エラー: ",St]}),!Yt&&!St&&Xt.length===0&&e.jsx("p",{className:"helper-text",children:"表示できる履歴がありません。"}),!Yt&&!St&&Xt.length>0&&e.jsx("div",{className:"history-list",children:e.jsxs("table",{className:"history-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"大分類"}),e.jsx("th",{children:"中分類"}),e.jsx("th",{children:"品目"}),e.jsx("th",{children:"メーカー名"}),e.jsx("th",{children:"型式"}),e.jsx("th",{children:"W"}),e.jsx("th",{children:"D"}),e.jsx("th",{children:"H"})]})}),e.jsx("tbody",{children:Xt.map(s=>{var Re,Fe,Pe,Qe,Te;const l=s.fields??{},Q=l.categoryName??((Re=pe.find(Y=>Y.id===l.categoryId))==null?void 0:Re.name)??"-",B=l.subcategoryName??((Fe=oe.find(Y=>Y.id===l.subcategoryId))==null?void 0:Fe.name)??"-",X=l.itemName??((Pe=ut.find(Y=>Y.id===l.itemId))==null?void 0:Pe.name)??"-",ve=l.makerName??((Qe=mt.find(Y=>Y.id===l.makerId))==null?void 0:Qe.name)??"-",De=l.modelName??((Te=ht.find(Y=>Y.id===l.modelId))==null?void 0:Te.name)??"-",ke=l.width??"-",qe=l.depth??"-",st=l.height??"-";return e.jsxs("tr",{className:"history-row",onClick:()=>ja(s),children:[e.jsx("td",{children:Q}),e.jsx("td",{children:B}),e.jsx("td",{children:X}),e.jsx("td",{children:ve}),e.jsx("td",{children:De}),e.jsx("td",{children:ke}),e.jsx("td",{children:qe}),e.jsx("td",{children:st})]},s.id)})})]})})]})})]})}export{to as A,Xa as D,Ya as L,so as P,fo as S,ro as a,lo as b,uo as c,j as d,is as e,mo as f,ho as g,Vs as p,co as q,We as u,Ga as w};
